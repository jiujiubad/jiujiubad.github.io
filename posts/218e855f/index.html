<!DOCTYPE HTML>
<html>
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>ror-system-购物网 | Hexo</title>


    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css?rev=3.3.4">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
    <div class="hide">
    	<script src="https://s4.cnzz.com/z_stat.php?id=1263868967&web_id=1263868967" language="JavaScript"></script>
    </div>






    
</head>

<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
  <div class="container-fluid">
    <div class="row">
      <header class="main-header"  style="background-image:url(http://7xpw2b.com1.z0.glb.clouddn.com/hexo-sinppet/img/banner2.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="">
            <img src="/img/avatar.jpg" alt="logo头像">
        </a>
        <div class="branding1">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 记录，把握点滴  ——by 99 </h2>
            
    	</div>
    </div>
</header>

      <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only">Toggle navigation</span>
                    <i class="fa fa-bars"></i>
                    </span>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>主页</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/archives/"><i class="fa fa-fw "></i>所有</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/posts/d16694c4/"><i class="fa fa-fw "></i>标题</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/ror系统/"><i class="fa fa-fw "></i>ror系统</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/微信小程序/"><i class="fa fa-fw "></i>微信小程序</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>关于我</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

      <section class="content-wra aa99">
        <!-- <div class="row">
          
    <div class="widget" style="padding:0 15px;">
        <div id="search-form" > 
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?" style="width:100%;border-radius:0;">

                
                
            </div>
            <div id="result-wrap" class="hide" style="padding:0 20px;">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        </div> -->
        <div class="row">
            <main class="col-md-9 main-content m-post">
                <p id="process"></p>
<article class="post pp99">
    <div class="post-head">
        <h1 id="ror-system-购物网">
            
	            ror-system-购物网
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <span>ror系统</span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            ror系统
            
        </span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">2017/11/20</span>
    </span>
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <h2 id="atom设置快捷键"><a href="#atom设置快捷键" class="headerlink" title="atom设置快捷键"></a>atom设置快捷键</h2><p>lt、ltp、ltd表示，&lt;%= link_to(“XXXX”, XXXX_path, class:”btn btn-danger btn-lg pull-right”, method: :post) %&gt;</p>
<p>tb表示，table.table.table-bordered&gt;(thead&gt;tr&gt;th<em>3)+(tbody&gt;tr&gt;td</em>3)</p>
<p>sf表示，&lt;%= simple_form_for @xx do |f| %&gt;&lt;% end %&gt;</p>
<h2 id="记住：controller中定义action都是按照find-and-do的思路。"><a href="#记住：controller中定义action都是按照find-and-do的思路。" class="headerlink" title="记住：controller中定义action都是按照find_and_do的思路。"></a>记住：controller中定义action都是按照find_and_do的思路。</h2><h2 id="一再遇到的-bug"><a href="#一再遇到的-bug" class="headerlink" title="一再遇到的 bug"></a>一再遇到的 bug</h2><p>1、gem ‘carrierwave’加上gem ‘mini_magick’后，上传图片的时候报错上传不了。</p>
<p>解决办法：更新<code>brew upgrade imagemagick</code>，然后bundle</p>
<p>2、cart.add_product_to_cart(product)在rails c测试时，<code>product = Product.last</code>把小写的product写成大写，折腾半天。</p>
<p>3、current_cart的定义，<code>@current_cart ||= find_cart</code>错写成<code>@current_cart || find_cart</code>，另外<code>if cart.blank?</code>错写成<code>if current_cart.blank?</code></p>
<p>4、6-1第四题，update会报错，是因为simple_form_for里要指明url，系统才能知道我们具体要删除哪一个cart_item，因为这里不是show页面。    </p>
<p>5、8-1checkout结算页在chrome浏览器里刷新，会跳出缺少order的show action的bug。换个浏览器就好了。</p>
<p>6、最常出现<code>No route matches {:action=&gt;&quot;index&quot;, :controller=&gt;&quot;admin/resumes&quot;} missing required keys: [:job_id]</code>。原因如下：</p>
<ul>
<li><p>1、Model层，model里没有做关联</p>
</li>
<li><p>2、Controller层，model关联后，所有外键（比如简历resume里有user_id、job_id）要在controlller的create的action里给一个表达式，指明这份简历具体属于哪一个用户、具体属于哪一个职位的。比如  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app/controllers/resumes_controller.rb</span><br><span class="line">  def create</span><br><span class="line">    @job = Job.find(params[:job_id])</span><br><span class="line">    @resume.job = @job</span><br><span class="line">    @resume.user = current_user</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、Views层，路径没有给参数，比如admin_job_resumes_path(@job)里的@job</p>
</li>
</ul>
<h1 id="一、简单版"><a href="#一、简单版" class="headerlink" title="一、简单版"></a>一、简单版</h1><h2 id="4、后台"><a href="#4、后台" class="headerlink" title="4、后台"></a>4、后台</h2><h3 id="4-1、基础建设"><a href="#4-1、基础建设" class="headerlink" title="4.1、基础建设"></a>4.1、基础建设</h3><p>4.1.1 fork、或新建专案</p>
<ul>
<li><a href="https://github.com/quanzhanying/jdstore" target="_blank" rel="noopener">https://github.com/quanzhanying/jdstore</a> </li>
</ul>
<p>4.1.2 gem ‘bootstrap-sass’</p>
<ul>
<li><p>css</p>
</li>
<li><p>html</p>
</li>
<li><p>flashes+js</p>
<ul>
<li><p>app/views/common/_flashes.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if flash.any? %&gt;</span><br><span class="line">  &lt;% user_facing_flashes.each do |key, value| %&gt;</span><br><span class="line">    &lt;div class=&quot;alert alert-dismissable alert-&lt;%= flash_class(key) %&gt;&quot;&gt;</span><br><span class="line">      &lt;button class=&quot;close&quot; data-dismiss=&quot;alert&quot;&gt;×&lt;/button&gt;</span><br><span class="line">      &lt;%= value %&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>app/helpers/flashes_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module FlashesHelper</span><br><span class="line">  FLASH_CLASSES = &#123; alert: &quot;danger&quot;, notice: &quot;success&quot;, warning: &quot;warning&quot;&#125;.freeze</span><br><span class="line"></span><br><span class="line">  def flash_class(key)</span><br><span class="line">    FLASH_CLASSES.fetch key.to_sym, key</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def user_facing_flashes</span><br><span class="line">    flash.to_hash.slice &quot;alert&quot;, &quot;notice&quot;,&quot;warning&quot; </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>4.1.3 gem ‘devise’</p>
<ul>
<li>注册、登录、退出</li>
</ul>
<p>4.1.4 gem ‘simple_form’</p>
<p>4.1.5 gem ‘font-awesome-rails’</p>
<h3 id="4-2、上架后台CRUD"><a href="#4-2、上架后台CRUD" class="headerlink" title="4.2、上架后台CRUD"></a>4.2、上架后台CRUD</h3><ul>
<li>使用者必须要是 admin 才能登入 <a href="http://localhost:3000/admin/products" target="_blank" rel="noopener">http://localhost:3000/admin/products</a></li>
<li>商品栏位必须要有 title, description, quantity, price</li>
<li>admin 后台 products 完整的 CRUD</li>
</ul>
<h3 id="4-3、admin-可以登录后台"><a href="#4-3、admin-可以登录后台" class="headerlink" title="4.3、admin 可以登录后台"></a>4.3、admin 可以登录后台</h3><ul>
<li>管理者（商家）必须先登录网站才能进入（商店）后台</li>
<li>管理者必须有 admin 权限才能进入后台</li>
<li>后台用layout ‘admin’自定义页面样式</li>
</ul>
<h3 id="4-4、上传图片"><a href="#4-4、上传图片" class="headerlink" title="4.4、上传图片"></a>4.4、上传图片</h3><ul>
<li>可以上传图片、且是剪切过的图片（gem ‘carrierwave’、gem ‘mini_magick’）</li>
<li>图片文件夹加入.gitignore中</li>
<li>设定 localhost:3000 为商品首页</li>
<li>商品index、show展示</li>
<li>重构后台各个views，加入图片</li>
</ul>
<h2 id="5、购物车实做"><a href="#5、购物车实做" class="headerlink" title="5、购物车实做"></a>5、购物车实做</h2><h3 id="5-2-Step-1-建立加入购物车的-action"><a href="#5-2-Step-1-建立加入购物车的-action" class="headerlink" title="5.2 Step 1 : 建立加入购物车的 action"></a>5.2 Step 1 : 建立加入购物车的 action</h3><ul>
<li>先做按钮和flashes</li>
</ul>
<h3 id="5-3-Step-2-购物车设计-Part-1"><a href="#5-3-Step-2-购物车设计-Part-1" class="headerlink" title="5.3 Step 2: 购物车设计 Part 1"></a>5.3 Step 2: 购物车设计 Part 1</h3><ul>
<li>cart、cart_item、product</li>
<li>实作add_product_to_cart(@product) </li>
<li>rails c 下测试功能</li>
</ul>
<h3 id="5-4-Step-3-购物车设计-Part-2"><a href="#5-4-Step-3-购物车设计-Part-2" class="headerlink" title="5.4 Step 3: 购物车设计 Part 2"></a>5.4 Step 3: 购物车设计 Part 2</h3><ul>
<li>显示购物车内物品数量</li>
<li>实作current_cart</li>
<li>rails c下测试功能</li>
</ul>
<h3 id="5-5-Step-4-显示购物车明细"><a href="#5-5-Step-4-显示购物车明细" class="headerlink" title="5.5 Step 4 : 显示购物车明细"></a>5.5 Step 4 : 显示购物车明细</h3><ul>
<li>carts的index</li>
</ul>
<h3 id="5-6-Step-5-计算总价"><a href="#5-6-Step-5-计算总价" class="headerlink" title="5.6 Step 5 : 计算总价"></a>5.6 Step 5 : 计算总价</h3><ul>
<li>先在views里做，测试ok后重构到helper和model中</li>
</ul>
<h2 id="6、购物车实做（解答）"><a href="#6、购物车实做（解答）" class="headerlink" title="6、购物车实做（解答）"></a>6、购物车实做（解答）</h2><h3 id="6-1-购物车练习作业-（解答）"><a href="#6-1-购物车练习作业-（解答）" class="headerlink" title="6.1 购物车练习作业 （解答）"></a>6.1 购物车练习作业 （解答）</h3><ul>
<li>请设计一个功能，可以一键清空购物车内所有的商品</li>
<li>某商品突然不想买了，我可以在购物车内删除它</li>
<li>已经加入购物车的商品，不能重复被加入</li>
<li>可以更改购物车内购买的商品数量(原本预设数量都是1)</li>
<li>库存为 0 的商品不能购买</li>
<li>在购物车新增数量时，不能更新超过原有库存的商品数量</li>
</ul>
<h2 id="8、订单实做"><a href="#8、订单实做" class="headerlink" title="8、订单实做"></a>8、订单实做</h2><h3 id="8-1-Step-1-建立结帐页"><a href="#8-1-Step-1-建立结帐页" class="headerlink" title="8.1 Step 1 : 建立结帐页"></a>8.1 Step 1 : 建立结帐页</h3><ul>
<li>按下「确认结帐」按钮后，可以显示结帐明细order页，并且可以让消费者输入寄送地址</li>
</ul>
<h3 id="8-2-Step-2-建立购买明细"><a href="#8-2-Step-2-建立购买明细" class="headerlink" title="8.2 Step 2 : 建立购买明细"></a>8.2 Step 2 : 建立购买明细</h3><ul>
<li>有时候商品会下架、价格会变，新建product_list的model</li>
<li>订单create时的购买明细缓存</li>
<li>购买明细show页面</li>
</ul>
<h3 id="8-3-Step-3-将网址改为秘密"><a href="#8-3-Step-3-将网址改为秘密" class="headerlink" title="8.3 Step 3 : 将网址改为秘密"></a>8.3 Step 3 : 将网址改为秘密</h3><ul>
<li>token</li>
</ul>
<h2 id="9、订单实做（解答）"><a href="#9、订单实做（解答）" class="headerlink" title="9、订单实做（解答）"></a>9、订单实做（解答）</h2><h3 id="9-1-订单练习作业（解答）"><a href="#9-1-订单练习作业（解答）" class="headerlink" title="9.1 订单练习作业（解答）"></a>9.1 订单练习作业（解答）</h3><ul>
<li>使用者可以在 /account/orders/ 看到过去所有订单</li>
<li>使用者在下拉式选单可以看到过去所有的订单</li>
<li>订单排序</li>
</ul>
<h2 id="10、支付订单与寄信"><a href="#10、支付订单与寄信" class="headerlink" title="10、支付订单与寄信"></a>10、支付订单与寄信</h2><h3 id="10-1-Step-1-消费者可以针对订单付款"><a href="#10-1-Step-1-消费者可以针对订单付款" class="headerlink" title="10.1 Step 1 : 消费者可以针对订单付款"></a>10.1 Step 1 : 消费者可以针对订单付款</h3><ul>
<li>使用 is_paid（boolean 属性）判断是否已付费</li>
<li>使用 payment_method 判断，实际付款渠道为：微信、支付宝</li>
<li>已付款过的订单不可以再付</li>
</ul>
<h3 id="10-2-Step-2-寄送订单确认通知信"><a href="#10-2-Step-2-寄送订单确认通知信" class="headerlink" title="10.2 Step 2 : 寄送订单确认通知信"></a>10.2 Step 2 : 寄送订单确认通知信</h3><ul>
<li>使用者在下单后会收到一封订单确认信，<code>rails g mailer OrderMailer</code></li>
<li>gem ‘letter_opener’，并在console下测试信件预览</li>
<li>在订单建立时寄通知信</li>
</ul>
<h2 id="11、后台出货订单操作"><a href="#11、后台出货订单操作" class="headerlink" title="11、后台出货订单操作"></a>11、后台出货订单操作</h2><h3 id="11-1-情境和-Model-准备"><a href="#11-1-情境和-Model-准备" class="headerlink" title="11.1 情境和 Model 准备"></a>11.1 情境和 Model 准备</h3><p>效果：「有限状态机」这个架构去做后台订单切换状态。</p>
<ul>
<li>已下订（order_placed）</li>
</ul>
<ul>
<li>已付款（paid）</li>
<li>卖家发货中（shipping）</li>
<li>已交货（shipped）</li>
<li>取消订单（order_cancelled）</li>
<li>退货（good_returned）</li>
</ul>
<h3 id="11-2-订单状态切换"><a href="#11-2-订单状态切换" class="headerlink" title="11.2 订单状态切换"></a>11.2 订单状态切换</h3><ul>
<li>建立 admin/orders 可以看到系统内所有订单</li>
<li>admin 的 order 列表应要能显示订单状态</li>
<li>使用者可以“申请取消订单”</li>
<li>使用者“申请取消订单”后，管理员应该要收到“申请通知信”</li>
<li>后台管理员可以“取消订单”、“出货”</li>
<li>后台管理“出货”后，系统应该寄出通知信</li>
<li>后台管理员“取消订单”后，系统应该寄出通知信</li>
</ul>
<h2 id="12、部署到-Heroku-（七牛云）"><a href="#12、部署到-Heroku-（七牛云）" class="headerlink" title="12、部署到 Heroku （七牛云）"></a>12、部署到 Heroku （七牛云）</h2><h3 id="12-1-本章学习指南"><a href="#12-1-本章学习指南" class="headerlink" title="12.1 本章学习指南"></a>12.1 本章学习指南</h3><h3 id="12-2-一些安全概念-本节只需要看，不需要实作"><a href="#12-2-一些安全概念-本节只需要看，不需要实作" class="headerlink" title="12.2 一些安全概念 (本节只需要看，不需要实作)"></a>12.2 一些安全概念 (本节只需要看，不需要实作)</h3><h3 id="12-3-使用七牛云（用来存储图片）"><a href="#12-3-使用七牛云（用来存储图片）" class="headerlink" title="12.3 使用七牛云（用来存储图片）"></a>12.3 使用七牛云（用来存储图片）</h3><h3 id="12-4-使用-Figaro-管理密码"><a href="#12-4-使用-Figaro-管理密码" class="headerlink" title="12.4 使用 Figaro 管理密码"></a>12.4 使用 Figaro 管理密码</h3><h3 id="12-5-将JDStore部署到Heroku"><a href="#12-5-将JDStore部署到Heroku" class="headerlink" title="12.5 将JDStore部署到Heroku"></a>12.5 将JDStore部署到Heroku</h3><h3 id="12-6-JDStore-商店创意大赛（第二季）参赛指南"><a href="#12-6-JDStore-商店创意大赛（第二季）参赛指南" class="headerlink" title="12.6 JDStore 商店创意大赛（第二季）参赛指南"></a>12.6 JDStore 商店创意大赛（第二季）参赛指南</h3><h3 id="12-7-使用SendCloud服务发送邮件"><a href="#12-7-使用SendCloud服务发送邮件" class="headerlink" title="12.7 使用SendCloud服务发送邮件"></a>12.7 使用SendCloud服务发送邮件</h3><h3 id="12-8-Rails-环境架构"><a href="#12-8-Rails-环境架构" class="headerlink" title="12.8 Rails 环境架构"></a>12.8 Rails 环境架构</h3><h3 id="12-9-如何在-Heroku-上-Debug"><a href="#12-9-如何在-Heroku-上-Debug" class="headerlink" title="12.9 如何在 Heroku 上 Debug"></a>12.9 如何在 Heroku 上 Debug</h3><h2 id="13-部署到-Heroku-海外用户方案"><a href="#13-部署到-Heroku-海外用户方案" class="headerlink" title="13-部署到 Heroku (海外用户方案)"></a>13-部署到 Heroku (海外用户方案)</h2><h3 id="13-1-本章部属指南"><a href="#13-1-本章部属指南" class="headerlink" title="13.1 本章部属指南"></a>13.1 本章部属指南</h3><h3 id="13-2-申请AWS-S3（用来储存图片）"><a href="#13-2-申请AWS-S3（用来储存图片）" class="headerlink" title="13.2 申请AWS S3（用来储存图片）"></a>13.2 申请AWS S3（用来储存图片）</h3><h3 id="13-3-使用-Figaro-管理密码"><a href="#13-3-使用-Figaro-管理密码" class="headerlink" title="13.3 使用 Figaro 管理密码"></a>13.3 使用 Figaro 管理密码</h3><h3 id="13-4-将JDStore部署到Heroku"><a href="#13-4-将JDStore部署到Heroku" class="headerlink" title="13.4 将JDStore部署到Heroku"></a>13.4 将JDStore部署到Heroku</h3><h3 id="13-5-泄漏-S3-密钥的处理方式"><a href="#13-5-泄漏-S3-密钥的处理方式" class="headerlink" title="13.5 泄漏 S3 密钥的处理方式"></a>13.5 泄漏 S3 密钥的处理方式</h3><h1 id="二、提示版"><a href="#二、提示版" class="headerlink" title="二、提示版"></a>二、提示版</h1><h2 id="4、后台-1"><a href="#4、后台-1" class="headerlink" title="4、后台"></a>4、后台</h2><h3 id="4-1、基础建设-1"><a href="#4-1、基础建设-1" class="headerlink" title="4.1、基础建设"></a>4.1、基础建设</h3><p>4.1.1 fork、或新建专案</p>
<p>方法一：for专案网址 <a href="https://github.com/quanzhanying/jdstore" target="_blank" rel="noopener">https://github.com/quanzhanying/jdstore</a> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/quanzhanying/jdstore.git rails/jdstore004 </span><br><span class="line">cd rails/jdstore004</span><br><span class="line">cp config/database.yml.example config/database.yml</span><br><span class="line">bundle check</span><br><span class="line">bundle install</span><br><span class="line">git checkout -b test</span><br><span class="line">rails s</span><br></pre></td></tr></table></figure>
<p>方法二：新建专案</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rails new rails/jdstore1201</span><br><span class="line">git init</span><br><span class="line">rails s</span><br></pre></td></tr></table></figure>
<p>4.1.2 gem ‘bootstrap-sass’</p>
<ul>
<li><p>css</p>
<ul>
<li><p>mv app/assets/stylesheets/application.css app/assets/stylesheets/application.scss</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app/assets/stylesheets/application.scss</span><br><span class="line"></span><br><span class="line">@import &quot;bootstrap-sprockets&quot;;</span><br><span class="line">@import &quot;bootstrap&quot;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>html</p>
<ul>
<li><p>rails g controller welcome，新建index并设置为首页</p>
</li>
<li><p>footer</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;footer class=&quot;container&quot; style=&quot;margin-top: 100px;&quot;&gt;</span><br><span class="line">    &lt;p class=&quot;text-center&quot;&gt;</span><br><span class="line">      Copyright ©2017 JDStore</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      Design by yourname       </span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">&lt;/footer&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>增加<code>_navbar.html.erb</code>、<code>_footer.html.erb</code>、<code>_flashes.htm.erb</code>，设置全局html</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app/views/layouts/application.html.erb</span><br><span class="line"></span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;div class=&quot;container-fluid&quot;&gt;</span><br><span class="line">            &lt;%= render &quot;common/navbar&quot; %&gt;</span><br><span class="line">            &lt;%= render &quot;common/flashes&quot; %&gt;</span><br><span class="line">            &lt;%= yield %&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;%= render &quot;common/footer&quot; %&gt;</span><br><span class="line">    &lt;/body&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>flashes+js</p>
<ul>
<li><p>js加入<code>//= require bootstrap/alert</code></p>
</li>
<li><p>app/views/common/_flashes.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if flash.any? %&gt;</span><br><span class="line">  &lt;% user_facing_flashes.each do |key, value| %&gt;</span><br><span class="line">    &lt;div class=&quot;alert alert-dismissable alert-&lt;%= flash_class(key) %&gt;&quot;&gt;</span><br><span class="line">      &lt;button class=&quot;close&quot; data-dismiss=&quot;alert&quot;&gt;×&lt;/button&gt;</span><br><span class="line">      &lt;%= value %&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>app/helpers/flashes_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module FlashesHelper</span><br><span class="line">  FLASH_CLASSES = &#123; alert: &quot;danger&quot;, notice: &quot;success&quot;, warning: &quot;warning&quot;&#125;.freeze</span><br><span class="line"></span><br><span class="line">  def flash_class(key)</span><br><span class="line">    FLASH_CLASSES.fetch key.to_sym, key</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def user_facing_flashes</span><br><span class="line">    flash.to_hash.slice &quot;alert&quot;, &quot;notice&quot;,&quot;warning&quot; </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>在welcome的index测试flashes</p>
</li>
</ul>
</li>
</ul>
<p>4.1.3 gem ‘devise’</p>
<ul>
<li><p>安装devise</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;devise&apos;</span><br><span class="line">rails g devise:install</span><br><span class="line">rails g devise user</span><br><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册、登录、退出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app/views/common/_navbar.html.erb</span><br><span class="line">-                &lt;li&gt; &lt;%= link_to(&quot;登入&quot;, &apos;#&apos;) %&gt;   &lt;/li&gt;</span><br><span class="line">+                &lt;% if !current_user %&gt;</span><br><span class="line">+                  &lt;li&gt;&lt;%= link_to(&quot;注册&quot;, new_user_registration_path) %&gt; &lt;/li&gt;</span><br><span class="line">+                  &lt;li&gt;&lt;%= link_to(&quot;登入&quot;, new_user_session_path) %&gt;&lt;/li&gt;</span><br><span class="line">+                &lt;% else %&gt;</span><br><span class="line">+                  &lt;li class=&quot;dropdown&quot;&gt;</span><br><span class="line">+                    &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;</span><br><span class="line">+                        Hi!, &lt;%= current_user.email %&gt;</span><br><span class="line">+                        &lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;</span><br><span class="line">+                    &lt;/a&gt;</span><br><span class="line">+                    &lt;ul class=&quot;dropdown-menu&quot;&gt;</span><br><span class="line">+                        &lt;li&gt; &lt;%= link_to(&quot;登出&quot;, destroy_user_session_path, method: :delete) %&gt; &lt;/li&gt;</span><br><span class="line">+                    &lt;/ul&gt;</span><br><span class="line">+                  &lt;/li&gt;</span><br><span class="line">+                &lt;% end %&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>js加入<code>//= require bootstrap/dropdown</code></p>
</li>
</ul>
<p>4.1.4 gem ‘simple_form’</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;simple_form&apos;</span><br><span class="line">rails generate simple_form:install --bootstrap</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>4.1.5 gem ‘font-awesome-rails’</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;font-awesome-rails&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@import &quot;font-awesome&quot;;</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= link_to(content_tag(:i, &apos;登入&apos;, class: &apos;fa fa-sign-in&apos;), new_user_session_path) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%= link_to(content_tag(:i, &apos;登出&apos;, class: &apos;fa fa-sign-out&apos;), destroy_user_session_path, method: :delete) %&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="4-2、上架后台CRUD-1"><a href="#4-2、上架后台CRUD-1" class="headerlink" title="4.2、上架后台CRUD"></a>4.2、上架后台CRUD</h3><ul>
<li><p>使用者必须要是 admin 才能登入 <a href="http://localhost:3000/admin/products" target="_blank" rel="noopener">http://localhost:3000/admin/products</a></p>
</li>
<li><p>商品栏位必须要有 title, description, quantity, price</p>
</li>
<li><p>admin 后台 products 完整的 CRUD</p>
<ul>
<li><p>1、R：admin::products</p>
<p>2、M：想到views里会用到栏位title/description/quantity/price</p>
<p>​</p>
<p>3、C：new和create</p>
<p>4、V：new页面，最简单的就好</p>
<p>​</p>
<p>5、C：index</p>
<p>6、V：index页面，最简单一个栏位就好</p>
<p>​</p>
<p>7、C：edit和update，顺便把destroy加上</p>
<p>8、V：edite页面</p>
</li>
</ul>
</li>
</ul>
<h3 id="4-3、admin-可以登录后台-1"><a href="#4-3、admin-可以登录后台-1" class="headerlink" title="4.3、admin 可以登录后台"></a>4.3、admin 可以登录后台</h3><ul>
<li><p>管理者（商家）必须先登录网站才能进入（商店）后台</p>
</li>
<li><p>管理者必须有 admin 权限才能进入后台</p>
</li>
<li><p>后台用layout ‘admin’自定义页面样式</p>
<ul>
<li><p>1、before_action :authenticate_user!、before_action :admin_required</p>
<p>2、C：def admin_required</p>
<p>3、M：def admin?</p>
<p>4、栏位：add_is_admin_to_user，boolean</p>
<p>5、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db/seeds.rb</span><br><span class="line">u = User.new</span><br><span class="line">u.email = &quot;admin@test.com&quot;           # 可以改成自己的 email</span><br><span class="line"></span><br><span class="line">u.password = &quot;111111&quot;                # 最少要六码</span><br><span class="line"></span><br><span class="line">u.password_confirmation = &quot;111111&quot;   # 最少要六码</span><br><span class="line"></span><br><span class="line">u.is_admin = true</span><br><span class="line">u.save</span><br></pre></td></tr></table></figure>
<p>​</p>
<p>6、C：layout “admin”</p>
<p>7、V：app/views/layouts/admin.html.erb</p>
</li>
</ul>
</li>
</ul>
<h3 id="4-4、上传图片-1"><a href="#4-4、上传图片-1" class="headerlink" title="4.4、上传图片"></a>4.4、上传图片</h3><ul>
<li><p>可以上传图片、且是剪切过的图片（gem ‘carrierwave’、gem ‘mini_magick’）</p>
</li>
<li><p>图片文件夹加入.gitignore中</p>
</li>
<li><p>设定 localhost:3000 为商品首页</p>
</li>
<li><p>商品index、show展示</p>
</li>
<li><p>重构后台各个views，加入图片</p>
<ul>
<li><p>1、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;carrierwave&apos;</span><br><span class="line">gem &apos;mini_magick&apos;</span><br></pre></td></tr></table></figure>
<p>rails g uploader image</p>
<p>2、栏位：add_image_to_product</p>
<p>3、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app/models/product.rb</span><br><span class="line">class Product &lt; ApplicationRecord</span><br><span class="line">+ mount_uploader :image, ImageUploader</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>4、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">include CarrierWave::MiniMagick</span><br><span class="line">+ process resize_to_fit: [800, 800]</span><br><span class="line"></span><br><span class="line">+ version :thumb do</span><br><span class="line">+   process resize_to_fill: [200,200]</span><br><span class="line">+ end</span><br><span class="line"></span><br><span class="line">+ version :medium do</span><br><span class="line">+   process resize_to_fill: [400,400]</span><br><span class="line">+ end</span><br></pre></td></tr></table></figure>
<p>5、C：params中加入image栏位</p>
<p>6、V：new表单加入上传图片&lt;%= f.input :image, as: :file %&gt;</p>
<p>7、V：edit表单加入现有图片&lt;% if @product.image.present? %&gt;，以及上传图片&lt;%= image_tag(@product.image.thumb.url) %&gt;</p>
<p>8、public/uploads加入.gitignore</p>
<p>​</p>
<p>9、C：product的index</p>
<p>10、V：index页面，并修改首页路径。页面显示图片、标题、价格，当没有图片是用<a href="http://placehold.it/200x200&amp;text=No" target="_blank" rel="noopener">http://placehold.it/200x200&amp;text=No</a> Pic</p>
<p>​</p>
<p>11、C：show</p>
<p>12、V：show页面&lt;%= image_tag(@product.image.medium.url) %&gt;，当没有图片是用<a href="http://placehold.it/400x400&amp;text=No" target="_blank" rel="noopener">http://placehold.it/400x400&amp;text=No</a> Pic</p>
<p>​</p>
<p>13、前后台navbar加入product</p>
<p>14、美化后台product的index页面如下：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fl9hdv3dyhj30m80c3mxx.jpg" alt=""></p>
</li>
</ul>
</li>
</ul>
<h2 id="5、购物车实做-1"><a href="#5、购物车实做-1" class="headerlink" title="5、购物车实做"></a>5、购物车实做</h2><h3 id="5-2-Step-1-建立加入购物车的-action-1"><a href="#5-2-Step-1-建立加入购物车的-action-1" class="headerlink" title="5.2 Step 1 : 建立加入购物车的 action"></a>5.2 Step 1 : 建立加入购物车的 action</h3><ul>
<li><p>先做按钮和flashes</p>
<ul>
<li><p>1、R：路由add_to_cart</p>
<p>2、V：按钮及路径</p>
<p>3、C：先做find_and_do的find，直接返回redirect_to :back</p>
</li>
</ul>
</li>
</ul>
<h3 id="5-3-Step-2-购物车设计-Part-1-1"><a href="#5-3-Step-2-购物车设计-Part-1-1" class="headerlink" title="5.3 Step 2: 购物车设计 Part 1"></a>5.3 Step 2: 购物车设计 Part 1</h3><ul>
<li><p>cart、cart_item、product</p>
</li>
<li><p>实作add_product_to_cart(@product) </p>
</li>
<li><p>rails c 下测试功能</p>
<ul>
<li><p>效果：current_cart.add_product_to_cart(@product)</p>
</li>
<li><p>1、M：新增cart和cart_item，并设置两者的关联</p>
<p>2、栏位：cart_item加入cart_id、product_id、quantity, default: 1</p>
<p>3、M：cart中定义add_product_to_cart(product)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+  def add_product_to_cart(product)</span><br><span class="line">+    ci = cart_items.build</span><br><span class="line">+    ci.product = product</span><br><span class="line">+    ci.quantity = 1</span><br><span class="line">+    ci.save</span><br><span class="line">+  end</span><br></pre></td></tr></table></figure>
<p>4、rails c中测试可否执行add_product_to_cart(product)，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Cart.create</span><br><span class="line">cart = Cart.first</span><br><span class="line">cart.add_product_to_cart(product)</span><br><span class="line">cart.cart_items</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="5-4-Step-3-购物车设计-Part-2-1"><a href="#5-4-Step-3-购物车设计-Part-2-1" class="headerlink" title="5.4 Step 3: 购物车设计 Part 2"></a>5.4 Step 3: 购物车设计 Part 2</h3><ul>
<li><p>显示购物车内物品数量</p>
</li>
<li><p>实作current_cart</p>
</li>
<li><p>rails c下测试功能</p>
<ul>
<li><p>效果：我们的目的是为了每个进店的客户（不管是否有登入，都准备一台购物车）。然后消费者随时可以察看购物车的产品数量。</p>
</li>
<li><p>1、V：显示车的icon，显示车的数量&lt;%= current_cart.products.count %&gt; </p>
<p>2、C：定义current_cart</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app/controllers/application_controller.rb</span><br><span class="line">+  helper_method :current_cart</span><br><span class="line"></span><br><span class="line">+  def current_cart</span><br><span class="line">+    @current_cart ||= find_cart</span><br><span class="line">+  end</span><br><span class="line"></span><br><span class="line">+  private</span><br><span class="line"></span><br><span class="line">+  def find_cart</span><br><span class="line">+    cart = Cart.find_by(id: session[:cart_id])</span><br><span class="line">+    if cart.blank?</span><br><span class="line">+      cart = Cart.create</span><br><span class="line">+    end</span><br><span class="line">+    session[:cart_id] = cart.id</span><br><span class="line">+    return cart</span><br><span class="line">+  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>3、C：补齐add_to_cart的定义，即current_cart.add_product_to_cart(@product)</p>
</li>
</ul>
</li>
</ul>
<h3 id="5-5-Step-4-显示购物车明细-1"><a href="#5-5-Step-4-显示购物车明细-1" class="headerlink" title="5.5 Step 4 : 显示购物车明细"></a>5.5 Step 4 : 显示购物车明细</h3><ul>
<li><p>carts的index</p>
<ul>
<li><p>1、R：路由加入carts</p>
<p>2、V：navbar的购物车按钮及链接</p>
<p>3、V：index页面</p>
<p>注意：为什么这里不用在controller里定义index？？——因为没有用到@carts，不用拿它来做@carts.each do |cart|。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1flqys6c6u9j30m809fmxk.jpg" alt=""></p>
</li>
</ul>
</li>
</ul>
<h3 id="5-6-Step-5-计算总价-1"><a href="#5-6-Step-5-计算总价-1" class="headerlink" title="5.6 Step 5 : 计算总价"></a>5.6 Step 5 : 计算总价</h3><ul>
<li><p>先在views里做，测试ok后重构到helper和model中</p>
<ul>
<li><p>1、V：测试运算&lt;% sum = sum + cart_item.quantity * cart_item.product.price %&gt;</p>
<p>2、helper：把步骤1的逻辑重构helper，测试运算。</p>
<p>3、M：用def total_price，把步骤2的运算重构到model中</p>
</li>
</ul>
</li>
</ul>
<h2 id="6、购物车实做（解答）-1"><a href="#6、购物车实做（解答）-1" class="headerlink" title="6、购物车实做（解答）"></a>6、购物车实做（解答）</h2><h3 id="6-1-购物车练习作业-（解答）-1"><a href="#6-1-购物车练习作业-（解答）-1" class="headerlink" title="6.1 购物车练习作业 （解答）"></a>6.1 购物车练习作业 （解答）</h3><ul>
<li><p>请设计一个功能，可以一键清空购物车内所有的商品</p>
<ul>
<li><p>1、R：路由collection，clean</p>
<p>2、V：按钮加入路径</p>
<p>3、C：定义clean，出现clean！</p>
<p>4、M：定义clean!，用cart_items**.destroy_all</p>
</li>
</ul>
</li>
<li><p>某商品突然不想买了，我可以在购物车内删除它</p>
<ul>
<li><p>1、R：路由cart_item</p>
<p>2、V：按钮加入路径</p>
<p>3、C：cart_item里定义destroy</p>
</li>
</ul>
</li>
<li><p>已经加入购物车的商品，不能重复被加入</p>
<ul>
<li>1、C：在add_to_cart的action里，用if !current_cart.products<strong>.include?</strong>(@product)判断</li>
</ul>
</li>
<li><p>可以更改购物车内购买的商品数量(原本预设数量都是1)</p>
<ul>
<li><p>1、V：加入&lt;%= f.select :quantity, [1,2,3,4,5] %&gt;</p>
<p>2、C：cart_item的update的action</p>
</li>
</ul>
</li>
<li><p>库存为 0 的商品不能购买</p>
<ul>
<li><p>1、V：&lt;% if @product.quantity &gt; 0 %&gt;</p>
<p>2、C：update的action，if @cart_item.product.quantity &gt;= <strong>cart_item_params[:quantity]</strong>.to_i</p>
</li>
</ul>
</li>
<li><p>在购物车新增数量时，不能更新超过原有库存的商品数量</p>
<ul>
<li>1、V：&lt;%= f.select :quantity, 1..cart_item.product.quantity %&gt;</li>
</ul>
</li>
</ul>
<h2 id="8、订单实做-1"><a href="#8、订单实做-1" class="headerlink" title="8、订单实做"></a>8、订单实做</h2><h3 id="8-1-Step-1-建立结帐页-1"><a href="#8-1-Step-1-建立结帐页-1" class="headerlink" title="8.1 Step 1 : 建立结帐页"></a>8.1 Step 1 : 建立结帐页</h3><ul>
<li><p>按下「确认结帐」按钮后，可以显示结帐明细order页，并且可以让消费者输入寄送地址</p>
<ul>
<li><p>1、R：路由加入checkout</p>
<p>2、V：改views里按钮的路径</p>
<p>3、C：checkout的action里新建一个order表单</p>
<p>4、V：点击checkout发现页面没变化，console里提示缺少checkout页面。——新建checkout.html.erb（需调用cart_item的商品信息、制作填表用上order栏位）</p>
<p>5、M：加入order所需栏位total、user_id、billing_name/address、shipping_name/address。并设置与user关系。</p>
<p>6、R：路由加入order</p>
<p>7、C：生成订单需要order的create的action。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1flrt0x20xug30m80dskjp.gif" alt=""></p>
</li>
</ul>
</li>
</ul>
<h3 id="8-2-Step-2-建立购买明细-1"><a href="#8-2-Step-2-建立购买明细-1" class="headerlink" title="8.2 Step 2 : 建立购买明细"></a>8.2 Step 2 : 建立购买明细</h3><ul>
<li><p>有时候商品会下架、价格会变，新建product_list的model</p>
</li>
<li><p>订单create时的购买明细缓存</p>
</li>
<li><p>购买明细show页面</p>
<ul>
<li><p>效果：用produst_list代替cart_item存储已下单的商品信息，达到订单里的商品信息不随商品更新而改变的目的。</p>
</li>
<li><p>问题、为什么要新建product_list的model ？——order和product_list的model，相当于是把cart和cart_item的商品信息转移过来。在购物车cart里商品会随着管理员产品信息更新而更新，而在订单order里商品的信息不再改变，已经单独储存在product_list中。</p>
</li>
<li><p>1、M：①新建product_list的model；②加入栏位order_id、product_name、product_price、quantity；③设置与order关系</p>
<p>2、C：订单creat的action中建立product_list的缓存信息</p>
<p>3、C：订单建立后会进入详情页即show，于是设置show的action</p>
<p>4、V：show的views，因为要用order和product_list来替代cart和cart_item，所以这里用order和product_list调用信息。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fl9ckubwyvj30m8082q3n.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1flahazqdt7j30m80b1aas.jpg" alt=""></p>
</li>
</ul>
</li>
</ul>
<h3 id="8-3-Step-3-将网址改为秘密-1"><a href="#8-3-Step-3-将网址改为秘密-1" class="headerlink" title="8.3 Step 3 : 将网址改为秘密"></a>8.3 Step 3 : 将网址改为秘密</h3><ul>
<li><p>token</p>
<ul>
<li><p>效果：订单号乱序显示</p>
</li>
<li><p>1、栏位：新建add_token_to_order</p>
<p>2、M：定义generate_token的action（SecureRandom.uuid），并加入before_create</p>
<p>3、C：修改order里的id调用，比如redirect_to order_path(@order)改成redirect_to order_path(@order.token)，find改成find_by_token</p>
</li>
</ul>
</li>
</ul>
<h2 id="9、订单实做（解答）-1"><a href="#9、订单实做（解答）-1" class="headerlink" title="9、订单实做（解答）"></a>9、订单实做（解答）</h2><h3 id="9-1-订单练习作业（解答）-1"><a href="#9-1-订单练习作业（解答）-1" class="headerlink" title="9.1 订单练习作业（解答）"></a>9.1 订单练习作业（解答）</h3><ul>
<li><p>使用者可以在 /account/orders/ 看到过去所有订单</p>
</li>
<li><p>使用者在下拉式选单可以看到过去所有的订单</p>
</li>
<li><p>订单排序</p>
<ul>
<li><p>1、R：路由加入</p>
<p>2、C：order的index，并按时间排序</p>
<p>3、V：index页面，并在navbar中加入链接。token报错，进入rails c，输入Order.where(token: nil).destroy_all</p>
</li>
</ul>
</li>
</ul>
<h2 id="10、支付订单与寄信-1"><a href="#10、支付订单与寄信-1" class="headerlink" title="10、支付订单与寄信"></a>10、支付订单与寄信</h2><h3 id="10-1-Step-1-消费者可以针对订单付款-1"><a href="#10-1-Step-1-消费者可以针对订单付款-1" class="headerlink" title="10.1 Step 1 : 消费者可以针对订单付款"></a>10.1 Step 1 : 消费者可以针对订单付款</h3><ul>
<li><p>使用 is_paid（boolean 属性）判断是否已付费</p>
</li>
<li><p>使用 payment_method 判断，实际付款渠道为：微信、支付宝</p>
</li>
<li><p>已付款过的订单不可以再付</p>
<ul>
<li><p>效果：用is_paid判断是否付费，用payment_method判断支付方式。</p>
</li>
<li><p>1、R：路由加入pay_with_alipay、pay_with_wechat</p>
<p>2、V：加入支付的按钮并链接路径</p>
<p>3、C：定义pay_with_alipay和pay_with_wechat的action</p>
<p>4、栏位：add_payment_method_to_order，string</p>
<p>5、M：定义set_payment_with!(method)、和 pay! ，用到上一步新建的栏位。这里的用法是self.update_columns(栏位: 设定的值 )</p>
<p>​</p>
<p>6、栏位：add_is_paid_to_order，boolean</p>
<p>7、V：加入if判断显示支付按钮，还是显示“订单已完成付款”</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fl9cy13agqj30m80d1aal.jpg" alt=""></p>
</li>
</ul>
</li>
</ul>
<h3 id="10-2-Step-2-寄送订单确认通知信-1"><a href="#10-2-Step-2-寄送订单确认通知信-1" class="headerlink" title="10.2 Step 2 : 寄送订单确认通知信"></a>10.2 Step 2 : 寄送订单确认通知信</h3><ul>
<li><p>使用者在下单后会收到一封订单确认信，<code>rails g mailer OrderMailer</code></p>
</li>
<li><p>gem ‘letter_opener’，并在console下测试信件预览</p>
</li>
<li><p>在订单建立时寄通知信</p>
<ul>
<li><p>1、rails g mailer OrderMailer，产生mailer相关文件</p>
<p>2、app/mailers/application_mailer.rb，设置寄信人邮箱</p>
<p>3、app/mailers/order_mailer.rb，设置寄信表头内容（完整代码见下面11章）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> def notify_order_placed(order)</span><br><span class="line">  @user = order.user</span><br><span class="line">  mail(to: @user.email , subject: &quot;xxx&quot;)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>4、V：notify_order_placed.html.erb，生成订单后的寄信内容（如果没有页面会在rails s报错）</p>
<p>5、</p>
<ul>
<li><code>gem &#39;letter_opener&#39;, group: :development</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>* config/environments/development.rb设置`config.action_mailer.delivery_method = :letter_opener`

6、rails c 中测试自动发送信件，OrderMailer.notify_order_placed(Order.last).deliver!

7、C：在order的create的action中加入清空购物车、发送邮件
</code></pre><h2 id="11、后台出货订单操作-1"><a href="#11、后台出货订单操作-1" class="headerlink" title="11、后台出货订单操作"></a>11、后台出货订单操作</h2><h3 id="11-1-情境和-Model-准备-1"><a href="#11-1-情境和-Model-准备-1" class="headerlink" title="11.1 情境和 Model 准备"></a>11.1 情境和 Model 准备</h3><p>效果：「有限状态机」这个架构去做后台订单切换状态。</p>
<ul>
<li><p>1、<a href="https://github.com/aasm/aasm" target="_blank" rel="noopener">aasm的github摘抄如下内容</a></p>
<ul>
<li><p>gem ‘aasm’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">class Job</span><br><span class="line">  include AASM #载入</span><br><span class="line"></span><br><span class="line">  aasm do</span><br><span class="line">    state :sleeping, :initial =&gt; true #初始状态</span><br><span class="line">    state :running #状态2</span><br><span class="line">    state :running #状态3</span><br><span class="line"></span><br><span class="line">    event :run do #定义run的动作，可以在controller中用run!调用</span><br><span class="line">      transitions :from =&gt; :sleeping, :to =&gt; :running #状态由sleeping转换为running</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    event :clean do</span><br><span class="line">      transitions :from =&gt; :running, :to =&gt; :cleaning</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    event :sleep do</span><br><span class="line">      transitions :from =&gt; [:running, :cleaning], :to =&gt; :sleeping #当有多种状态时用[]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>下面这几个用到after_commit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">event           before_all_transactions</span><br><span class="line">event           before_transaction</span><br><span class="line">event           aasm_fire_event (within transaction)</span><br><span class="line">event           after_commit (if event successful)</span><br><span class="line">event           after_transaction</span><br><span class="line">event           after_all_transactions</span><br><span class="line"></span><br><span class="line">aasm do</span><br><span class="line">  state :sleeping, :initial =&gt; true</span><br><span class="line">  state :running</span><br><span class="line"></span><br><span class="line">  event :run, :after_commit =&gt; :notify_about_running_job do</span><br><span class="line">    transitions :from =&gt; :sleeping, :to =&gt; :running</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、增加栏位：add_aasm_state_to_order， :string, default: “order_placed”，目的是设置初始值</p>
<p>3、六个状态state注意是状态：</p>
<ul>
<li>已下订（order_placed）</li>
<li>已付款（paid）</li>
<li>卖家发货中（shipping）</li>
<li>已交货（shipped）</li>
<li>取消订单（order_cancelled）</li>
<li>退货（good_returned）</li>
</ul>
<p>4、五种个model里的动作，即五种状态切换</p>
<p>注意：这里是model的动作，常常会在controller的action行为下调用，因为在后面加!所以可以同名</p>
<ul>
<li>make_payment（付款）</li>
<li><strong>ship卖家发货</strong>（货物离开启运地或者发货人交运给承运人）</li>
<li><strong>deliver交货（货物到达目的地或者交付收货人）</strong></li>
<li>return（退货）</li>
<li>cancel（取消订单）</li>
</ul>
<p>4、C：<code>-   @order.pay!</code>，然后<code>+   @order.make_payment!</code></p>
<p>5、M：修改有限状态机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event :make_payment, after_commit: :pay! do</span><br></pre></td></tr></table></figure>
<p>6、测试：重新操作订单新建到付款，rails c，Order.last，看aasm_state是否显示为转换后的状态paid</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fl9fdf4i1vj30ez09f0t3.jpg" alt=""></p>
</li>
</ul>
</li>
</ul>
<h3 id="11-2-订单状态切换-1"><a href="#11-2-订单状态切换-1" class="headerlink" title="11.2 订单状态切换"></a>11.2 订单状态切换</h3><ul>
<li><p>建立 admin/orders 可以看到系统内所有订单</p>
</li>
<li><p>admin 的 order 列表应要能显示订单状态</p>
</li>
<li><p>使用者可以“申请取消订单”</p>
</li>
<li><p>使用者“申请取消订单”后，管理员应该要收到“申请通知信”</p>
</li>
<li><p>后台管理员可以“取消订单”、“出货”</p>
</li>
<li><p>后台管理“出货”后，系统应该寄出通知信</p>
</li>
<li><p>后台管理员“取消订单”后，系统应该寄出通知信</p>
<ul>
<li><p>1、R：路由加入admin::order</p>
<p>2、C：index，按id排序</p>
<p>3、V：index页面，用order调用信息：订单号、创建人、创建时间、订单状态</p>
<p>​</p>
<p>4、C：show，显示product_lists</p>
<p>5、V：show页面，用product_lists和@order调用信息</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1flaorhgrlyg30m80f7kjm.gif" alt=""></p>
<p>6、helper：render_order_paid_state(order)，显示已付款、未付款</p>
<p>7、V：调用</p>
<p>​</p>
<p>后台操作：</p>
<p>8、V：app/views/admin/orders/_state_option.html.erb，用case..when语法罗列6种订单状态，然后分别在各种状态下列出需要出现的操作按钮，发现总共需要4种按钮、2种状态：</p>
<ul>
<li>已下订（order_placed）——申请取消订单cancel</li>
<li>已付款（paid）——申请取消订单cancel+卖家发货ship</li>
<li>卖家发货中（shipping）——交货deliver</li>
<li>已交货（shipped）——退货</li>
<li>取消订单（order_cancelled）——状态：订单已取消</li>
<li>退货（good_returned）——状态：已完成退货</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">app/views/admin/orders/_state_option.html.erb</span><br><span class="line"></span><br><span class="line">&lt;% case order.aasm_state %&gt;</span><br><span class="line"> &lt;% when &quot;order_placed&quot; %&gt;</span><br><span class="line">   &lt;%= link_to(&quot;取消订单&quot;,</span><br><span class="line">               cancel_admin_order_path(order),</span><br><span class="line">               class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line"> &lt;% when &quot;paid&quot; %&gt;</span><br><span class="line">   &lt;%= link_to(&quot;取消订单&quot;,</span><br><span class="line">               cancel_admin_order_path(order),</span><br><span class="line">               class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line">   &lt;%= link_to(&quot;出货&quot;,</span><br><span class="line">               ship_admin_order_path(order),</span><br><span class="line">               class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line"> &lt;% when &quot;shipping&quot; %&gt;</span><br><span class="line">   &lt;%= link_to(&quot;设为已出货&quot;,</span><br><span class="line">               shipped_admin_order_path(order),</span><br><span class="line">               class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line"> &lt;% when &quot;shipped&quot; %&gt;</span><br><span class="line">   &lt;%= link_to(&quot;退货&quot;,</span><br><span class="line">               return_admin_order_path(order),</span><br><span class="line">               class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line"> &lt;% when &quot;order_cancelled&quot; %&gt;</span><br><span class="line">   &lt;span class=&quot;label label-default&quot;&gt;订单已取消&lt;/span&gt;</span><br><span class="line"></span><br><span class="line"> &lt;% when &quot;good_returned&quot; %&gt;</span><br><span class="line">   &lt;span class=&quot;label label-default&quot;&gt;已退货&lt;/span&gt;</span><br><span class="line"></span><br><span class="line"> &lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>9、R：路由加入4种动作ship、shiped、return、cancel</p>
<p>10、C：设置4种动作的find_and_do，其中do的部分已经在11-1的aasm..do里设置过，可以直接调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">def ship</span><br><span class="line">  @order = Order.find(params[:id])</span><br><span class="line">  @order.ship!</span><br><span class="line">  redirect_to :back</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def deliver</span><br><span class="line">  @order = Order.find(params[:id])</span><br><span class="line">  @order.deliver!</span><br><span class="line">  redirect_to :back</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def cancel</span><br><span class="line">  @order = Order.find(params[:id])</span><br><span class="line">  @order.cancel!</span><br><span class="line">  redirect_to :back</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def return</span><br><span class="line">  @order = Order.find(params[:id])</span><br><span class="line">  @order.return!</span><br><span class="line">  redirect_to :back</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>11、V：show里加入刚刚步骤8做的页面 &lt;%= render “state_option”, order: @order %&gt;</p>
<p>​</p>
<p>前台用户操作：</p>
<p>12、R：加入用户取消订单动作apply_to_cancel</p>
<p>13、V：申请取消订单的按钮附上链接，加条件&lt;% if @order.order_placed? || @order.paid? %&gt;</p>
<p>14、C：定义apply_to_cancel</p>
<p>​</p>
<p>寄信设置：</p>
<p>15、C：分别加入寄信OrderMailer.notify_ship(@order).deliver!</p>
<p>前台用户，apply_to_cancel申请取消订单apply_cancel(@order)</p>
<p>后台，ship卖家已发货notify_ship(@order)</p>
<p>后台，cancel订单已取消notify_cancel(@order)</p>
<p>16、修改OrderMailer的表头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app/mailers/order_mailer.rb</span><br><span class="line"></span><br><span class="line">def apply_cancel(order)</span><br><span class="line">  @order       = order</span><br><span class="line">  @user        = order.user</span><br><span class="line">  @product_lists = @order.product_lists</span><br><span class="line"></span><br><span class="line">  mail(to: &quot;admin@test.com&quot; , subject: &quot;[JDStore] 用户#&#123;order.user.email&#125;申请取消订单 #&#123;order.token&#125;&quot;)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>V：加入寄信页面，几个页面内容一样，可以用partial</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">app/views/order_mailer/apply_cancel.html.erb</span><br><span class="line">&lt;div class=&quot;row&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;col-md-12&quot;&gt;</span><br><span class="line">    &lt;h2&gt;</span><br><span class="line">      订单明细 &lt;br&gt;</span><br><span class="line">      &lt;small&gt;</span><br><span class="line">        &lt;%= link_to(&quot;订单连结&quot;, order_url(@order.token)) %&gt;</span><br><span class="line">      &lt;/small&gt;</span><br><span class="line">    &lt;/h2&gt;</span><br><span class="line">    &lt;table class=&quot;table table-bordered&quot;&gt;</span><br><span class="line">      &lt;thead&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">          &lt;th width=&quot;70%&quot;&gt;商品明细&lt;/th&gt;</span><br><span class="line">          &lt;th&gt;单价&lt;/th&gt;</span><br><span class="line">          &lt;th&gt;数量&lt;/th&gt;</span><br><span class="line">          &lt;th&gt;小记&lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">      &lt;/thead&gt;</span><br><span class="line">      &lt;tbody&gt;</span><br><span class="line"></span><br><span class="line">        &lt;% @product_lists.each do |product_list| %&gt;</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">              &lt;%= product_list.product_name %&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">              &lt;%= product_list.product_price %&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">              &lt;%= product_list.quantity %&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">              &lt;%= product_list.quantity * product_list.product_price %&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;% end %&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;total group clearfix&quot;&gt;</span><br><span class="line">      &lt;h4 class=&quot;pull-right&quot;&gt;</span><br><span class="line">        总计 &lt;%= @order.total %&gt; CNY</span><br><span class="line">      &lt;/h4&gt;</span><br><span class="line">     &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">     &lt;hr&gt;</span><br><span class="line"></span><br><span class="line">     &lt;h2&gt; 寄送资讯 &lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">     &lt;table class=&quot;table table-striped table-bordered&quot;&gt;</span><br><span class="line">      &lt;tbody&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">          &lt;td&gt; 订购人 &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">          &lt;td&gt;</span><br><span class="line">            &lt;%= @order.billing_name %&gt; - &lt;%= @order.billing_address %&gt;</span><br><span class="line">          &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">          &lt;td&gt; 收件者 &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">          &lt;td&gt;</span><br><span class="line">            &lt;%= @order.shipping_name %&gt; - &lt;%= @order.shipping_address %&gt;</span><br><span class="line">          &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">      &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>17、在rails c中测试，OrderMailer.notify_order_placed(Order.last).deliver!</p>
</li>
</ul>
</li>
</ul>
<h2 id="12、部署到-Heroku-（七牛云）-1"><a href="#12、部署到-Heroku-（七牛云）-1" class="headerlink" title="12、部署到 Heroku （七牛云）"></a>12、部署到 Heroku （七牛云）</h2><h3 id="12-1-本章学习指南-1"><a href="#12-1-本章学习指南-1" class="headerlink" title="12.1 本章学习指南"></a>12.1 本章学习指南</h3><h3 id="12-2-一些安全概念-本节只需要看，不需要实作-1"><a href="#12-2-一些安全概念-本节只需要看，不需要实作-1" class="headerlink" title="12.2 一些安全概念 (本节只需要看，不需要实作)"></a>12.2 一些安全概念 (本节只需要看，不需要实作)</h3><h3 id="12-3-使用七牛云（用来存储图片）-1"><a href="#12-3-使用七牛云（用来存储图片）-1" class="headerlink" title="12.3 使用七牛云（用来存储图片）"></a>12.3 使用七牛云（用来存储图片）</h3><h3 id="12-4-使用-Figaro-管理密码-1"><a href="#12-4-使用-Figaro-管理密码-1" class="headerlink" title="12.4 使用 Figaro 管理密码"></a>12.4 使用 Figaro 管理密码</h3><h3 id="12-5-将JDStore部署到Heroku-1"><a href="#12-5-将JDStore部署到Heroku-1" class="headerlink" title="12.5 将JDStore部署到Heroku"></a>12.5 将JDStore部署到Heroku</h3><h3 id="12-6-JDStore-商店创意大赛（第二季）参赛指南-1"><a href="#12-6-JDStore-商店创意大赛（第二季）参赛指南-1" class="headerlink" title="12.6 JDStore 商店创意大赛（第二季）参赛指南"></a>12.6 JDStore 商店创意大赛（第二季）参赛指南</h3><h3 id="12-7-使用SendCloud服务发送邮件-1"><a href="#12-7-使用SendCloud服务发送邮件-1" class="headerlink" title="12.7 使用SendCloud服务发送邮件"></a>12.7 使用SendCloud服务发送邮件</h3><h3 id="12-8-Rails-环境架构-1"><a href="#12-8-Rails-环境架构-1" class="headerlink" title="12.8 Rails 环境架构"></a>12.8 Rails 环境架构</h3><h3 id="12-9-如何在-Heroku-上-Debug-1"><a href="#12-9-如何在-Heroku-上-Debug-1" class="headerlink" title="12.9 如何在 Heroku 上 Debug"></a>12.9 如何在 Heroku 上 Debug</h3><h2 id="13-部署到-Heroku-海外用户方案-1"><a href="#13-部署到-Heroku-海外用户方案-1" class="headerlink" title="13-部署到 Heroku (海外用户方案)"></a>13-部署到 Heroku (海外用户方案)</h2><h3 id="13-1-本章部属指南-1"><a href="#13-1-本章部属指南-1" class="headerlink" title="13.1 本章部属指南"></a>13.1 本章部属指南</h3><h3 id="13-2-申请AWS-S3（用来储存图片）-1"><a href="#13-2-申请AWS-S3（用来储存图片）-1" class="headerlink" title="13.2 申请AWS S3（用来储存图片）"></a>13.2 申请AWS S3（用来储存图片）</h3><h3 id="13-3-使用-Figaro-管理密码-1"><a href="#13-3-使用-Figaro-管理密码-1" class="headerlink" title="13.3 使用 Figaro 管理密码"></a>13.3 使用 Figaro 管理密码</h3><h3 id="13-4-将JDStore部署到Heroku-1"><a href="#13-4-将JDStore部署到Heroku-1" class="headerlink" title="13.4 将JDStore部署到Heroku"></a>13.4 将JDStore部署到Heroku</h3><h3 id="13-5-泄漏-S3-密钥的处理方式-1"><a href="#13-5-泄漏-S3-密钥的处理方式-1" class="headerlink" title="13.5 泄漏 S3 密钥的处理方式"></a>13.5 泄漏 S3 密钥的处理方式</h3>
    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">by 99</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/posts/c5bd9801/" class="pre-post btn btn-default"><i class="fa fa-angle-left fa-fw"></i>上一篇</a>
    
    
        <a href="/posts/2fb899c2/" class="next-post btn btn-default">下一篇<i class="fa fa-angle-right fa-fw"></i></a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMzE1My85NzEx">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>


            </main>
            
    <aside class="col-md-3 sidebar">
        
        
    <div class="widget">
        <h3 class="title">搜索</h3>
        <div id="search-form">
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?">
                    <button type="button" class="search-form-submit" id="search-local">搜索</button>
                
                
            </div>
            <div id="result-wrap" class="hide">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        
        
    <div class="widget notification">
        <h3 class="title">网站公告</h3>
        <div>
            <p>你好，我是99。<br/>欢迎来到我的博客。<br/>
<br/>
<hr/>接受贡献，包括不限于提交问题与需求，修复代码。欢迎Pull Request<br/>支持主题：<a href="https://github.com/shenliyang/hexo-theme-snippet/stargazers">Star一下</a>
</p>
        </div>
    </div>

        
        
    <div class="widget">
      <h3 class="title">社交</h3> 
        <div class="content social">
            
	            <a href="https://github.com/jiujiubad?tab=repositories" rel="external nofollow" title="Github" target="_blank">
			    	<i class="github fa fa-github"></i>
			    </a>
            
	            <a href="jiujiubad@gmail.com" rel="external nofollow" title="邮箱" target="_blank">
			    	<i class="envelope-o fa fa-envelope-o"></i>
			    </a>
            
	            <a href="https://ws4.sinaimg.cn/large/006tNc79ly1fnvcxiavzgj30by0bymxg.jpg" rel="external nofollow" title="微信" target="_blank">
			    	<i class="weixin fa fa-weixin"></i>
			    </a>
            
        </div>
    </div>


        
        
    <div class="widget">
        <h3 class="title">分类</h3>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ror功能/"><i class="fa" aria-hidden="true">ror功能</i></a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ror知识点/"><i class="fa" aria-hidden="true">ror知识点</i></a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link current" href="/categories/ror系统/"><i class="fa" aria-hidden="true">ror系统</i></a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web页面/"><i class="fa" aria-hidden="true">web页面</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/"><i class="fa" aria-hidden="true">工具</i></a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信小程序/"><i class="fa" aria-hidden="true">微信小程序</i></a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/心得/"><i class="fa" aria-hidden="true">心得</i></a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/投资/"><i class="fa" aria-hidden="true">投资</i></a><span class="category-list-count">1</span></li></ul>
    </div>


        
        
    <div class="widget">
      <h3 class="title">归档</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/"><i class="fa" aria-hidden="true">March 2018</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/"><i class="fa" aria-hidden="true">February 2018</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/"><i class="fa" aria-hidden="true">January 2018</i></a><span class="archive-list-count">37</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/"><i class="fa" aria-hidden="true">December 2017</i></a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/"><i class="fa" aria-hidden="true">November 2017</i></a><span class="archive-list-count">36</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/"><i class="fa" aria-hidden="true">September 2017</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/"><i class="fa" aria-hidden="true">April 2017</i></a><span class="archive-list-count">1</span></li></ul>
    </div>


        
        
  <div class="widget">
    <h3 class="title">标签云</h3>
    <div class="content tag-cloud">
        <a href="/tags/atom/" style="font-size: 13.08px;">atom</a> <a href="/tags/bug/" style="font-size: 17.69px;">bug</a> <a href="/tags/heroku/" style="font-size: 10px;">heroku</a> <a href="/tags/hexo/" style="font-size: 11.54px;">hexo</a> <a href="/tags/interview/" style="font-size: 13.85px;">interview</a> <a href="/tags/mac/" style="font-size: 11.54px;">mac</a> <a href="/tags/orid-day/" style="font-size: 10.77px;">orid-day</a> <a href="/tags/orid-month/" style="font-size: 11.54px;">orid-month</a> <a href="/tags/ror功能/" style="font-size: 13.08px;">ror功能</a> <a href="/tags/ror知识点/" style="font-size: 16.92px;">ror知识点</a> <a href="/tags/ror系统/" style="font-size: 20px;">ror系统</a> <a href="/tags/stackoverflow/" style="font-size: 10px;">stackoverflow</a> <a href="/tags/typora/" style="font-size: 10px;">typora</a> <a href="/tags/vps/" style="font-size: 16.15px;">vps</a> <a href="/tags/web页面/" style="font-size: 11.54px;">web页面</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/工具/" style="font-size: 19.23px;">工具</a> <a href="/tags/常用/" style="font-size: 13.08px;">常用</a> <a href="/tags/微信功能/" style="font-size: 12.31px;">微信功能</a> <a href="/tags/微信系统/" style="font-size: 15.38px;">微信系统</a> <a href="/tags/微信页面/" style="font-size: 10.77px;">微信页面</a> <a href="/tags/心得/" style="font-size: 18.46px;">心得</a> <a href="/tags/手机/" style="font-size: 10px;">手机</a> <a href="/tags/投资/" style="font-size: 10px;">投资</a> <a href="/tags/搬砖/" style="font-size: 10px;">搬砖</a> <a href="/tags/核聚编程/" style="font-size: 14.62px;">核聚编程</a> <a href="/tags/科学上网/" style="font-size: 13.08px;">科学上网</a> <a href="/tags/部署/" style="font-size: 12.31px;">部署</a>
    </div>
  </div>


        
        
    <div class="widget">
        <h3 class="title">友链</h3>
        <div class="content friends-link">
        
            <a href="http://www.shenliyang.com" class="fa" target="_blank">个人博客</a>
        
        </div>
    </div>


        
    </aside>


        </div>
      </section>
    </div>
  </div>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <span>Copyright &copy; 2018
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



	<script src="/js/search.js?rev=@@hash"></script>


<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>
