<!DOCTYPE HTML>
<html>
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>ror-system-rails tutorial笔记 | Hexo</title>


    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css?rev=3.3.4">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
    <div class="hide">
    	<script src="https://s4.cnzz.com/z_stat.php?id=1263868967&web_id=1263868967" language="JavaScript"></script>
    </div>






    
</head>

<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
  <div class="container-fluid">
    <div class="row">
      <header class="main-header"  style="background-image:url(http://7xpw2b.com1.z0.glb.clouddn.com/hexo-sinppet/img/banner2.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="">
            <img src="/img/avatar.jpg" alt="logo头像">
        </a>
        <div class="branding1">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 记录，把握点滴  ——by 99 </h2>
            
    	</div>
    </div>
</header>

      <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only">Toggle navigation</span>
                    <i class="fa fa-bars"></i>
                    </span>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>主页</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/archives/"><i class="fa fa-fw "></i>所有</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/posts/d16694c4/"><i class="fa fa-fw "></i>标题</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/ror系统/"><i class="fa fa-fw "></i>ror系统</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/微信小程序/"><i class="fa fa-fw "></i>微信小程序</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>关于我</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

      <section class="content-wra aa99">
        <!-- <div class="row">
          
    <div class="widget" style="padding:0 15px;">
        <div id="search-form" > 
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?" style="width:100%;border-radius:0;">

                
                
            </div>
            <div id="result-wrap" class="hide" style="padding:0 20px;">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        </div> -->
        <div class="row">
            <main class="col-md-9 main-content m-post">
                <p id="process"></p>
<article class="post pp99">
    <div class="post-head">
        <h1 id="ror-system-rails tutorial笔记">
            
	            ror-system-rails tutorial笔记
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <span>ror系统</span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            ror系统
            
        </span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">2018/01/30</span>
    </span>
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <ul>
<li>201802</li>
<li>编程+rails</li>
</ul>
<p>[TOC]</p>
<p>▲▲▲测试的情景，写法对应哪一章节？——目的是在其他专案也知道怎么写测试</p>
<p>twitter的MVC关系？用devise是不是可以省略中间的章节？——目的是理清twitter最小模型，可以完成练习题</p>
<p>首页显示其他用户的动态是怎么实现？——目的是在其他专案写动态效果</p>
<h2 id="推荐课程和书籍"><a href="#推荐课程和书籍" class="headerlink" title="推荐课程和书籍"></a>推荐课程和书籍</h2><h3 id="第三章"><a href="#第三章" class="headerlink" title="第三章"></a>第三章</h3><p>codeschool的rspec，可以解惑很多rspec的疑问。<a href="https://www.codeschool.com/courses/testing-with-rspec" target="_blank" rel="noopener">https://www.codeschool.com/courses/testing-with-rspec</a></p>
<h3 id="第四章"><a href="#第四章" class="headerlink" title="第四章"></a>第四章</h3><p>读完本书后读一本专门针对ruby的书：《Ruby入门》、《The Well-Grounded Rubyist》、或《Ruby之道》。</p>
<h2 id="tip1、新建专案"><a href="#tip1、新建专案" class="headerlink" title="tip1、新建专案"></a>tip1、新建专案</h2><p>rails new </p>
<p>git init</p>
<p>.gitignore忽略rails应用程序文档，vim和emacs的交换文件swap file，mac finder生成的.DS_Store文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Ignore bundler config.</span><br><span class="line">/.bundle</span><br><span class="line"># Ignore the default SQLite database.</span><br><span class="line">/db/*.sqlite3</span><br><span class="line">/db/*.sqlite3-journal</span><br><span class="line"># Ignore all logfiles and tempfiles.</span><br><span class="line">/log/*.log</span><br><span class="line">/tmp</span><br><span class="line"># Ignore other unneeded files.</span><br><span class="line">doc/</span><br><span class="line">*.swp</span><br><span class="line">*~</span><br><span class="line">.project</span><br><span class="line">.DS_Store</span><br><span class="line">.idea</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle install --without production #不安装生产环境的gem</span><br></pre></td></tr></table></figure>
<p>README.md</p>
<p>2.3.5 config/environments/production.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DemoApp::Application.configure do</span><br><span class="line">  config.serve_static_assets = true</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="tip2、rails-c-命令4-2、4-3、第六章、8-2-2"><a href="#tip2、rails-c-命令4-2、4-3、第六章、8-2-2" class="headerlink" title="tip2、rails c 命令4.2、4.3、第六章、8.2.2"></a>tip2、rails c 命令4.2、4.3、第六章、8.2.2</h2><h3 id="【1】常用"><a href="#【1】常用" class="headerlink" title="【1】常用"></a>【1】常用</h3><p>常用方法：length、first、last、sort、reverse、shuffle打乱、to_a/i/f/s、inspect、class、superclass、evn</p>
<p>布尔方法：empty?，比如nil.to_s.empty?。blank?。present?。valid?，全部验证都通过返回true。evn.test/development/production?</p>
<p>显示报错详情：.errors.full_messages</p>
<p>转换方法：split，字符转数组。join，数组转字符。push，同&lt;&lt;，生成新数组。</p>
<p>控制流程：==、!=</p>
<p>块：each、map同collect执行并返回数组、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(0..9).to_a #Range</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = %w[foo bar baz quux] #创建一个元素为字符串的数组</span><br></pre></td></tr></table></figure>
<h3 id="【2】rails-c-里针对错误信息的命令7-3-3"><a href="#【2】rails-c-里针对错误信息的命令7-3-3" class="headerlink" title="【2】rails c 里针对错误信息的命令7.3.3"></a>【2】rails c 里针对错误信息的命令7.3.3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">u.errors.full_messages</span><br><span class="line">u.errors.count</span><br><span class="line">u.errors.empty?</span><br><span class="line">u.errors.any?</span><br></pre></td></tr></table></figure>
<p>其中，count?、empty?、any?都可以用在ruby数组上。</p>
<h3 id="【3】8-2-2-日期、文件大小"><a href="#【3】8-2-2-日期、文件大小" class="headerlink" title="【3】8.2.2 日期、文件大小"></a>【3】8.2.2 日期、文件大小</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; 1.year.from_now</span><br><span class="line">=&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00</span><br><span class="line">&gt;&gt; 10.weeks.ago</span><br><span class="line">=&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</span><br><span class="line"></span><br><span class="line">&gt;&gt; 1.kilobyte</span><br><span class="line">=&gt; 1024</span><br><span class="line">&gt;&gt; 5.megabytes</span><br><span class="line">=&gt; 5242880</span><br></pre></td></tr></table></figure>
<h3 id="【4】9-1-1-资料是否在数据库中"><a href="#【4】9-1-1-资料是否在数据库中" class="headerlink" title="【4】9.1.1 资料是否在数据库中"></a>【4】9.1.1 资料是否在数据库中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rails console</span><br><span class="line">&gt;&gt; User.new.new_record?</span><br><span class="line">=&gt; true</span><br><span class="line">&gt;&gt; User.first.new_record?</span><br><span class="line">=&gt; false</span><br></pre></td></tr></table></figure>
<h2 id="tip3、rails命令-第六章很多"><a href="#tip3、rails命令-第六章很多" class="headerlink" title="tip3、rails命令 第六章很多"></a>tip3、rails命令 第六章很多</h2><p>1）删除文件。-rf意思是强制递归，无需确认就删除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf xxx</span><br></pre></td></tr></table></figure>
<p>2）不安装生产环境的gem</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle install --without production</span><br></pre></td></tr></table></figure>
<p>3）db前进</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake db:migrate</span><br></pre></td></tr></table></figure>
<p>4）db后退</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake db:rollback</span><br></pre></td></tr></table></figure>
<p>或是用以下命令。0是回到最开始的版本，数字对应不同版本。与rake db:rollback类似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake db:migrate VERSION=0</span><br></pre></td></tr></table></figure>
<p>4）不生成测试文件（暂时不建议用，因为2017rails测试改版）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails new sample_app --skip-test-unit #忽略测试文件。但是2017新版好像很好用。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails generate controller StaticPages home help --no-test-framework</span><br></pre></td></tr></table></figure>
<h2 id="tip4、heroku命令1-4-4"><a href="#tip4、heroku命令1-4-4" class="headerlink" title="tip4、heroku命令1.4.4"></a>tip4、heroku命令1.4.4</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">heroku login</span><br><span class="line">heroku create</span><br><span class="line">heroku open</span><br><span class="line">heroku logs</span><br><span class="line">heroku rename xxx</span><br><span class="line">git push heroku master</span><br><span class="line">heroku pg:reset DATABASE</span><br><span class="line">heroku rake db:migrate</span><br><span class="line">heroku rake db:populate //在lib/task的rake文件中定义的</span><br><span class="line">heroku restart 强制重启heroku应用程序</span><br></pre></td></tr></table></figure>
<p>heroku命令，<a href="http://devcenter.heroku.com/heroku-command" target="_blank" rel="noopener">http://devcenter.heroku.com/heroku-command</a></p>
<p>heroku自定义域名，<a href="https://devcenter.heroku.com/" target="_blank" rel="noopener">https://devcenter.heroku.com/</a></p>
<h2 id="tip5、rspec命令"><a href="#tip5、rspec命令" class="headerlink" title="tip5、rspec命令"></a>tip5、rspec命令</h2><p>1）生成测试文件的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g integration_test xxxx</span><br></pre></td></tr></table></figure>
<p>2）运行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rake</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rspec spec</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rspec 文件夹/文件名</span><br></pre></td></tr></table></figure>
<p>3）rails g 生成文件后，要准备相应的测试数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rails g xxx</span><br><span class="line">rake db:migrate</span><br><span class="line">rake test:prepare #这个代码比较旧，改用下面的</span><br><span class="line">rails db:migrate RAILS_ENV=test</span><br></pre></td></tr></table></figure>
<p>测试中常用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rake db:reset</span><br><span class="line">rails db:migrate RAILS_ENV=test</span><br><span class="line">rake db:populate //在lib/task的rake文件中定义的，导入测试数据。</span><br></pre></td></tr></table></figure>
<p>4）指定运行某个测试用例，其中“single page”是描述的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rspec spec/requests/user_pages_spec.rb -e &quot;signup page&quot;</span><br></pre></td></tr></table></figure>
<h1 id="rspec代码重构："><a href="#rspec代码重构：" class="headerlink" title="rspec代码重构："></a>rspec代码重构：</h1><h2 id="1、5-3-4-单个案例，重复使用的动作。"><a href="#1、5-3-4-单个案例，重复使用的动作。" class="headerlink" title="1、5.3.4 单个案例，重复使用的动作。"></a>1、5.3.4 单个案例，重复使用的动作。</h2><p>比如访问首页。重构前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">visit root_path</span><br></pre></td></tr></table></figure>
<p>重构后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">before &#123; visit root_path &#125; #before还有别名方法before(:each)</span><br></pre></td></tr></table></figure>
<h2 id="2、5-3-4-单个案例，测试对象用subject-xx-。"><a href="#2、5-3-4-单个案例，测试对象用subject-xx-。" class="headerlink" title="2、5.3.4 单个案例，测试对象用subject{xx}。"></a>2、5.3.4 单个案例，测试对象用subject{xx}。</h2><p>重构前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expect(page).to have_content(&apos;Sample App&apos;)</span><br></pre></td></tr></table></figure>
<p>重构后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subject &#123; page &#125; #page就是要测试的对象</span><br><span class="line">it &#123; should have_content(&apos;Sample App&apos;) &#125;</span><br></pre></td></tr></table></figure>
<p>其中，should会自动使用capybara提供的page变量。</p>
<h2 id="3、5-3-4-rspec通用函数文件"><a href="#3、5-3-4-rspec通用函数文件" class="headerlink" title="3、5.3.4 rspec通用函数文件"></a>3、5.3.4 rspec通用函数文件</h2><p>1）比如，spec/support/utilities.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def full_title(page_title)</span><br><span class="line">  base_title = &quot;Ruby on Rails Tutorial Sample App&quot;</span><br><span class="line">  if page_title.empty?</span><br><span class="line">    base_title</span><br><span class="line">  else</span><br><span class="line">    &quot;#&#123;base_title&#125; | #&#123;page_title&#125;&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）简化后的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Static pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  describe &quot;Home page&quot; do</span><br><span class="line">    before &#123; visit root_path &#125;</span><br><span class="line">    it &#123; should have_content(&apos;Sample App&apos;) &#125;</span><br><span class="line">    it &#123; should have_title(full_title(&apos;&apos;)) &#125;</span><br><span class="line">    it &#123; should_not have_title(&apos;| Home&apos;) &#125;</span><br><span class="line">  end</span><br><span class="line">  describe &quot;Help page&quot; do</span><br><span class="line">    before &#123; visit help_path &#125;</span><br><span class="line">    it &#123; should have_content(&apos;Help&apos;) &#125;</span><br><span class="line">    it &#123; should have_title(full_title(&apos;Help&apos;)) &#125;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>3）【问题】更好的方式是直接测试原来那个full_tilte方法，参见5.6练习？另外，代码还可以变的更简洁，详见5.6节，我们都会用这种方式。</p>
<h2 id="4、5-6-多个案例，rspec的shared-example功能"><a href="#4、5-6-多个案例，rspec的shared-example功能" class="headerlink" title="4、5.6 多个案例，rspec的shared example功能"></a>4、5.6 多个案例，rspec的shared example功能</h2><p>1）提取相同部分，定义shared_example</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shared_examples_for &quot;all static pages&quot; do</span><br></pre></td></tr></table></figure>
<p>2）let方法用指定的值创建局部变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let(:heading)    &#123; &apos;Sample App&apos; &#125;</span><br><span class="line">let(:page_title) &#123; &apos;&apos; &#125;</span><br></pre></td></tr></table></figure>
<p>3）调用shared_example</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">it_should_behave_like &quot;all static pages&quot;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Static pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  shared_examples_for &quot;all static pages&quot; do</span><br><span class="line">    it &#123; should have_content(heading) &#125;</span><br><span class="line">    it &#123; should have_title(full_title(page_title)) &#125;</span><br><span class="line">  end</span><br><span class="line">  describe &quot;Home page&quot; do</span><br><span class="line">    before &#123; visit root_path &#125;</span><br><span class="line">    let(:heading)    &#123; &apos;Sample App&apos; &#125;</span><br><span class="line">    let(:page_title) &#123; &apos;&apos; &#125;</span><br><span class="line">    it_should_behave_like &quot;all static pages&quot;</span><br><span class="line">    it &#123; should_not have_title(&apos;| Home&apos;) &#125;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="5、用factorygirl-factorybot生成预购件"><a href="#5、用factorygirl-factorybot生成预购件" class="headerlink" title="5、用factorygirl/factorybot生成预购件"></a>5、用factorygirl/factorybot生成预购件</h2><h2 id="6、8-3-3、8-5练习-帮助函数和自定义匹配器"><a href="#6、8-3-3、8-5练习-帮助函数和自定义匹配器" class="headerlink" title="6、8.3.3、8.5练习 帮助函数和自定义匹配器"></a>6、8.3.3、8.5练习 帮助函数和自定义匹配器</h2><p>1）定义帮助函数和自定义匹配器</p>
<p>spec/support/utilities.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">include ApplicationHelper</span><br><span class="line">def valid_signin(user)  #自定义valid_signin(user)函数</span><br><span class="line">  fill_in &quot;Email&quot;,    with: user.email</span><br><span class="line">  fill_in &quot;Password&quot;, with: user.password</span><br><span class="line">  click_button &quot;Sign in&quot;</span><br><span class="line">end</span><br><span class="line">RSpec::Matchers.define :have_error_message do |message| #自定义匹配器have_error_message</span><br><span class="line">  match do |page|</span><br><span class="line">    expect(page).to have_selector(&apos;div.alert.alert-error&apos;, text: message)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）重构代码，比如情景13，8.1.2节案例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it &#123; should have_error_message(&apos;Invalid&apos;) &#125;</span><br><span class="line"></span><br><span class="line">describe &quot;with valid information&quot; do</span><br><span class="line">  let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">  before &#123; valid_signin(user) &#125;</span><br><span class="line">  .</span><br><span class="line">  .</span><br></pre></td></tr></table></figure>
<h2 id="7、9-1-1-帮助函数"><a href="#7、9-1-1-帮助函数" class="headerlink" title="7、9.1.1 帮助函数"></a>7、9.1.1 帮助函数</h2><p>spec/support/utilities.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def sign_in(user, options=&#123;&#125;)</span><br><span class="line">  if options[:no_capybara]</span><br><span class="line">  # Sign in when not using Capybara.</span><br><span class="line">  remember_token = User.new_remember_token</span><br><span class="line">  cookies[:remember_token] = remember_token user.update_attribute(:remember_token,     User.encrypt(remember_token))</span><br><span class="line">  else</span><br><span class="line">    visit signin_path</span><br><span class="line">    fill_in &quot;Email&quot;,    with: user.email</span><br><span class="line">    fill_in &quot;Password&quot;, with: user.password</span><br><span class="line">    click_button &quot;Sign in&quot;</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>解读：</p>
<ul>
<li>if options[:no_capybara]，如果没有用Capybara的话，填写表单的操作是无效的，此时跳过默认的登录操作，直接处理cookie</li>
<li>注意：cookie.permanent方法不能在测试中使用。</li>
</ul>
<h1 id="rspec情景："><a href="#rspec情景：" class="headerlink" title="rspec情景："></a>rspec情景：</h1><p>1、目的：</p>
<ul>
<li>知道大概什么情景要写测试，主要抓住什么点去写（title/selector/content等），相应的代码是怎么写的。</li>
<li>代码重构的写法。</li>
</ul>
<p>2、情景主要分类：——常分为valid、invalid</p>
<ul>
<li>创建栏位，验证栏位存在、权限限制、身份验证。</li>
<li>创建页面，验证页面存在、页面是否成功跳转。</li>
<li>CRUD的验证。</li>
</ul>
<h2 id="1、新建页面时，测试是否正在这个页面。"><a href="#1、新建页面时，测试是否正在这个页面。" class="headerlink" title="1、新建页面时，测试是否正在这个页面。"></a>1、新建页面时，测试是否正在这个页面。</h2><p>5.3.4重构测试home等页面的title和h1文字，与5.4.2测试User页面相同。</p>
<h3 id="5-3-4"><a href="#5-3-4" class="headerlink" title="5.3.4"></a>5.3.4</h3><p>用have_content，检测含有文字’Sample App’。</p>
<p>spec/requests/static_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Static pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  describe &quot;Home page&quot; do</span><br><span class="line">    before &#123; visit root_path &#125;</span><br><span class="line">    it &#123; should have_content(&apos;Sample App&apos;) &#125;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="7-1-3"><a href="#7-1-3" class="headerlink" title="7.1.3"></a>7.1.3</h3><p>spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  describe &quot;profile page&quot; do</span><br><span class="line">    let(:user) &#123; FactoryGirl.create(:user) &#125; #用let方法是factorygirl生成User对象</span><br><span class="line">    before &#123; visit user_path(user) &#125;</span><br><span class="line">    it &#123; should have_content(user.name) &#125;</span><br><span class="line">    it &#123; should have_title(user.name) &#125;</span><br><span class="line">  end</span><br><span class="line">  describe &quot;signup page&quot; do</span><br><span class="line">    before &#123; visit signup_path &#125;</span><br><span class="line">    it &#123; should have_content(&apos;Sign up&apos;) &#125;</span><br><span class="line">    it &#123; should have_title(full_title(&apos;Sign up&apos;)) &#125;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="8-1-1"><a href="#8-1-1" class="headerlink" title="8.1.1"></a>8.1.1</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  describe &quot;signin page&quot; do</span><br><span class="line">    before &#123; visit signin_path &#125;</span><br><span class="line">    it &#123; should have_content(&apos;Sign in&apos;) &#125;</span><br><span class="line">    it &#123; should have_title(&apos;Sign in&apos;) &#125;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）8.1.1 让测试通过：</p>
<p>①、设置路由config/routes，修改登录/退出的具名路由，session路由还是用默认。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resources :sessions, only: [:new, :create, :destroy]</span><br><span class="line">match &apos;/signin&apos;,  to: &apos;sessions#new&apos;, via:&apos;get&apos;</span><br><span class="line">match &apos;/signout&apos;, to: &apos;sessions#destroy&apos;, via:&apos;get&apos;</span><br></pre></td></tr></table></figure>
<p>其中，外卡路由不安全，写法要自己修改。</p>
<p>②、controller加入动作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def new</span><br><span class="line">end</span><br><span class="line">def create</span><br><span class="line">end</span><br><span class="line">def destroy</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fo3b1pak3dj30hr05faab.jpg" width="500"></p>
<p>③、view页面</p>
<p>app/views/sessions/new.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;% provide(:title, &quot;Sign in&quot;) %&gt;</span><br><span class="line">&lt;h1&gt;Sign in&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<h2 id="2、5-3-4-新建页面后，测试是否包含标题。"><a href="#2、5-3-4-新建页面后，测试是否包含标题。" class="headerlink" title="2、5.3.4 新建页面后，测试是否包含标题。"></a>2、5.3.4 新建页面后，测试是否包含标题。</h2><p>用have_title，检测含有标题”Ruby on Rails Tutorial Sample App | Home”。并新增一个测试，不包含“| Home”。</p>
<p>1）测试代码</p>
<p>spec/requests/static_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Static pages&quot; do</span><br><span class="line"></span><br><span class="line">  describe &quot;Home page&quot; do</span><br><span class="line">    it &quot;should have the h1 &apos;Sample App&apos;&quot; do</span><br><span class="line">      visit root_path</span><br><span class="line">      expect(page).to have_content(&apos;Sample App&apos;)</span><br><span class="line">	end</span><br><span class="line">    it &quot;should have the base title&quot; do</span><br><span class="line">      visit root_path</span><br><span class="line">      expect(page).to have_title(&quot;Ruby on Rails Tutorial Sample App&quot;)</span><br><span class="line">	end</span><br><span class="line">    it &quot;should not have a custom page title&quot; do</span><br><span class="line">      visit root_path</span><br><span class="line">      expect(page).not_to have_title(&apos;| Home&apos;)</span><br><span class="line">	end </span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  describe &quot;Help page&quot; do</span><br><span class="line">    it &quot;should have the h1 &apos;Help&apos;&quot; do</span><br><span class="line">      visit help_path</span><br><span class="line">      expect(page).to have_content(&apos;Help&apos;)</span><br><span class="line">	end</span><br><span class="line">    it &quot;should have the title &apos;Help&apos;&quot; do</span><br><span class="line">      visit help_path</span><br><span class="line">      expect(page).to have_title(&quot;Ruby on Rails Tutorial Sample App | Help&quot;)</span><br><span class="line">	end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）application.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;&lt;%= full_title(yield(:title)) %&gt;&lt;/title&gt;</span><br></pre></td></tr></table></figure>
<p>3）app/helpers/application_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def full_title(page_title)</span><br><span class="line">  base_title = &quot;Ruby on Rails Tutorial Sample App&quot;</span><br><span class="line">  if page_title.empty?</span><br><span class="line">    base_title</span><br><span class="line">  else</span><br><span class="line">    &quot;#&#123;base_title&#125; | #&#123;page_title&#125;&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>4）home.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% provide(:title, &apos;Home&apos;) %&gt; #把Home赋值给title</span><br></pre></td></tr></table></figure>
<h2 id="3、5-6-测试首页navbar的链接地址"><a href="#3、5-6-测试首页navbar的链接地址" class="headerlink" title="3、5.6 测试首页navbar的链接地址"></a>3、5.6 测试首页navbar的链接地址</h2><p>1）使用visit和click_link</p>
<p>spec/requests/static_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Static pages&quot; do</span><br><span class="line">  it &quot;should have the right links on the layout&quot; do</span><br><span class="line">    visit root_path</span><br><span class="line">    click_link &quot;About&quot;</span><br><span class="line">    expect(page).to have_title(full_title(&apos;About Us&apos;)) </span><br><span class="line">    click_link &quot;Help&quot;</span><br><span class="line">    expect(page).to # fill in</span><br><span class="line">    click_link &quot;Contact&quot;</span><br><span class="line">    expect(page).to # fill in</span><br><span class="line">    click_link &quot;Home&quot;</span><br><span class="line">    click_link &quot;Sign up now!&quot;</span><br><span class="line">    expect(page).to # fill in</span><br><span class="line">    click_link &quot;sample app&quot;</span><br><span class="line">    expect(page).to # fill in</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上代码可以按rspec部分的第1、第2点重构</p>
</blockquote>
<h2 id="4、5-6-测试rspec辅助方法full-title"><a href="#4、5-6-测试rspec辅助方法full-title" class="headerlink" title="4、5.6 测试rspec辅助方法full_title"></a>4、5.6 测试rspec辅助方法full_title</h2><p>1）spec/helpers/application_helper_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">describe ApplicationHelper do</span><br><span class="line">  describe &quot;full_title&quot; do</span><br><span class="line">    it &quot;should include the page title&quot; do</span><br><span class="line">      expect(full_title(&quot;foo&quot;)).to match(/foo/)</span><br><span class="line">    end</span><br><span class="line">    it &quot;should include the base title&quot; do</span><br><span class="line">      expect(full_title(&quot;foo&quot;)).to match(/^Ruby on Rails Tutorial Sample App/)</span><br><span class="line">	end</span><br><span class="line">    it &quot;should not include a bar for the home page&quot; do</span><br><span class="line">      expect(full_title(&quot;&quot;)).not_to match(/\|/)</span><br><span class="line">	end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>【问题】match是匹配的意思？跟eq的区别是？</p>
<p>2）spec/support/utilities.rb，引用helper</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include ApplicationHelper</span><br></pre></td></tr></table></figure>
<h2 id="5、6-2-1-新增栏位时，测试栏位"><a href="#5、6-2-1-新增栏位时，测试栏位" class="headerlink" title="5、6.2.1 新增栏位时，测试栏位"></a>5、6.2.1 新增栏位时，测试栏位</h2><p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe User do</span><br><span class="line">  before &#123; @user = User.new(name: &quot;Example User&quot;, email: &quot;user@example.com&quot;) &#125; #创建@user</span><br><span class="line">  subject &#123; @user &#125; #默认测试对象是@user</span><br><span class="line">  it &#123; should respond_to(:name) &#125; #respond_to方法，若响应指定的方法或属性则返回true</span><br><span class="line">  it &#123; should respond_to(:email) &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>其中，使用ruby的respond_to?方法，接受一个Symbol参数，如果能响应指定的方法或属性则返回true。</p>
<p>由于rspec对布尔值的约定，这里省略问号。</p>
<h2 id="6、6-2-2-限制栏位：不能为空"><a href="#6、6-2-2-限制栏位：不能为空" class="headerlink" title="6、6.2.2 限制栏位：不能为空"></a>6、6.2.2 限制栏位：不能为空</h2><p>以6.2.2的name栏位为例，剩下的email栏位写法相同。</p>
<p>1）spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">describe User do</span><br><span class="line">  before &#123; @user = User.new(name: &quot;Example User&quot;, </span><br><span class="line">                            email: &quot;user@example.com&quot;,</span><br><span class="line">                            password: &quot;foobar&quot;,</span><br><span class="line">                            password_confirmation: &quot;foobar&quot;) &#125; #创建@user</span><br><span class="line">  subject &#123; @user &#125; #默认测试对象是@user</span><br><span class="line">  it &#123; should respond_to(:name) &#125; #respond_to方法，若响应指定的方法或属性则返回true</span><br><span class="line">  it &#123; should respond_to(:email) &#125;</span><br><span class="line"></span><br><span class="line">  it &#123; should be_valid &#125; #在开始测试前，确保@user是能通过validates验证的</span><br><span class="line">  </span><br><span class="line">  describe &quot;when name is not present&quot; do</span><br><span class="line">    before &#123; @user.name = &quot; &quot; &#125; #设置一个不合法的值</span><br><span class="line">    it &#123; should_not be_valid &#125; #期望不能通过验证</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：只要对象可以响应布尔值方法，比如foo?，就有对应的be_foo方法可以在rspec测试中使用。</p>
</blockquote>
<p>2）让测试通过，要加入validates验证</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ActiveRecord::Base</span><br><span class="line">  validates(:name, presence: true) #括号可以省略</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="7、6-2-3-限制栏位：长度"><a href="#7、6-2-3-限制栏位：长度" class="headerlink" title="7、6.2.3 限制栏位：长度"></a>7、6.2.3 限制栏位：长度</h2><p>1）在6.2.2的基础上，增加describe测试</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;when name is too long&quot; do</span><br><span class="line">  before &#123; @user.name = &quot;a&quot; * 51 &#125;</span><br><span class="line">  it &#123; should_not be_valid &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validates :name,  presence: true, length: &#123; maximum: 50 &#125;</span><br></pre></td></tr></table></figure>
<h2 id="8、6-2-4-限制栏位：email格式"><a href="#8、6-2-4-限制栏位：email格式" class="headerlink" title="8、6.2.4 限制栏位：email格式"></a>8、6.2.4 限制栏位：email格式</h2><p>1）在6.2.2的基础上，增加describe测试。</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;when email format is invalid&quot; do  </span><br><span class="line">  it &quot;should be invalid&quot; do</span><br><span class="line">    addresses = %w[user@foo,com user_at_foo.org example.user@foo. </span><br><span class="line">                   foo@bar_baz.com foo@bar+baz.com]  #用%w[]创建字符串阵列</span><br><span class="line">    addresses.each do |invalid_address|</span><br><span class="line">      @user.email = invalid_address</span><br><span class="line">      expect(@user).not_to be_valid</span><br><span class="line">    end </span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">describe &quot;when email format is valid&quot; do</span><br><span class="line">  it &quot;should be valid&quot; do</span><br><span class="line">    addresses = %w[user@foo.COM A_US-ER@f.b.org frst.lst@foo.jp a+b@baz.cn]</span><br><span class="line">    addresses.each do |valid_address|</span><br><span class="line">      @user.email = valid_address</span><br><span class="line">      expect(@user).to be_valid</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>第一个测试，包含一些不合法的邮箱格式。</p>
<p>第二个测试，包含一些合法的邮箱格式，如大写字母、下划线、子域名等。</p>
<p>2）让测试通过</p>
<p>用validates方法的 :format 参数指定合法格式。</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VALID_EMAIL_REGEX = /\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i  #把正则表达式定义为常量，值不变。</span><br><span class="line">validates :email, presence: true, format: &#123; with: VALID_EMAIL_REGEX &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：这个表达式有漏洞，可以匹配foo@bar..com，在6.5节改善。</p>
</blockquote>
<h2 id="9、6-2-5-限制栏位：email唯一"><a href="#9、6-2-5-限制栏位：email唯一" class="headerlink" title="9、6.2.5 限制栏位：email唯一"></a>9、6.2.5 限制栏位：email唯一</h2><h3 id="【1】model层限制"><a href="#【1】model层限制" class="headerlink" title="【1】model层限制"></a>【1】model层限制</h3><p>1）在6.2.2的基础上，增加describe测试。</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;when email address is already taken&quot; do</span><br><span class="line">  before do</span><br><span class="line">    user_with_same_email = @user.dup #用dup方法复制对象@user</span><br><span class="line">    user_with_same_email.save</span><br><span class="line">  end</span><br><span class="line">  it &#123; should_not be_valid &#125; #因为已经存在@user，所以这个验证不通过</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>【问题】dup和clone的区别？</p>
<p>2）让测试通过</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validates :email, presence: true, format: &#123; with: VALID_EMAIL_REGEX &#125;, uniqueness: true</span><br><span class="line">#唯一性的验证用，默认区分大小写。</span><br></pre></td></tr></table></figure>
<h3 id="【2】数据库层限制、及索引"><a href="#【2】数据库层限制、及索引" class="headerlink" title="【2】数据库层限制、及索引"></a>【2】数据库层限制、及索引</h3><p>目的：防止用户重复提交表单后，生成两笔相同的数据。</p>
<p>1）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g migration add_index_to_users_email</span><br></pre></td></tr></table></figure>
<p>2）db/migrate/[timestamp]_add_index_to_users_email.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class AddIndexToUsersEmail &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    add_index :users, :email, unique: true  #加入索引add_index，并指定email是唯一的。</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>3）为了保证email地址唯一，把它们转成小写。</p>
<p>回调函数，在生命周期的特定时刻调用，比如下面的before_save函数。</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">before_save &#123; self.email = email.downcase &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试代码见6.20节的练习。</p>
</blockquote>
<h2 id="10、6-2-5-限制栏位：email不区分大小写"><a href="#10、6-2-5-限制栏位：email不区分大小写" class="headerlink" title="10、6.2.5 限制栏位：email不区分大小写"></a>10、6.2.5 限制栏位：email不区分大小写</h2><p>1）在6.2.2的基础上，增加describe测试。</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;when email address is already taken&quot; do</span><br><span class="line">  before do</span><br><span class="line">    user_with_same_email = @user.dup</span><br><span class="line">    user_with_same_email.email = @user.email.upcase</span><br><span class="line">    user_with_same_email.save</span><br><span class="line">  end</span><br><span class="line">  it &#123; should_not be_valid &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validates :email, presence: true, format: &#123; with: VALID_EMAIL_REGEX &#125;, uniqueness: &#123; case_sensitive: false &#125; #唯一性验证，不区分大小写，这样写默认uniqueness是true。</span><br></pre></td></tr></table></figure>
<h2 id="11、6-3-1-6-3-2-密码加密及密码确认"><a href="#11、6-3-1-6-3-2-密码加密及密码确认" class="headerlink" title="11、6.3.1/6.3.2 密码加密及密码确认"></a>11、6.3.1/6.3.2 密码加密及密码确认</h2><h3 id="【1】准备工作"><a href="#【1】准备工作" class="headerlink" title="【1】准备工作"></a>【1】准备工作</h3><p>1）新增栏位password_digest</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g migration add_password_digest_to_users password_digest:string</span><br></pre></td></tr></table></figure>
<p>迁移的名字可以随便取，但一般会以<code>_to_users</code>结尾，rails会向users表增加列的迁移。</p>
<p>2）用哈希算法对密码进行不可逆的加密。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;bcrypt-ruby&apos;</span><br></pre></td></tr></table></figure>
<h3 id="【2】测试"><a href="#【2】测试" class="headerlink" title="【2】测试"></a>【2】测试</h3><p>1）在6.2.2的基础上，增加</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it &#123; should respond_to(:password_digest) &#125;</span><br><span class="line">it &#123; should respond_to(:password) &#125;</span><br><span class="line">it &#123; should respond_to(:password_confirmation) &#125;</span><br><span class="line"></span><br><span class="line">describe &quot;when password is not present&quot; do</span><br><span class="line">  before do</span><br><span class="line">    @user = User.new(name: &quot;Example User&quot;, email: &quot;user@example.com&quot;,</span><br><span class="line">                     password: &quot; &quot;, password_confirmation: &quot; &quot;) #密码不能为空</span><br><span class="line">  end</span><br><span class="line">  it &#123; should_not be_valid &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">describe &quot;when password doesn&apos;t match confirmation&quot; do</span><br><span class="line">  before &#123; @user.password_confirmation = &quot;mismatch&quot; &#125; #更新栏位值，这样两个密码就不同了。</span><br><span class="line">  it &#123; should_not be_valid &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">has_secure_password</span><br></pre></td></tr></table></figure>
<p><code>has_secure_password</code>是rails方法。会创建password_confirmation属性，还有针对password_digest属性的数据验证（不能为空）。这个命令的效果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; user = User.find_by(email: &quot;mhartl@example.com&quot;)</span><br><span class="line">&gt;&gt; user.password_digest</span><br><span class="line">=&gt; &quot;$2a$10$kn4cQDJTzV76ZgDxOWk6Je9A0Ttn5sKNaGTEmT0jU7.ncBJ/60gHq&quot; #生成加密密码串</span><br><span class="line"></span><br><span class="line">&gt;&gt; user.authenticate(&quot;invalid&quot;)</span><br><span class="line">=&gt; false</span><br><span class="line">&gt;&gt; user.authenticate(&quot;foobar&quot;)  #用authenticate方法来验证和调用用户</span><br><span class="line">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;, created_at: &quot;2013-03-11 20:45:19&quot;, updated_at: &quot;2013-03-11 20:45:19&quot;, password_digest: &quot;$2a$10$kn4cQDJTzV76ZgDxOWk6Je9A0Ttn5sKNaGTEmT0jU7.n...&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>【问题】做完了还是不清楚password_digest，是不是在保存到数据库前，会自动对password和password_comfirmation进行摘要？最后保存到数据库的只有password_digest？</p>
<h2 id="12、6-3-3-用户身份验证"><a href="#12、6-3-3-用户身份验证" class="headerlink" title="12、6.3.3 用户身份验证"></a>12、6.3.3 用户身份验证</h2><p>原理：确保可以用email和password取到用户数据，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = User.find_by(email: email) #先通过email找到用户记录</span><br><span class="line">current_user = user.authenticate(password) #使用authenticate方法，用密码进行身份验证。</span><br></pre></td></tr></table></figure>
<p>1）在6.2.2的基础上，增加。</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it &#123; should respond_to(:authenticate) &#125;  #@user要能响应authenticate方法</span><br><span class="line"></span><br><span class="line">describe &quot;with a password that&apos;s too short&quot; do</span><br><span class="line">  before &#123; @user.password = @user.password_confirmation = &quot;a&quot; * 5 &#125; #密码长度测试</span><br><span class="line">  it &#123; should be_invalid &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">describe &quot;return value of authenticate method&quot; do</span><br><span class="line">  before &#123; @user.save &#125; #保存用户数据</span><br><span class="line">  let(:found_user) &#123; User.find_by(email: @user.email) &#125; #用find_by取出用户，复制给局部变量</span><br><span class="line">  describe &quot;with valid password&quot; do</span><br><span class="line">    it &#123; should eq found_user.authenticate(@user.password) &#125; #使用authenticate方法，用密码进行身份验证。取出的用户要和@user相同</span><br><span class="line">  end</span><br><span class="line">  describe &quot;with invalid password&quot; do</span><br><span class="line">    let(:user_for_invalid_password) &#123; found_user.authenticate(&quot;invalid&quot;) &#125; #用错误</span><br><span class="line">    it &#123; should_not eq user_for_invalid_password &#125;</span><br><span class="line">    specify &#123; expect(user_for_invalid_password).to be_false &#125; #specify是it的别名</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>let方法的参数是Symbol，后面跟一个快。let方法会记住find_by的值，所以不管写多少个describe测试，find_by方法只运行一次。</p>
<p>2）让测试通过</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validates :password, length: &#123; minimum: 6 &#125;</span><br></pre></td></tr></table></figure>
<h2 id="13、（模拟用户填表）点击按钮，成功"><a href="#13、（模拟用户填表）点击按钮，成功" class="headerlink" title="13、（模拟用户填表）点击按钮，成功"></a>13、（模拟用户填表）点击按钮，成功</h2><h3 id="【1】7-2-1-重点是change方法"><a href="#【1】7-2-1-重点是change方法" class="headerlink" title="【1】7.2.1 重点是change方法"></a>【1】7.2.1 重点是change方法</h3><p>1）spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  </span><br><span class="line">  describe &quot;signup&quot; do</span><br><span class="line">    before &#123; visit signup_path &#125; #用visit访问网站</span><br><span class="line">    let(:submit) &#123; &quot;Create my account&quot; &#125; #let方法定义submit按钮</span><br><span class="line">    </span><br><span class="line">    describe &quot;with invalid information&quot; do</span><br><span class="line">      it &quot;should not create a user&quot; do</span><br><span class="line">        expect &#123; click_button submit &#125;.not_to change(User, :count) #change方法，下边细说</span><br><span class="line">      end </span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    describe &quot;with valid information&quot; do</span><br><span class="line">      before do</span><br><span class="line">        fill_in &quot;Name&quot;, with: &quot;Example User&quot; #用fill_in填表</span><br><span class="line">        fill_in &quot;Email&quot;, with: &quot;user@example.com&quot;</span><br><span class="line">        fill_in &quot;Password&quot;, with: &quot;foobar&quot;</span><br><span class="line">        fill_in &quot;Confirmation&quot;, with: &quot;foobar&quot;</span><br><span class="line">      end</span><br><span class="line">      it &quot;should create a user&quot; do</span><br><span class="line">        expect &#123; click_button submit &#125;.to change(User, :count).by(1) #点击按钮，及to方法。</span><br><span class="line">      end </span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>①、以上代码，change方法，接受两个参数，第一个是对象名，第二个是Symbol。会在expect执行“点击按钮”的前后，分别在第一个参数调用第二个参数。重构前的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">initial = User.count</span><br><span class="line">click_button &quot;Create my account&quot;</span><br><span class="line">final = User.count</span><br><span class="line">expect(initial).to eq final</span><br></pre></td></tr></table></figure>
<p>②、以上代码，to方法。点击按钮后，可以创建一个新用户。</p>
<h3 id="【2】8-1-2-登录成功，用have-link"><a href="#【2】8-1-2-登录成功，用have-link" class="headerlink" title="【2】8.1.2 登录成功，用have_link"></a>【2】8.1.2 登录成功，用have_link</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;signin&quot; do</span><br><span class="line">    before &#123; visit signin_path &#125;</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;with valid information&quot; do</span><br><span class="line">      let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      before do</span><br><span class="line">        fill_in &quot;Email&quot;,    with: user.email.upcase #邮箱转换成大写</span><br><span class="line">        fill_in &quot;Password&quot;, with: user.password</span><br><span class="line">        click_button &quot;Sign in&quot;</span><br><span class="line">      end</span><br><span class="line">      it &#123; should have_title(user.name) &#125;</span><br><span class="line">      it &#123; should have_link(&apos;Profile&apos;,     href: user_path(user)) &#125; #登录后有用户资料链接</span><br><span class="line">      it &#123; should have_link(&apos;Sign out&apos;,    href: signout_path) &#125; #登录后有退出链接</span><br><span class="line">      it &#123; should_not have_link(&apos;Sign in&apos;, href: signin_path) &#125; #登录后没有登录链接</span><br><span class="line">    end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>注意：把邮箱转换成大写，确保在数据库中查询用户时不用担心大小写问题。</p>
<p>2）8.1.2 通过测试：</p>
<p>详见情景18，8.2.4节。</p>
<h3 id="【3】情景19，8-2-5-注册后直接登录"><a href="#【3】情景19，8-2-5-注册后直接登录" class="headerlink" title="【3】情景19，8.2.5 注册后直接登录"></a>【3】情景19，8.2.5 注册后直接登录</h3><p>因为按顺序定义current_user和sign in方法，所以没有放过来。</p>
<h3 id="【4】8-2-7-退出"><a href="#【4】8-2-7-退出" class="headerlink" title="【4】8.2.7 退出"></a>【4】8.2.7 退出</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;signin&quot; do</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;with valid information&quot; do</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      describe &quot;followed by signout&quot; do</span><br><span class="line">        before &#123; click_link &quot;Sign out&quot; &#125;</span><br><span class="line">        it &#123; should have_link(&apos;Sign in&apos;) &#125;</span><br><span class="line">      end</span><br><span class="line">    end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过</p>
<p>app/controllers/sessions_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def destroy</span><br><span class="line">  sign_out</span><br><span class="line">  redirect_to root_path</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>app/helpers/sessions_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def sign_out</span><br><span class="line">  self.current_user = nil </span><br><span class="line">  cookies.delete(:remember_token)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="【5】9-1-1放在步骤【2】8-2-1中"><a href="#【5】9-1-1放在步骤【2】8-2-1中" class="headerlink" title="【5】9.1.1放在步骤【2】8.2.1中"></a>【5】9.1.1放在步骤【2】8.2.1中</h3><h2 id="14、（用户不填表）点击按钮，失败"><a href="#14、（用户不填表）点击按钮，失败" class="headerlink" title="14、（用户不填表）点击按钮，失败"></a>14、（用户不填表）点击按钮，失败</h2><h3 id="8-1-2-登录失败，用have-selector"><a href="#8-1-2-登录失败，用have-selector" class="headerlink" title="8.1.2 登录失败，用have_selector"></a>8.1.2 登录失败，用have_selector</h3><p>spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;signin&quot; do</span><br><span class="line">    before &#123; visit signin_path &#125;</span><br><span class="line">    describe &quot;with invalid information&quot; do</span><br><span class="line">      before &#123; click_button &quot;Sign in&quot; &#125;</span><br><span class="line">      it &#123; should have_title(&apos;Sign in&apos;) &#125;</span><br><span class="line">      it &#123; should have_selector(&apos;div.alert.alert-error&apos;, text: &apos;Invalid&apos;) &#125;</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>以上代码，测试的是页面中，是否含有如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;alert alert-error&quot;&gt;Invalid...&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<h3 id="9-1-1-edit失败，用have-content"><a href="#9-1-1-edit失败，用have-content" class="headerlink" title="9.1.1 edit失败，用have_content"></a>9.1.1 edit失败，用have_content</h3><p>1）spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  describe &quot;edit&quot; do</span><br><span class="line">    let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">    before &#123; visit edit_user_path(user) &#125;</span><br><span class="line">    describe &quot;page&quot; do</span><br><span class="line">      it &#123; should have_content(&quot;Update your profile&quot;) &#125;</span><br><span class="line">      it &#123; should have_title(&quot;Edit user&quot;) &#125;</span><br><span class="line">      it &#123; should have_link(&apos;change&apos;, href: &apos;http://gravatar.com/emails&apos;) &#125;</span><br><span class="line">    end</span><br><span class="line">    describe &quot;with invalid information&quot; do</span><br><span class="line">      before &#123; click_button &quot;Save changes&quot; &#125;</span><br><span class="line">      it &#123; should have_content(&apos;error&apos;) &#125;</span><br><span class="line">    end</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）9.1.1 让测试通过：</p>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def edit</span><br><span class="line">  @user = User.find(params[:id])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>views</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;% provide(:title, &quot;Edit user&quot;) %&gt;</span><br><span class="line">&lt;h1&gt;Update your profile&lt;/h1&gt;</span><br><span class="line">&lt;div class=&quot;row&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;span6 offset3&quot;&gt;</span><br><span class="line">    &lt;%= form_for(@user) do |f| %&gt;</span><br><span class="line">      &lt;%= render &apos;shared/error_messages&apos; %&gt; #再次用到7.3.3节创建的局部视图</span><br><span class="line">      &lt;%= f.label :name %&gt;</span><br><span class="line">      &lt;%= f.text_field :name %&gt;</span><br><span class="line">      &lt;%= f.label :email %&gt;</span><br><span class="line">      &lt;%= f.text_field :email %&gt;</span><br><span class="line">      &lt;%= f.label :password %&gt;</span><br><span class="line">      &lt;%= f.password_field :password %&gt;</span><br><span class="line">      &lt;%= f.label :password_confirmation, &quot;Confirm Password&quot; %&gt;</span><br><span class="line">      &lt;%= f.password_field :password_confirmation %&gt;</span><br><span class="line">      &lt;%= f.submit &quot;Save changes&quot;, class: &quot;btn btn-large btn-primary&quot; %&gt;</span><br><span class="line">    &lt;% end %&gt;</span><br><span class="line">    &lt;%= gravatar_for @user %&gt;</span><br><span class="line">    &lt;a href=&quot;http://gravatar.com/emails&quot;&gt;change&lt;/a&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<h2 id="15、练习7-6-针对错误信息的测试"><a href="#15、练习7-6-针对错误信息的测试" class="headerlink" title="15、练习7.6 针对错误信息的测试"></a>15、练习7.6 针对错误信息的测试</h2><h2 id="16、练习7-5-是否转向正确的页面"><a href="#16、练习7-5-是否转向正确的页面" class="headerlink" title="16、练习7.5 是否转向正确的页面"></a>16、练习7.5 是否转向正确的页面</h2><h2 id="17、-flash没有按预期消失"><a href="#17、-flash没有按预期消失" class="headerlink" title="17、 flash没有按预期消失"></a>17、 flash没有按预期消失</h2><p>触发flash后，希望点击首页后，flash可以消失。</p>
<h3 id="8-1-5-登录失败，用have-selector"><a href="#8-1-5-登录失败，用have-selector" class="headerlink" title="8.1.5 登录失败，用have_selector"></a>8.1.5 登录失败，用have_selector</h3><p>spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;signin&quot; do</span><br><span class="line">    before &#123; visit signin_path &#125;</span><br><span class="line">    describe &quot;with invalid information&quot; do</span><br><span class="line">      before &#123; click_button &quot;Sign in&quot; &#125;</span><br><span class="line">      it &#123; should have_title(&apos;Sign in&apos;) &#125;</span><br><span class="line">      it &#123; should have_selector(&apos;div.alert.alert-error&apos;, text: &apos;Invalid&apos;) &#125;</span><br><span class="line">      describe &quot;after visiting another page&quot; do</span><br><span class="line">        before &#123; click_link &quot;Home&quot; &#125;</span><br><span class="line">        it &#123; should_not have_selector(&apos;div.alert.alert-error&apos;) &#125;</span><br><span class="line">      end </span><br><span class="line">    end</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="测试通过的办法："><a href="#测试通过的办法：" class="headerlink" title="测试通过的办法："></a>测试通过的办法：</h3><p>用 flash.now</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flash.now[:error] = &apos;Invalid email/password combination&apos;</span><br></pre></td></tr></table></figure>
<h2 id="18、记住我（记忆权标remember-token测试）"><a href="#18、记住我（记忆权标remember-token测试）" class="headerlink" title="18、记住我（记忆权标remember_token测试）"></a>18、记住我（记忆权标remember_token测试）</h2><h3 id="【1】8-2-1-测试remember-token栏位"><a href="#【1】8-2-1-测试remember-token栏位" class="headerlink" title="【1】8.2.1 测试remember_token栏位"></a>【1】8.2.1 测试remember_token栏位</h3><p>1）spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">describe User do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  it &#123; should respond_to(:authenticate) &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g migration add_remember_token_to_users</span><br></pre></td></tr></table></figure>
<p>db/migrate/[timestamp]_add_remember_token_to_users.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class AddRememberTokenToUsers &lt; ActiveRecord::Migration</span><br><span class="line">  def change</span><br><span class="line">    add_column :users, :remember_token, :string</span><br><span class="line">    add_index :users, :remember_token #因为要用记忆权标取回用户，所以加入索引</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="【2】8-2-1-测试remember-token是否生成"><a href="#【2】8-2-1-测试remember-token是否生成" class="headerlink" title="【2】8.2.1 测试remember_token是否生成"></a>【2】8.2.1 测试remember_token是否生成</h3><p>1）spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">describe User do</span><br><span class="line">  before do</span><br><span class="line">    @user = User.new(name: &quot;Example User&quot;, email: &quot;user@example.com&quot;,</span><br><span class="line">                     password: &quot;foobar&quot;, password_confirmation: &quot;foobar&quot;)</span><br><span class="line">  end</span><br><span class="line">  subject &#123; @user &#125;</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;remember token&quot; do </span><br><span class="line">    before &#123; @user.save &#125;</span><br><span class="line">    its(:remember_token) &#123; should_not be_blank &#125; </span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>其中，its测试的是对象的属性，而it测试的则是对象。等同于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">it &#123; expect(@user.remember_token).not_to be_blank &#125;</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  before_create :create_remember_token</span><br><span class="line"> </span><br><span class="line">  def User.new_remember_token</span><br><span class="line">    SecureRandom.urlsafe_base64 #生成16位字符串</span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  def User.encrypt(token)</span><br><span class="line">    Digest::SHA1.hexdigest(token.to_s) #加密字符串。to_s防止输入的字符串是nil。</span><br><span class="line">  end </span><br><span class="line"></span><br><span class="line">private</span><br><span class="line"></span><br><span class="line">  def create_remember_token</span><br><span class="line">    self.remember_token = User.encrypt(User.new_remember_token) #用self赋值给用户</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>用SecureRandom模块的urlsafe_base64方法，生成16位的字符串。在浏览器中存储这个base64字符串，在数据库从存储加密后的版本。</li>
<li>为了让用户从一开始就有记忆权标，使用回调函数before_create。如果没有这样做，用户注册后自动登录时，会再创建 一个记忆权标。</li>
<li>SHA1安全性不如Bcrypt，但这里够用。</li>
<li>self.remember_token，会把这个属性连同用户的其他属性一起保存到数据库。如果用remember_token，那只是创建了一个局部变量。</li>
</ul>
<h3 id="【3】8-2-2-定义sign-in"><a href="#【3】8-2-2-定义sign-in" class="headerlink" title="【3】8.2.2 定义sign in"></a>【3】8.2.2 定义sign in</h3><p>1）app/helpers/sessions_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module SessionsHelper</span><br><span class="line">  def sign_in(user)</span><br><span class="line">    remember_token = User.new_remember_token</span><br><span class="line">    cookies.permanent[:remember_token] = remember_token</span><br><span class="line">    user.update_attribute(:remember_token, User.encrypt(remember_token))</span><br><span class="line">    self.current_user = user</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><p>创建新权标。</p>
</li>
<li><p>把未加密的权标，保存到浏览器的cookie。</p>
<p>①、permanent方法，会自动把cookie的失效日期设置为20年后。</p>
<p>②、cookie是rails提供的方法</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cookies[:remember_token] = &#123; value:   remember_token,</span><br><span class="line">                             expires: 20.years.from_now.utc &#125; #expires失效日期20年后</span><br></pre></td></tr></table></figure>
<p>​    ③、浏览器中保存的cookie并不是Hash，赋值给cookie只是把值以文本形式保存在浏览器中。</p>
<ul>
<li>把加密后的权标，保存到数据库。使用update_attribute可以跳过数据验证更新单个属性，因为我们没有用户密码只有权标，所以必须用update_attribute。</li>
<li>把输入的用户设置成当前登录的用户current_user。</li>
</ul>
<h3 id="【4】8-2-3-定义current-user"><a href="#【4】8-2-3-定义current-user" class="headerlink" title="【4】8.2.3 定义current_user"></a>【4】8.2.3 定义current_user</h3><p>app/helpers/sessions_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">module SessionsHelper</span><br><span class="line">  def sign_in(user)</span><br><span class="line">  .</span><br><span class="line">  . </span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  def current_user=(user)</span><br><span class="line">    @current_user = user #设定@current_user的值，以备后用</span><br><span class="line">  end </span><br><span class="line">  </span><br><span class="line">  def current_user</span><br><span class="line">    remember_token = User.encrypt(cookies[:remember_token]) #拿到cookie里的权标，并加密</span><br><span class="line">    @current_user ||= User.find_by(remember_token: remember_token) #用来读取@current_user的值</span><br><span class="line">  end  </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>因为数据库的权标remember_token是用浏览器权标加密的，所以拿到cookie的remember_token后，要用encrypt加密。</li>
<li>||=，短路计算。只要第一个满足就会终止。</li>
</ul>
<h3 id="【5】8-2-4-改变链接"><a href="#【5】8-2-4-改变链接" class="headerlink" title="【5】8.2.4 改变链接"></a>【5】8.2.4 改变链接</h3><p>1）定义signed_in?方法</p>
<p>app/helpers/sessions_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def signed_in?</span><br><span class="line">  !current_user.nil?</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）添加链接</p>
<p>app/views/layouts/_header.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul class=&quot;dropdown-menu&quot;&gt;</span><br><span class="line">  &lt;li&gt;&lt;%= link_to &quot;Profile&quot;, current_user %&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;&lt;%= link_to &quot;Settings&quot;, &apos;#&apos; %&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class=&quot;divider&quot;&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;%= link_to &quot;Sign out&quot;, signout_path, method: &quot;delete&quot; %&gt;</span><br><span class="line">  &lt;/li&gt; </span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<h3 id="至此，情景13的8-1-2，测试通过。"><a href="#至此，情景13的8-1-2，测试通过。" class="headerlink" title="至此，情景13的8.1.2，测试通过。"></a>至此，情景13的8.1.2，测试通过。</h3><h2 id="19、8-2-5-注册后直接登录——可归类到情景13"><a href="#19、8-2-5-注册后直接登录——可归类到情景13" class="headerlink" title="19、8.2.5 注册后直接登录——可归类到情景13"></a>19、8.2.5 注册后直接登录——可归类到情景13</h2><p>1）spec/requests/user_pages_spec.rb，这个是注册页面的测试，跟情景13，8.1.2的测试类似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;with valid information&quot; do</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      describe &quot;after saving the user&quot; do</span><br><span class="line">        before &#123; click_button submit &#125;</span><br><span class="line">        let(:user) &#123; User.find_by(email: &apos;user@example.com&apos;) &#125;</span><br><span class="line">        it &#123; should have_link(&apos;Sign out&apos;) &#125;</span><br><span class="line">        it &#123; should have_title(user.name) &#125;</span><br><span class="line">        it &#123; should have_selector(&apos;div.alert.alert-success&apos;, text: &apos;Welcome&apos;) &#125;</span><br><span class="line">	  end </span><br><span class="line">	end</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过</p>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def create</span><br><span class="line">  @user = User.new(user_params)</span><br><span class="line">  if @user.save</span><br><span class="line">    sign_in @user #情景18，8.2.2已经定义了sign in方法</span><br><span class="line">    flash[:success] = &quot;Welcome to the Sample App!&quot;</span><br><span class="line">    redirect_to @user</span><br><span class="line">  else</span><br><span class="line">    render &apos;new&apos;</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="20、CRUD测试"><a href="#20、CRUD测试" class="headerlink" title="20、CRUD测试"></a>20、CRUD测试</h2><h3 id="9-1-1-edit-测试，分别放在情景13、情景14中。并有代码重构7。"><a href="#9-1-1-edit-测试，分别放在情景13、情景14中。并有代码重构7。" class="headerlink" title="9.1.1 edit 测试，分别放在情景13、情景14中。并有代码重构7。"></a>9.1.1 edit 测试，分别放在情景13、情景14中。并有代码重构7。</h3><h3 id="9-1-3-update测试，和create类似。主要用到reload方法。"><a href="#9-1-3-update测试，和create类似。主要用到reload方法。" class="headerlink" title="9.1.3 update测试，和create类似。主要用到reload方法。"></a>9.1.3 update测试，和create类似。主要用到reload方法。</h3><p>1）spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;edit&quot; do</span><br><span class="line">    let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">    before &#123; visit edit_user_path(user) &#125;</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;with valid information&quot; do</span><br><span class="line">      let(:new_name)  &#123; &quot;New Name&quot; &#125;</span><br><span class="line">      let(:new_email) &#123; &quot;new@example.com&quot; &#125;</span><br><span class="line">      before do</span><br><span class="line">        fill_in &quot;Name&quot;,</span><br><span class="line">        fill_in &quot;Email&quot;,</span><br><span class="line">        fill_in &quot;Password&quot;,</span><br><span class="line">        fill_in &quot;Confirm Password&quot;, with: user.password</span><br><span class="line">        click_button &quot;Save changes&quot;</span><br><span class="line">      end</span><br><span class="line">      it &#123; should have_title(new_name) &#125;</span><br><span class="line">      it &#123; should have_selector(&apos;div.alert.alert-success&apos;) &#125;</span><br><span class="line">      it &#123; should have_link(&apos;Sign out&apos;, href: signout_path) &#125;</span><br><span class="line">      specify &#123; expect(user.reload.name).to  eq new_name &#125;</span><br><span class="line">      specify &#123; expect(user.reload.email).to eq new_email &#125;</span><br><span class="line">    end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）9.1.3 让测试通过：</p>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def update</span><br><span class="line">  @user = User.find(params[:id])</span><br><span class="line">  if @user.update_attributes(user_params)</span><br><span class="line">    flash[:success] = &quot;Profile updated&quot;</span><br><span class="line">    sign_in @user</span><br><span class="line">    redirect_to @user</span><br><span class="line">  else</span><br><span class="line">    render &apos;edit&apos;</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>注意：因为model里的回调函数before_create :create_remember_token，保存前会重设权标，之前的session就失效了，因此任何会话劫持都会自动失效。</p>
<h2 id="21、权限限制"><a href="#21、权限限制" class="headerlink" title="21、权限限制"></a>21、权限限制</h2><h3 id="已有第八章，情景6、情景7、情景8、情景9、情景10。"><a href="#已有第八章，情景6、情景7、情景8、情景9、情景10。" class="headerlink" title="已有第八章，情景6、情景7、情景8、情景9、情景10。"></a>已有第八章，情景6、情景7、情景8、情景9、情景10。</h3><h3 id="第九章，针对edit和update的权限限制。"><a href="#第九章，针对edit和update的权限限制。" class="headerlink" title="第九章，针对edit和update的权限限制。"></a>第九章，针对edit和update的权限限制。</h3><h3 id="9-2-1-edit和update前，必须先登录"><a href="#9-2-1-edit和update前，必须先登录" class="headerlink" title="9.2.1 edit和update前，必须先登录"></a>9.2.1 edit和update前，必须先登录</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;authorization&quot; do</span><br><span class="line">    describe &quot;for non-signed-in users&quot; do</span><br><span class="line">      let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      describe &quot;in the Users controller&quot; do</span><br><span class="line">        describe &quot;visiting the edit page&quot; do</span><br><span class="line">          before &#123; visit edit_user_path(user) &#125;</span><br><span class="line">          it &#123; should have_title(&apos;Sign in&apos;) &#125;</span><br><span class="line">	    end</span><br><span class="line">        describe &quot;submitting to the update action&quot; do</span><br><span class="line">          before &#123; patch user_path(user) &#125; #重点patch</span><br><span class="line">          specify &#123; expect(response).to redirect_to(signin_path) &#125; #重点response</span><br><span class="line">		end </span><br><span class="line">	  end</span><br><span class="line">	end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>发起HTTP请求，直接使用相应的动词，比如这里的before { patch user_path(user) }。会向users/1发送PATCH请求，由controller#update处理。因为update没有页面，所以只能用PATCH。</li>
<li>注意：HTTP请求比如patch的用法，只能在rspec的request测试里使用，不能在feature测试里用。</li>
<li>这里的测试对象不是page页面，而是用response来测试服务器相应。</li>
<li>specify同it。</li>
</ul>
<p>2）让测试通过：</p>
<p>①、app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">before_action :signed_in_user, only: [:edit, :update]</span><br><span class="line"></span><br><span class="line">private</span><br><span class="line"></span><br><span class="line">def signed_in_user</span><br><span class="line">  redirect_to signin_url, notice: &quot;Please sign in.&quot; unless signed_in?</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>②、修复情景20，9.1.3的edit测试代码，因为要提前登陆而出错的问题。</p>
<p>spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;edit&quot; do</span><br><span class="line">  let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">  before do</span><br><span class="line">  sign_in user</span><br><span class="line">    visit edit_user_path(user)</span><br><span class="line">  end</span><br><span class="line">  . . .</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="9-2-2-edit和update前，必须是current-user"><a href="#9-2-2-edit和update前，必须是current-user" class="headerlink" title="9.2.2 edit和update前，必须是current_user"></a>9.2.2 edit和update前，必须是current_user</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">require &apos;spec_helper&apos;</span><br><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;authorization&quot; do</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;as wrong user&quot; do</span><br><span class="line">      let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      let(:wrong_user) &#123; FactoryGirl.create(:user, email: &quot;wrong@example.com&quot;) &#125;</span><br><span class="line">      before &#123; sign_in user, no_capybara: true &#125;</span><br><span class="line">      describe &quot;visiting Users#edit page&quot; do</span><br><span class="line">        before &#123; visit edit_user_path(wrong_user) &#125;</span><br><span class="line">        it &#123; should_not have_title(full_title(&apos;Edit user&apos;)) &#125;</span><br><span class="line">      end</span><br><span class="line">      describe &quot;submitting a PATCH request to the Users#update action&quot; do</span><br><span class="line">        before &#123; patch user_path(wrong_user) &#125;</span><br><span class="line">        specify &#123; expect(response).to redirect_to(root_path) &#125;</span><br><span class="line">      end </span><br><span class="line">    end</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">before_action :correct_user, only: [:edit, :update]</span><br><span class="line"></span><br><span class="line">private</span><br><span class="line"></span><br><span class="line">def correct_user</span><br><span class="line">  redirect_to(root_path) unless current_user?(@user)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>定义current_user?，app/helpers/sessions_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def current_user</span><br><span class="line">  remember_token = User.encrypt(cookies[:remember_token])</span><br><span class="line">  @current_user ||= User.find_by(remember_token: remember_token)</span><br><span class="line">end</span><br><span class="line">def current_user?(user)</span><br><span class="line">  user == current_user</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="9-2-3-edit和update，更友好的转向"><a href="#9-2-3-edit和update，更友好的转向" class="headerlink" title="9.2.3 edit和update，更友好的转向"></a>9.2.3 edit和update，更友好的转向</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;authorization&quot; do</span><br><span class="line">    describe &quot;for non-signed-in users&quot; do</span><br><span class="line">      let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      describe &quot;when attempting to visit a protected page&quot; do</span><br><span class="line">        before do</span><br><span class="line">          visit edit_user_path(user)</span><br><span class="line">          fill_in &quot;Email&quot;,    with: user.email</span><br><span class="line">          fill_in &quot;Password&quot;, with: user.password</span><br><span class="line">          click_button &quot;Sign in&quot;</span><br><span class="line">        end</span><br><span class="line">        describe &quot;after signing in&quot; do</span><br><span class="line">          it &quot;should render the desired protected page&quot; do</span><br><span class="line">            expect(page).to have_title(&apos;Edit user&apos;)</span><br><span class="line">	      end </span><br><span class="line">	    end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/helpers/sessions_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def store_location</span><br><span class="line">  session[:return_to] = request.fullpath #存储页面地址。其中，session在关闭浏览器时失效。</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def redirect_back_or(default)</span><br><span class="line">  redirect_to(session[:return_to] || default) #登录后转向这个已存储的地址上。</span><br><span class="line">  session.delete(:return_to) #如果不删除，每次关闭浏览器前都会转到存储的地址上。</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def signed_in_user</span><br><span class="line">  unless signed_in?</span><br><span class="line">    store_location</span><br><span class="line">    redirect_to signin_url, notice: &quot;Please sign in.&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>app/controllers/sessions_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def create</span><br><span class="line">    user = User.find_by(email: params[:session][:email].downcase)</span><br><span class="line">    if user &amp;&amp; user.authenticate(params[:session][:password])</span><br><span class="line">      sign_in user</span><br><span class="line">      redirect_back_or user</span><br><span class="line">    else</span><br><span class="line">      flash.now[:error] = &apos;Invalid email/password combination&apos;</span><br><span class="line">      render &apos;new&apos;</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="9-3-1-index前，必须先登录"><a href="#9-3-1-index前，必须先登录" class="headerlink" title="9.3.1 index前，必须先登录"></a>9.3.1 index前，必须先登录</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;authorization&quot; do</span><br><span class="line">    describe &quot;for non-signed-in users&quot; do</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      describe &quot;in the Users controller&quot; do</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        describe &quot;visiting the user index&quot; do</span><br><span class="line">          before &#123; visit users_path &#125;</span><br><span class="line">          it &#123; should have_title(&apos;Sign in&apos;) &#125;</span><br><span class="line">        end</span><br><span class="line">	  end </span><br><span class="line">	  . </span><br><span class="line">	  . </span><br><span class="line">	  .</span><br><span class="line">	end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">before_action :signed_in_user, only: [:index, :edit, :update]</span><br></pre></td></tr></table></figure>
<h3 id="9-3-1-index页面要有li标签和user-name"><a href="#9-3-1-index页面要有li标签和user-name" class="headerlink" title="9.3.1 index页面要有li标签和user.name"></a>9.3.1 index页面要有li标签和user.name</h3><p>1）spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  describe &quot;index&quot; do</span><br><span class="line">    before do</span><br><span class="line">      sign_in FactoryGirl.create(:user)</span><br><span class="line">      FactoryGirl.create(:user, name: &quot;Bob&quot;, email: &quot;bob@example.com&quot;)</span><br><span class="line">      FactoryGirl.create(:user, name: &quot;Ben&quot;, email: &quot;ben@example.com&quot;)</span><br><span class="line">      visit users_path</span><br><span class="line">    end</span><br><span class="line">    it &#123; should have_title(&apos;All users&apos;) &#125;</span><br><span class="line">    it &#123; should have_content(&apos;All users&apos;) &#125;</span><br><span class="line">    it &quot;should list each user&quot; do</span><br><span class="line">      User.all.each do |user|</span><br><span class="line">        expect(page).to have_selector(&apos;li&apos;, text: user.name) #关键代码</span><br><span class="line">      end</span><br><span class="line">	end </span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def index</span><br><span class="line">  @users = User.all</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>app/views/users/index.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;% provide(:title, &apos;All users&apos;) %&gt;</span><br><span class="line">&lt;h1&gt;All users&lt;/h1&gt;</span><br><span class="line">&lt;ul class=&quot;users&quot;&gt;</span><br><span class="line">  &lt;% @users.each do |user| %&gt;</span><br><span class="line">    &lt;li&gt;</span><br><span class="line">      &lt;%= gravatar_for user, size: 52 %&gt;</span><br><span class="line">      &lt;%= link_to user.name, user %&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<h2 id="22、分页功能"><a href="#22、分页功能" class="headerlink" title="22、分页功能"></a>22、分页功能</h2><h3 id="9-3-2-rspec中创建示例数据（factorybot的sequence）"><a href="#9-3-2-rspec中创建示例数据（factorybot的sequence）" class="headerlink" title="9.3.2 rspec中创建示例数据（factorybot的sequence）"></a>9.3.2 rspec中创建示例数据（factorybot的sequence）</h3><p>spec/factories.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FactoryGirl.define do</span><br><span class="line">  factory :user do</span><br><span class="line">    sequence(:name)  &#123; |n| &quot;Person #&#123;n&#125;&quot; &#125;</span><br><span class="line">    sequence(:email) &#123; |n| &quot;person_#&#123;n&#125;@example.com&quot;&#125;</span><br><span class="line">    password &quot;foobar&quot;</span><br><span class="line">    password_confirmation &quot;foobar&quot;</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="9-3-2-测试分页"><a href="#9-3-2-测试分页" class="headerlink" title="9.3.2 测试分页"></a>9.3.2 测试分页</h3><p>1）spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  describe &quot;index&quot; do	</span><br><span class="line">    let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">    before(:each) do #和before(:all)是相反的操作</span><br><span class="line">      sign_in user</span><br><span class="line">      visit users_path</span><br><span class="line">    end</span><br><span class="line">    it &#123; should have_title(&apos;All users&apos;) &#125;</span><br><span class="line">    it &#123; should have_content(&apos;All users&apos;) &#125;</span><br><span class="line">    describe &quot;pagination&quot; do</span><br><span class="line">      before(:all) &#123; 30.times &#123; FactoryGirl.create(:user) &#125; &#125; #创建30个示例数据</span><br><span class="line">      after(:all)  &#123; User.delete_all &#125; #测试后删除数据，让其他测试速度不受此影响。</span><br><span class="line">      it &#123; should have_selector(&apos;div.pagination&apos;) &#125; #必须含有分页的css</span><br><span class="line">      it &quot;should list each user&quot; do</span><br><span class="line">        User.paginate(page: 1).each do |user| #第一页的数据</span><br><span class="line">          expect(page).to have_selector(&apos;li&apos;, text: user.name)</span><br><span class="line">        end</span><br><span class="line">      end </span><br><span class="line">    end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/views/users/index.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= will_paginate %&gt; #会自动寻找@user对象，默认一页30个，返回的是ActiveRecord::Relation类对象。</span><br></pre></td></tr></table></figure>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def index</span><br><span class="line">  @users = User.paginate(page: params[:page])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="23、admin和destroy权限"><a href="#23、admin和destroy权限" class="headerlink" title="23、admin和destroy权限"></a>23、admin和destroy权限</h2><h3 id="9-4-1-测试admin"><a href="#9-4-1-测试admin" class="headerlink" title="9.4.1 测试admin"></a>9.4.1 测试admin</h3><p>1）spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">describe User do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  it &#123; should respond_to(:authenticate) &#125;</span><br><span class="line">  it &#123; should respond_to(:admin) &#125;</span><br><span class="line">  it &#123; should be_valid &#125;</span><br><span class="line">  it &#123; should_not be_admin &#125;</span><br><span class="line">  describe &quot;with admin attribute set to &apos;true&apos;&quot; do</span><br><span class="line">    before do</span><br><span class="line">	  @user.save!</span><br><span class="line">      @user.toggle!(:admin) #toggle!方法，状态切换。把属性值从false变成true。</span><br><span class="line">    end</span><br><span class="line">    it &#123; should be_admin &#125; #be_admin，说明用户可以相应admin?方法</span><br></pre></td></tr></table></figure>
<p>2）添加admin栏位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails generate migration add_admin_to_users admin:boolean default:false</span><br></pre></td></tr></table></figure>
<p>执行三兄弟</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rake db:reset</span><br><span class="line">rake db:populate #自定义的db</span><br><span class="line">rails db:migrate RAILS_ENV=test</span><br></pre></td></tr></table></figure>
<h3 id="9-6练习-对admin的可访问性测试，使用健壮参数"><a href="#9-6练习-对admin的可访问性测试，使用健壮参数" class="headerlink" title="9.6练习 对admin的可访问性测试，使用健壮参数"></a>9.6练习 对admin的可访问性测试，使用健壮参数</h3><h3 id="9-4-2-admin才能删除用户"><a href="#9-4-2-admin才能删除用户" class="headerlink" title="9.4.2 admin才能删除用户"></a>9.4.2 admin才能删除用户</h3><p>1）创建示例数据时，给予管理员权限</p>
<p>spec/factories.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FactoryGirl.define do</span><br><span class="line">  factory :user do</span><br><span class="line">    sequence(:name)  &#123; |n| &quot;Person #&#123;n&#125;&quot; &#125;</span><br><span class="line">    sequence(:email) &#123; |n| &quot;person_#&#123;n&#125;@example.com&quot;&#125;</span><br><span class="line">    password &quot;foobar&quot;</span><br><span class="line">    password_confirmation &quot;foobar&quot;</span><br><span class="line">    factory :admin do</span><br><span class="line">      admin true</span><br><span class="line">    end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）测试代码</p>
<p>spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  subject &#123; page &#125;</span><br><span class="line">  describe &quot;index&quot; do</span><br><span class="line">    let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">    before do</span><br><span class="line">      sign_in user</span><br><span class="line">      visit users_path</span><br><span class="line">	end</span><br><span class="line">    it &#123; should have_title(&apos;All users&apos;) &#125;</span><br><span class="line">    it &#123; should have_content(&apos;All users&apos;) &#125;</span><br><span class="line">    describe &quot;pagination&quot; do</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      . </span><br><span class="line">    end</span><br><span class="line">    describe &quot;delete links&quot; do</span><br><span class="line">      it &#123; should_not have_link(&apos;delete&apos;) &#125; #普通用户看不到delete链接。</span><br><span class="line">      describe &quot;as an admin user&quot; do</span><br><span class="line">        let(:admin) &#123; FactoryGirl.create(:admin) &#125;</span><br><span class="line">        before do</span><br><span class="line">          sign_in admin</span><br><span class="line">          visit users_path</span><br><span class="line">        end</span><br><span class="line">        it &#123; should have_link(&apos;delete&apos;, href: user_path(User.first)) &#125;</span><br><span class="line">        it &quot;should be able to delete another user&quot; do</span><br><span class="line">          expect do</span><br><span class="line">            click_link(&apos;delete&apos;, match: :first) #告知capybara，只点击第一个看到的delete链接。</span><br><span class="line">          end.to change(User, :count).by(-1) #用户被删除，数量减少1。</span><br><span class="line">        end</span><br><span class="line">        it &#123; should_not have_link(&apos;delete&apos;, href: user_path(admin)) &#125;</span><br><span class="line">      end</span><br><span class="line">	end </span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>3）让测试通过：</p>
<p>app/views/users/_user.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;</span><br><span class="line">  &lt;%= gravatar_for user, size: 52 %&gt;</span><br><span class="line">  &lt;%= link_to user.name, user %&gt;</span><br><span class="line">  &lt;% if current_user.admin? &amp;&amp; !current_user?(user) %&gt;</span><br><span class="line">    | &lt;%= link_to &quot;delete&quot;, user, method: :delete,</span><br><span class="line">                                  data: &#123; confirm: &quot;You sure?&quot; &#125; %&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def destroy</span><br><span class="line">   User.find(params[:id]).destroy #把find和destroy连在一起用。</span><br><span class="line">   flash[:success] = &quot;User destroyed.&quot;</span><br><span class="line">   redirect_to users_url</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="9-4-2-非admin不能删除用户"><a href="#9-4-2-非admin不能删除用户" class="headerlink" title="9.4.2 非admin不能删除用户"></a>9.4.2 非admin不能删除用户</h3><p>1）spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Authentication&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;authorization&quot; do</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;as non-admin user&quot; do</span><br><span class="line">      let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      let(:non_admin) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      before &#123; sign_in non_admin, no_capybara: true &#125;</span><br><span class="line">      describe &quot;submitting a DELETE request to the Users#destroy action&quot; do</span><br><span class="line">        before &#123; delete user_path(user) &#125;</span><br><span class="line">        specify &#123; expect(response).to redirect_to(root_path) &#125;</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">before_action :admin_user, only: :destroy</span><br></pre></td></tr></table></figure>
<h3 id="9-6练习-admin不能删除自己"><a href="#9-6练习-admin不能删除自己" class="headerlink" title="9.6练习 admin不能删除自己"></a>9.6练习 admin不能删除自己</h3><h2 id="24、10-1-微博模型"><a href="#24、10-1-微博模型" class="headerlink" title="24、10.1 微博模型"></a>24、10.1 微博模型</h2><h3 id="10-1-1-响应新栏位content、user-id的测试。"><a href="#10-1-1-响应新栏位content、user-id的测试。" class="headerlink" title="10.1.1 响应新栏位content、user_id的测试。"></a>10.1.1 响应新栏位content、user_id的测试。</h3><p>spec/models/micropost_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subject &#123; @micropost &#125;</span><br><span class="line">it &#123; should respond_to(:content) &#125;</span><br><span class="line">it &#123; should respond_to(:user_id) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-1-2-权限验证"><a href="#10-1-2-权限验证" class="headerlink" title="10.1.2 权限验证"></a>10.1.2 权限验证</h3><p>存在性验证，当user_id为nil时验证不通过。</p>
<p>spec/models/micropost_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;when user_id is not present&quot; do</span><br><span class="line">    before &#123; @micropost.user_id = nil &#125;</span><br><span class="line">    it &#123; should_not be_valid &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="10-1-3-用户和微博关联测试。"><a href="#10-1-3-用户和微博关联测试。" class="headerlink" title="10.1.3 用户和微博关联测试。"></a>10.1.3 用户和微博关联测试。</h3><p>spec/models/micropost_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">before &#123; @micropost = user.microposts.build(content: &quot;Lorem ipsum&quot;)&#125;</span><br><span class="line"></span><br><span class="line">it &#123; should respond_to(:user) &#125;</span><br><span class="line">its(:user) &#123; should eq user &#125;</span><br></pre></td></tr></table></figure>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">it &#123; should respond_to(:microposts) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-1-4-改进，用预购件"><a href="#10-1-4-改进，用预购件" class="headerlink" title="10.1.4 改进，用预购件"></a>10.1.4 改进，用预购件</h3><p>1）写预购件</p>
<p>spec/factories.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">factory :micropost do</span><br><span class="line">  content &quot;Lorem ipsum&quot;</span><br><span class="line">  user</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）然后在测试文件中新建微博：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FactoryGirl.create(:micropost, user: @user, created_at: 1.day.ago)</span><br></pre></td></tr></table></figure>
<p>3）按创建时间排序（默认是按id）</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">describe User do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;micropost associations&quot; do</span><br><span class="line">    before &#123; @user.save &#125;</span><br><span class="line">    let!(:older_micropost) do</span><br><span class="line">      FactoryGirl.create(:micropost, user: @user, created_at: 1.day.ago)</span><br><span class="line">    end</span><br><span class="line">    let!(:newer_micropost) do</span><br><span class="line">      FactoryGirl.create(:micropost, user: @user, created_at: 1.hour.ago)</span><br><span class="line">	end</span><br><span class="line">    it &quot;should have the right microposts in the right order&quot; do</span><br><span class="line">      expect(@user.microposts.to_a).to eq [newer_micropost, older_micropost]</span><br><span class="line">	end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>4）让测试通过：</p>
<p>app/models/micropost.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_scope -&gt; &#123; order(&apos;created_at DESC&apos;) &#125; #本书第一次接触作用域</span><br></pre></td></tr></table></figure>
<p>补充知识：</p>
<ul>
<li>作用域都需要匿名函式，如这里的<code>-&gt; { order(&#39;created_at DESC&#39;)</code>，这种对象叫Proc。</li>
<li>匿名函式调用call方法，会执行匿名函式的代码。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; -&gt; &#123; puts &quot;foo&quot; &#125;</span><br><span class="line">=&gt; #&lt;Proc:0x007fab938d0108@(irb):1 (lambda)&gt; &gt;&gt; -&gt; &#123; puts &quot;foo&quot; &#125;.call</span><br><span class="line">foo</span><br><span class="line">=&gt; nil</span><br></pre></td></tr></table></figure>
<h3 id="10-1-4-user删除后对应的microposts也要删除"><a href="#10-1-4-user删除后对应的microposts也要删除" class="headerlink" title="10.1.4 user删除后对应的microposts也要删除"></a>10.1.4 user删除后对应的microposts也要删除</h3><p>1）spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> describe &quot;micropost associations&quot; do</span><br><span class="line">   before &#123; @user.save &#125;</span><br><span class="line">   let!(:older_micropost) do</span><br><span class="line">     FactoryGirl.create(:micropost, user: @user, created_at: 1.day.ago)</span><br><span class="line">   end</span><br><span class="line">   let!(:newer_micropost) do</span><br><span class="line">     FactoryGirl.create(:micropost, user: @user, created_at: 1.hour.ago)</span><br><span class="line">   end</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   it &quot;should destroy associated microposts&quot; do</span><br><span class="line">     microposts = @user.microposts.to_a</span><br><span class="line">     @user.destroy</span><br><span class="line">     expect(microposts).not_to be_empty</span><br><span class="line">     microposts.each do |micropost|</span><br><span class="line">       expect(Micropost.where(id: micropost.id)).to be_empty</span><br><span class="line">     end</span><br><span class="line">end </span><br><span class="line"> end</span><br></pre></td></tr></table></figure>
<ul>
<li>我们希望微博立即创建，所以用let!</li>
</ul>
<p>2）补充知识：测试异常的方法</p>
<p>上边用where是因为查询为空时返回nil，这里用find时因为查询为空时返回error。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">expect do</span><br><span class="line">  Micropost.find(micropost)</span><br><span class="line">end.to raise_error(ActiveRecord::RecordNotFound)</span><br></pre></td></tr></table></figure>
<p>3）让测试通过：</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">has_many :microposts, dependent: :destroy #user被删除时，会同时删除microposts。</span><br></pre></td></tr></table></figure>
<h3 id="10-1-5-权限验证"><a href="#10-1-5-权限验证" class="headerlink" title="10.1.5 权限验证"></a>10.1.5 权限验证</h3><p>1）权限验证：content不能为空’ ‘、不能nil、长度不能超过140个字符。</p>
<p>spec/models/micropost_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">describe Micropost do</span><br><span class="line">  let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">  before &#123; @micropost = user.microposts.build(content: &quot;Lorem ipsum&quot;) &#125;</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;when user_id is not present&quot; do</span><br><span class="line">    before &#123; @micropost.user_id = nil &#125;</span><br><span class="line">    it &#123; should_not be_valid &#125;</span><br><span class="line">  end</span><br><span class="line">  describe &quot;with blank content&quot; do</span><br><span class="line">    before &#123; @micropost.content = &quot; &quot; &#125;</span><br><span class="line">    it &#123; should_not be_valid &#125;</span><br><span class="line">  end</span><br><span class="line">  describe &quot;with content that is too long&quot; do</span><br><span class="line">    before &#123; @micropost.content = &quot;a&quot; * 141 &#125;</span><br><span class="line">    it &#123; should_not be_valid &#125;</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>app/models/micropost.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validates :content, presence: true, length: &#123; maximum: 140 &#125;</span><br></pre></td></tr></table></figure>
<h2 id="25、10-2-显示微博"><a href="#25、10-2-显示微博" class="headerlink" title="25、10.2 显示微博"></a>25、10.2 显示微博</h2><h3 id="10-2-1-测试用户show页面是否显示微博"><a href="#10-2-1-测试用户show页面是否显示微博" class="headerlink" title="10.2.1 测试用户show页面是否显示微博"></a>10.2.1 测试用户show页面是否显示微博</h3><p>1）spec/requests/user_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;User pages&quot; do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;profile page&quot; do</span><br><span class="line">    let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">    let!(:m1) &#123; FactoryGirl.create(:micropost, user: user, content: &quot;Foo&quot;) &#125;</span><br><span class="line">    let!(:m2) &#123; FactoryGirl.create(:micropost, user: user, content: &quot;Bar&quot;) &#125;</span><br><span class="line">    before &#123; visit user_path(user) &#125;</span><br><span class="line">    </span><br><span class="line">    it &#123; should have_content(user.name) &#125;</span><br><span class="line">    it &#123; should have_title(user.name) &#125;</span><br><span class="line">    </span><br><span class="line">    describe &quot;microposts&quot; do</span><br><span class="line">      it &#123; should have_content(m1.content) &#125;</span><br><span class="line">      it &#123; should have_content(m2.content) &#125;</span><br><span class="line">      it &#123; should have_content(user.microposts.count) &#125;</span><br><span class="line">    end </span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<ul>
<li>count方法，直接在数据库层统计数量，而不是调用出微博再用length方法。</li>
</ul>
<p>2）让测试通过：</p>
<p>①、app/views/users/show.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;span8&quot;&gt;</span><br><span class="line">  &lt;% if @user.microposts.any? %&gt;</span><br><span class="line">    &lt;h3&gt;Microposts (&lt;%= @user.microposts.count %&gt;)&lt;/h3&gt;</span><br><span class="line">    &lt;ol class=&quot;microposts&quot;&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;span class=&quot;content&quot;&gt;&lt;%= micropost.content %&gt;&lt;/span&gt;</span><br><span class="line">        &lt;span class=&quot;timestamp&quot;&gt;</span><br><span class="line">          Posted &lt;%= time_ago_in_words(micropost.created_at) %&gt; ago.</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">    &lt;/ol&gt;</span><br><span class="line">    &lt;%= will_paginate @microposts %&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>any?方法，如果用户没有发布微博，就不会显示。</li>
<li>count方法，显示数量。</li>
<li>time_ago_in_words方法，显示微博距离发布的时间。示例图见10.2.2。</li>
</ul>
<p>②、app/controllers/users_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def show</span><br><span class="line">  @user = User.find(params[:id])</span><br><span class="line">  @microposts = @user.microposts.paginate(page: params[:page])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="10-2-2-示例微博"><a href="#10-2-2-示例微博" class="headerlink" title="10.2.2 示例微博"></a>10.2.2 示例微博</h3><p>1）生成测试数据，6个用户，每个50条微博。</p>
<p>lib/tasks/sample_data.rake</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">task populate: :environment do</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    users = User.all(limit: 6)</span><br><span class="line">    50.times do</span><br><span class="line">      content = Faker::Lorem.sentence(5)</span><br><span class="line">      users.each &#123; |user| user.microposts.create!(content: content) &#125;</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>数据库更改了，要执行rake三兄弟。</p>
<h2 id="26、10-3-微博的CRUD"><a href="#26、10-3-微博的CRUD" class="headerlink" title="26、10.3 微博的CRUD"></a>26、10.3 微博的CRUD</h2><p>与以往惯例不同，微博resources的页面不是通过Microposts控制器实现，而是依赖于Users和StaticPages控制器。    </p>
<p>config/routes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resources :microposts, only: [:create, :destroy]</span><br></pre></td></tr></table></figure>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1foadb490jkj30c904gq2z.jpg" width="350"></p>
<h3 id="10-3-1-访问限制"><a href="#10-3-1-访问限制" class="headerlink" title="10.3.1 访问限制"></a>10.3.1 访问限制</h3><p>1）访问Create和destroy，要先登录。</p>
<p>spec/requests/authentication_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;authorization&quot; do</span><br><span class="line">    describe &quot;for non-signed-in users&quot; do</span><br><span class="line">      let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      describe &quot;in the Microposts controller&quot; do</span><br><span class="line">        describe &quot;submitting to the create action&quot; do</span><br><span class="line">          before &#123; post microposts_path &#125;</span><br><span class="line">          specify &#123; expect(response).to redirect_to(signin_path) &#125;</span><br><span class="line">		end</span><br><span class="line">        describe &quot;submitting to the destroy action&quot; do</span><br><span class="line">          before &#123; delete micropost_path(FactoryGirl.create(:micropost)) &#125;</span><br><span class="line">          specify &#123; expect(response).to redirect_to(signin_path) &#125;</span><br><span class="line">		end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>移动UserHelper中的signed_in_user，作为User和Micropost都能使用的方法。</p>
<p>①、app/helpers/sessions_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def signed_in_user</span><br><span class="line">  unless signed_in?</span><br><span class="line">    store_location</span><br><span class="line">    redirect_to signin_url, notice: &quot;Please sign in.&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>②、app/controllers/microposts_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">before_action :signed_in_user</span><br></pre></td></tr></table></figure>
<h3 id="10-3-2-创建微博"><a href="#10-3-2-创建微博" class="headerlink" title="10.3.2 创建微博"></a>10.3.2 创建微博</h3><p>想根据用户的登录状态，显示不同的首页内容。与第七章User不同的是，create表单不是放在micropost/new中，而是在网站首页。</p>
<p>1）创建测试文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails g integration_test micropost_page</span><br></pre></td></tr></table></figure>
<p>2）spec/requests/micropost_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Micropost pages&quot; do</span><br><span class="line">    subject &#123; page &#125;</span><br><span class="line"></span><br><span class="line">    let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">    before &#123; sign_in user &#125;</span><br><span class="line"></span><br><span class="line">    describe &quot;micropost creation&quot; do</span><br><span class="line">      before &#123; visit root_path &#125;</span><br><span class="line">      describe &quot;with invalid information&quot; do</span><br><span class="line">        it &quot;should not create a micropost&quot; do</span><br><span class="line">          expect &#123; click_button &quot;Post&quot; &#125;.not_to change(Micropost, :count)</span><br><span class="line">      end</span><br><span class="line">      describe &quot;error messages&quot; do</span><br><span class="line">        before &#123; click_button &quot;Post&quot; &#125;</span><br><span class="line">        it &#123; should have_content(&apos;error&apos;) &#125;</span><br><span class="line">      end </span><br><span class="line">    end</span><br><span class="line">	</span><br><span class="line">    describe &quot;with valid information&quot; do</span><br><span class="line">      before &#123; fill_in &apos;micropost_content&apos;, with: &quot;Lorem ipsum&quot; &#125;</span><br><span class="line">      it &quot;should create a micropost&quot; do</span><br><span class="line">        expect &#123; click_button &quot;Post&quot; &#125;.to change(Micropost, :count).by(1)</span><br><span class="line">      end</span><br><span class="line">	end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>3）让测试通过：</p>
<p>①、app/controllers/microposts_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  before_action :signed_in_user</span><br><span class="line">  def create</span><br><span class="line">    @micropost = current_user.microposts.build(micropost_params)</span><br><span class="line">    if @micropost.save</span><br><span class="line">      flash[:success] = &quot;Micropost created!&quot;</span><br><span class="line">      redirect_to root_url</span><br><span class="line">    else</span><br><span class="line">      render &apos;static_pages/home&apos;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">private</span><br><span class="line">  </span><br><span class="line">  def micropost_params</span><br><span class="line">      params.require(:micropost).permit(:content)</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<p>②、app/views/static_pages/home.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if signed_in? %&gt;</span><br><span class="line">  &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">    &lt;aside class=&quot;span4&quot;&gt;</span><br><span class="line">      &lt;section&gt;</span><br><span class="line">        &lt;%= render &apos;shared/user_info&apos; %&gt;</span><br><span class="line">      &lt;/section&gt;</span><br><span class="line">      &lt;section&gt;</span><br><span class="line">        &lt;%= render &apos;shared/micropost_form&apos; %&gt;</span><br><span class="line">      &lt;/section&gt;</span><br><span class="line">    &lt;/aside&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% else %&gt;</span><br><span class="line">  &lt;div class=&quot;center hero-unit&quot;&gt;</span><br><span class="line">    &lt;h1&gt;Welcome to the Sample App&lt;/h1&gt;</span><br><span class="line">    &lt;h2&gt;</span><br><span class="line">      This is the home page for the</span><br><span class="line">      &lt;a href=&quot;http://railstutorial.org/&quot;&gt;Ruby on Rails Tutorial&lt;/a&gt;</span><br><span class="line">      sample application.</span><br><span class="line">    &lt;/h2&gt;</span><br><span class="line">    &lt;%= link_to &quot;Sign up now!&quot;, signup_path,</span><br><span class="line">                                class: &quot;btn btn-large btn-primary&quot; %&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">  &lt;%= link_to image_tag(&quot;rails.png&quot;, alt: &quot;Rails&quot;), &apos;http://rubyonrails.org/&apos; %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>③、局部视图</p>
<p>app/views/shared/_user_info.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;&lt;%= user_path(current_user) %&gt;&quot;&gt;</span><br><span class="line">  &lt;%= gravatar_for current_user, size: 52 %&gt;</span><br><span class="line">&lt;/a&gt; &lt;h1&gt;</span><br><span class="line">  &lt;%= current_user.name %&gt;</span><br><span class="line">&lt;/h1&gt;</span><br><span class="line">&lt;span&gt;</span><br><span class="line">  &lt;%= link_to &quot;view my profile&quot;, current_user %&gt;</span><br><span class="line">&lt;/span&gt;</span><br><span class="line">&lt;span&gt;</span><br><span class="line">  &lt;%= pluralize(current_user.microposts.count, &quot;micropost&quot;) %&gt;</span><br><span class="line">&lt;/span&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>和第七章一样，用定义的gravatar_for方法。</li>
<li>pluralize方法，自动改变单词大小写。</li>
</ul>
<p>④、局部视图</p>
<p>app/views/shared/_micropost_form.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for(@micropost) do |f| %&gt;</span><br><span class="line">  &lt;%= render &apos;shared/error_messages&apos;, object: f.object %&gt;</span><br><span class="line">  &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">    &lt;%= f.text_area :content, placeholder: &quot;Compose new micropost...&quot; %&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;%= f.submit &quot;Post&quot;, class: &quot;btn btn-large btn-primary&quot; %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过Hash，即<code>{ object: f.object }</code>，把object对象传到局部视图。</li>
</ul>
<p>⑤、为了拿到步骤④的@micropost</p>
<p>app/controllers/static_pages_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def home</span><br><span class="line">    @micropost = current_user.microposts.build if signed_in?</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>加入if sign_in?，好处是当忘了在before_action加入登录限制，测试也会失败。</li>
</ul>
<p>⑥、局部视图</p>
<p>app/views/shared/_error_messages.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if object.errors.any? %&gt;</span><br><span class="line">  &lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;alert alert-error&quot;&gt;</span><br><span class="line">      The form contains &lt;%= pluralize(object.errors.count, &quot;error&quot;) %&gt;.</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">    &lt;% object.errors.full_messages.each do |msg| %&gt;</span><br><span class="line">      &lt;li&gt;* &lt;%= msg %&gt;&lt;/li&gt;</span><br><span class="line">    &lt;% end %&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>⑦、因为把User里的代码作为共用代码，所以要修改User的views里的局部视图引用。</p>
<p>app/views/users/new.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;% provide(:title, &apos;Sign up&apos;) %&gt;</span><br><span class="line">&lt;h1&gt;Sign up&lt;/h1&gt;</span><br><span class="line">&lt;div class=&quot;row&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;span6 offset3&quot;&gt;</span><br><span class="line">    &lt;%= form_for(@user) do |f| %&gt;</span><br><span class="line">      &lt;%= render &apos;shared/error_messages&apos;, object: f.object %&gt;</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">    &lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>app/views/users/edit.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;row&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;span6 offset3&quot;&gt;</span><br><span class="line">    &lt;%= form_for(@user) do |f| %&gt;</span><br><span class="line">      &lt;%= render &apos;shared/error_messages&apos;, object: f.object %&gt;</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h3 id="10-3-3-测试临时动态列表"><a href="#10-3-3-测试临时动态列表" class="headerlink" title="10.3.3 测试临时动态列表"></a>10.3.3 测试临时动态列表</h3><p>目的：显示当前登录用户的微博。</p>
<p>1）测试feed方法，是否只有当前登入用户的微博，而没有其他用户的微博（关注的微博见十一章）。</p>
<p>spec/models/user_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">describe User do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  it &#123; should respond_to(:microposts) &#125;</span><br><span class="line">  it &#123; should respond_to(:feed) &#125;</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  describe &quot;micropost associations&quot; do</span><br><span class="line">    before &#123; @user.save &#125;</span><br><span class="line">    let!(:older_micropost) do</span><br><span class="line">      FactoryGirl.create(:micropost, user: @user, created_at: 1.day.ago)</span><br><span class="line">    end</span><br><span class="line">    let!(:newer_micropost) do</span><br><span class="line">      FactoryGirl.create(:micropost, user: @user, created_at: 1.hour.ago)</span><br><span class="line">    end</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;status&quot; do</span><br><span class="line">      let(:unfollowed_post) do</span><br><span class="line">        FactoryGirl.create(:micropost, user: FactoryGirl.create(:user))</span><br><span class="line">	  end</span><br><span class="line">      its(:feed) &#123; should include(newer_micropost) &#125;</span><br><span class="line">      its(:feed) &#123; should include(older_micropost) &#125;</span><br><span class="line">      its(:feed) &#123; should_not include(unfollowed_post) &#125;</span><br><span class="line">	end</span><br></pre></td></tr></table></figure>
<ul>
<li>include方法，检查数组中是否包含指定元素。</li>
</ul>
<p>2）让测试通过：</p>
<p>app/models/user.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def feed</span><br><span class="line">  # This is preliminary. See &quot;Following users&quot; for the full implementation.</span><br><span class="line">  Micropost.where(&quot;user_id = ?&quot;, id)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>取出所有user_id等于用户id的微博。其中问号?，可以确保id的值在传入底层的SQL查询语句之前做了适当的转义，避免SQL注入的安全隐患。</li>
<li>在SQL语句中引入变量前，先做转义，是个好习惯。</li>
<li>这里的代码<code>Micropost.where(&quot;user_id = ?&quot;, id)</code>等同于<code>microposts</code>，这样写是为了服务十一章完整的动态列表。</li>
</ul>
<h3 id="10-3-3-测试首页显示微博列表"><a href="#10-3-3-测试首页显示微博列表" class="headerlink" title="10.3.3 测试首页显示微博列表"></a>10.3.3 测试首页显示微博列表</h3><p>1）spec/requests/static_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Static pages&quot; do</span><br><span class="line"> subject &#123; page &#125;</span><br><span class="line">  describe &quot;Home page&quot; do</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    describe &quot;for signed-in users&quot; do</span><br><span class="line">      let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br><span class="line">      before do</span><br><span class="line">        FactoryGirl.create(:micropost, user: user, content: &quot;Lorem ipsum&quot;)</span><br><span class="line">        FactoryGirl.create(:micropost, user: user, content: &quot;Dolor sit amet&quot;)</span><br><span class="line">        sign_in user</span><br><span class="line">        visit root_path</span><br><span class="line">	  end</span><br><span class="line">      it &quot;should render the user&apos;s feed&quot; do</span><br><span class="line">        user.feed.each do |item|</span><br><span class="line">          expect(page).to have_selector(&quot;li##&#123;item.id&#125;&quot;, text: item.content)</span><br><span class="line">        end</span><br></pre></td></tr></table></figure>
<ul>
<li>以上代码，假设了所显示的每篇微博都有唯一的css id。</li>
<li><code>expect(page).to have_selector(&quot;li##{item.id}&quot;, text: item.content)</code>，第一个#是Capybara对应的css id的语法，第二个#是ruby字符串插值。</li>
</ul>
<p>2）让测试通过：</p>
<p>①、定义@feed_items实例变量</p>
<p>app/controllers/static_pages_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def home</span><br><span class="line">  if signed_in?</span><br><span class="line">    @micropost  = current_user.microposts.build</span><br><span class="line">    @feed_items = current_user.feed.paginate(page: params[:page])</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>②、动态列表局部视图</p>
<p>app/views/shared/_feed.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if @feed_items.any? %&gt;</span><br><span class="line">  &lt;ol class=&quot;microposts&quot;&gt;</span><br><span class="line">    &lt;%= render partial: &apos;shared/feed_item&apos;, collection: @feed_items %&gt;</span><br><span class="line">  &lt;/ol&gt;</span><br><span class="line">  &lt;%= will_paginate @feed_items %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>之前的局部视图，我们把partial: 省略了。这里因为要指定collection参数，所以不能省略。</li>
</ul>
<p>③、步骤②的局部视图</p>
<p>app/views/shared/_feed_item.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;li id=&quot;&lt;%= feed_item.id %&gt;&quot;&gt;</span><br><span class="line">  &lt;%= link_to gravatar_for(feed_item.user), feed_item.user %&gt;</span><br><span class="line">  &lt;span class=&quot;user&quot;&gt;</span><br><span class="line">    &lt;%= link_to feed_item.user.name, feed_item.user %&gt;</span><br><span class="line">  &lt;/span&gt;</span><br><span class="line">  &lt;span class=&quot;content&quot;&gt;&lt;%= feed_item.content %&gt;&lt;/span&gt;</span><br><span class="line">  &lt;span class=&quot;timestamp&quot;&gt;</span><br><span class="line">    Posted &lt;%= time_ago_in_words(feed_item.created_at) %&gt; ago.</span><br><span class="line">  &lt;/span&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>用<code>id=&quot;&lt;%= feed_item.id %&gt;&quot;</code>，为每个动态项目指定了css id。就是rspec测试要检测的。</li>
</ul>
<p>④、在首页加入以上局部视图</p>
<p>app/views/static_pages/home.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;span8&quot;&gt;</span><br><span class="line">  &lt;h3&gt;Micropost Feed&lt;/h3&gt;</span><br><span class="line">  &lt;%= render &apos;shared/feed&apos; %&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>⑤、如果create失败，@feed_items应该为空，否则view就拿不到数组@feed_items。</p>
<p>app/controllers/microposts_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def create</span><br><span class="line">  @micropost = current_user.microposts.build(micropost_params)</span><br><span class="line">  if @micropost.save</span><br><span class="line">    flash[:success] = &quot;Micropost created!&quot;</span><br><span class="line">    redirect_to root_url</span><br><span class="line">  else</span><br><span class="line">    @feed_items = []</span><br><span class="line">    render &apos;static_pages/home&apos;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="10-3-4-删除微博"><a href="#10-3-4-删除微博" class="headerlink" title="10.3.4 删除微博"></a>10.3.4 删除微博</h3><p>之前删除用户要限制管理员才能操作，这里删除微博，只有微博的发布者才能操作。</p>
<p>1）点击删除链接，数量减一。</p>
<p>spec/requests/micropost_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;Micropost pages&quot; do</span><br><span class="line">  .</span><br><span class="line">  . </span><br><span class="line">  .</span><br><span class="line">  describe &quot;micropost destruction&quot; do</span><br><span class="line">      before &#123; FactoryGirl.create(:micropost, user: user) &#125;</span><br><span class="line">      describe &quot;as correct user&quot; do</span><br><span class="line">        before &#123; visit root_path &#125;</span><br><span class="line">        it &quot;should delete a micropost&quot; do</span><br><span class="line">          expect &#123; click_link &quot;delete&quot; &#125;.to change(Micropost, :count).by(-1)</span><br><span class="line">  		end</span><br></pre></td></tr></table></figure>
<p>2）让测试通过：</p>
<p>①、微博局部视图，加入删除链接</p>
<p>app/views/microposts/_micropost.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if current_user?(micropost.user) %&gt;</span><br><span class="line">  &lt;%= link_to &quot;delete&quot;, micropost, method: :delete,</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>②、动态列表局部视图，加入删除链接</p>
<p>app/views/shared/_feed_item.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if current_user?(feed_item.user) %&gt;</span><br><span class="line">  &lt;%= link_to &quot;delete&quot;, feed_item, method: :delete,</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>③、用事前过滤器</p>
<p>app/controllers/microposts_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">before_action :correct_user, only: :destroy</span><br><span class="line"></span><br><span class="line">def destroy</span><br><span class="line">  @micropost.destroy</span><br><span class="line">  redirect_to root_url</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">private</span><br><span class="line"></span><br><span class="line">  def correct_user</span><br><span class="line">    @micropost = current_user.microposts.find_by(id: params[:id])</span><br><span class="line">    redirect_to root_url if @micropost.nil?</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<ul>
<li>注意，在correct_user中，是通过关联关系查找微博的。</li>
<li>这里用find_by，如果没找到会返回nil。如果用find，找不到会返回error。</li>
</ul>
<p>补充知识：</p>
<p>以上代码有另外一种写法，常常用于debug</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def correct_user</span><br><span class="line">  @micropost = current_user.microposts.find(params[:id])</span><br><span class="line">  rescue</span><br><span class="line">  redirect_to root_url</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>rescue是什么？</li>
</ul>
<h2 id="27、11-1-关系模型"><a href="#27、11-1-关系模型" class="headerlink" title="27、11.1 关系模型"></a>27、11.1 关系模型</h2><p>11.1.1，relationsip建立，并增加索引</p>
<p>11.1.2，relationship访问权限测试、has_many测试、belongs_to测试</p>
<p>11.1.3，relationship存在性测试validate</p>
<p>11.1.4，测试被关注的用户user.followed_users，对应follow!和unfollow!方法</p>
<p>11.1.4，测试粉丝user.followers，涉及reverse_relationship</p>
<h2 id="28、11-2-关注用户功能的网页界面"><a href="#28、11-2-关注用户功能的网页界面" class="headerlink" title="28、11.2 关注用户功能的网页界面"></a>28、11.2 关注用户功能的网页界面</h2><h2 id="29、11-3-动态列表"><a href="#29、11-3-动态列表" class="headerlink" title="29、11.3 动态列表"></a>29、11.3 动态列表</h2><h1 id="第一章-配置"><a href="#第一章-配置" class="headerlink" title="第一章 配置"></a>第一章 配置</h1><p>环境搭建、git、github、heroku。</p>
<p>目的：了解一些命令即可，命令相关的可以归档在这一章。</p>
<h2 id="1-2-2-搭建环境"><a href="#1-2-2-搭建环境" class="headerlink" title="1.2.2 搭建环境"></a>1.2.2 搭建环境</h2><p>RubyGems的作用，一定要安装吗？一般不生成rdoc和ri文档，而是依靠在线文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">install: --no-rdoc --no-ri</span><br><span class="line">update: --no-rdoc --no-ri</span><br></pre></td></tr></table></figure>
<h2 id="1-3-1-git"><a href="#1-3-1-git" class="headerlink" title="1.3.1 git"></a>1.3.1 git</h2><p>1）用git co替代git checkout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global alias.co checkout</span><br></pre></td></tr></table></figure>
<p>2）.gitignore设置，可以忽略mac finder产生的.DS_Store。详见tips1。</p>
<h2 id="1-3-4-github"><a href="#1-3-4-github" class="headerlink" title="1.3.4 github"></a>1.3.4 github</h2><p>1）-u的意思：将本地master分支推送到origin主机，同时指定origin主机为默认主机。后面就可以不加任何参数的使用git push、或git pull了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin https://github.com/&lt;username&gt;/demo_app.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>
<p>2）用git push替代git push origin master</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push --set-upstream origin master //跟踪远程分支，让本地与远程仓库关联</span><br></pre></td></tr></table></figure>
<h2 id="1-3-5-分支"><a href="#1-3-5-分支" class="headerlink" title="1.3.5 分支"></a>1.3.5 分支</h2><p>1）-a意思是添加文件的所有改动，包括对旧文件的重命名、移动等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -am &quot;xxx&quot;</span><br></pre></td></tr></table></figure>
<h1 id="第二章-脚手架"><a href="#第二章-脚手架" class="headerlink" title="第二章 脚手架"></a>第二章 脚手架</h1><p>创建脚手架（上线网站要有验证、有测试、有布局）、MVC、REST、OOP面向对象编程的继承。</p>
<p>目的：了解上线网站的需求。能用自己的话清晰描述MVC、REST、OOP。</p>
<h2 id="2-1-脚手架"><a href="#2-1-脚手架" class="headerlink" title="2.1 脚手架"></a>2.1 脚手架</h2><p>1）脚手架命令。rails会自动创建id，所以不用写id。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rails g scaffold User name:string email:string</span><br><span class="line">或</span><br><span class="line">rails g scaffold Micropost content:string user_id:integer</span><br></pre></td></tr></table></figure>
<blockquote>
<p>缺陷是：</p>
<p>①、没有数据验证、没有身份验证。——不安全。</p>
<p>②、没有自动化测试。——存在各种bug。</p>
<p>③、没有布局。——代码是重复的。</p>
</blockquote>
<h2 id="2-2-Users"><a href="#2-2-Users" class="headerlink" title="2.2 Users"></a>2.2 Users</h2><p>查看所有的rake命令，或查看所有的rake与db相关的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rake -T</span><br><span class="line">rake -T db</span><br></pre></td></tr></table></figure>
<h2 id="2-2-2-MVC、REST"><a href="#2-2-2-MVC、REST" class="headerlink" title="2.2.2 MVC、REST"></a>2.2.2 MVC、REST</h2><p>1）mvc运作流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def index </span><br><span class="line">  @user = User.all</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">1、点击网页浏览器发出请求</span><br><span class="line">2、通过routes找到对应的controller和action</span><br><span class="line">3、controller向model请求资料，比如User.all</span><br><span class="line">4、model从db里读取出的User.all的资料</span><br><span class="line">5、model拿到的资料回传给controller</span><br><span class="line">6、controller把拿到的数据赋值给@user变量，传递给view</span><br><span class="line">7、view文件比如index.html.erb使用ruby渲染成html</span><br><span class="line">8、controller把生成的html发送给浏览器</span><br></pre></td></tr></table></figure>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fnocpw8yz2j30dj0et0sx.jpg" width="400"></p>
<p>2）REST，是表现层状态转换。</p>
<p>把七个action对应到浏览器的四个verb。关于HTTP超文本传输协议，详见3.1章。</p>
<p>一般create、update、destroy不会渲染页面，只修改数据库中的用户数据。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fnzsq2mpsvj30cv09jdga.jpg" width="500"></p>
<h2 id="2-3-4-OOP面向对象继承"><a href="#2-3-4-OOP面向对象继承" class="headerlink" title="2.3.4 OOP面向对象继承"></a>2.3.4 OOP面向对象继承</h2><p>User和Micropost继承自ActiveRecord::Base，才能和数据库通讯。</p>
<p>UserController和MicropostController继承自ActionController::Base，能获得很多功能。比如处理模型对象、过滤http请求、将视图渲染成html等。</p>
<h2 id="2-3-5-让rails能服务于静态资源文件——不配置会怎样？？"><a href="#2-3-5-让rails能服务于静态资源文件——不配置会怎样？？" class="headerlink" title="2.3.5 让rails能服务于静态资源文件——不配置会怎样？？"></a>2.3.5 让rails能服务于静态资源文件——不配置会怎样？？</h2><p>config/environments/production.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DemoApp::Application.configure do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  config.serve_static_assets = true</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h1 id="第三章-BDD之rspec"><a href="#第三章-BDD之rspec" class="headerlink" title="第三章 BDD之rspec"></a>第三章 BDD之rspec</h1><p>3.2.1章节有3个bug，关于正确配置rspec。</p>
<p>目的：能用自己的话描述BDD、TDD、集成测试、单元测试。</p>
<p>动态标题写法用在其他专案。</p>
<p>rspec测试效率的工具，需要google找替代品。</p>
<h2 id="！！3-2-1-课程bug1-配置rspec"><a href="#！！3-2-1-课程bug1-配置rspec" class="headerlink" title="！！3.2.1 课程bug1 配置rspec"></a>！！3.2.1 课程bug1 配置rspec</h2><p>【bug】执行以下命令后报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rspec spec/requests/static_pages_spec.rb</span><br></pre></td></tr></table></figure>
<p>报错如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">✘ apple@apple ⮀ ~/rails/sample_app ⮀ ⭠ test± ⮀ bundle exec rspec spec/requests/static_pages_spec.rb</span><br><span class="line">/Users/apple/.rvm/gems/ruby-2.3.1/gems/selenium-webdriver-2.0.0/lib/selenium/webdriver/common/zipper.rb:1:in `require&apos;: cannot load such file -- zip/zip (LoadError)</span><br><span class="line">	from /Users/apple/.rvm/gems/ruby-2.3.1/gems/selenium-webdriver-2.0.0/lib/selenium/webdriver/common/zipper.rb:1:in `&lt;top (required)&gt;&apos;</span><br></pre></td></tr></table></figure>
<p>解决办法：找了以下三个解答，无效。</p>
<p><a href="http://blog.csdn.net/mydo/article/details/54345527" target="_blank" rel="noopener">http://blog.csdn.net/mydo/article/details/54345527</a></p>
<p><a href="https://ruby-china.org/topics/18548" target="_blank" rel="noopener">https://ruby-china.org/topics/18548</a></p>
<p>rspect官网问答区<a href="https://github.com/rspec/rspec-rails/issues/1273" target="_blank" rel="noopener">https://github.com/rspec/rspec-rails/issues/1273</a></p>
<p>同个例子别人的blog<a href="https://hk.saowen.com/a/63a91c9dbdc6cc6e4409e590b69dbe80ce8961e5a9aec8307c6f108ad4796204" target="_blank" rel="noopener">https://hk.saowen.com/a/63a91c9dbdc6cc6e4409e590b69dbe80ce8961e5a9aec8307c6f108ad4796204</a></p>
<p>stackoverflow<a href="https://stackoverflow.com/questions/18555992/bundle-exec-rspec-spec-requests-static-pages-spec-rb-from-hartls-tutorial-isnt" target="_blank" rel="noopener">https://stackoverflow.com/questions/18555992/bundle-exec-rspec-spec-requests-static-pages-spec-rb-from-hartls-tutorial-isnt</a></p>
<p>装上gem ‘test-unit’，和gem ‘zip’，报错如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> apple@apple ⮀ ~/rails/sample_app ⮀ ⭠ test± ⮀ bundle exec rspec spec/requests/static_pages_spec.rb</span><br><span class="line">DEPRECATION WARNING: alias_method_chain is deprecated. Please, use Module#prepend instead. From module, you can access the original method using super. (called from &lt;top (required)&gt; at /Users/apple/rails/sample_app/spec/spec_helper.rb:4)</span><br><span class="line">DEPRECATION WARNING: alias_method_chain is deprecated. Please, use Module#prepend instead. From module, you can access the original method using super. (called from &lt;top (required)&gt; at /Users/apple/rails/sample_app/spec/spec_helper.rb:4)</span><br><span class="line">/Users/apple/.rvm/gems/ruby-2.3.1/gems/rspec-rails-2.13.1/lib/rspec/rails/fixture_support.rb:19:in `block (2 levels) in &lt;module:FixtureSupport&gt;&apos;: private method `fixture_path&apos; called for #&lt;RSpec::Core::Configuration:0x007fdba70f85e0&gt; (NoMethodError)</span><br><span class="line">Did you mean?  fixture_path=</span><br><span class="line">	from /Users/apple/.rvm/gems/ruby-2.3.1/gems/rspec-rails-2.13.1/lib/rspec/rails/fixture_support.rb:17:in `class_eval&apos;</span><br></pre></td></tr></table></figure>
<h3 id="最终解决办法："><a href="#最终解决办法：" class="headerlink" title="最终解决办法："></a>最终解决办法：</h3><p>参考资料stackoverflow：<a href="https://stackoverflow.com/questions/15148585/undefined-method-visit-when-using-rspec-and-capybara-in-rails" target="_blank" rel="noopener">https://stackoverflow.com/questions/15148585/undefined-method-visit-when-using-rspec-and-capybara-in-rails</a></p>
<p>修改spec/rails_helper.rb，搞定！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">require &apos;spec_helper&apos;</span><br><span class="line">ENV[&apos;RAILS_ENV&apos;] ||= &apos;test&apos;</span><br><span class="line">require File.expand_path(&apos;../../config/environment&apos;, __FILE__)</span><br><span class="line">abort(&quot;The Rails environment is running in production mode!&quot;) if Rails.env.production?</span><br><span class="line">require &apos;rspec/rails&apos; #加入</span><br><span class="line">require &apos;capybara/rails&apos; #加入</span><br><span class="line">require &apos;capybara/rspec&apos; #加入</span><br><span class="line"></span><br><span class="line">ActiveRecord::Migration.maintain_test_schema!</span><br><span class="line">RSpec.configure do |config|</span><br><span class="line">  config.fixture_path = &quot;#&#123;::Rails.root&#125;/spec/fixtures&quot;</span><br><span class="line">  config.infer_spec_type_from_file_location!</span><br><span class="line">  config.filter_rails_from_backtrace!</span><br><span class="line">  config.include Capybara::DSL #针对这个问题，重点加入</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="怎么知道gem-capybara是否生效？"><a href="#怎么知道gem-capybara是否生效？" class="headerlink" title="怎么知道gem capybara是否生效？"></a>怎么知道gem capybara是否生效？</h3><p>新建spec/features/demo.rb，用一个demo案例来测试。</p>
<p>粘贴后执行<code>rspec spec/features/demo.rb</code>，会显示1个成功0个失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">require &apos;rails_helper&apos; #注意是rails_helper</span><br><span class="line"></span><br><span class="line">feature &quot;demo&quot;, :type =&gt; :feature do #注意是feature</span><br><span class="line">  scenario &quot;demo1&quot; do</span><br><span class="line">    visit &quot;/&quot;</span><br><span class="line">    expect(page).to have_content(&quot;Hello&quot;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="！！3-2-1-课程bug2-配置rspec"><a href="#！！3-2-1-课程bug2-配置rspec" class="headerlink" title="！！3.2.1 课程bug2 配置rspec"></a>！！3.2.1 课程bug2 配置rspec</h2><p>教材的这段代码，因为太旧不能使用，怎么改都报错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">require &quot;spec_helper&quot;</span><br><span class="line">describe &quot;Static pages&quot; do</span><br><span class="line">  describe &quot;Home page&quot; do</span><br><span class="line">    it &quot;should have the content &apos;Sample App&apos;&quot; do</span><br><span class="line">      visit &apos;/static_pages/home&apos;</span><br><span class="line">      expect(page).to have_content(&apos;Sample App&apos;)</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="暂时解决办法："><a href="#暂时解决办法：" class="headerlink" title="暂时解决办法："></a>暂时解决办法：</h3><p>把<code>spec_helper</code>改成<code>rails_helper</code>。并加上<code>:type =&gt; :feature</code>。</p>
<p>本来想用<code>:type =&gt; :request</code>，但是报错，不知道怎么解决。暂时先用feature做下去吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">require &apos;rails_helper&apos; #注意是rails_helper</span><br><span class="line"></span><br><span class="line">describe &quot;Static pages&quot;, :type =&gt; :feature do #注意是feature</span><br><span class="line">  describe &quot;Home page&quot; do</span><br><span class="line">    it &quot;should have the content &apos;Sample App&apos;&quot; do</span><br><span class="line">      visit &quot;/static_pages/home&quot;</span><br><span class="line">      expect(page).to have_content(&quot;Sample App&quot;)</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="最终解决办法：-1"><a href="#最终解决办法：-1" class="headerlink" title="最终解决办法："></a>最终解决办法：</h3><p>按3.2.1课程bug1最终解法做。</p>
<h2 id="！！3-2-1-课程bug3-配置rspec"><a href="#！！3-2-1-课程bug3-配置rspec" class="headerlink" title="！！3.2.1 课程bug3 配置rspec"></a>！！3.2.1 课程bug3 配置rspec</h2><p>不做任何操作，直接执行<code>rake db:migrate</code>报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> apple@apple ⮀ ~/rails/sample_app ⮀ ⭠ master± ⮀ rake db:migrate</span><br><span class="line">rake aborted!</span><br><span class="line">NoMethodError: undefined method `last_comment&apos; for #&lt;Rake::Application:0x007fe240bed8c0&gt;</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<p><a href="https://stackoverflow.com/questions/35893584/nomethoderror-undefined-method-last-comment-after-upgrading-to-rake-11" target="_blank" rel="noopener">https://stackoverflow.com/questions/35893584/nomethoderror-undefined-method-last-comment-after-upgrading-to-rake-11</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle update rspec-rails</span><br></pre></td></tr></table></figure>
<p>附：官网<a href="https://github.com/rspec/rspec-rails" target="_blank" rel="noopener">https://github.com/rspec/rspec-rails</a></p>
<h2 id="3-1-静态页面"><a href="#3-1-静态页面" class="headerlink" title="3.1 静态页面"></a>3.1 静态页面</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails generate controller StaticPages home help --no-test-framework</span><br></pre></td></tr></table></figure>
<p>1）驼峰式命名StaticPages，生成的控制器名是蛇底式命名static_pages_controller.rb。</p>
<p>2）HTTP超文本传输协议。</p>
<h2 id="3-2-BDD（rspec和cucumber）"><a href="#3-2-BDD（rspec和cucumber）" class="headerlink" title="3.2 BDD（rspec和cucumber）"></a>3.2 BDD（rspec和cucumber）</h2><p>TDD是什么？</p>
<p>BDD是什么？行为驱动开发，<strong>『遇红、变绿、重构』</strong>的流程。分为集成测试（integration test）和单元测试（unit test）。</p>
<p>什么是集成测试？模拟用户在浏览器的交互操作。配合capybara语法使用。</p>
<h2 id="3-6-测试效率工具，结合实战圣经"><a href="#3-6-测试效率工具，结合实战圣经" class="headerlink" title="3.6 测试效率工具，结合实战圣经"></a>3.6 测试效率工具，结合实战圣经</h2><h2 id="3-6-1-集成了bundler的RVM"><a href="#3-6-1-集成了bundler的RVM" class="headerlink" title="3.6.1 集成了bundler的RVM"></a>3.6.1 集成了bundler的RVM</h2><blockquote>
<p>作用：不用输入rspec命令前的bundle exec。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rvm -v #查看RVM版本，只要是v1.11.x以上的就可以</span><br><span class="line">rvm get stable #更新RVM</span><br></pre></td></tr></table></figure>
<p>如果更新失败，查看解决办法。</p>
<h3 id="binstubs"><a href="#binstubs" class="headerlink" title="binstubs"></a>binstubs</h3><blockquote>
<p>作用：跟3.6.1的RVM一样，如果RVM安装成功了就跳过。</p>
</blockquote>
<h2 id="3-6-2-guard"><a href="#3-6-2-guard" class="headerlink" title="3.6.2 guard"></a>3.6.2 guard</h2><blockquote>
<p>作用：执行guard后，会进入guard界面，每当rspec文件改动保存，就会在guard界面自动测试。</p>
</blockquote>
<p>1、安装gem，并bundle</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">group :development, :test do</span><br><span class="line">  gem &apos;guard-rspec&apos;, &apos;2.5.0&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2、让guard结合rspec，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">guard init rspec</span><br></pre></td></tr></table></figure>
<p>3、！！99未尝试。确保失败的测试通过后grard不会运行所有测试（为了加快遇红、变绿、重构过程）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">guard &apos;rspec&apos;, all_after_pass: false do</span><br></pre></td></tr></table></figure>
<p>4、运行后，修改repec文件的代码，保存后就能在guard中看到正在自动测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">guard</span><br></pre></td></tr></table></figure>
<h2 id="3-6-3-Spork，gem很老有bug，先跳过"><a href="#3-6-3-Spork，gem很老有bug，先跳过" class="headerlink" title="3.6.3 Spork，gem很老有bug，先跳过"></a>3.6.3 Spork，gem很老有bug，先跳过</h2><blockquote>
<p>作用：每次测试前都要重新加载整个rails目录，速度很慢。用Spork只需加载一次。</p>
</blockquote>
<p>安装加速gem spork-rails遇到bug，看这个gem也几年没更新了。先跳过。</p>
<p>有没有其他取代的gem？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time bundle exec rspec spec/requests/static_pages_spec.rb #列出测试所用时间</span><br></pre></td></tr></table></figure>
<h2 id="3-6-4-sublime"><a href="#3-6-4-sublime" class="headerlink" title="3.6.4 sublime"></a>3.6.4 sublime</h2><p>用快捷键执行rspec。有空回头找找atom的。</p>
<h1 id="第四章-ruby知识点-数组-hash-类"><a href="#第四章-ruby知识点-数组-hash-类" class="headerlink" title="第四章 ruby知识点/数组/hash/类"></a>第四章 ruby知识点/数组/hash/类</h1><p>布局文件三行命令的解读。4.2章ruby知识点：module、注释#、局部变量赋值、布尔值boolean、流程控制if或unless、字符串插值#{xx}、返回值return。数组和hash。类的继承、类方法、类变量、类引用。</p>
<p>目的：知识点比较零碎，多看多在rails c里练。数组、hash、类方法的写法在model、controller、rails c经常用到，要练到想写什么效果就能写出来转换自如。</p>
<h2 id="4-2-ruby知识点"><a href="#4-2-ruby知识点" class="headerlink" title="4.2 ruby知识点"></a>4.2 ruby知识点</h2><h2 id="4-3-数组和hash"><a href="#4-3-数组和hash" class="headerlink" title="4.3 数组和hash"></a>4.3 数组和hash</h2><p>hash区别于数组，在于hash没有顺序。</p>
<p>hash的格式，用hashrocket即 :foo =&gt; “xx”，或用symbol即foo: “xx”。</p>
<h2 id="4-3-2-ruby语法例子"><a href="#4-3-2-ruby语法例子" class="headerlink" title="4.3.2 ruby语法例子"></a>4.3.2 ruby语法例子</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&apos;a&apos;..&apos;z&apos;).to_a.shuffle[0..7].join</span><br></pre></td></tr></table></figure>
<p>解读：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; (&apos;a&apos;..&apos;z&apos;).to_a #生成数组      </span><br><span class="line">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;, &quot;g&quot;, &quot;h&quot;, &quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;l&quot;, &quot;m&quot;, &quot;n&quot;, &quot;o&quot;, &quot;p&quot;, &quot;q&quot;, &quot;r&quot;, &quot;s&quot;, &quot;t&quot;, &quot;u&quot;, &quot;v&quot;, &quot;w&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;]</span><br><span class="line">&gt;&gt; (&apos;a&apos;..&apos;z&apos;).to_a.shuffle #打乱</span><br><span class="line">=&gt; [&quot;c&quot;, &quot;g&quot;, &quot;l&quot;, &quot;k&quot;, &quot;h&quot;, &quot;z&quot;, &quot;s&quot;, &quot;i&quot;, &quot;n&quot;, &quot;d&quot;, &quot;y&quot;, &quot;u&quot;, &quot;t&quot;, &quot;j&quot;, &quot;q&quot;, &quot;b&quot;, &quot;r&quot;, &quot;o&quot;, &quot;f&quot;, &quot;e&quot;, &quot;w&quot;, &quot;v&quot;, &quot;m&quot;, &quot;a&quot;, &quot;x&quot;, &quot;p&quot;]</span><br><span class="line">&gt;&gt; (&apos;a&apos;..&apos;z&apos;).to_a.shuffle[0..7] #前8个数据</span><br><span class="line">=&gt; [&quot;f&quot;, &quot;w&quot;, &quot;i&quot;, &quot;a&quot;, &quot;h&quot;, &quot;p&quot;, &quot;c&quot;, &quot;x&quot;]</span><br><span class="line">&gt;&gt; (&apos;a&apos;..&apos;z&apos;).to_a.shuffle[0..7].join #数组转成字符串           </span><br><span class="line">=&gt; &quot;mznpybuj&quot;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-3-inspect"><a href="#4-3-3-inspect" class="headerlink" title="4.3.3 inspect"></a>4.3.3 inspect</h2><p>对比<code>puts (1..5).to_a</code>和<code>puts (1..5).to_a.inspect</code>，前者把数组作为字符串输出即输出数字。后者输出数组的字面量形式即一个阵列。</p>
<p>inspect的快捷用法是p。比如<code>p :name</code>等价于<code>puts :name.inspect</code>。</p>
<p>【问题】inspect和print效果好像差不多，两者有什么区别？</p>
<h2 id="4-3-4-布局application-rb三个命令理解"><a href="#4-3-4-布局application-rb三个命令理解" class="headerlink" title="4.3.4 布局application.rb三个命令理解"></a>4.3.4 布局application.rb三个命令理解</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= stylesheet_link_tag &quot;application&quot;, media: &quot;all&quot;,</span><br><span class="line">                                           &quot;data-turbolinks-track&quot; =&gt; true %&gt;</span><br><span class="line">&lt;%= javascript_include_tag &quot;application&quot;, &quot;data-turbolinks-track&quot; =&gt; true %&gt;</span><br><span class="line">&lt;%= csrf_meta_tags %&gt;</span><br></pre></td></tr></table></figure>
<p>1）布局里的&lt;%= csrf_meta_tags %&gt;，用来防止“跨站请求伪造”。</p>
<p>2）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= stylesheet_link_tag &quot;application&quot;, media: &quot;all&quot;,</span><br><span class="line">                                       &quot;data-turbolinks-track&quot; =&gt; true %&gt;</span><br></pre></td></tr></table></figure>
<p>上边这段是下边这段的缩写。</p>
<ul>
<li>使用&lt;%= %&gt;，执行结果会通过erb即ruby语法转化成html插入模板中。</li>
</ul>
<ul>
<li>stylesheet_link_tag是rails一个特殊函数，用来引入样式表</li>
</ul>
<ul>
<li>ruby中函数的括号可以省略</li>
<li>hash最后一个参数，可以省略花括号</li>
<li>symbol符号不能用连字符-，所以要用旧语法<code>data-turbolinks-track&quot; =&gt; true</code></li>
<li>拆成两行，ruby不关心有没有换行或空格，也保持每行代码不超过80列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= stylesheet_link_tag (&quot;application&quot;, &#123; media: &quot;all&quot;,</span><br><span class="line">                                       &quot;data-turbolinks-track&quot; =&gt; true &#125;) %&gt;</span><br></pre></td></tr></table></figure>
<p>整句解读：调用stylesheet_link_tag函数，传进两个参数，一个是字符串指明样式表路径，一个是hash包含两个元素，指明媒介类型，并启用Turbolinks功能。</p>
<h2 id="4-4-1-构造器"><a href="#4-4-1-构造器" class="headerlink" title="4.4.1 构造器"></a>4.4.1 构造器</h2><p>双引号是字符串的<strong>『字面构造器』</strong>。</p>
<p>new是<strong>『具名构造器』</strong>。</p>
<p><strong>『在类上调用的方法比如new，称为类方法。调用new得到的结果是一个对象，称为类的实例。在实例上调用的方法叫实例方法，比如length』</strong>。</p>
<h2 id="4-4-2-类的继承-superclass和-class"><a href="#4-4-2-类的继承-superclass和-class" class="headerlink" title="4.4.2 类的继承.superclass和.class"></a>4.4.2 类的继承.superclass和.class</h2><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fnzzlg5ydzj306f06qjra.jpg" width="250"></p>
<h2 id="4-4-3-修改内置的类"><a href="#4-4-3-修改内置的类" class="headerlink" title="4.4.3 修改内置的类"></a>4.4.3 修改内置的类</h2><p>可以改String等类，但是少用。</p>
<p>blank?是rails为ruby添加的方法。</p>
<p>blank?、empty?、nil?的区别？bank?表示是否空白，empty?是针对字符串表示是否为空。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2.3.1 :001 &gt; &quot;&quot;.blank?</span><br><span class="line"> =&gt; true</span><br><span class="line">2.3.1 :002 &gt; &quot;&quot;.empty?</span><br><span class="line"> =&gt; true</span><br><span class="line">2.3.1 :003 &gt; &quot;&quot;.nil?</span><br><span class="line"> =&gt; false</span><br><span class="line"> </span><br><span class="line">2.3.1 :006 &gt; &quot; &quot;.blank?</span><br><span class="line"> =&gt; true</span><br><span class="line">2.3.1 :007 &gt; &quot; &quot;.empty?</span><br><span class="line"> =&gt; false</span><br><span class="line">2.3.1 :008 &gt; &quot; &quot;.nil?</span><br><span class="line"> =&gt; false</span><br><span class="line"> </span><br><span class="line">2.3.1 :009 &gt; nil.blank?</span><br><span class="line"> =&gt; true</span><br><span class="line">2.3.1 :010 &gt; nil.empty?</span><br><span class="line">NoMethodError: undefined method `empty?&apos; for nil:NilClass</span><br><span class="line">2.3.1 :011 &gt; nil.nil?</span><br><span class="line"> =&gt; true</span><br></pre></td></tr></table></figure>
<h2 id="4-4-4-controller类"><a href="#4-4-4-controller类" class="headerlink" title="4.4.4 controller类"></a>4.4.4 controller类</h2><p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fo004zhng1j307c0f7aa7.jpg" width="250"></p>
<p>rails和ruby的不同，比如没有看到类.new来定义方法，而是直接如下写出home的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class StaticPagesController &lt; ApplicationController</span><br><span class="line">  def home</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="4-4-5-用户类"><a href="#4-4-5-用户类" class="headerlink" title="4.4.5 用户类"></a>4.4.5 用户类</h2><p>example_user.rb</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class User</span><br><span class="line">  attr_accessor :name, :email</span><br><span class="line">  def initialize(attributes = &#123;&#125;)</span><br><span class="line">    @name  = attributes[:name]</span><br><span class="line">    @email = attributes[:email]</span><br><span class="line">  end</span><br><span class="line">  def formatted_email</span><br><span class="line">    "#&#123;@name&#125; <span class="tag">&lt;<span class="name">#&#123;@email&#125;</span>&gt;</span>"</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>attr_accessor，相当于能够get读取、set修改。</p>
<p>initialize在ruby有特殊意义，当执行User.new时会执行这个方法。比如可以执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user = User.new(name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;)</span><br></pre></td></tr></table></figure>
<p>实例变量@home，意义在于自动在视图中可用。</p>
<p>require ‘./example_user’，加载文件。</p>
<h1 id="第五章-布局css、rspec代码重构"><a href="#第五章-布局css、rspec代码重构" class="headerlink" title="第五章 布局css、rspec代码重构"></a>第五章 布局css、rspec代码重构</h1><p>5.3.5章节有bug，外部文件要用require引入。</p>
<p>目的：</p>
<p>了解定义样式的partial、asset pipeline、sass，把sass的实用功能（嵌套css和变量）用到其他专案。</p>
<p>rspec重构，把5.6最简洁的重构方法用到其他专案。</p>
<p>用户注册，教材用外卡路由不安全，改用resources。</p>
<h2 id="5-1-1-navbar"><a href="#5-1-1-navbar" class="headerlink" title="5.1.1 navbar"></a>5.1.1 navbar</h2><p>1）html样式bug，navbar显示有问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;nav&gt; </span><br><span class="line">  &lt;ul class=&quot;nav pull-right&quot;&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">&lt;/nav&gt;</span><br></pre></td></tr></table></figure>
<p>把代码改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul class=&quot;nav navbar-nav pull-right&quot;&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<p>2）【问题】html5标签，header、nav、section、div。分别用在什么区域？</p>
<p>3）link_to是rails的帮助方法，可用来创建链接。</p>
<p>4）【问题】hero-unit在bootstrap中的意义是？</p>
<p>5）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= link_to image_tag(&quot;rails.png&quot;, alt: &quot;Rails&quot;), &apos;http://rubyonrails.org/&apos; %&gt;</span><br></pre></td></tr></table></figure>
<p>image_tag帮助方法，第一个参数图片路径(app/assets/images)，第二个参数是hash可选。alt属性是图片无法加载时，针对视觉障碍人士的显示。</p>
<p>rails默认会加上alt属性，如果不指定参数会默认使用图片文件名。</p>
<h2 id="5-1-2-bootstrap和css"><a href="#5-1-2-bootstrap和css" class="headerlink" title="5.1.2 bootstrap和css"></a>5.1.2 bootstrap和css</h2><p>bootstrap使用LESS动态生成样式表，Rails默认支持Sass。用gem bootstrap-sass，把LESS转换成Sass。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@import &quot;bootstrap&quot;; #引入整个bootstrap css框架</span><br></pre></td></tr></table></figure>
<h2 id="5-1-3-局部视图render"><a href="#5-1-3-局部视图render" class="headerlink" title="5.1.3 局部视图render"></a>5.1.3 局部视图render</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= render &apos;layouts/header&apos; %&gt; #&lt;%=...%&gt;表示执行ruby表达式，并将结果插入模板中</span><br></pre></td></tr></table></figure>
<p>一般，每个页面都会用到的局部视图放在layouts文件夹，一些辅助的局部视图放在shared文件夹。</p>
<h2 id="5-2-1-asset-pipeline"><a href="#5-2-1-asset-pipeline" class="headerlink" title="5.2.1 asset pipeline"></a>5.2.1 asset pipeline</h2><p>sass是asset pipeline默认的一部分。</p>
<p>asset pipeline</p>
<p>把生产环境中的css、js分别集中在一个文件中所以加载快，并且会压缩（包括lib/assets和vendor/assets文件，删除不必要空格）减小文件大小。明显提高了css、js等静态文件的生成效率。</p>
<p>有三个特性：</p>
<p><strong>【1】资源目录</strong></p>
<ul>
<li>app/assets，存放应用程序用到的资源文件</li>
<li>lib/assets，存放团队自己开发代码库用到的资源文件</li>
<li>vendor/assets，存放第三方代码库用到的资源文件</li>
</ul>
<p><strong>【2】清单文件</strong></p>
<p>gem sprockets，会通过清单文件合并成一个文件。只适用于css、js，不适用于图片。</p>
<p>app/assets/stylesheets/application.css</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * This is a manifest file that&apos;ll automatically include all the stylesheets</span><br><span class="line"> * available in this directory and any sub-directories. You&apos;re free to add</span><br><span class="line"> * application-wide styles to this file and they&apos;ll appear at the top of the</span><br><span class="line"> * compiled file, but it&apos;s generally better to create a new file per style</span><br><span class="line"> * scope.</span><br><span class="line"> *= require_self </span><br><span class="line"> *= require_tree .</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>其中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*= require_self  #会把application.css这个文件中的css加载进来</span><br></pre></td></tr></table></figure>
<p>其中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*= require_tree . #会把app/assets/stylesheets目录中的所有css引入应用程序的样式表中</span><br></pre></td></tr></table></figure>
<p><strong>【3】预处理引擎</strong></p>
<p>不同扩展名对应不同的预处理引擎，主要有三种：</p>
<p>1）.scss对应Sass</p>
<p>2）.coffee对应CoffeeScript</p>
<p>3）.erb对应Erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foobar.js.erb.coffee #会使用CoffeeScript和Erb，从右到左处理，先执行CoffeeScript处理器。</span><br></pre></td></tr></table></figure>
<h2 id="5-2-2-Sass"><a href="#5-2-2-Sass" class="headerlink" title="5.2.2 Sass"></a>5.2.2 Sass</h2><p>Sass提供很多功能，可以用来简化样式表，以下是主要功能。</p>
<p>先把文件名改成scss结尾，比如custom.css.scss。</p>
<h3 id="Sass常用写法"><a href="#Sass常用写法" class="headerlink" title="Sass常用写法"></a>Sass常用写法</h3><p>1）Sass的嵌套常规写法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.center &#123;</span><br><span class="line">  text-align: center;</span><br><span class="line">  h1 &#123;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2）有hover时，用&amp;符号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#logo &#123;</span><br><span class="line">  float: left;</span><br><span class="line">  margin-right: 10px;</span><br><span class="line">  font-size: 1.7em;</span><br><span class="line">  color: #fff;</span><br><span class="line">  text-transform: uppercase;</span><br><span class="line">  letter-spacing: -1px;</span><br><span class="line">  padding-top: 9px;</span><br><span class="line">  font-weight: bold;</span><br><span class="line">  line-height: 1;</span><br><span class="line">  &amp;:hover &#123;</span><br><span class="line">color: #fff;</span><br><span class="line">    text-decoration: none;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Sass使用变量"><a href="#Sass使用变量" class="headerlink" title="Sass使用变量"></a>Sass使用变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$lightGray: #999; #Sass语法定义的变量</span><br><span class="line">h2 &#123; </span><br><span class="line">  color: $lightGray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>bootstrap定义了很多颜色变量，是用LESS语法，<a href="http://bootstrapdocs.com/v2.0.4/docs/less.html。" target="_blank" rel="noopener">http://bootstrapdocs.com/v2.0.4/docs/less.html。</a></p>
<p>LESS语法使用@定义变量，Sass语法使用$定义变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@grayLight: #999; #LESS语法定义的变量</span><br></pre></td></tr></table></figure>
<h2 id="5-3-2-外卡路由（不安全）"><a href="#5-3-2-外卡路由（不安全）" class="headerlink" title="5.3.2 外卡路由（不安全）"></a>5.3.2 外卡路由（不安全）</h2><p>教材这一章比较老。</p>
<p>更好的办法是用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resources :static_pages</span><br></pre></td></tr></table></figure>
<h2 id="！！5-3-4-课程bug-rspec代码重构"><a href="#！！5-3-4-课程bug-rspec代码重构" class="headerlink" title="！！5.3.4 课程bug  rspec代码重构"></a>！！5.3.4 课程bug  rspec代码重构</h2><p>报错如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1) Static pages Home page</span><br><span class="line">   Failure/Error: it &#123; should have_title(full_title(&apos;&apos;)) &#125;</span><br><span class="line"></span><br><span class="line">   NoMethodError:</span><br><span class="line">     undefined method `full_title&apos; for #&lt;RSpec::ExampleGroups::StaticPages::HomePage:0x007fd6b8b72e60&gt;</span><br></pre></td></tr></table></figure>
<h3 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h3><p>在spec/support/utilities.rb里定义full_tittle后，要在spec/requests/static_pages_spec.rb里引入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require &apos;support/utilities.rb&apos;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-4-rspec代码重构"><a href="#5-3-4-rspec代码重构" class="headerlink" title="5.3.4 rspec代码重构"></a>5.3.4 rspec代码重构</h2><p>好用，整理到rspec专栏。</p>
<h2 id="5-4-用户注册"><a href="#5-4-用户注册" class="headerlink" title="5.4 用户注册"></a>5.4 用户注册</h2><p>注册页面User的controller</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails generate controller Users new --no-test-framework</span><br></pre></td></tr></table></figure>
<p>注册路由，教材用的是外卡路由（不安全），更好的用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resources :users</span><br></pre></td></tr></table></figure>
<h2 id="5-6-rspec代码重构"><a href="#5-6-rspec代码重构" class="headerlink" title="5.6 rspec代码重构"></a>5.6 rspec代码重构</h2><p>好用，整理到rspec专栏。</p>
<p>rspec提供一种名为“共享用例shared example”的辅助功能，用于消除代码重复。</p>
<h1 id="第六章"><a href="#第六章" class="headerlink" title="第六章"></a>第六章</h1><p>第六章到第九章，功能完整的登录和用户验证系统。同Clearance、Authlogic、Devise、CanCan。自己开发可以更好地理解实现的过程，且很多时候，对第三方代码库做修改，工作量比重新开发一个还大。</p>
<p>User的model。</p>
<h2 id="6-1-1-迁移"><a href="#6-1-1-迁移" class="headerlink" title="6.1.1 迁移"></a>6.1.1 迁移</h2><p>迁移，用于精确修改数据库。用<code>rails g</code>，创建。用<code>rake db:migrate</code>，向上迁移。</p>
<p>第一次使用<code>rake db:migrate</code>，会创建<code>db/development.sqlite3</code>文件。</p>
<p>change方法使用rails的<code>create_table</code>方法创建表格，用来存储数据。</p>
<h2 id="6-1-3-rails-c-–sandbox"><a href="#6-1-3-rails-c-–sandbox" class="headerlink" title="6.1.3 rails c –sandbox"></a>6.1.3 rails c –sandbox</h2><p>1）rails c沙盒模型，所有对数据库的修改，在exit退出后会rollback还原。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails c --sandbox</span><br></pre></td></tr></table></figure>
<p>2）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u=User.new(name:&quot;99&quot;)</span><br><span class="line">u.save #save返回的是true或false</span><br></pre></td></tr></table></figure>
<p>相当于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u=User.create(name:&quot;99&quot;) #返回创建的对象</span><br></pre></td></tr></table></figure>
<p>保存成功后，都会出现SQL预计INSERT INTO “users”。</p>
<p>3）create的反操作是destroy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u.destroy #返回删除的对象user</span><br></pre></td></tr></table></figure>
<h2 id="6-1-4-rails-c-查找对象"><a href="#6-1-4-rails-c-查找对象" class="headerlink" title="6.1.4 rails c 查找对象"></a>6.1.4 rails c 查找对象</h2><p>1）通过id查找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.find(1)</span><br></pre></td></tr></table></figure>
<p>2）指定属性查找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.find_by_email(&quot;mhartl@example.com&quot;)</span><br></pre></td></tr></table></figure>
<p>但是，find_by效率不高，6.2.5节使用数据库索引，改善这个问题。</p>
<p>3）其他</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.first</span><br><span class="line">User.last</span><br><span class="line">User.all</span><br></pre></td></tr></table></figure>
<h2 id="6-1-5-rails-c-更新对象"><a href="#6-1-5-rails-c-更新对象" class="headerlink" title="6.1.5 rails c 更新对象"></a>6.1.5 rails c 更新对象</h2><p>1）方法一：分别为每个属性赋值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u.email = &quot;mhartl@example.net&quot;</span><br><span class="line">u.save</span><br></pre></td></tr></table></figure>
<p>可以用reload查看是否已保存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u.reload.email</span><br></pre></td></tr></table></figure>
<p>2）方法二：用update_attributes方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.update_attributes(name: &quot;The Dude&quot;, email: &quot;dude@abides.org&quot;) #成功则返回true</span><br></pre></td></tr></table></figure>
<p>注意：如果任何一个数据验证失败，操作就会失败。</p>
<p>可以改用update_attribute，更新单个属性就可以跳过数据验证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.update_attribute(:name, &quot;The Dude&quot;) #成功则返回true</span><br></pre></td></tr></table></figure>
<h2 id="6-2-1-测试新增的栏位"><a href="#6-2-1-测试新增的栏位" class="headerlink" title="6.2.1 测试新增的栏位"></a>6.2.1 测试新增的栏位</h2><p>命令：创建“测试数据库”。即把开发数据库db/development.sqlite3中的数据模型复制到db/test.sqlite3测试数据库。</p>
<p>用在新建model后，rake db:migrate后执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rake db:migrate</span><br><span class="line">rake test:prepare #这个代码比较旧，改用下面的</span><br><span class="line">rails db:migrate RAILS_ENV=test</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果测试出现莫名其妙的问题，可以尝试执行以上命令。</p>
</blockquote>
<h2 id="6-2-2-测试-验证存在性"><a href="#6-2-2-测试-验证存在性" class="headerlink" title="6.2.2 测试/验证存在性"></a>6.2.2 测试/验证存在性</h2><p>整理到rspec专栏。</p>
<h2 id="6-2-3-测试-验证长度"><a href="#6-2-3-测试-验证长度" class="headerlink" title="6.2.3  测试/验证长度"></a>6.2.3  测试/验证长度</h2><p>整理到rspec专栏。</p>
<h2 id="6-2-4-测试-验证email格式"><a href="#6-2-4-测试-验证email格式" class="headerlink" title="6.2.4 测试/验证email格式"></a>6.2.4 测试/验证email格式</h2><p>1）整理到rspec专栏。</p>
<p>2）rubular，正则表达式编辑器，是学习正则表达式的必备工具。</p>
<p>注意：如果在rubular中用正则表达式，要把\A和\z去掉。如图，可以自己加入括号，括号部分的匹配结果会显示在如图的红色框中。</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fnri1pexwyj30rh0hkaas.jpg" width="500"></p>
<p>3）正则表达式解读。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i #完整代码</span><br><span class="line">/ #正则表达式开始</span><br><span class="line">\A #开头</span><br><span class="line">[\w+\-.]+ #字母、加号、连字符、点，有一个或多个</span><br><span class="line">@ #匹配@符号</span><br><span class="line">[a-z\d\-.]+ #小写字母、数字、连字符、点，有一个或多个</span><br><span class="line">\. #点</span><br><span class="line">[a-z]+ #小写字母，有一个或多个</span><br><span class="line">\z #结尾</span><br><span class="line">/ #正则表达式结束</span><br><span class="line">i #不区分大小写</span><br></pre></td></tr></table></figure>
<h2 id="6-2-5-测试-验证email唯一性"><a href="#6-2-5-测试-验证email唯一性" class="headerlink" title="6.2.5 测试/验证email唯一性"></a>6.2.5 测试/验证email唯一性</h2><p>创建栏位时，要考虑是否会用这个栏位进行查询，如果有要增加索引add_index。否则查询时会进行“全表扫描”，效能极差。</p>
<p>索引的原理类似于一本书的目录。</p>
<h2 id="6-3-1-加密密码"><a href="#6-3-1-加密密码" class="headerlink" title="6.3.1 加密密码"></a>6.3.1 加密密码</h2><h3 id="bcrypt-ruby"><a href="#bcrypt-ruby" class="headerlink" title="bcrypt-ruby"></a>bcrypt-ruby</h3><p>rails密码安全机制，是由一个单独的方法<code>has_secure_password</code>方法实现的。</p>
<p>gem ‘bcrypt-ruby’，用哈希算法对密码进行不可逆的加密。</p>
<h3 id="加密后测试速度变慢7-1-3"><a href="#加密后测试速度变慢7-1-3" class="headerlink" title="加密后测试速度变慢7.1.3"></a>加密后测试速度变慢7.1.3</h3><p>因为慢加密的密码难破解，所以加密过程会延长测试运行的时间。</p>
<p>解决办法：</p>
<p>config/environments/test.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SampleApp::Application.configure do</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  # Speed up tests by lowering bcrypt&apos;s cost function. </span><br><span class="line">  ActiveModel::SecurePassword.min_cost = true #把test环境下，bcrypt的耗时因子改为最小。</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="6-3-3"><a href="#6-3-3" class="headerlink" title="6.3.3"></a>6.3.3</h2><p>u.authenticate(“密码”)，密码正确会对应到这笔数据。</p>
<p>u.password_digest，密码的加密形式。</p>
<h1 id="第七章"><a href="#第七章" class="headerlink" title="第七章"></a>第七章</h1><p>用户注册功能</p>
<p>用户资料页面</p>
<p>目的：写法大部分都知道，主要是注册功能的测试以及7.6的练习。</p>
<h2 id="7-1-1-调试信息和rails环境"><a href="#7-1-1-调试信息和rails环境" class="headerlink" title="7.1.1 调试信息和rails环境"></a>7.1.1 调试信息和rails环境</h2><p>1）指定进入test环境的rails c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails c test</span><br></pre></td></tr></table></figure>
<p>2）指定进入production生产环境的rails s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails s --environment production</span><br></pre></td></tr></table></figure>
<p>3）指定production生产环境的迁移migration</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails db:migrate RAILS_ENV=production</span><br></pre></td></tr></table></figure>
<h3 id="【1】布局中加入调试信息"><a href="#【1】布局中加入调试信息" class="headerlink" title="【1】布局中加入调试信息"></a>【1】布局中加入调试信息</h3><p>1）layout/aplication.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= debug(params) if Rails.env.development? %&gt; #rails内置的debug方法和params变量</span><br></pre></td></tr></table></figure>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fnrp764de6j30vv09awes.jpg" width="500"></p>
<p>2）css美化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@mixin box_sizing &#123;</span><br><span class="line">  -moz-box-sizing: border-box;</span><br><span class="line">  -webkit-box-sizing: border-box;</span><br><span class="line">  box-sizing: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.debug_dump &#123;</span><br><span class="line">  clear: both;</span><br><span class="line">  float: left;</span><br><span class="line">  width: 100%;</span><br><span class="line">  margin-top: 45px;</span><br><span class="line">  @include box_sizing; #用到Sass的mixin功能（打包样式，供多次使用）。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-1-2-Users资源"><a href="#7-1-2-Users资源" class="headerlink" title="7.1.2 Users资源"></a>7.1.2 Users资源</h2><p>@user = User.params[:id]中，params[:id]返回的是字符串比如”1”，find方法自动将其转换成整数。</p>
<h2 id="7-1-3-使用预构件测试"><a href="#7-1-3-使用预构件测试" class="headerlink" title="7.1.3 使用预构件测试"></a>7.1.3 使用预构件测试</h2><p>1）安装gem。gem ‘factory_girl_rails’改名成gem ‘factory_bot_rails’，不过旧的还能用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;factory_bot_rails&apos;</span><br></pre></td></tr></table></figure>
<p>2）设置预购件。</p>
<p>spec/factories.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FactoryGirl.define do</span><br><span class="line">  factory :user do</span><br><span class="line">    name     &quot;Michael Hartl&quot;</span><br><span class="line">    email    &quot;michael@example.com&quot;</span><br><span class="line">    password &quot;foobar&quot;</span><br><span class="line">    password_confirmation &quot;foobar&quot;</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>3）用let方法生成User对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let(:user) &#123; FactoryGirl.create(:user) &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-1-4-添加Gravatar头像"><a href="#7-1-4-添加Gravatar头像" class="headerlink" title="7.1.4 添加Gravatar头像"></a>7.1.4 添加Gravatar头像</h2><p>1）app/helpers/users_helper.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module UsersHelper</span><br><span class="line">  def gravatar_for(user) </span><br><span class="line">    gravatar_id = Digest::MD5::hexdigest(user.email.downcase) #把email用MD5加密成字符串</span><br><span class="line">    gravatar_url = &quot;https://secure.gravatar.com/avatar/#&#123;gravatar_id&#125;&quot;</span><br><span class="line">    image_tag(gravatar_url, alt: user.name, class: &quot;gravatar&quot;)</span><br><span class="line">end end</span><br></pre></td></tr></table></figure>
<p>加密后的gravatar_id，类似于“1fda4469bcbec3badf5418269ffc5968”的格式。</p>
<p>2）bootstrap的aside标签，一般是对主体内容的补充。现在还有在用？？</p>
<p>class设置为 row span4，现在还有在用？？</p>
<h2 id="7-2-1-测试用户注册功能"><a href="#7-2-1-测试用户注册功能" class="headerlink" title="7.2.1 测试用户注册功能"></a>7.2.1 测试用户注册功能</h2><h2 id="7-2-2-使用form-for"><a href="#7-2-2-使用form-for" class="headerlink" title="7.2.2 使用form_for"></a>7.2.2 使用form_for</h2><h2 id="7-2-3-form-for表单html"><a href="#7-2-3-form-for表单html" class="headerlink" title="7.2.3 form_for表单html"></a>7.2.3 form_for表单html</h2><h3 id="参考8-1-3-form-for和form-tag的区别，练习8-5。"><a href="#参考8-1-3-form-for和form-tag的区别，练习8-5。" class="headerlink" title="参考8.1.3 form_for和form_tag的区别，练习8.5。"></a>参考8.1.3 form_for和form_tag的区别，练习8.5。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_for(@user) do |f| %&gt;</span><br><span class="line">  &lt;%= f.label :name %&gt;</span><br><span class="line">  &lt;%= f.text_field :name %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;%= f.label :password %&gt;</span><br><span class="line">  &lt;%= f.password_field :password %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>生成的html是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/users&quot; class=&quot;new_user&quot; id=&quot;new_user&quot; method=&quot;post&quot;&gt;</span><br><span class="line">  &lt;label for=&quot;user_name&quot;&gt;Name&lt;/label&gt;</span><br><span class="line">  &lt;input id=&quot;user_name&quot; name=&quot;user[name]&quot; type=&quot;text&quot; /&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;label for=&quot;user_password&quot;&gt;Password&lt;/label&gt;</span><br><span class="line">  &lt;input id=&quot;user_password&quot; name=&quot;user[password]&quot; type=&quot;password&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>可以创建用户，依赖于input的name属性。</p>
<p>form标签里，action=”/users”会向地址/users发送请求。</p>
<p>form标签里，method=”post”指明请求是POST。</p>
<h2 id="7-3-1-可正常使用的表单"><a href="#7-3-1-可正常使用的表单" class="headerlink" title="7.3.1 可正常使用的表单"></a>7.3.1 可正常使用的表单</h2><p>1）params是一个嵌套的Hash。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@user = User.new(params[:user])</span><br></pre></td></tr></table></figure>
<p>基本上等同于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@user = User.new(name: &quot;Foo Bar&quot;, email: &quot;foo@invalid&quot;,</span><br><span class="line">                 password: &quot;foo&quot;, password confirmation: &quot;bar&quot;)</span><br></pre></td></tr></table></figure>
<p>但是，因为不安全（普通用户可以请求任意用户数据），所以要改用7.3.2健壮参数。</p>
<p>2）回顾7.2.3提交表单后，rails会利用input的name属性，构建一个名为user的Hash。Hash的键key是name的属性值，键值value是用户填写的文本。</p>
<h2 id="7-3-2-健壮参数strong-parameter"><a href="#7-3-2-健壮参数strong-parameter" class="headerlink" title="7.3.2 健壮参数strong parameter"></a>7.3.2 健壮参数strong parameter</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params.require(:user).permit(:name, :email, :password, :password_confirmation)</span><br></pre></td></tr></table></figure>
<p>1）让params包含:user元素，只允许使用给定的栏位属性。</p>
<p>2）设置为私有方法，private。</p>
<h2 id="7-3-3-注册时的错误提示信息"><a href="#7-3-3-注册时的错误提示信息" class="headerlink" title="7.3.3 注册时的错误提示信息"></a>7.3.3 注册时的错误提示信息</h2><h3 id="【1】针对错误信息的测试，在练习7-6。"><a href="#【1】针对错误信息的测试，在练习7-6。" class="headerlink" title="【1】针对错误信息的测试，在练习7.6。"></a>【1】针对错误信息的测试，在练习7.6。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; user.errors.full_messages</span><br><span class="line">=&gt; [&quot;Email is invalid&quot;, &quot;Password is too short (minimum is 6 characters)&quot;]</span><br></pre></td></tr></table></figure>
<h3 id="【2】在页面显示错误信息，用each打印。"><a href="#【2】在页面显示错误信息，用each打印。" class="headerlink" title="【2】在页面显示错误信息，用each打印。"></a>【2】在页面显示错误信息，用each打印。</h3><p>app/views/users/new.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= render &apos;shared/error_messages&apos; %&gt;</span><br></pre></td></tr></table></figure>
<p>app/views/shared/_error_messages.html.erb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if @user.errors.any? %&gt;</span><br><span class="line">  &lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;alert alert-error&quot;&gt;</span><br><span class="line">      The form contains &lt;%= pluralize(@user.errors.count, &quot;error&quot;) %&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">    &lt;% @user.errors.full_messages.each do |msg| %&gt;</span><br><span class="line">      &lt;li&gt;* &lt;%= msg %&gt;&lt;/li&gt;</span><br><span class="line">    &lt;% end %&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<h3 id="【3】pluralize方法"><a href="#【3】pluralize方法" class="headerlink" title="【3】pluralize方法"></a>【3】pluralize方法</h3><p>用来处理单词的单复数变化。</p>
<p>pluralize方法默认在控制台不可用，可以通过载入TextHelper来使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; include ActionView::Helpers::TextHelper</span><br><span class="line">&gt;&gt; pluralize(1, &quot;error&quot;)</span><br><span class="line">=&gt; &quot;1 error&quot;</span><br><span class="line">&gt;&gt; pluralize(5, &quot;error&quot;)</span><br><span class="line">=&gt; &quot;5 errors&quot;</span><br></pre></td></tr></table></figure>
<h3 id="【4】Sass的-extend函数"><a href="#【4】Sass的-extend函数" class="headerlink" title="【4】Sass的@extend函数"></a>【4】Sass的@extend函数</h3><p>让错误信息显示为红色。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.field_with_errors &#123;</span><br><span class="line">  @extend .control-group;</span><br><span class="line">  @extend .error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-4-2-flash"><a href="#7-4-2-flash" class="headerlink" title="7.4.2 flash"></a>7.4.2 flash</h2><h2 id="7-4-4-部署并开启SSL"><a href="#7-4-4-部署并开启SSL" class="headerlink" title="7.4.4 部署并开启SSL"></a>7.4.4 部署并开启SSL</h2><p>确保注册、登录安全。而且可以避免会话劫持。</p>
<p>1）config/environments/production.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SampleApp::Application.configure do</span><br><span class="line">  config.force_ssl = true</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）为域名安装SSL证书</p>
<ul>
<li>可以购买和安装，比较麻烦。</li>
<li>也可以用heroku提供的二级域名，可以直接使用heroku的SSL证书，好处是方便，坏处是不能使用自己的域名。<a href="http://devcenter.heroku.com/articles/ssl" target="_blank" rel="noopener">http://devcenter.heroku.com/articles/ssl</a></li>
</ul>
<h1 id="第八章"><a href="#第八章" class="headerlink" title="第八章"></a>第八章</h1><p>用户登录和退出功能</p>
<p>目的：rspec测试页面跳转的写法。了解cookie和remember_token的由来和作用，整理代码。sign in、current_user、sign out方法定义，要自己能够写出来。8.3.3和8.5练习，自定义帮助函数和匹配器，进行代码重构。</p>
<h2 id="8-1-session"><a href="#8-1-session" class="headerlink" title="8.1 session"></a>8.1 session</h2><p>session是客户端和服务端的永久性连接，利用session来实现登录功能。</p>
<ul>
<li>选择一，关闭浏览器后清除session。</li>
<li>选择二，记住登录状态，直到用户退出才清除session。</li>
</ul>
<p>session是利用cookie来存储数据的。</p>
<h2 id="8-1-1-session控制器"><a href="#8-1-1-session控制器" class="headerlink" title="8.1.1 session控制器"></a>8.1.1 session控制器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g controller Sessions --no-test-framework</span><br><span class="line">rails g integration_test authentication_pages</span><br></pre></td></tr></table></figure>
<h2 id="8-1-3-创建表单form-for-和-form-tag"><a href="#8-1-3-创建表单form-for-和-form-tag" class="headerlink" title="8.1.3 创建表单form_for 和 form_tag"></a>8.1.3 创建表单form_for 和 form_tag</h2><p>form_for(@user)，rails会向/users地址发送POST请求。在注册表单用到。</p>
<p>form_for(:session, url:session_path)，指明资源名称和相应的URL地址。在登录表单用到，因为没有Session魔兵，也就没有@seesion变量。</p>
<h2 id="8-1-4-分析表单提交"><a href="#8-1-4-分析表单提交" class="headerlink" title="8.1.4 分析表单提交"></a>8.1.4 分析表单提交</h2><p>1）同注册一样，这里的params是一个嵌套Hash，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; session: &#123; password: &quot;&quot;, email: &quot;&quot; &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>所以调用email地址是用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params[:session][:password]</span><br></pre></td></tr></table></figure>
<p>2）create的action写法跟6.1.4节类似，都是找到用户，然后验证用户。</p>
<p>即User.find_by_email，然后由has_secure_password提供的authenticate方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def create</span><br><span class="line">  user = User.find_by(email: params[:session][:email].downcase)</span><br><span class="line">  if user &amp;&amp; user.authenticate(params[:session][:password])</span><br><span class="line">    # Sign the user in and redirect to the user&apos;s show page.</span><br><span class="line">  else</span><br><span class="line">    # Create an error message and re-render the signin form.</span><br><span class="line">  end </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="8-1-5-flash"><a href="#8-1-5-flash" class="headerlink" title="8.1.5 flash"></a>8.1.5 flash</h2><p>flash在一个请求的生命周期里是持续存在的。重新渲染页面用render方法，它不算新的请求。</p>
<p>针对flash没有按预期消失，写测试。</p>
<h2 id="8-2-1-its方法——发现不能用"><a href="#8-2-1-its方法——发现不能用" class="headerlink" title="8.2.1 its方法——发现不能用"></a>8.2.1 its方法——发现不能用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">its(:remember_token) &#123; should_not be_blank &#125;</span><br></pre></td></tr></table></figure>
<p>its测试对象是指定的属性，而it是整个测试对象。上边代码等同于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">it &#123; expect(@user.remember_token).not_to be_blank &#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-2-1-记住我"><a href="#8-2-1-记住我" class="headerlink" title="8.2.1 记住我"></a>8.2.1 记住我</h2><p>1）session控制器提供SessionHelper帮助函数，会自动引入rails中的视图。</p>
<p>默认情况下，帮助函数只能在view中使用，这里要在controller用到，所以要引入</p>
<p>app/controllers/application_controller.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class ApplicationController &lt; ActionController::Base</span><br><span class="line">  protect_from_forgery with: :exception </span><br><span class="line">  include SessionsHelper #引入帮助函数</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>2）记住用户状态的方法：通过session函数，把用户的id保存在<strong>『记忆权标 remember token』</strong>中，即浏览器的cookie中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session[:remember_token] = user.id</span><br></pre></td></tr></table></figure>
<p>在网站的任何页面，调用用户对象，使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.find(session[:remember_token])</span><br></pre></td></tr></table></figure>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fo3dba7chlj30md06jwet.jpg" width="700"></p>
<h2 id="8-3-Cucumber"><a href="#8-3-Cucumber" class="headerlink" title="8.3 Cucumber"></a>8.3 Cucumber</h2><p>cucumber，是一个行为驱动开发BBD工具。</p>
<p>cucumber，使用纯文本语言Gherkin编写故事，描述应用程序的行为。经常是由客户来编写的。但是，对于程序员来说，可能纯文本的故事会很啰嗦。</p>
<p>cucumber，阅读性好，但是却和测试代码分开，同时削弱了功能和测试代码的作用。读起来顺口，但写起来怪怪的。</p>
<p>rspec，读起来不顺口，但写起来容易。</p>
<h2 id="8-3-1-cucumber安装"><a href="#8-3-1-cucumber安装" class="headerlink" title="8.3.1 cucumber安装"></a>8.3.1 cucumber安装</h2><p>1）打开Gemfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">group :development, :test do</span><br><span class="line">  # BDD测试</span><br><span class="line">  gem &apos;cucumber-rails&apos;</span><br><span class="line">  gem &apos;database_cleaner&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>bundle，安装</p>
<p>2）生成文件夹及文件，在app/features</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails generate cucumber:install</span><br></pre></td></tr></table></figure>
<h2 id="8-3-2-cucumber使用案例"><a href="#8-3-2-cucumber使用案例" class="headerlink" title="8.3.2 cucumber使用案例"></a>8.3.2 cucumber使用案例</h2><p>例如针对登录功能做测试：</p>
<p>1）touch features/signing_in.feature，生成放纯文本代码的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Feature: Signing in #文本描述</span><br><span class="line">  Scenario: Unsuccessful signin #登录失败的场景</span><br><span class="line">    Given a user visits the signin page</span><br><span class="line">    When he submits invalid signin information</span><br><span class="line">    Then he should see an error message</span><br><span class="line">  Scenario: Successful signin #登录成功的场景</span><br><span class="line">    Given a user visits the signin page</span><br><span class="line">    And the user has an account</span><br><span class="line">    When the user submits valid signin information</span><br><span class="line">    Then he should see his profile page</span><br><span class="line">	And he should see a signout link</span><br></pre></td></tr></table></figure>
<p>其中，Feature和Scenario的行只作为描述，其余的行要和ruby代码对应。见步骤3）。</p>
<p>2）运行上面功能（和rspec类似）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cucumber features</span><br><span class="line">或</span><br><span class="line">rake cucumber</span><br><span class="line">或</span><br><span class="line">rake cucumber:ok  #鉴于某些原因，经常用这一个</span><br></pre></td></tr></table></figure>
<p>运行结果：测试不通过。</p>
<p>3）让测试通过：</p>
<p>features/step_definitions/authentication_steps.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Given /^a user visits the signin page$/ do</span><br><span class="line">  visit signin_path</span><br><span class="line">end</span><br><span class="line">When /^he submits invalid signin information$/ do</span><br><span class="line">  click_button &quot;Sign in&quot;</span><br><span class="line">end</span><br><span class="line">Then /^he should see an error message$/ do</span><br><span class="line">  expect(page).to have_selector(&apos;div.alert.alert-error&apos;)</span><br><span class="line">end</span><br><span class="line">Given /^the user has an account$/ do</span><br><span class="line">  @user = User.create(name: &quot;Example User&quot;, email: &quot;user@example.com&quot;,</span><br><span class="line">                      password: &quot;foobar&quot;, password_confirmation: &quot;foobar&quot;)</span><br><span class="line">end</span><br><span class="line">When /^the user submits valid signin information$/ do</span><br><span class="line">  fill_in &quot;Email&quot;,    with: @user.email</span><br><span class="line">  fill_in &quot;Password&quot;, with: @user.password</span><br><span class="line">  click_button &quot;Sign in&quot;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">Then /^he should see his profile page$/ do</span><br><span class="line">  expect(page).to have_title(@user.name)</span><br><span class="line">end</span><br><span class="line">Then /^he should see a signout link$/ do</span><br><span class="line">  expect(page).to have_link(&apos;Sign out&apos;, href: signout_path)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="8-3-3"><a href="#8-3-3" class="headerlink" title="8.3.3"></a>8.3.3</h2><h2 id="8-5-练习"><a href="#8-5-练习" class="headerlink" title="8.5 练习"></a>8.5 练习</h2><p>1、什么时候用 form_for 什么时候用 form_tag ？</p>
<p>有对应 Model 的时候用 form_for，没有就用 form_tag，比如搜索框一般没有对应 Model。</p>
<h3 id="2、bug——命令rspec-spec，不能检测到执行单个文件里的bug"><a href="#2、bug——命令rspec-spec，不能检测到执行单个文件里的bug" class="headerlink" title="2、bug——命令rspec spec，不能检测到执行单个文件里的bug"></a>2、bug——命令rspec spec，不能检测到执行单个文件里的bug</h3><p>——所以，测试时修改哪个文件，就执行哪个文件的测试。</p>
<h1 id="第九章"><a href="#第九章" class="headerlink" title="第九章"></a>第九章</h1><p>9.2.1课程bug</p>
<p>9.1、9.2更新个人资料，涉及权限限制。</p>
<p>9.3页面显示所有用户，涉及权限限制。创建示例数据、分页功能。</p>
<p>9.4删除用户，需要创建管理员。</p>
<p>9.5，rspec练习。</p>
<h2 id="9-1-1"><a href="#9-1-1" class="headerlink" title="9.1.1"></a>9.1.1</h2><p>1）rails是怎么知道创建新用户是要发送POST还是PATCH请求呢？</p>
<p>Active Record的new_record?方法。检测这笔资料是否存在于数据库中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rails console</span><br><span class="line">&gt;&gt; User.new.new_record?</span><br><span class="line">=&gt; true</span><br><span class="line">&gt;&gt; User.first.new_record?</span><br><span class="line">=&gt; false</span><br></pre></td></tr></table></figure>
<h2 id="9-2-1-bug"><a href="#9-2-1-bug" class="headerlink" title="9.2.1 bug"></a>9.2.1 bug</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Failure/Error: before &#123; patch user_path(user) &#125;</span><br><span class="line">     NoMethodError:</span><br><span class="line">       undefined method `patch&apos; for #</span><br></pre></td></tr></table></figure>
<p>原因：代码<code>before { patch user_path(user) }</code>里的patch，以及其他get、put、delete，只能用在rspece的type是request的文件中。现在我用的是feature，所以报错。</p>
<p>参考资料：<a href="https://stackoverflow.com/questions/18289463/undefined-method-patch-for-rspeccore-rails-tutorial-chapter-9" target="_blank" rel="noopener">https://stackoverflow.com/questions/18289463/undefined-method-patch-for-rspeccore-rails-tutorial-chapter-9</a></p>
<h2 id="9-2-3-gem-‘fake’创建示例数据"><a href="#9-2-3-gem-‘fake’创建示例数据" class="headerlink" title="9.2.3 gem ‘fake’创建示例数据"></a>9.2.3 gem ‘fake’创建示例数据</h2><p>Gemfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;faker&apos;</span><br></pre></td></tr></table></figure>
<p>lib/tasks/sample_data.rake</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">namespace :db do</span><br><span class="line">  desc &quot;Fill database with sample data&quot;</span><br><span class="line">  task populate: :environment do #确保rails任务可以获取rails环境的信息。</span><br><span class="line">    User.create!(name: &quot;Example User&quot;,  #用create!如果不合法会返回false，容易debug。</span><br><span class="line">                 email: &quot;example@railstutorial.org&quot;,</span><br><span class="line">                 password: &quot;foobar&quot;,</span><br><span class="line">                 password_confirmation: &quot;foobar&quot;,</span><br><span class="line">                 admin: true)</span><br><span class="line">    99.times do |n|</span><br><span class="line">      name  = Faker::Name.name</span><br><span class="line">      email = &quot;example-#&#123;n+1&#125;@railstutorial.org&quot;</span><br><span class="line">      password  = &quot;password&quot;</span><br><span class="line">      User.create!(name: name,</span><br><span class="line">                   email: email,</span><br><span class="line">                   password: password,</span><br><span class="line">                   password_confirmation: password)</span><br><span class="line">    end </span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rake db:reset</span><br><span class="line">rake db:populate</span><br><span class="line">rails db:migrate RAILS_ENV=test</span><br></pre></td></tr></table></figure>
<h2 id="9-3-2-分页、rspec中创建示例数据（factorybot的sequence）"><a href="#9-3-2-分页、rspec中创建示例数据（factorybot的sequence）" class="headerlink" title="9.3.2 分页、rspec中创建示例数据（factorybot的sequence）"></a>9.3.2 分页、rspec中创建示例数据（factorybot的sequence）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;will_paginate&apos;</span><br><span class="line">gem &apos;bootstrap-will_paginate&apos;</span><br></pre></td></tr></table></figure>
<h1 id="第十章"><a href="#第十章" class="headerlink" title="第十章"></a>第十章</h1><p>微博的resources（前面章节是用户的resources）</p>
<p>has_many和belongs_to</p>
<h2 id="10-1-3-课程bug"><a href="#10-1-3-课程bug" class="headerlink" title="10.1.3 课程bug"></a>10.1.3 课程bug</h2><h3 id="bug：rails-tutorial-Chapter-10-undefined-method-its’-for-RSpec"><a href="#bug：rails-tutorial-Chapter-10-undefined-method-its’-for-RSpec" class="headerlink" title="bug：rails tutorial Chapter 10  undefined method `its’ for RSpec"></a>bug：rails tutorial Chapter 10  undefined method `its’ for RSpec</h3><h3 id="解决办法：-1"><a href="#解决办法：-1" class="headerlink" title="解决办法："></a>解决办法：</h3><p>新版本的rspec不支持its语法，要安装这个gem才能使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;rspec-its&apos;</span><br></pre></td></tr></table></figure>
<p>参考资料：<a href="https://stackoverflow.com/questions/28014000/undefined-method-its-for-rspec-hartls-ruby-on-rails-tutorial" target="_blank" rel="noopener">https://stackoverflow.com/questions/28014000/undefined-method-its-for-rspec-hartls-ruby-on-rails-tutorial</a></p>
<h2 id="10-1-4"><a href="#10-1-4" class="headerlink" title="10.1.4"></a>10.1.4</h2><p>User.where(1)，没有查询到会返回nil。</p>
<p>User.find_by(1)，跟where一样，没有查询到会返回nil。</p>
<p>User.find(1)，没有查询到会bug报错。类似于!方法。</p>
<h2 id="10-2-2-课程bug"><a href="#10-2-2-课程bug" class="headerlink" title="10.2.2 课程bug"></a>10.2.2 课程bug</h2><h3 id="bug-rails-tutorial-chapter10-ArgumentError-wrong-number-of-arguments-given-1-expected-0"><a href="#bug-rails-tutorial-chapter10-ArgumentError-wrong-number-of-arguments-given-1-expected-0" class="headerlink" title="bug: rails tutorial chapter10 ArgumentError: wrong number of arguments (given 1, expected 0)"></a>bug: rails tutorial chapter10 ArgumentError: wrong number of arguments (given 1, expected 0)</h3><h3 id="解决办法：-2"><a href="#解决办法：-2" class="headerlink" title="解决办法："></a>解决办法：</h3><p>打开lib/tasks/sample_data.rake，把<code>users = User.all.limit(6)</code>改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">users = User.limit(6)</span><br></pre></td></tr></table></figure>
<p>参考资料：<a href="https://stackoverflow.com/questions/23749612/wrong-number-of-arguments-1-for-0-hartl-chapter-10-bundle-exec-rake-dbpopul" target="_blank" rel="noopener">https://stackoverflow.com/questions/23749612/wrong-number-of-arguments-1-for-0-hartl-chapter-10-bundle-exec-rake-dbpopul</a></p>
<h2 id="10-3-2-课程bug，同上新文件要引入共用文件"><a href="#10-3-2-课程bug，同上新文件要引入共用文件" class="headerlink" title="10.3.2 课程bug，同上新文件要引入共用文件"></a>10.3.2 课程bug，同上新文件要引入共用文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Failure/Error: before &#123; sign_in user &#125;</span><br><span class="line"></span><br><span class="line">     NoMethodError:</span><br><span class="line">       undefined method `sign_in&apos; for #&lt;RSpec::ExampleGroups::MicropostPages::MicropostCreation::WithValidInformation:0x007fb44e1acea8&gt;</span><br></pre></td></tr></table></figure>
<h3 id="解决办法：-3"><a href="#解决办法：-3" class="headerlink" title="解决办法："></a>解决办法：</h3><p>spec/requests/micropost_pages_spec.rb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require &apos;support/utilities.rb&apos;</span><br></pre></td></tr></table></figure>
<h2 id="10-3-3-课程bug"><a href="#10-3-3-课程bug" class="headerlink" title="10.3.3 课程bug"></a>10.3.3 课程bug</h2><p>bug：执行<code>rspec spec/models/user_spec.rb</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">An error occurred while loading ./spec/models/user_spec.rb.</span><br><span class="line">Failure/Error: load file</span><br><span class="line"></span><br><span class="line">SyntaxError:</span><br><span class="line">  /Users/apple/rails/sys-sample_app/spec/models/user_spec.rb:138: syntax error, unexpected tIDENTIFIER, expecting keyword_end</span><br><span class="line">      its(:feed) &#123; should include(newe...</span><br><span class="line">  ...                               ^</span><br><span class="line">  /Users/apple/rails/sys-sample_app/spec/models/user_spec.rb:138: syntax error, unexpected tIDENTIFIER, expecting keyword_end</span><br><span class="line">      its(:feed) &#123; should include(olde...</span><br><span class="line">  ...                               ^</span><br><span class="line">  /Users/apple/rails/sys-sample_app/spec/models/user_spec.rb:138: syntax error, unexpected tIDENTIFIER, expecting keyword_end</span><br><span class="line">      its(:feed) &#123; should_not include(...</span><br></pre></td></tr></table></figure>
<h3 id="解决办法：-4"><a href="#解决办法：-4" class="headerlink" title="解决办法："></a>解决办法：</h3><p>把测试从以下块中移出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;micropost associations&quot; do</span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>然后单独作为一个块。重新执行<code>rspec spec/models/user_spec.rb</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe &quot;status&quot; do</span><br><span class="line">  before &#123; @user.save &#125;</span><br><span class="line">  let!(:older_micropost) do</span><br><span class="line">    FactoryGirl.create(:micropost, user: @user, created_at: 1.day.ago)</span><br><span class="line">  end</span><br><span class="line">  let!(:newer_micropost) do</span><br><span class="line">    FactoryGirl.create(:micropost, user: @user, created_at: 1.hour.ago)</span><br><span class="line">  end</span><br><span class="line">  let(:unfollowed_post) do</span><br><span class="line">    FactoryGirl.create(:micropost, user: FactoryGirl.create(:user))</span><br><span class="line">  end</span><br><span class="line">  its(:feed) &#123; should include(newer_micropost) &#125;</span><br><span class="line">  its(:feed) &#123; should include(older_micropost) &#125;</span><br><span class="line">  its(:feed) &#123; should_not include(unfollowed_post) &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h1 id="第十一章"><a href="#第十一章" class="headerlink" title="第十一章"></a>第十一章</h1><p>关注或取消关注</p>
<p>首页动态显示已关注用户的微博更新</p>
<p>views-已关注的用户列表</p>
<p>views-粉丝列表</p>
<h2 id="11-2-5课程bug"><a href="#11-2-5课程bug" class="headerlink" title="11.2.5课程bug"></a>11.2.5课程bug</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Failures:</span><br><span class="line"></span><br><span class="line">  1) RelationshipsController creating a relationship with Ajax should increment the Relationship count</span><br><span class="line">     Failure/Error: cookies[:remember_token] = remember_token user.update_attribute(:remember_token, User.encrypt(remember_token))</span><br><span class="line"></span><br><span class="line">     NoMethodError:</span><br><span class="line">       undefined method `remember_token&apos; for #&lt;RSpec::ExampleGroups::RelationshipsController::CreatingARelationshipWithAjax:0x007f836346bcf0&gt;</span><br><span class="line">     # ./spec/support/utilities.rb:29:in `sign_in&apos;</span><br><span class="line">     # ./spec/controllers/relationships_controller_spec.rb:7:in `block (2 levels) in &lt;top (required)&gt;&apos;</span><br></pre></td></tr></table></figure>
<h3 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h3><p>跟上边的教材一样，没有require引入共用文件。</p>
<h3 id="解决办法：-5"><a href="#解决办法：-5" class="headerlink" title="解决办法："></a>解决办法：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">by 99</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/posts/72ed4d05/" class="pre-post btn btn-default"><i class="fa fa-angle-left fa-fw"></i>上一篇</a>
    
    
        <a href="/posts/47bfe85d/" class="next-post btn btn-default">下一篇<i class="fa fa-angle-right fa-fw"></i></a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMzE1My85NzEx">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>


            </main>
            
    <aside class="col-md-3 sidebar">
        
        
    <div class="widget">
        <h3 class="title">Search</h3>
        <div id="search-form">
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?">
                    <button type="button" class="search-form-submit" id="search-local">搜索</button>
                
                
            </div>
            <div id="result-wrap" class="hide">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        
        
    <div class="widget notification">
        <h3 class="title">网站公告</h3>
        <div>
            <p>你好，我是99。<br/>欢迎来到我的博客。<br/>
<br/>
<hr/>接受贡献，包括不限于提交问题与需求，修复代码。欢迎Pull Request<br/>支持主题：<a href="https://github.com/shenliyang/hexo-theme-snippet/stargazers">Star一下</a>
</p>
        </div>
    </div>

        
        
    <div class="widget">
      <h3 class="title">Social</h3> 
        <div class="content social">
            
	            <a href="https://github.com/jiujiubad?tab=repositories" rel="external nofollow" title="Github" target="_blank">
			    	<i class="github fa fa-github"></i>
			    </a>
            
	            <a href="jiujiubad@gmail.com" rel="external nofollow" title="邮箱" target="_blank">
			    	<i class="envelope-o fa fa-envelope-o"></i>
			    </a>
            
	            <a href="https://ws4.sinaimg.cn/large/006tNc79ly1fnvcxiavzgj30by0bymxg.jpg" rel="external nofollow" title="微信" target="_blank">
			    	<i class="weixin fa fa-weixin"></i>
			    </a>
            
        </div>
    </div>


        
        
    <div class="widget">
        <h3 class="title">Categories</h3>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ror功能/"><i class="fa" aria-hidden="true">ror功能</i></a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ror知识点/"><i class="fa" aria-hidden="true">ror知识点</i></a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ror系统/"><i class="fa" aria-hidden="true">ror系统</i></a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web页面/"><i class="fa" aria-hidden="true">web页面</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/"><i class="fa" aria-hidden="true">工具</i></a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信小程序/"><i class="fa" aria-hidden="true">微信小程序</i></a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link current" href="/categories/心得/"><i class="fa" aria-hidden="true">心得</i></a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/投资/"><i class="fa" aria-hidden="true">投资</i></a><span class="category-list-count">1</span></li></ul>
    </div>


        
        
    <div class="widget">
      <h3 class="title">Archives</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/"><i class="fa" aria-hidden="true">March 2018</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/"><i class="fa" aria-hidden="true">February 2018</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/"><i class="fa" aria-hidden="true">January 2018</i></a><span class="archive-list-count">37</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/"><i class="fa" aria-hidden="true">December 2017</i></a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/"><i class="fa" aria-hidden="true">November 2017</i></a><span class="archive-list-count">36</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/"><i class="fa" aria-hidden="true">September 2017</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/"><i class="fa" aria-hidden="true">April 2017</i></a><span class="archive-list-count">1</span></li></ul>
    </div>


        
        
  <div class="widget">
    <h3 class="title">Tag Cloud</h3>
    <div class="content tag-cloud">
        <a href="/tags/atom/" style="font-size: 13.08px;">atom</a> <a href="/tags/bug/" style="font-size: 17.69px;">bug</a> <a href="/tags/heroku/" style="font-size: 10px;">heroku</a> <a href="/tags/hexo/" style="font-size: 11.54px;">hexo</a> <a href="/tags/interview/" style="font-size: 13.85px;">interview</a> <a href="/tags/mac/" style="font-size: 11.54px;">mac</a> <a href="/tags/orid-day/" style="font-size: 10.77px;">orid-day</a> <a href="/tags/orid-month/" style="font-size: 11.54px;">orid-month</a> <a href="/tags/ror功能/" style="font-size: 13.08px;">ror功能</a> <a href="/tags/ror知识点/" style="font-size: 16.92px;">ror知识点</a> <a href="/tags/ror系统/" style="font-size: 20px;">ror系统</a> <a href="/tags/stackoverflow/" style="font-size: 10px;">stackoverflow</a> <a href="/tags/typora/" style="font-size: 10px;">typora</a> <a href="/tags/vps/" style="font-size: 16.15px;">vps</a> <a href="/tags/web页面/" style="font-size: 11.54px;">web页面</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/工具/" style="font-size: 19.23px;">工具</a> <a href="/tags/常用/" style="font-size: 13.08px;">常用</a> <a href="/tags/微信功能/" style="font-size: 12.31px;">微信功能</a> <a href="/tags/微信系统/" style="font-size: 15.38px;">微信系统</a> <a href="/tags/微信页面/" style="font-size: 10.77px;">微信页面</a> <a href="/tags/心得/" style="font-size: 18.46px;">心得</a> <a href="/tags/手机/" style="font-size: 10px;">手机</a> <a href="/tags/投资/" style="font-size: 10px;">投资</a> <a href="/tags/搬砖/" style="font-size: 10px;">搬砖</a> <a href="/tags/核聚编程/" style="font-size: 14.62px;">核聚编程</a> <a href="/tags/科学上网/" style="font-size: 13.08px;">科学上网</a> <a href="/tags/部署/" style="font-size: 12.31px;">部署</a>
    </div>
  </div>


        
        
    <div class="widget">
        <h3 class="title">Friends</h3>
        <div class="content friends-link">
        
            <a href="http://www.shenliyang.com" class="fa" target="_blank">个人博客</a>
        
        </div>
    </div>


        
    </aside>


        </div>
      </section>
    </div>
  </div>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <span>Copyright &copy; 2018
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



	<script src="/js/search.js?rev=@@hash"></script>


<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>
