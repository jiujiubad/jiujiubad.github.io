<!DOCTYPE HTML>
<html>
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>ror-system-rails guides 1-5 | Hexo</title>


    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css?rev=3.3.4">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
    <div class="hide">
    	<script src="https://s4.cnzz.com/z_stat.php?id=1263868967&web_id=1263868967" language="JavaScript"></script>
    </div>






    
</head>

<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
  <div class="container-fluid">
    <div class="row">
      <header class="main-header"  style="background-image:url(http://7xpw2b.com1.z0.glb.clouddn.com/hexo-sinppet/img/banner2.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="">
            <img src="/img/avatar.jpg" alt="logo头像">
        </a>
        <div class="branding1">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 记录，把握点滴  ——by 99 </h2>
            
    	</div>
    </div>
</header>

      <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only">Toggle navigation</span>
                    <i class="fa fa-bars"></i>
                    </span>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>主页</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/archives/"><i class="fa fa-fw "></i>所有</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/posts/d16694c4/"><i class="fa fa-fw "></i>标题</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/ror系统/"><i class="fa fa-fw "></i>ror系统</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/微信小程序/"><i class="fa fa-fw "></i>微信小程序</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>关于我</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

      <section class="content-wra aa99">
        <!-- <div class="row">
          
    <div class="widget" style="padding:0 15px;">
        <div id="search-form" > 
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?" style="width:100%;border-radius:0;">

                
                
            </div>
            <div id="result-wrap" class="hide" style="padding:0 20px;">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        </div> -->
        <div class="row">
            <main class="col-md-9 main-content m-post">
                <p id="process"></p>
<article class="post pp99">
    <div class="post-head">
        <h1 id="ror-system-rails guides 1-5">
            
	            ror-system-rails guides 1-5
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <span>ror系统</span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            ror系统
            
        </span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">2017/12/14</span>
    </span>
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <h1 id="一、Active-Record-基础"><a href="#一、Active-Record-基础" class="headerlink" title="一、Active Record 基础"></a>一、Active Record 基础</h1><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1flbn2zjutlj31kw0ykqgc.jpg" alt=""></p>
<h3 id="1-Active-Record-是什么？"><a href="#1-Active-Record-是什么？" class="headerlink" title="1 Active Record 是什么？"></a>1 Active Record 是什么？</h3><ul>
<li>Active Record 是 <a href="http://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller" target="_blank" rel="noopener">MVC</a> 中的 M（模型），负责处理数据和业务逻辑，是一种对象关系映射系统。</li>
</ul>
<h3 id="2-Active-Record-中的“多约定少配置”原则"><a href="#2-Active-Record-中的“多约定少配置”原则" class="headerlink" title="2 Active Record 中的“多约定少配置”原则"></a>2 Active Record 中的“多约定少配置”原则</h3><h4 id="2-1-命名约定"><a href="#2-1-命名约定" class="headerlink" title="2.1 命名约定"></a>2.1 命名约定</h4><ul>
<li>数据库表名：复数，下划线分隔单词（例如 <code>book_clubs</code>）</li>
<li>模型类名：单数，每个单词的首字母大写（例如 <code>BookClub</code>）</li>
</ul>
<table>
<thead>
<tr>
<th>模型/类</th>
<th>表/模式</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Article</code></td>
<td><code>articles</code></td>
</tr>
<tr>
<td><code>LineItem</code></td>
<td><code>line_items</code></td>
</tr>
<tr>
<td><code>Deer</code></td>
<td><code>deers</code></td>
</tr>
<tr>
<td><code>Mouse</code></td>
<td><code>mice</code></td>
</tr>
<tr>
<td><code>Person</code></td>
<td><code>people</code></td>
</tr>
</tbody>
</table>
<h4 id="2-2-模式约定"><a href="#2-2-模式约定" class="headerlink" title="2.2 模式约定"></a>2.2 模式约定</h4><ul>
<li>主键和外键</li>
</ul>
<h3 id="3-创建-Active-Record-模型"><a href="#3-创建-Active-Record-模型" class="headerlink" title="3 创建 Active Record 模型"></a>3 创建 Active Record 模型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class Product &lt; ApplicationRecord</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>上面的代码会创建 <code>Product</code> 模型，对应于数据库中的 <code>products</code> 表。同时，<code>products</code> 表中的字段也映射到 <code>Product</code> 模型实例的属性上。</li>
</ul>
<h3 id="4-覆盖命名约定"><a href="#4-覆盖命名约定" class="headerlink" title="4 覆盖命名约定"></a>4 覆盖命名约定</h3><ul>
<li>.table_name= 方法可以指定要使用的表名。如果这么做，还要调用 set_fixture_class 方法，手动指定固件（my_products.yml）的类名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Product &lt; ApplicationRecord</span><br><span class="line">  self.table_name = &quot;my_products&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class ProductTest &lt; ActiveSupport::TestCase</span><br><span class="line">  set_fixture_class my_products: Product</span><br><span class="line">  fixtures :my_products</span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>.primary_key= 方法指定表的主键</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Product &lt; ApplicationRecord</span><br><span class="line">  self.primary_key = &quot;product_id&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="5-CRUD：读写数据"><a href="#5-CRUD：读写数据" class="headerlink" title="5 CRUD：读写数据"></a>5 CRUD：读写数据</h3><h4 id="5-1-创建"><a href="#5-1-创建" class="headerlink" title="5.1 创建"></a>5.1 创建</h4><p><code>new</code> 方法创建一个新对象，<code>create</code> 方法创建新对象，并将其存入数据库。调用 <code>user.save</code> 可以把记录存入数据库。</p>
<h4 id="5-2-读取"><a href="#5-2-读取" class="headerlink" title="5.2 读取"></a>5.2 读取</h4><ul>
<li>Active Record 为读取数据库中的数据提供了丰富的 API，如.all、.first等。</li>
</ul>
<ul>
<li>find、find_by、where三种查询API的区别？<ul>
<li>find是找一个或多个id</li>
<li><code>david = User.find_by(name: &#39;David&#39;)</code>，查找返回第一个名为 David 的用户</li>
<li><code>users = User.where(name: &#39;David&#39;)</code>，查找所有名为 David的用户</li>
</ul>
</li>
</ul>
<h4 id="5-3-更新"><a href="#5-3-更新" class="headerlink" title="5.3 更新"></a>5.3 更新</h4><ul>
<li><code>user.name = &#39;Dave&#39;</code> <code>user.save</code>，相当于是<code>user.update(name: &#39;Dave&#39;)</code></li>
<li>量更新多个记录<code>User.update_all &quot;max_login_attempts = 3, must_change_password = &#39;true&#39;&quot;</code></li>
</ul>
<h4 id="5-4-删除"><a href="#5-4-删除" class="headerlink" title="5.4 删除"></a>5.4 删除</h4><p><code>user.destroy</code></p>
<h3 id="6-数据验证"><a href="#6-数据验证" class="headerlink" title="6 数据验证"></a>6 数据验证</h3><p>在存入数据库之前，Active Record 还可以验证模型。模型验证有很多方法，可以检查属性值是否不为空，是否是唯一的、没有在数据库中出现过，等等。</p>
<h3 id="7-回调"><a href="#7-回调" class="headerlink" title="7 回调"></a>7 回调</h3><p>Active Record 回调用于在模型生命周期的特定事件上绑定代码，相应的事件发生时，执行绑定的代码。例如创建新纪录时、更新记录时、删除记录时，等等</p>
<h3 id="8-迁移"><a href="#8-迁移" class="headerlink" title="8 迁移"></a>8 迁移</h3><p>Rails 提供了一个 DSL（Domain-Specific Language）用来处理数据库模式，叫做“迁移”。迁移的代码存储在特定的文件中，通过 <code>rails</code> 命令执行，可以用在 Active Record 支持的所有数据库上。</p>
<h1 id="二、Active-Record-迁移"><a href="#二、Active-Record-迁移" class="headerlink" title="二、Active Record 迁移"></a>二、Active Record 迁移</h1><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1flbngdowrlj31kw1084cd.jpg" alt=""></p>
<h3 id="1-迁移概述"><a href="#1-迁移概述" class="headerlink" title="1 迁移概述"></a>1 迁移概述</h3><ul>
<li>迁移是以一致和轻松的方式按时间顺序修改数据库模式的实用方法。它使用 Ruby DSL，因此不必手动编写 SQL。<ul>
<li>可以把迁移看做数据库的新“版本”。数据库模式一开始并不包含任何内容，之后通过一个个迁移来添加或删除数据表、字段和记录。 </li>
<li>Active Record 还会更新 <code>db/schema.rb</code> 文件，以匹配最新的数据库结构。</li>
</ul>
</li>
<li>如果想在迁移中完成一些 Active Record 不知如何撤销的操作，可以使用 <code>reversible do |dir|</code> 方法，或者用 <code>def up</code> 和 <code>def down</code> 方法来代替 <code>change</code> 方法</li>
</ul>
<h3 id="2-创建迁移"><a href="#2-创建迁移" class="headerlink" title="2 创建迁移"></a>2 创建迁移</h3><h4 id="2-1-创建独立的迁移"><a href="#2-1-创建独立的迁移" class="headerlink" title="2.1 创建独立的迁移"></a>2.1 创建独立的迁移</h4><ul>
<li><p><code>rails generate migration</code>，会创建空的迁移，并进行适当命名。</p>
<ul>
<li><p><code>rails generate migration xxx:string:index</code></p>
</li>
<li><p>如果迁移名称是 <code>AddXXXToYYY</code> 或 <code>RemoveXXXFromYYY</code> 的形式，并且后面跟着字段名和类型列表，那么会生成包含合适的 <code>add_column</code> 或 <code>remove_column</code> <strong>语句的迁移（用于补充栏位）</strong>。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rails generate migration RemovePartNumberFromProducts part_number:string</span><br><span class="line"></span><br><span class="line">class RemovePartNumberFromProducts &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    remove_column :products, :part_number, :string</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果迁移名称是 <code>CreateXXX</code> 的形式，并且后面跟着字段名和类型列表，那么会生成用于创建包含指定字段的 <code>XXX</code> <strong>数据表的迁移</strong>。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rails generate migration CreateProducts name:string part_number:string</span><br><span class="line"></span><br><span class="line">class CreateProducts &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :products do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.string :part_number</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>其他数据表</p>
<ul>
<li><p><code>references</code> 字段类型作为参数（还可使用 <code>belongs_to</code>）。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rails generate migration AddUserRefToProducts user:references</span><br><span class="line"></span><br><span class="line">class AddUserRefToProducts &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    add_reference :products, :user, foreign_key: true</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果迁移名称中包含 <code>JoinTable</code>，生成器会创建联结数据表。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rails g migration CreateJoinTableCustomerProduct customer product</span><br><span class="line"></span><br><span class="line">class CreateJoinTableCustomerProduct &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_join_table :customers, :products do |t|</span><br><span class="line">      # t.index [:customer_id, :product_id]</span><br><span class="line">      # t.index [:product_id, :customer_id]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="2-2-模型生成器"><a href="#2-2-模型生成器" class="headerlink" title="2.2 模型生成器"></a>2.2 模型生成器</h4><ul>
<li><p>什么是脚手架生成器？</p>
<p>在项目最开始的时候，就帮你搭建好架子，脚手架工具会生成好一些基本代码，一般是遵循MVC结构代码。比如生成好 struts+spring+hibernate 三个框架整合好的脚手架代码，会包含一下简单的CRUD代码、数据源、视图层等等项目中很常用的。</p>
</li>
<li><p>模型和脚手架生成器会生成适用于添加新模型的迁移。在<code>rails g migration xxx:xxx</code>添加字段名称:类型,那么添加这些字段所需的语句也会被创建。</p>
</li>
</ul>
<h4 id="2-3-传递类型修饰符"><a href="#2-3-传递类型修饰符" class="headerlink" title="2.3 传递类型修饰符"></a>2.3 传递<a href="https://ruby-china.github.io/rails-guides/active_record_migrations.html#column-modifiers" target="_blank" rel="noopener">类型修饰符</a></h4><ul>
<li><p>这些类型修饰符用大括号括起来，放在字段类型之后。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rails generate migration AddDetailsToProducts &apos;price:decimal&#123;5,2&#125;&apos; supplier:references&#123;polymorphic&#125;</span><br><span class="line"></span><br><span class="line">class AddDetailsToProducts &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    add_column :products, :price, :decimal, precision: 5, scale: 2</span><br><span class="line">    add_reference :products, :supplier, polymorphic: true</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-编写迁移"><a href="#3-编写迁移" class="headerlink" title="3 编写迁移"></a>3 编写迁移</h3><h2 id="三、Active-Record-数据验证"><a href="#三、Active-Record-数据验证" class="headerlink" title="三、Active Record 数据验证"></a>三、Active Record 数据验证</h2><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1flbtsis34sj31kw0zd7ln.jpg" alt=""></p>
<h3 id="2-数据验证辅助方法"><a href="#2-数据验证辅助方法" class="headerlink" title="2 数据验证辅助方法"></a>2 数据验证辅助方法</h3><h4 id="2-11-uniqueness"><a href="#2-11-uniqueness" class="headerlink" title="2.11 uniqueness"></a>2.11 <code>uniqueness</code></h4><ul>
<li>这个辅助方法在保存对象之前验证属性值是否是唯一的。</li>
</ul>
<h3 id="3-常用的验证选项"><a href="#3-常用的验证选项" class="headerlink" title="3 常用的验证选项"></a>3 常用的验证选项</h3><h4 id="3-1、allow-nil"><a href="#3-1、allow-nil" class="headerlink" title="3-1、allow_nil"></a>3-1、allow_nil</h4><ul>
<li>如果要验证的值为 <code>nil</code> 就跳过验证。</li>
</ul>
<h4 id="3-2、-allow-blank"><a href="#3-2、-allow-blank" class="headerlink" title="3-2、 :allow_blank"></a>3-2、 <code>:allow_blank</code></h4><ul>
<li>如果要验证的值为空（调用 <code>blank?</code> 方法判断，例如 <code>nil</code> 或空字符串），就跳过验证。</li>
</ul>
<h4 id="3-3、-message"><a href="#3-3、-message" class="headerlink" title="3-3、 :message"></a>3-3、 <code>:message</code></h4><h4 id="3-4、-on-选项指定什么时候验证。"><a href="#3-4、-on-选项指定什么时候验证。" class="headerlink" title="3-4、:on 选项指定什么时候验证。"></a>3-4、<code>:on</code> 选项指定什么时候验证。</h4><ul>
<li><p><code>on: :create</code>，指定只在创建记录时验证；或者使用 <code>on: :update</code>，指定只在更新记录时验证。</p>
<ul>
<li>还可以使用 <code>on:</code> 定义自定义的上下文。必须把上下文的名称传给 <code>valid?</code>、<code>invalid?</code> 或 <code>save</code> 才能触发自定义的上下文。</li>
</ul>
<p>​</p>
</li>
</ul>
<h3 id="4-严格验证"><a href="#4-严格验证" class="headerlink" title="4 严格验证"></a>4 严格验证</h3><ul>
<li><p>当对象无效时抛出 <code>ActiveModel::StrictValidationFailed</code> 异常。还可以通过 <code>:strict</code> 选项指定抛出什么异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  validates :token, presence: true, uniqueness: true, strict: TokenGenerationException</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">Person.new.valid?  # =&gt; TokenGenerationException: Token can&apos;t be blank</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="5-条件验证"><a href="#5-条件验证" class="headerlink" title="5 条件验证"></a>5 条件验证</h3><ul>
<li><code>:if</code> 和 <code>:unless</code> 选项指定，这两个选项的值可以是符号、字符串、<code>Proc</code> 或数组。<code>:if</code> 选项指定何时做验证。如果要指定何时不做验证，使用 <code>:unless</code> 选项。</li>
</ul>
<h4 id="5-1-使用符号"><a href="#5-1-使用符号" class="headerlink" title="5.1 使用符号"></a>5.1 使用符号</h4><ul>
<li>表示要在验证之前执行对应的方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validates :card_number, presence: true, if: :paid_with_card?</span><br></pre></td></tr></table></figure>
<h4 id="5-2-使用-Proc"><a href="#5-2-使用-Proc" class="headerlink" title="5.2 使用 Proc"></a>5.2 使用 Proc</h4><ul>
<li>使用 Proc 对象可以在行间编写条件，不用定义额外的方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Account &lt; ApplicationRecord</span><br><span class="line">  validates :password, confirmation: true,</span><br><span class="line">    unless: Proc.new &#123; |a| a.password.blank? &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="5-3-条件组合"><a href="#5-3-条件组合" class="headerlink" title="5.3 条件组合"></a>5.3 条件组合</h4><ul>
<li>同一个条件会用在多个验证上，这时可以使用 <code>with_options</code> 方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ApplicationRecord</span><br><span class="line">  with_options if: :is_admin? do |admin|</span><br><span class="line">    admin.validates :password, length: &#123; minimum: 10 &#125;</span><br><span class="line">    admin.validates :email, presence: true</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<h4 id="5-4-联合条件"><a href="#5-4-联合条件" class="headerlink" title="5.4 联合条件"></a>5.4 联合条件</h4><ul>
<li>如果是否做某个验证要满足多个条件时，可以使用数组。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Computer &lt; ApplicationRecord</span><br><span class="line">  validates :mouse, presence: true,</span><br><span class="line">                    if: [&quot;market.retail?&quot;, :desktop?],</span><br><span class="line">                    unless: Proc.new &#123; |c| c.trackpad.present? &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="6-自定义验证"><a href="#6-自定义验证" class="headerlink" title="6 自定义验证"></a>6 自定义验证</h3><h4 id="6-1-自定义验证类-class"><a href="#6-1-自定义验证类-class" class="headerlink" title="6.1 自定义验证类(class)"></a>6.1 自定义验证类(class)</h4><ul>
<li><p>自定义的验证类继承自 <code>ActiveModel::Validator</code>，必须实现 <code>validate</code> 方法，其参数是要验证的记录，然后验证这个记录是否有效。自定义的验证类通过 <code>validates_with</code> 方法调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class MyValidator &lt; ActiveModel::Validator</span><br><span class="line">  def validate(record)</span><br><span class="line">    unless record.name.starts_with? &apos;X&apos;</span><br><span class="line">      record.errors[:name] &lt;&lt; &apos;Need a name starting with X please!&apos;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Person</span><br><span class="line">  include ActiveModel::Validations</span><br><span class="line">  validates_with MyValidator</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>在自定义的验证类中验证单个属性，最简单的方法是继承 <code>ActiveModel::EachValidator</code> 类。此时，自定义的验证类必须实现 <code>validate_each</code> 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class EmailValidator &lt; ActiveModel::EachValidator</span><br><span class="line">  def validate_each(record, attribute, value)</span><br><span class="line">    unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]&#123;2,&#125;)\z/i</span><br><span class="line">      record.errors[attribute] &lt;&lt; (options[:message] || &quot;is not an email&quot;)</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  validates :email, presence: true, email: true</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="6-2-自定义验证方法"><a href="#6-2-自定义验证方法" class="headerlink" title="6.2 自定义验证方法"></a>6.2 自定义验证方法</h4><ul>
<li><p>验证方法必须使用类方法 <code>validate</code>（<a href="http://api.rubyonrails.org/v5.1.1/classes/ActiveModel/Validations/ClassMethods.html#method-i-validate" target="_blank" rel="noopener">API</a>）注册，传入自定义验证方法名的符号形式。</p>
</li>
<li><p>自定义的验证方法会按照注册的顺序执行。</p>
</li>
<li><p>使用 <code>validate</code> 方法注册自定义验证方法时可以设置 <code>:on</code> 选项，指定什么时候验证。<code>:on</code> 的可选值为 <code>:create</code> 和 <code>:update</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Invoice &lt; ApplicationRecord</span><br><span class="line">  validate :active_customer, on: :create</span><br><span class="line"> </span><br><span class="line">  def active_customer</span><br><span class="line">    errors.add(:customer_id, &quot;is not active&quot;) unless customer.active?</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="7-处理验证错误"><a href="#7-处理验证错误" class="headerlink" title="7 处理验证错误"></a>7 处理验证错误</h3><h4 id="7-1-errors"><a href="#7-1-errors" class="headerlink" title="7.1 errors"></a>7.1 <code>errors</code></h4><ul>
<li><p><code>person.errors.messages # =&gt; {}</code>，键是每个属性的名称，值是一个数组，包含错误消息字符串。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  validates :name, presence: true, length: &#123; minimum: 3 &#125;</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">person = Person.new(name: &quot;John Doe&quot;)</span><br><span class="line">person.valid? # =&gt; true</span><br><span class="line">person.errors.messages # =&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="7-2-errors"><a href="#7-2-errors" class="headerlink" title="7.2 errors[]"></a>7.2 <code>errors[]</code></h4><ul>
<li><p>如上代码，<code>errors[]</code> 用于获取某个属性上的错误消息，返回结果是一个由该属性所有错误消息字符串组成的数组，每个字符串表示一个错误消息。如果字段上没有错误，则返回空数组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  validates :name, presence: true, length: &#123; minimum: 3 &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">person = Person.new</span><br><span class="line">person.valid? # =&gt; false</span><br><span class="line">person.errors[:name]</span><br><span class="line"> # =&gt; [&quot;can&apos;t be blank&quot;, &quot;is too short (minimum is 3 characters)&quot;]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="7-3-errors-add"><a href="#7-3-errors-add" class="headerlink" title="7.3 errors.add"></a>7.3 <code>errors.add</code></h4><ul>
<li><p><code>add</code> 方法用于手动添加某属性的错误消息，它的参数是属性和错误消息。    使用 <code>errors.full_messages</code>（或等价的 <code>errors.to_a</code>）方法调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  def a_method_used_for_validation_purposes</span><br><span class="line">    errors.add(:name, &quot;cannot contain the characters !@#%*()_-+=&quot;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">person = Person.create(name: &quot;!@#&quot;)</span><br><span class="line"> </span><br><span class="line">person.errors[:name]</span><br><span class="line"> # =&gt; [&quot;cannot contain the characters !@#%*()_-+=&quot;]</span><br><span class="line"> </span><br><span class="line">person.errors.full_messages</span><br><span class="line"> # =&gt; [&quot;Name cannot contain the characters !@#%*()_-+=&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;&lt;</code> 的作用与 <code>errors#add</code> 一样：把一个消息追加到 <code>errors.messages</code> 数组中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  def a_method_used_for_validation_purposes</span><br><span class="line">    errors.messages[:name] &lt;&lt; &quot;cannot contain the characters !@#%*()_-+=&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">person = Person.create(name: &quot;!@#&quot;)</span><br><span class="line"> </span><br><span class="line">person.errors[:name]</span><br><span class="line"> # =&gt; [&quot;cannot contain the characters !@#%*()_-+=&quot;]</span><br><span class="line"> </span><br><span class="line">person.errors.to_a</span><br><span class="line"> # =&gt; [&quot;Name cannot contain the characters !@#%*()_-+=&quot;]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="7-4-errors-details"><a href="#7-4-errors-details" class="headerlink" title="7.4 errors.details"></a>7.4 <code>errors.details</code></h4><ul>
<li><p>使用 <code>errors.add</code> 方法可以为返回的错误详情散列指定验证程序类型。</p>
<ul>
<li>如果想提升错误详情的信息量，可以为 <code>errors.add</code> 方法提供额外的键，指定不允许的字符。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  def a_method_used_for_validation_purposes</span><br><span class="line">    errors.add(:name, :invalid_characters, not_allowed: &quot;!@#%*()_-+=&quot;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">person = Person.create(name: &quot;!@#&quot;)</span><br><span class="line"> </span><br><span class="line">person.errors.details[:name]</span><br><span class="line"># =&gt; [&#123;error: :invalid_characters, not_allowed: &quot;!@#%*()_-+=&quot;&#125;]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="7-5-errors-base"><a href="#7-5-errors-base" class="headerlink" title="7.5 errors[:base]"></a>7.5 <code>errors[:base]</code></h4><ul>
<li><p>错误消息可以添加到整个对象上，而不是针对某个属性。如果不想管是哪个属性导致对象无效，只想把对象标记为无效状态，就可以使用这个方法。<code>errors[:base]</code> 是个数组，可以添加字符串作为错误消息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Person &lt; ApplicationRecord</span><br><span class="line">  def a_method_used_for_validation_purposes</span><br><span class="line">    errors[:base] &lt;&lt; &quot;This person is invalid because ...&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="7-6-errors-clear"><a href="#7-6-errors-clear" class="headerlink" title="7.6 errors.clear"></a>7.6 <code>errors.clear</code></h4><ul>
<li>想清除 <code>errors</code> 集合中的所有错误消息，可以使用 <code>clear</code> 方法。<ul>
<li>当然，在无效的对象上调用 <code>errors.clear</code> 方法后，对象还是无效的，虽然 <code>errors</code> 集合为空了，但下次调用 <code>valid?</code> 方法，或调用其他把对象存入数据库的方法时， 会再次进行验证。如果任何一个验证失败了，<code>errors</code> 集合中就再次出现值了。</li>
</ul>
</li>
</ul>
<h4 id="7-7-errors-size"><a href="#7-7-errors-size" class="headerlink" title="7.7 errors.size"></a>7.7 <code>errors.size</code></h4><ul>
<li><code>size</code> 方法返回对象上错误消息的总数。</li>
</ul>
<h3 id="8-在视图中显示验证错误"><a href="#8-在视图中显示验证错误" class="headerlink" title="8 在视图中显示验证错误"></a>8 在视图中显示验证错误</h3><ul>
<li><p>使用脚手架时，Rails 会在生成的 <code>_form.html.erb</code> 中加入一些 ERB 代码，显示模型错误消息的完整列表。假如有个模型对象存储在实例变量 <code>@article</code> 中，视图的代码可以这么写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if @article.errors.any? %&gt;</span><br><span class="line">  &lt;div id=&quot;error_explanation&quot;&gt;</span><br><span class="line">    &lt;h2&gt;&lt;%= pluralize(@article.errors.count, &quot;error&quot;) %&gt; prohibited this article from being saved:&lt;/h2&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">    &lt;% @article.errors.full_messages.each do |msg| %&gt;</span><br><span class="line">      &lt;li&gt;&lt;%= msg %&gt;&lt;/li&gt;</span><br><span class="line">    &lt;% end %&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此外，如果使用 Rails 的表单辅助方法生成表单，如果某个表单字段验证失败，会把字段包含在一个 <code>&lt;div&gt;</code> 中。脚手架默认添加的 CSS 规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;field_with_errors&quot;&gt;</span><br><span class="line">  &lt;input id=&quot;article_title&quot; name=&quot;article[title]&quot; size=&quot;30&quot; type=&quot;text&quot; value=&quot;&quot;&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.field_with_errors &#123;</span><br><span class="line">  padding: 2px;</span><br><span class="line">  background-color: red;</span><br><span class="line">  display: table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="四、Active-Record-回调"><a href="#四、Active-Record-回调" class="headerlink" title="四、Active Record 回调"></a>四、Active Record 回调</h1><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1flbz202ifrj31hm11un8v.jpg" alt=""></p>
<h3 id="1-对象的生命周期"><a href="#1-对象的生命周期" class="headerlink" title="1 对象的生命周期"></a>1 对象的生命周期</h3><ul>
<li>在 Rails 应用正常运作期间，对象可以被创建、更新、保存或删除。</li>
</ul>
<h3 id="2-回调概述"><a href="#2-回调概述" class="headerlink" title="2 回调概述"></a>2 回调概述</h3><ul>
<li>回调是在对象生命周期的某些时刻被调用的方法。</li>
</ul>
<h4 id="2-1-注册回调"><a href="#2-1-注册回调" class="headerlink" title="2.1 注册回调"></a>2.1 注册回调</h4><ul>
<li><p>回调在使用之前需要注册。我们可以先把回调定义为普通方法，然后使用宏式类方法把这些普通方法注册为回调：</p>
<p>——99：“类宏，书中给出的解释很简单, <strong>Use a class method in a class definition.</strong> 就是在一个类定义中使用一个类方法，那么这个类方法就叫类宏。”如下在User的class中使用self.login，这就是宏式类方法？before_validation就是注册？</p>
<ul>
<li>通常应该把回调定义为私有方法private。如果把回调定义为公共方法，就可以从模型外部调用回调，这样做违反了对象封装原则。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ApplicationRecord</span><br><span class="line">  validates :login, :email, presence: true</span><br><span class="line"> </span><br><span class="line">  before_validation :ensure_login_has_a_value</span><br><span class="line"> </span><br><span class="line">  private</span><br><span class="line">    def ensure_login_has_a_value</span><br><span class="line">      if login.nil?</span><br><span class="line">        self.login = email unless email.blank?</span><br><span class="line">      end</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-可用的回调"><a href="#3-可用的回调" class="headerlink" title="3 可用的回调"></a>3 可用的回调</h3><h4 id="3-1-创建对象-amp-3-2-更新对象"><a href="#3-1-创建对象-amp-3-2-更新对象" class="headerlink" title="3.1 创建对象 &amp; 3.2 更新对象"></a>3.1 创建对象 &amp; 3.2 更新对象</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">before_validation</span><br><span class="line">after_validation</span><br><span class="line">before_save</span><br><span class="line">around_save</span><br><span class="line">before_update</span><br><span class="line">around_update</span><br><span class="line">after_update</span><br><span class="line">after_save</span><br><span class="line">after_commit/after_rollback</span><br></pre></td></tr></table></figure>
<h4 id="3-3-删除对象"><a href="#3-3-删除对象" class="headerlink" title="3.3 删除对象"></a>3.3 删除对象</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">before_destroy</span><br><span class="line">around_destroy</span><br><span class="line">after_destroy</span><br><span class="line">after_commit/after_rollback</span><br></pre></td></tr></table></figure>
<ul>
<li>无论按什么顺序注册回调，在创建和更新对象时，<code>after_save</code> 回调总是在更明确的 <code>after_create</code> 和 <code>after_update</code> 回调之后被调用。</li>
</ul>
<h4 id="3-4-after-initialize-和-after-find-回调"><a href="#3-4-after-initialize-和-after-find-回调" class="headerlink" title="3.4 after_initialize 和 after_find 回调"></a>3.4 <code>after_initialize</code> 和 <code>after_find</code> 回调</h4><ul>
<li>当 Active Record 对象被实例化时，不管是通过直接使用 <code>new</code> 方法还是从数据库加载记录，都会调用 <code>after_initialize</code> 回调。</li>
<li>当 Active Record 从数据库中加载记录时，会调用 <code>after_find</code> 回调。</li>
</ul>
<ul>
<li>如果同时定义了 <code>after_initialize</code> 和 <code>after_find</code> 回调，会先调用 <code>after_find</code> 回调。</li>
</ul>
<h4 id="3-5-after-touch-回调"><a href="#3-5-after-touch-回调" class="headerlink" title="3.5 after_touch 回调"></a>3.5 <code>after_touch</code> 回调</h4><ul>
<li>当我们在 Active Record 对象上调用 <code>touch</code> 方法时，会调用 <code>after_touch</code> 回调。</li>
</ul>
<ul>
<li><code>after_touch</code> 回调可以和 <code>belongs_to</code> 一起使用：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ApplicationRecord</span><br><span class="line">  after_touch do |user|</span><br><span class="line">    puts &quot;You have touched an object&quot;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="4-调用回调"><a href="#4-调用回调" class="headerlink" title="4 调用回调"></a>4 调用回调</h3><ul>
<li>下面这些方法会触发回调：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">create</span><br><span class="line">create!</span><br><span class="line">decrement!</span><br><span class="line">destroy</span><br><span class="line">destroy!</span><br><span class="line">destroy_all</span><br><span class="line">increment!</span><br><span class="line">save</span><br><span class="line">save!</span><br><span class="line">save(validate: false)</span><br><span class="line">toggle!</span><br><span class="line">update_attribute</span><br><span class="line">update</span><br><span class="line">update!</span><br><span class="line">valid?</span><br></pre></td></tr></table></figure>
<ul>
<li>此外，下面这些查找方法会触发 <code>after_find</code> 回调：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">all</span><br><span class="line">first</span><br><span class="line">find</span><br><span class="line">find_by</span><br><span class="line">find_by_*</span><br><span class="line">find_by_*!</span><br><span class="line">find_by_sql</span><br><span class="line">last</span><br></pre></td></tr></table></figure>
<ul>
<li>每次初始化类的新对象时都会触发 <code>after_initialize</code> 回调。</li>
</ul>
<h3 id="5-跳过回调"><a href="#5-跳过回调" class="headerlink" title="5 跳过回调"></a>5 跳过回调</h3><ul>
<li>请慎重地使用这些方法，因为有些回调包含了重要的业务规则和应用逻辑，在不了解潜在影响的情况下就跳过回调，可能导致无效数据。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">decrement</span><br><span class="line">decrement_counter</span><br><span class="line">delete</span><br><span class="line">delete_all</span><br><span class="line">increment</span><br><span class="line">increment_counter</span><br><span class="line">toggle</span><br><span class="line">touch</span><br><span class="line">update_column</span><br><span class="line">update_columns</span><br><span class="line">update_all</span><br><span class="line">update_counters</span><br></pre></td></tr></table></figure>
<h3 id="6-停止执行"><a href="#6-停止执行" class="headerlink" title="6 停止执行"></a>6 停止执行</h3><ul>
<li>整个回调链包装在一个事务中。只要有回调抛出异常，回调链随即停止，并且发出 <code>ROLLBACK</code> 消息。如果想故意停止回调链，可以这么做：<code>throw :abort</code></li>
</ul>
<h3 id="7-关联回调"><a href="#7-关联回调" class="headerlink" title="7 关联回调"></a>7 关联回调</h3><ul>
<li><p>回调不仅可以在模型关联中使用，还可以通过模型关联定义。假设有一个用户在博客中发表了多篇文章，现在我们要删除这个用户，那么这个用户的所有文章也应该删除，为此我们通过 <code>Article</code> 模型和 <code>User</code> 模型的关联来给 <code>User</code> 模型添加一个 <code>after_destroy</code> 回调：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class User &lt; ApplicationRecord</span><br><span class="line">  has_many :articles, dependent: :destroy</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Article &lt; ApplicationRecord</span><br><span class="line">  after_destroy :log_destroy_action</span><br><span class="line"> </span><br><span class="line">  def log_destroy_action</span><br><span class="line">    puts &apos;Article destroyed&apos;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="8-条件回调"><a href="#8-条件回调" class="headerlink" title="8 条件回调"></a>8 条件回调</h3><h4 id="8-1-使用符号作为-if-和-unless-选项的值"><a href="#8-1-使用符号作为-if-和-unless-选项的值" class="headerlink" title="8.1 使用符号作为 :if 和 :unless 选项的值"></a>8.1 使用符号作为 <code>:if</code> 和 <code>:unless</code> 选项的值</h4><ul>
<li><p>可以使用符号作为 <code>:if</code> 和 <code>:unless</code> 选项的值，这个符号用于表示先于回调调用的断言方法。当使用 <code>:if</code> 选项时，如果断言方法返回 <code>false</code> 就不会调用回调；当使用 <code>:unless</code> 选项时，如果断言方法返回 <code>true</code> 就不会调用回调。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Order &lt; ApplicationRecord</span><br><span class="line">  before_save :normalize_card_number, if: :paid_with_card?</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="8-2-使用-Proc-作为-if-和-unless-选项的值"><a href="#8-2-使用-Proc-作为-if-和-unless-选项的值" class="headerlink" title="8.2 使用 Proc 作为 :if 和 :unless 选项的值"></a>8.2 使用 Proc 作为 <code>:if</code> 和 <code>:unless</code> 选项的值</h4><ul>
<li><p>在验证方法非常短时最适合使用这种方式，这类验证方法通常只有一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Order &lt; ApplicationRecord</span><br><span class="line">  before_save :normalize_card_number,</span><br><span class="line">    if: Proc.new &#123; |order| order.paid_with_card? &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="8-3-在条件回调中使用多个条件"><a href="#8-3-在条件回调中使用多个条件" class="headerlink" title="8.3 在条件回调中使用多个条件"></a>8.3 在条件回调中使用多个条件</h4><ul>
<li><p>在编写条件回调时，我们可以在同一个回调声明中混合使用 <code>:if</code> 和 <code>:unless</code> 选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Comment &lt; ApplicationRecord</span><br><span class="line">  after_create :send_email_to_author, if: :author_wants_emails?,</span><br><span class="line">    unless: Proc.new &#123; |comment| comment.article.ignore_comments? &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="9-回调类"><a href="#9-回调类" class="headerlink" title="9 回调类"></a>9 回调类</h3><ul>
<li><p>有时需要在其他模型中重用已有的回调方法，为了解决这个问题，Active Record 允许我们用类来封装回调方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">在下面的例子中，我们为 PictureFile 模型创建了 PictureFileCallbacks 回调类，在这个回调类中包含了 after_destroy 回调方法：</span><br><span class="line"></span><br><span class="line">class PictureFileCallbacks</span><br><span class="line">  def after_destroy(picture_file)</span><br><span class="line">    if File.exist?(picture_file.filepath)</span><br><span class="line">      File.delete(picture_file.filepath)</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">在上面的代码中我们可以看到，当在回调类中声明回调方法时，回调方法接受模型对象作为参数。回调类定义之后就可以在模型中使用了：</span><br><span class="line"></span><br><span class="line">class PictureFile &lt; ApplicationRecord</span><br><span class="line">  after_destroy PictureFileCallbacks.new</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li><p>请注意，上面我们<strong>把回调声明为实例方法</strong>，因此需要实例化新的 <code>PictureFileCallbacks</code> 对象。当回调想要使用实例化的对象的状态时，这种声明方式特别有用。尽管如此，一般我们会把回调声明为类方法：</p>
</li>
<li><p>如果<strong>把回调声明为类方法</strong>，就不需要实例化新的 <code>PictureFileCallbacks</code> 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class PictureFile &lt; ApplicationRecord</span><br><span class="line">  after_destroy PictureFileCallbacks</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="10-事务回调"><a href="#10-事务回调" class="headerlink" title="10 事务回调"></a>10 事务回调</h3><ul>
<li><p><code>after_commit</code> 和 <code>after_rollback</code> 这两个回调会在数据库事务完成时触发。它们和 <code>after_save</code>回调非常相似，区别在于它们在数据库变更已经提交或回滚后才会执行，常用于 Active Record 模型需要和数据库事务之外的系统交互的场景。</p>
</li>
<li><p>由于只在执行创建、更新或删除动作时触发 <code>after_commit</code> 回调是很常见的，这些操作都拥有别名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">after_create_commit</span><br><span class="line">after_update_commit</span><br><span class="line">after_destroy_commit</span><br></pre></td></tr></table></figure>
</li>
<li><p>在事务中创建、更新或删除模型时会调用 <code>after_commit</code> 和 <code>after_rollback</code> 回调。然而，如果其中有一个回调引发异常，异常会向上冒泡，后续 <code>after_commit</code> 和 <code>after_rollback</code> 回调不再执行。</p>
</li>
</ul>
<h2 id="五、Active-Record-关联"><a href="#五、Active-Record-关联" class="headerlink" title="五、Active Record 关联"></a>五、Active Record 关联</h2><p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1flc5zed7xmj31kw1007fu.jpg" alt=""></p>
<h3 id="1-为什么使用关联"><a href="#1-为什么使用关联" class="headerlink" title="1 为什么使用关联"></a>1 为什么使用关联</h3><ul>
<li>Rails 知道两个模型之间有联系，相关操作可以得到简化。</li>
</ul>
<h3 id="2-关联的类型"><a href="#2-关联的类型" class="headerlink" title="2 关联的类型"></a>2 关联的类型</h3><ul>
<li>关联使用宏式调用实现，用声明的形式为模型添加功能。例如，声明一个模型属于（<code>belongs_to</code>）另一个模型后，Rails 会维护两个模型之间的“<a href="https://en.wikipedia.org/wiki/Unique_key" target="_blank" rel="noopener">主键</a>-<a href="https://en.wikipedia.org/wiki/Foreign_key" target="_blank" rel="noopener">外键</a>”关系，而且还会向模型中添加很多实用的方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Rails 支持六种关联：</span><br><span class="line">belongs_to</span><br><span class="line">has_one</span><br><span class="line">has_many</span><br><span class="line">has_many :through</span><br><span class="line">has_one :through</span><br><span class="line">has_and_belongs_to_many</span><br></pre></td></tr></table></figure>
<h4 id="2-1-belongs-to-关联"><a href="#2-1-belongs-to-关联" class="headerlink" title="2.1 belongs_to 关联"></a>2.1 <code>belongs_to</code> 关联</h4><ul>
<li><p><code>belongs_to</code> 关联创建两个模型之间一对一的关系，声明所在的模型实例属于另一个模型的实例。</p>
<ul>
<li><p>例如，如果应用中有作者和图书两个模型，而且每本书只能指定给一位作者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Book &lt; ApplicationRecord</span><br><span class="line">  belongs_to :author</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>相应的迁移如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class CreateBooks &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :authors do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :books do |t|</span><br><span class="line">      t.belongs_to :author, index: true</span><br><span class="line">      t.datetime :published_at</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="2-2-has-one-关联"><a href="#2-2-has-one-关联" class="headerlink" title="2.2 has_one 关联"></a>2.2 <code>has_one</code> 关联</h4><ul>
<li><p><code>has_one</code> 关联也建立两个模型之间的一对一关系，但语义和结果有点不一样。这种关联表示模型的实例包含或拥有另一个模型的实例。</p>
<ul>
<li><p>例如，应用中每个供应商只有一个账户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Supplier &lt; ApplicationRecord</span><br><span class="line">  has_one :account</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>相应的迁移如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class CreateSuppliers &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :suppliers do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :accounts do |t|</span><br><span class="line">      t.belongs_to :supplier, index: true</span><br><span class="line">      t.string :account_number</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>根据使用需要，可能还要为 accounts 表中的 supplier 列创建唯一性索引和（或）外键约束。这里，我们像下面这样定义这一列：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">create_table :accounts do |t|</span><br><span class="line">  t.belongs_to :supplier, index: &#123; unique: true &#125;, foreign_key: true</span><br><span class="line">  # ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2-3-has-many-关联"><a href="#2-3-has-many-关联" class="headerlink" title="2.3 has_many 关联"></a>2.3 <code>has_many</code> 关联</h4><ul>
<li><p><code>has_many</code> 关联建立两个模型之间的一对多关系。在 <code>belongs_to</code> 关联的另一端经常会使用这个关联。</p>
</li>
<li><p>声明 <code>has_many</code> 关联时，另一个模型使用复数形式。</p>
<ul>
<li><p>例如，对应用中的作者和图书模型来说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Author &lt; ApplicationRecord</span><br><span class="line">  has_many :books</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>相应的迁移如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class CreateAuthors &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :authors do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :books do |t|</span><br><span class="line">      t.belongs_to :author, index: true</span><br><span class="line">      t.datetime :published_at</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="2-4-has-many-through-关联"><a href="#2-4-has-many-through-关联" class="headerlink" title="2.4 has_many :through 关联"></a>2.4 <code>has_many :through</code> 关联</h4><ul>
<li><p><code>has_many :through</code> 关联经常用于建立两个模型之间的多对多关联。这种关联表示一个模型的实例可以借由第三个模型，拥有零个和多个另一模型的实例。</p>
</li>
<li><p><code>physician.patients = patients</code>会为新建立的关联对象创建联结模型实例。如果其中一个对象删除了，相应的联结记录也会删除。</p>
</li>
<li><p>自动删除联结模型的操作直接执行，不会触发 <code>*_destroy</code> 回调。</p>
<ul>
<li><p>例如，在医疗锻炼中，病人要和医生约定练习时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Physician &lt; ApplicationRecord</span><br><span class="line">  has_many :appointments</span><br><span class="line">  has_many :patients, through: :appointments</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Appointment &lt; ApplicationRecord</span><br><span class="line">  belongs_to :physician</span><br><span class="line">  belongs_to :patient</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Patient &lt; ApplicationRecord</span><br><span class="line">  has_many :appointments</span><br><span class="line">  has_many :physicians, through: :appointments</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>相应的迁移如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class CreateAppointments &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :physicians do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :patients do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :appointments do |t|</span><br><span class="line">      t.belongs_to :physician, index: true</span><br><span class="line">      t.belongs_to :patient, index: true</span><br><span class="line">      t.datetime :appointment_date</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1flc8to7mnaj30ui0zsdpp.jpg" alt=""></p>
</li>
</ul>
</li>
</ul>
<h4 id="2-5-has-one-through-关联"><a href="#2-5-has-one-through-关联" class="headerlink" title="2.5 has_one :through 关联"></a>2.5 <code>has_one :through</code> 关联</h4><ul>
<li><p><code>has_one :through</code> 关联建立两个模型之间的一对一关系。这种关联表示一个模型通过第三个模型拥有另一模型的实例。</p>
<ul>
<li><p>例如，每个供应商只有一个账户，而且每个账户都有一个账户历史</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class Supplier &lt; ApplicationRecord</span><br><span class="line">  has_one :account</span><br><span class="line">  has_one :account_history, through: :account</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Account &lt; ApplicationRecord</span><br><span class="line">  belongs_to :supplier</span><br><span class="line">  has_one :account_history</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class AccountHistory &lt; ApplicationRecord</span><br><span class="line">  belongs_to :account</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>相应的迁移如下：</p>
</li>
</ul>
</li>
</ul>
<pre><code>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class CreateAccountHistories &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :suppliers do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :accounts do |t|</span><br><span class="line">      t.belongs_to :supplier, index: true</span><br><span class="line">      t.string :account_number</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :account_histories do |t|</span><br><span class="line">      t.belongs_to :account, index: true</span><br><span class="line">      t.integer :credit_rating</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line">​</span><br></pre></td></tr></table></figure>


![](https://ws3.sinaimg.cn/large/006tKfTcgy1flc9ad3xitj30u210uajb.jpg)
</code></pre><h4 id="2-6-has-and-belongs-to-many-关联"><a href="#2-6-has-and-belongs-to-many-关联" class="headerlink" title="2.6 has_and_belongs_to_many 关联"></a>2.6 <code>has_and_belongs_to_many</code> 关联</h4><ul>
<li><p>直接建立两个模型之间的多对多关系，不借由第三个模型。</p>
<ul>
<li><p>例如，应用中有装配体和零件两个模型，每个装配体有多个零件，每个零件又可用于多个装配体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Assembly &lt; ApplicationRecord</span><br><span class="line">  has_and_belongs_to_many :parts</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Part &lt; ApplicationRecord</span><br><span class="line">  has_and_belongs_to_many :assemblies</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>相应的迁移如下：</p>
</li>
</ul>
</li>
</ul>
<pre><code>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class CreateAssembliesAndParts &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :assemblies do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :parts do |t|</span><br><span class="line">      t.string :part_number</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    create_table :assemblies_parts, id: false do |t|</span><br><span class="line">      t.belongs_to :assembly, index: true</span><br><span class="line">      t.belongs_to :part, index: true</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line">​</span><br></pre></td></tr></table></figure>


![](https://ws4.sinaimg.cn/large/006tKfTcgy1flc9hkgojnj30t00u2tf2.jpg)
</code></pre><h4 id="2-7-在-belongs-to-和-has-one-之间选择"><a href="#2-7-在-belongs-to-和-has-one-之间选择" class="headerlink" title="2.7 在 belongs_to 和 has_one 之间选择"></a>2.7 在 <code>belongs_to</code> 和 <code>has_one</code> 之间选择</h4><ul>
<li>二者之间的区别是在哪里放置外键（外键在 <code>belongs_to</code> 关联所在模型对应的表中），不过也要考虑数据的语义。<code>has_one</code> 的意思是某样东西属于我，即哪个东西指向你。<ul>
<li>例如，说供应商有一个账户，比账户拥有供应商更合理</li>
</ul>
</li>
</ul>
<h4 id="2-8-在-has-many-through-和-has-and-belongs-to-many-之间选择"><a href="#2-8-在-has-many-through-和-has-and-belongs-to-many-之间选择" class="headerlink" title="2.8 在 has_many :through 和 has_and_belongs_to_many 之间选择"></a>2.8 在 <code>has_many :through</code> 和 <code>has_and_belongs_to_many</code> 之间选择</h4><ul>
<li>根据经验，如果想把关联模型当做独立实体使用，要用 <code>has_many :through</code> 关联；如果不需要使用关联模型，建立 <code>has_and_belongs_to_many</code> 关联更简单（不过要记得在数据库中创建联结表）。</li>
<li>如果要对联结模型做数据验证、调用回调，或者使用其他属性，要使用 <code>has_many :through</code> 关联。</li>
</ul>
<h4 id="2-9-多态关联"><a href="#2-9-多态关联" class="headerlink" title="2.9 多态关联"></a>2.9 多态关联</h4><ul>
<li><p>关联还有一种高级形式——多态关联（polymorphic association）。在多态关联中，在同一个关联中，一个模型可以属于多个模型。</p>
<ul>
<li><p>例如，图片模型可以属于雇员模型或者产品模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Picture &lt; ApplicationRecord</span><br><span class="line">  belongs_to :imageable, polymorphic: true</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Employee &lt; ApplicationRecord</span><br><span class="line">  has_many :pictures, as: :imageable</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Product &lt; ApplicationRecord</span><br><span class="line">  has_many :pictures, as: :imageable</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>belongs_to</code> 中指定使用多态，可以理解成创建了一个接口，可供任何一个模型使用。</p>
<ul>
<li>在 <code>Employee</code> 模型实例上，可以使用 <code>@employee.pictures</code> 获取图片集合。</li>
<li>类似地，可使用 <code>@product.pictures</code> 获取产品的图片。</li>
</ul>
</li>
<li><p>在 <code>Picture</code> 模型的实例上，可以使用 <code>@picture.imageable</code> 获取父对象。不过事先要在声明多态接口的模型中创建外键字段和类型字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class CreatePictures &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :pictures do |t|</span><br><span class="line">      t.string  :name</span><br><span class="line">      t.integer :imageable_id</span><br><span class="line">      t.string  :imageable_type</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    add_index :pictures, [:imageable_type, :imageable_id]</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>上面的迁移可以使用 <code>t.references</code> 简化：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class CreatePictures &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :pictures do |t|</span><br><span class="line">      t.string :name</span><br><span class="line">      t.references :imageable, polymorphic: true, index: true</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1flcaao466qj30ta0xs10t.jpg" alt=""></p>
</li>
</ul>
</li>
</ul>
<h4 id="2-10-自联结"><a href="#2-10-自联结" class="headerlink" title="2.10 自联结"></a>2.10 自联结</h4><ul>
<li><p>设计数据模型时，模型有时要和自己建立关系。</p>
<ul>
<li><p>例如，在一个数据库表中保存所有雇员的信息，但要建立经理和下属之间的关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Employee &lt; ApplicationRecord</span><br><span class="line">  has_many :subordinates, class_name: &quot;Employee&quot;,</span><br><span class="line">                          foreign_key: &quot;manager_id&quot;</span><br><span class="line"> </span><br><span class="line">  belongs_to :manager, class_name: &quot;Employee&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>在迁移（模式）中，要添加一个引用字段，指向模型自身：</p>
</li>
</ul>
</li>
</ul>
<pre><code>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class CreateEmployees &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :employees do |t|</span><br><span class="line">      t.references :manager, index: true</span><br><span class="line">      t.timestamps</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line">​</span><br></pre></td></tr></table></figure>
</code></pre><h3 id="3-小技巧和注意事项"><a href="#3-小技巧和注意事项" class="headerlink" title="3 小技巧和注意事项"></a>3 小技巧和注意事项</h3><ul>
<li><p>为了在 Rails 应用中有效使用 Active Record 关联，要了解以下几点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">控制缓存</span><br><span class="line">避免命名冲突</span><br><span class="line">更新模式</span><br><span class="line">控制关联的作用域</span><br><span class="line">双向关联</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-1-控制缓存"><a href="#3-1-控制缓存" class="headerlink" title="3.1 控制缓存"></a>3.1 控制缓存</h4><ul>
<li><p>关联添加的方法都会使用缓存，记录最近一次查询的结果，以备后用。缓存还会在方法之间共享。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">author.books           # 从数据库中检索图书</span><br><span class="line">author.books.size      # 使用缓存的图书副本</span><br><span class="line">author.books.empty?    # 使用缓存的图书副本</span><br></pre></td></tr></table></figure>
</li>
<li><p>应用的其他部分可能会修改数据，那么应该怎么重载缓存呢？在关联上调用 <code>reload</code> 即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">author.books                 # 从数据库中检索图书</span><br><span class="line">author.books.size            # 使用缓存的图书副本</span><br><span class="line">author.books.reload.empty?   # 丢掉缓存的图书副本</span><br><span class="line">                             # 重新从数据库中检索</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-2-避免命名冲突"><a href="#3-2-避免命名冲突" class="headerlink" title="3.2 避免命名冲突"></a>3.2 避免命名冲突</h4><ul>
<li>因为创建关联时，会向模型添加同名方法，所以关联的名字不能和 <code>ActiveRecord::Base</code> 中的实例方法同名。如果同名，关联方法会覆盖 <code>ActiveRecord::Base</code> 中的实例方法，导致错误。</li>
</ul>
<h4 id="3-3-更新模式"><a href="#3-3-更新模式" class="headerlink" title="3.3 更新模式"></a>3.3 更新模式</h4><ul>
<li>对 <code>belongs_to</code> 关联来说，要创建外键；对 <code>has_and_belongs_to_many</code> 关联来说，要创建相应的联结表。</li>
</ul>
<h5 id="3-3-1-创建-belongs-to-关联所需的外键"><a href="#3-3-1-创建-belongs-to-关联所需的外键" class="headerlink" title="3.3.1 创建 belongs_to 关联所需的外键"></a>3.3.1 创建 <code>belongs_to</code> 关联所需的外键</h5><ul>
<li><p>为了提升查询性能，最好为外键添加索引；为了保证参照完整性，最好为外键添加约束：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class CreateBooks &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :books do |t|</span><br><span class="line">      t.datetime :published_at</span><br><span class="line">      t.string   :book_number</span><br><span class="line">      t.integer  :author_id</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    add_index :books, :author_id</span><br><span class="line">    add_foreign_key :books, :authors</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="3-3-2-创建-has-and-belongs-to-many-关联所需的联结表"><a href="#3-3-2-创建-has-and-belongs-to-many-关联所需的联结表" class="headerlink" title="3.3.2 创建 has_and_belongs_to_many 关联所需的联结表"></a>3.3.2 创建 <code>has_and_belongs_to_many</code> 关联所需的联结表</h5><ul>
<li><p>创建 <code>has_and_belongs_to_many</code> 关联后，必须手动创建联结表。除非使用 <code>:join_table</code> 选项指定了联结表的名称，否则 Active Record 会按照类名出现在字典中的顺序为表起名。因此，作者和图书模型使用的联结表默认名为“authors_books”，因为在字典中，“a”在“b”前面。</p>
<ul>
<li>我们把 <code>id: false</code> 选项传给 <code>create_table</code> 方法，因为这个表不对应模型。只有这样，关联才能正常建立。如果在使用 <code>has_and_belongs_to_many</code> 关联时遇到奇怪的行为，例如提示模型 ID 损坏，或 ID 冲突，有可能就是因为创建了主键。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Assembly &lt; ApplicationRecord</span><br><span class="line">  has_and_belongs_to_many :parts</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Part &lt; ApplicationRecord</span><br><span class="line">  has_and_belongs_to_many :assemblies</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>上述关联需要在迁移中创建 <code>assemblies_parts</code> 表，而且该表无主键：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class CreateAssembliesPartsJoinTable &lt; ActiveRecord::Migration[5.0]</span><br><span class="line">  def change</span><br><span class="line">    create_table :assemblies_parts, id: false do |t|</span><br><span class="line">      t.integer :assembly_id</span><br><span class="line">      t.integer :part_id</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    add_index :assemblies_parts, :assembly_id</span><br><span class="line">    add_index :assemblies_parts, :part_id</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-4-控制关联的作用域"><a href="#3-4-控制关联的作用域" class="headerlink" title="3.4 控制关联的作用域"></a>3.4 控制关联的作用域</h4><ul>
<li><p>默认情况下，关联只会查找当前模块作用域中的对象。</p>
<ul>
<li><p>第一段代码能正常运行，因为 <code>Supplier</code> 和 <code>Account</code> 在同一个作用域中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">module MyApplication</span><br><span class="line">  module Business</span><br><span class="line">    class Supplier &lt; ApplicationRecord</span><br><span class="line">       has_one :account</span><br><span class="line">    end</span><br><span class="line"> </span><br><span class="line">    class Account &lt; ApplicationRecord</span><br><span class="line">       belongs_to :supplier</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>但第二段代码就不行了，因为 <code>Supplier</code> 和 <code>Account</code> 在不同的作用域中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">module MyApplication</span><br><span class="line">  module Business</span><br><span class="line">    class Supplier &lt; ApplicationRecord</span><br><span class="line">       has_one :account</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  module Billing</span><br><span class="line">    class Account &lt; ApplicationRecord</span><br><span class="line">       belongs_to :supplier</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二段代码改成第三段，声明关联时指定完整的类名可正常关联。但啰嗦不如用第一段。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">module MyApplication</span><br><span class="line">  module Business</span><br><span class="line">    class Supplier &lt; ApplicationRecord</span><br><span class="line">       has_one :account,</span><br><span class="line">        class_name: &quot;MyApplication::Billing::Account&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  module Billing</span><br><span class="line">    class Account &lt; ApplicationRecord</span><br><span class="line">       belongs_to :supplier,</span><br><span class="line">        class_name: &quot;MyApplication::Business::Supplier&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="3-5-双向关联"><a href="#3-5-双向关联" class="headerlink" title="3.5 双向关联"></a>3.5 双向关联</h4><ul>
<li><p>即在两个模型中都要声明关联。这样一来，Active Record 只会加载一个 <code>Author</code> 对象副本，从而确保应用运行效率更高效，并避免数据不一致。</p>
</li>
<li><p>具有下述选项的关联Active Record无法自动识别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:conditions</span><br><span class="line">:through</span><br><span class="line">:polymorphic</span><br><span class="line">:class_name</span><br><span class="line">:foreign_key</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Active Record 提供了 <code>inverse_of</code> 选项，可以通过它明确声明双向关联：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Author &lt; ApplicationRecord</span><br><span class="line">  has_many :books, inverse_of: &apos;writer&apos;</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Book &lt; ApplicationRecord</span><br><span class="line">  belongs_to :writer, class_name: &apos;Author&apos;, foreign_key: &apos;author_id&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>inverse_of</code> 有些限制：</p>
<blockquote>
<ul>
<li>不支持 <code>:through</code> 关联；</li>
<li>不支持 <code>:polymorphic</code> 关联；</li>
<li>不支持 <code>:as</code> 选项；</li>
</ul>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="4-关联详解"><a href="#4-关联详解" class="headerlink" title="4 关联详解"></a>4 关联详解</h3><h4 id="4-1-belongs-to-关联详解"><a href="#4-1-belongs-to-关联详解" class="headerlink" title="4.1 belongs_to 关联详解"></a>4.1 <code>belongs_to</code> 关联详解</h4><ul>
<li><code>belongs_to</code> 关联创建一个模型与另一个模型之间的一对一关系。用数据库术语来说，就是这个类中包含外键。</li>
</ul>
<h5 id="4-1-1-belongs-to-关联添加的方法"><a href="#4-1-1-belongs-to-关联添加的方法" class="headerlink" title="4.1.1 belongs_to 关联添加的方法"></a>4.1.1 <code>belongs_to</code> 关联添加的方法</h5><ul>
<li><p>声明 <code>belongs_to</code> 关联后，所在的类自动获得了五个和关联相关的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">association</span><br><span class="line">association=(associate)</span><br><span class="line">build_association(attributes = &#123;&#125;)</span><br><span class="line">create_association(attributes = &#123;&#125;)</span><br><span class="line">create_association!(attributes = &#123;&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>对下述声明来说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Book &lt; ApplicationRecord</span><br><span class="line">  belongs_to :author</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Book</code> 模型的每个实例都获得了这些方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">author</span><br><span class="line">author=</span><br><span class="line">build_author</span><br><span class="line">create_author</span><br><span class="line">create_author!</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>在 <code>has_one</code> 和 <code>belongs_to</code> 关联中，必须使用 <code>build_*</code> 方法构建关联对象。<code>association.build</code> 方法是在 <code>has_many</code> 和 <code>has_and_belongs_to_many</code> 关联中使用的。创建关联对象要使用 <code>create_*</code> 方法。</p>
</li>
</ul>
<h6 id="4-1-1-1-association"><a href="#4-1-1-1-association" class="headerlink" title="4.1.1.1 association"></a>4.1.1.1 <code>association</code></h6><blockquote>
<p>1、<code>@author= @book.author</code>，如果找不到关联的对象，返回 <code>nil</code>。</p>
<p>2、如果关联的对象之前已经取回，会返回缓存版本。如果不想使用缓存版本（强制读取数据库）在父对象上调用 <code>#reload</code> 方法。</p>
</blockquote>
<h6 id="4-1-1-2-association-associate"><a href="#4-1-1-2-association-associate" class="headerlink" title="4.1.1.2 association=(associate)"></a>4.1.1.2 <code>association=(associate)</code></h6><blockquote>
<p>这个方法的底层操作是，从关联对象上读取主键，然后把值赋给该主键对应的对象<code>@book.author = @author</code></p>
</blockquote>
<h6 id="4-1-1-3-build-association-attributes"><a href="#4-1-1-3-build-association-attributes" class="headerlink" title="4.1.1.3 build_association(attributes = {})"></a>4.1.1.3 <code>build_association(attributes = {})</code></h6><blockquote>
<p><code>build_association</code> 方法返回该关联类型的一个新对象。这个对象使用传入的属性初始化，对象的外键会自动设置，但关联对象不会存入数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; @author = @book.build_author(author_number: 123,</span><br><span class="line">&gt;                              author_name: &quot;John Doe&quot;)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-1-1-4-create-association-attributes"><a href="#4-1-1-4-create-association-attributes" class="headerlink" title="4.1.1.4 create_association(attributes = {})"></a>4.1.1.4 <code>create_association(attributes = {})</code></h6><blockquote>
<p><code>create_association</code> 方法返回该关联类型的一个新对象。这个对象使用传入的属性初始化，对象的外键会自动设置，只要能通过所有数据验证，就会把关联对象存入数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; @author = @book.create_author(author_number: 123,</span><br><span class="line">&gt;                                    author_name: &quot;John Doe&quot;)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-1-1-5-create-association-attributes"><a href="#4-1-1-5-create-association-attributes" class="headerlink" title="4.1.1.5 create_association!(attributes = {})"></a>4.1.1.5 <code>create_association!(attributes = {})</code></h6><blockquote>
<p>与 <code>create_association</code> 方法作用相同，但是如果记录无效，会抛出 <code>ActiveRecord::RecordInvalid</code> 异常。</p>
</blockquote>
<h5 id="4-1-2-belongs-to-方法的选项"><a href="#4-1-2-belongs-to-方法的选项" class="headerlink" title="4.1.2 belongs_to 方法的选项"></a>4.1.2 <code>belongs_to</code> 方法的选项</h5><ul>
<li><p>定制的方法很简单，声明关联时传入选项或者使用代码块即可。<code>belongs_to</code> 关联支持下列选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">:autosave</span><br><span class="line">:class_name</span><br><span class="line">:counter_cache</span><br><span class="line">:dependent</span><br><span class="line">:foreign_key</span><br><span class="line">:primary_key</span><br><span class="line">:inverse_of</span><br><span class="line">:polymorphic</span><br><span class="line">:touch</span><br><span class="line">:validate</span><br><span class="line">:optional</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-1-2-1-autosave"><a href="#4-1-2-1-autosave" class="headerlink" title="4.1.2.1 :autosave"></a>4.1.2.1 <code>:autosave</code></h6><blockquote>
<p>如果把 <code>:autosave</code> 选项设为 <code>true</code>，保存父对象时，会自动保存所有子对象，并把标记为析构的子对象销毁。</p>
</blockquote>
<h6 id="4-1-2-2-class-name"><a href="#4-1-2-2-class-name" class="headerlink" title="4.1.2.2 :class_name"></a>4.1.2.2 <code>:class_name</code></h6><blockquote>
<p> 如果另一个模型无法从关联的名称获取，可以使用 <code>:class_name</code> 选项指定模型名。例如，如果一本书属于一位作者，但是表示作者的模型是 <code>Patron</code>，就可以这样声明关联：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt;  class Book &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :author, class_name: &quot;Patron&quot;</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-1-2-3-counter-cache"><a href="#4-1-2-3-counter-cache" class="headerlink" title="4.1.2.3 :counter_cache"></a>4.1.2.3 <code>:counter_cache</code></h6><blockquote>
<p>如果想知道 <code>@author.books.size</code> 的结果，要在数据库中执行 <code>COUNT(*)</code> 查询。如果不想执行这个查询，可以在声明 <code>belongs_to</code> 关联的模型中加入计数缓存功能：</p>
</blockquote>
<h6 id="4-1-2-4-dependent"><a href="#4-1-2-4-dependent" class="headerlink" title="4.1.2.4 :dependent"></a>4.1.2.4 <code>:dependent</code></h6><blockquote>
<p><code>:dependent</code> 选项控制属主销毁后怎么处理关联的对象：</p>
<ul>
<li><code>:destroy</code>：也销毁关联的对象</li>
<li><code>:delete_all</code>：直接从数据库中删除关联的对象（不执行回调）</li>
<li><code>:nullify</code>：把外键设为 <code>NULL</code>（不执行回调）</li>
<li><code>:restrict_with_exception</code>：如果有关联的记录，抛出异常</li>
<li><code>:restrict_with_error</code>：如果有关联的对象，为属主添加一个错误</li>
</ul>
</blockquote>
<p>4.1.2.5 <code>:foreign_key</code></p>
<blockquote>
<p>Rails 都不会自动创建外键字段 <code>xxx_id</code>，你要自己在迁移中创建。</p>
</blockquote>
<p>4.1.2.6 <code>:primary_key</code></p>
<blockquote>
<p>Rails 假定使用表中的 <code>id</code> 列保存主键。使用 <code>:primary_key</code> 选项可以指定使用其他列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; class User &lt; ApplicationRecord</span><br><span class="line">&gt;   self.primary_key = &apos;guid&apos; # 主键是 guid，不是 id</span><br><span class="line">&gt; end</span><br><span class="line">&gt;  </span><br><span class="line">&gt; class Todo &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :user, primary_key: &apos;guid&apos;</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>执行 <code>@user.todos.create</code> 时，<code>@todo</code> 记录的用户 ID 是 <code>@user</code> 的 <code>guid</code> 值。</p>
</blockquote>
<h6 id="4-1-2-7-inverse-of"><a href="#4-1-2-7-inverse-of" class="headerlink" title="4.1.2.7 :inverse_of"></a>4.1.2.7 <code>:inverse_of</code></h6><blockquote>
<p><code>:inverse_of</code> 选项指定 <code>belongs_to</code> 关联另一端的 <code>has_many</code> 和 <code>has_one</code> 关联名。不能和 <code>:polymorphic</code> 选项一起使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt; class Author &lt; ApplicationRecord</span><br><span class="line">&gt;   has_many :books, inverse_of: :author</span><br><span class="line">&gt; end</span><br><span class="line">&gt;  </span><br><span class="line">&gt; class Book &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :author, inverse_of: :books</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-1-2-8-polymorphic"><a href="#4-1-2-8-polymorphic" class="headerlink" title="4.1.2.8 :polymorphic"></a>4.1.2.8 <code>:polymorphic</code></h6><blockquote>
<p><code>:polymorphic</code> 选项为 <code>true</code> 时，表明这是个多态关联。</p>
</blockquote>
<h6 id="4-1-2-9-touch"><a href="#4-1-2-9-touch" class="headerlink" title="4.1.2.9 :touch"></a>4.1.2.9 <code>:touch</code></h6><blockquote>
<p> 如果把 <code>:touch</code> 选项设为 <code>true</code>，保存或销毁对象时，关联对象的 <code>updated_at</code> 或 <code>updated_on</code> 字段会自动设为当前时间。还可指定要更新哪个时间戳字段：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt;  class Book &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :author, touch: :books_updated_at</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-1-2-10-validate"><a href="#4-1-2-10-validate" class="headerlink" title="4.1.2.10 :validate"></a>4.1.2.10 <code>:validate</code></h6><blockquote>
<p>如果把 <code>:validate</code> 选项设为 <code>true</code>，保存对象时，会同时验证关联的对象。该选项的默认值是 <code>false</code>，保存对象时不验证关联的对象</p>
</blockquote>
<p>4.1.2.11 <code>:optional</code></p>
<blockquote>
<p>如果把 <code>:optional</code> 选项设为 <code>true</code>，不会验证关联的对象是否存在。该选项的默认值是 <code>false</code>。</p>
</blockquote>
<h5 id="4-1-3-belongs-to-的作用域"><a href="#4-1-3-belongs-to-的作用域" class="headerlink" title="4.1.3 belongs_to 的作用域"></a>4.1.3 <code>belongs_to</code> 的作用域</h5><ul>
<li><p>在作用域代码块中可以使用任何一个标准的<a href="https://ruby-china.github.io/rails-guides/active_record_querying.html" target="_blank" rel="noopener">查询方法</a>。下面分别介绍这几个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">where</span><br><span class="line">includes</span><br><span class="line">readonly</span><br><span class="line">select</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-1-3-1-where"><a href="#4-1-3-1-where" class="headerlink" title="4.1.3.1 where"></a>4.1.3.1 <code>where</code></h6><blockquote>
<p><code>where</code> 方法指定关联对象必须满足的条件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt; class book &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :author, -&gt; &#123; where active: true &#125;</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-1-3-2-includes"><a href="#4-1-3-2-includes" class="headerlink" title="4.1.3.2 includes"></a>4.1.3.2 <code>includes</code></h6><blockquote>
<p><code>includes</code> 方法指定使用关联时要及早加载的间接关联。</p>
<p>如果经常要直接从商品上获取作者对象（<code>@line_item.book.author</code>），就可以在关联中把作者从商品引入图书中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt; class LineItem &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :book, -&gt; &#123; includes :author &#125;</span><br><span class="line">&gt; end</span><br><span class="line">&gt;  </span><br><span class="line">&gt; class Book &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :author</span><br><span class="line">&gt;   has_many :line_items</span><br><span class="line">&gt; end</span><br><span class="line">&gt;  </span><br><span class="line">&gt; class Author &lt; ApplicationRecord</span><br><span class="line">&gt;   has_many :books</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>直接关联没必要使用 <code>includes</code>，常用于多对多关联。</p>
</blockquote>
<h6 id="4-1-3-3-readonly"><a href="#4-1-3-3-readonly" class="headerlink" title="4.1.3.3 readonly"></a>4.1.3.3 <code>readonly</code></h6><blockquote>
<p>如果使用 <code>readonly</code>，通过关联获取的对象是只读的。</p>
</blockquote>
<h6 id="4-1-3-4-select"><a href="#4-1-3-4-select" class="headerlink" title="4.1.3.4 select"></a>4.1.3.4 <code>select</code></h6><blockquote>
<p>1、<code>select</code> 方法用于覆盖检索关联对象使用的 SQL <code>SELECT</code> 子句。默认情况下，Rails 检索所有字段。</p>
<p>2、如果在 <code>belongs_to</code> 关联中使用 <code>select</code> 方法，应该同时设置 <code>:foreign_key</code> 选项，确保返回的结果正确。</p>
</blockquote>
<h5 id="4-1-4-什么时候保存对象"><a href="#4-1-4-什么时候保存对象" class="headerlink" title="4.1.4 什么时候保存对象"></a>4.1.4 什么时候保存对象</h5><ul>
<li>把对象赋值给 <code>belongs_to</code> 关联不会自动保存对象，也不会保存关联的对象。</li>
</ul>
<h4 id="4-2-has-one-关联详解"><a href="#4-2-has-one-关联详解" class="headerlink" title="4.2 has_one 关联详解"></a>4.2 <code>has_one</code> 关联详解</h4><ul>
<li><code>has_one</code> 关联建立两个模型之间的一对一关系。用数据库术语来说，这种关联的意思是外键在另一个类中。如果外键在这个类中，应该使用 <code>belongs_to</code> 关联。</li>
</ul>
<h5 id="4-2-1-has-one-关联添加的方法"><a href="#4-2-1-has-one-关联添加的方法" class="headerlink" title="4.2.1 has_one 关联添加的方法"></a>4.2.1 <code>has_one</code> 关联添加的方法</h5><ul>
<li><p>声明 <code>has_one</code> 关联后，声明所在的类自动获得了五个关联相关的方法：——<strong>同4.1的belongs_to</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">association</span><br><span class="line">association=(associate)</span><br><span class="line">build_association(attributes = &#123;&#125;)</span><br><span class="line">create_association(attributes = &#123;&#125;)</span><br><span class="line">create_association!(attributes = &#123;&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Supplier &lt; ApplicationRecord</span><br><span class="line">  has_one :account</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">account</span><br><span class="line">account=</span><br><span class="line">build_account</span><br><span class="line">create_account</span><br><span class="line">create_account!</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-2-1-1-association"><a href="#4-2-1-1-association" class="headerlink" title="4.2.1.1 association"></a>4.2.1.1 <code>association</code></h6><h6 id="4-2-1-2-association-associate"><a href="#4-2-1-2-association-associate" class="headerlink" title="4.2.1.2 association=(associate)"></a>4.2.1.2 <code>association=(associate)</code></h6><h6 id="4-2-1-3-build-association-attributes"><a href="#4-2-1-3-build-association-attributes" class="headerlink" title="4.2.1.3 build_association(attributes = {})"></a>4.2.1.3 <code>build_association(attributes = {})</code></h6><h6 id="4-2-1-5-create-association-attributes"><a href="#4-2-1-5-create-association-attributes" class="headerlink" title="4.2.1.5 create_association!(attributes = {})"></a>4.2.1.5 <code>create_association!(attributes = {})</code></h6><h5 id="4-2-2-has-one-方法的选项"><a href="#4-2-2-has-one-方法的选项" class="headerlink" title="4.2.2 has_one 方法的选项"></a>4.2.2 <code>has_one</code> 方法的选项</h5><ul>
<li><p>有时还是需要定制 <code>has_one</code> 关联的行为。定制的方法很简单，声明关联时传入选项即可。</p>
<ul>
<li><p>例如，下面的关联使用了两个选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Supplier &lt; ApplicationRecord</span><br><span class="line">  has_one :account, class_name: &quot;Billing&quot;, dependent: :nullify</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>has_one</code> 关联支持下列选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">:as</span><br><span class="line">:autosave</span><br><span class="line">:class_name</span><br><span class="line">:dependent</span><br><span class="line">:foreign_key</span><br><span class="line">:inverse_of</span><br><span class="line">:primary_key</span><br><span class="line">:source</span><br><span class="line">:source_type</span><br><span class="line">:through</span><br><span class="line">:validate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-2-2-1-as"><a href="#4-2-2-1-as" class="headerlink" title="4.2.2.1 :as"></a>4.2.2.1 <code>:as</code></h6><blockquote>
<p><code>:as</code> 选项表明这是多态关联。<a href="https://ruby-china.github.io/rails-guides/association_basics.html#polymorphic-associations" target="_blank" rel="noopener">前文</a>已经详细介绍过多态关联。</p>
</blockquote>
<h6 id="4-2-2-2-autosave"><a href="#4-2-2-2-autosave" class="headerlink" title="4.2.2.2 :autosave"></a>4.2.2.2 <code>:autosave</code></h6><blockquote>
<p>如果把 <code>:autosave</code> 选项设为 <code>true</code>，保存父对象时，会自动保存所有子对象，并把标记为析构的子对象销毁。</p>
</blockquote>
<h6 id="4-2-2-3-class-name"><a href="#4-2-2-3-class-name" class="headerlink" title="4.2.2.3 :class_name"></a>4.2.2.3 <code>:class_name</code></h6><blockquote>
<p>如果另一个模型无法从关联的名称获取，可以使用 <code>:class_name</code> 选项指定模型名。例如，供应商有一个账户，但表示账户的模型是 <code>Billing</code>，那么就可以这样声明关联：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt; class Supplier &lt; ApplicationRecord</span><br><span class="line">&gt;   has_one :account, class_name: &quot;Billing&quot;</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-2-2-4-dependent"><a href="#4-2-2-4-dependent" class="headerlink" title="4.2.2.4 :dependent"></a>4.2.2.4 <code>:dependent</code></h6><blockquote>
<p>控制属主销毁后怎么处理关联的对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; :destroy：也销毁关联的对象；</span><br><span class="line">&gt; :delete：直接把关联的对象从数据库中删除（不执行回调）；</span><br><span class="line">&gt; :nullify：把外键设为 NULL，不执行回调；</span><br><span class="line">&gt; :restrict_with_exception：有关联的对象时抛出异常；</span><br><span class="line">&gt; :restrict_with_error：有关联的对象时，向属主添加一个错误；</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-2-2-5-foreign-key"><a href="#4-2-2-5-foreign-key" class="headerlink" title="4.2.2.5 :foreign_key"></a>4.2.2.5 <code>:foreign_key</code></h6><blockquote>
<p>按照约定，在另一个模型中用来存储外键的字段名是模型名后加 <code>_id</code>。<code>:foreign_key</code> 选项用于设置要使用的外键名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt; class Supplier &lt; ApplicationRecord</span><br><span class="line">&gt;   has_one :account, foreign_key: &quot;supp_id&quot;</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-2-2-6-inverse-of"><a href="#4-2-2-6-inverse-of" class="headerlink" title="4.2.2.6 :inverse_of"></a>4.2.2.6 <code>:inverse_of</code></h6><blockquote>
<p><code>:inverse_of</code> 选项指定 <code>has_one</code> 关联另一端的 <code>belongs_to</code> 关联名。不能和 <code>:through</code> 或 <code>:as</code> 选项一起使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">&gt; class Supplier &lt; ApplicationRecord</span><br><span class="line">&gt;   has_one :account, inverse_of: :supplier</span><br><span class="line">&gt; end</span><br><span class="line">&gt;  </span><br><span class="line">&gt; class Account &lt; ApplicationRecord</span><br><span class="line">&gt;   belongs_to :supplier, inverse_of: :account</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="4-2-2-7-primary-key"><a href="#4-2-2-7-primary-key" class="headerlink" title="4.2.2.7 :primary_key"></a>4.2.2.7 <code>:primary_key</code></h6><blockquote>
<p>按照约定，用来存储该模型主键的字段名 <code>id</code>。<code>:primary_key</code> 选项用于设置要使用的主键名。</p>
</blockquote>
<h6 id="4-2-2-8-source"><a href="#4-2-2-8-source" class="headerlink" title="4.2.2.8 :source"></a>4.2.2.8 <code>:source</code></h6><blockquote>
<p><code>:source</code> 选项指定 <code>has_one :through</code> 关联的源关联名称。</p>
</blockquote>
<h6 id="4-2-2-9-source-type"><a href="#4-2-2-9-source-type" class="headerlink" title="4.2.2.9 :source_type"></a>4.2.2.9 <code>:source_type</code></h6><blockquote>
<p><code>:source_type</code> 选项指定通过多态关联处理 <code>has_one :through</code> 关联的源关联类型。</p>
</blockquote>
<h6 id="4-2-2-10-through"><a href="#4-2-2-10-through" class="headerlink" title="4.2.2.10 :through"></a>4.2.2.10 <code>:through</code></h6><blockquote>
<p><code>:through</code> 选项指定用于执行查询的联结模型。<a href="https://ruby-china.github.io/rails-guides/association_basics.html#the-has-one-through-association" target="_blank" rel="noopener">前文</a>详细介绍过 <code>has_one :through</code> 关联。</p>
</blockquote>
<h6 id="4-2-2-11-validate"><a href="#4-2-2-11-validate" class="headerlink" title="4.2.2.11 :validate"></a>4.2.2.11 <code>:validate</code></h6><blockquote>
<p>如果把 <code>:validate</code> 选项设为 <code>true</code>，保存对象时，会同时验证关联的对象。该选项的默认值是 <code>false</code>，即保存对象时不验证关联的对象。</p>
</blockquote>
<h5 id="4-2-3-has-one-的作用域"><a href="#4-2-3-has-one-的作用域" class="headerlink" title="4.2.3 has_one 的作用域"></a>4.2.3 <code>has_one</code> 的作用域</h5><ul>
<li><p>在作用域代码块中可以使用任何一个标准的<a href="https://ruby-china.github.io/rails-guides/active_record_querying.html" target="_blank" rel="noopener">查询方法</a>。下面介绍其中几个：——<strong>同4.1的belongs_to</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">where</span><br><span class="line">includes</span><br><span class="line">readonly</span><br><span class="line">select</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-2-3-1-where"><a href="#4-2-3-1-where" class="headerlink" title="4.2.3.1 where"></a>4.2.3.1 <code>where</code></h6><h6 id="4-2-3-2-includes"><a href="#4-2-3-2-includes" class="headerlink" title="4.2.3.2 includes"></a>4.2.3.2 <code>includes</code></h6><h6 id="4-2-3-3-readonly"><a href="#4-2-3-3-readonly" class="headerlink" title="4.2.3.3 readonly"></a>4.2.3.3 <code>readonly</code></h6><h6 id="4-2-3-4-select"><a href="#4-2-3-4-select" class="headerlink" title="4.2.3.4 select"></a>4.2.3.4 <code>select</code></h6><h5 id="4-2-4-检查关联的对象是否存在"><a href="#4-2-4-检查关联的对象是否存在" class="headerlink" title="4.2.4 检查关联的对象是否存在"></a>4.2.4 检查关联的对象是否存在</h5><ul>
<li><p>检查关联的对象是否存在，可以使用 <code>association.nil?</code> 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if @supplier.account.nil?</span><br><span class="line">  @msg = &quot;No account found for this supplier&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="4-2-5-什么时候保存对象"><a href="#4-2-5-什么时候保存对象" class="headerlink" title="4.2.5 什么时候保存对象"></a>4.2.5 什么时候保存对象</h5><ul>
<li>把对象赋值给 <code>has_one</code> 关联时，那个对象会自动保存（因为要更新外键）。而且所有被替换的对象也会自动保存，因为外键也变了<ul>
<li>如果父对象（<code>has_one</code> 关联声明所在的模型）没保存（<code>new_record?</code> 方法返回 <code>true</code>），那么子对象也不会保存。只有保存了父对象，才会保存子对象。</li>
</ul>
</li>
</ul>
<h4 id="4-3-has-many-关联详解"><a href="#4-3-has-many-关联详解" class="headerlink" title="4.3 has_many 关联详解"></a>4.3 <code>has_many</code> 关联详解</h4><ul>
<li><code>has_many</code> 关联建立两个模型之间的一对多关系。用数据库术语来说，这种关联的意思是外键在另一个类中，指向这个类的实例。</li>
</ul>
<h5 id="4-3-1-has-many-关联添加的方法"><a href="#4-3-1-has-many-关联添加的方法" class="headerlink" title="4.3.1 has_many 关联添加的方法"></a>4.3.1 <code>has_many</code> 关联添加的方法</h5><ul>
<li><p>声明 <code>has_many</code> 关联后，声明所在的类自动获得了 16 个关联相关的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">collection</span><br><span class="line">collection&lt;&lt;(object, &amp;#8230;&amp;#8203;)</span><br><span class="line">collection.delete(object, &amp;#8230;&amp;#8203;)</span><br><span class="line">collection.destroy(object, &amp;#8230;&amp;#8203;)</span><br><span class="line">collection=(objects)</span><br><span class="line">collection_singular_ids</span><br><span class="line">collection_singular_ids=(ids)</span><br><span class="line">collection.clear</span><br><span class="line">collection.empty?</span><br><span class="line">collection.size</span><br><span class="line">collection.find(&amp;#8230;&amp;#8203;)</span><br><span class="line">collection.where(&amp;#8230;&amp;#8203;)</span><br><span class="line">collection.exists?(&amp;#8230;&amp;#8203;)</span><br><span class="line">collection.build(attributes = &#123;&#125;, &amp;#8230;&amp;#8203;)</span><br><span class="line">collection.create(attributes = &#123;&#125;)</span><br><span class="line">collection.create!(attributes = &#123;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>这些个方法中的 <code>collection</code> 要替换成传给 <code>has_many</code> 方法的第一个参数。<code>collection_singular</code> 要替换成第一个参数的单数形式。对如下的声明来说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Author &lt; ApplicationRecord</span><br><span class="line">  has_many :books</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">每个 Author 模型实例都获得了这些方法：</span><br><span class="line">books</span><br><span class="line">books&lt;&lt;(object, ...)</span><br><span class="line">books.delete(object, ...)</span><br><span class="line">books.destroy(object, ...)</span><br><span class="line">books=(objects)</span><br><span class="line">book_ids</span><br><span class="line">book_ids=(ids)</span><br><span class="line">books.clear</span><br><span class="line">books.empty?</span><br><span class="line">books.size</span><br><span class="line">books.find(...)</span><br><span class="line">books.where(...)</span><br><span class="line">books.exists?(...)</span><br><span class="line">books.build(attributes = &#123;&#125;, ...)</span><br><span class="line">books.create(attributes = &#123;&#125;)</span><br><span class="line">books.create!(attributes = &#123;&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-3-1-1-collection"><a href="#4-3-1-1-collection" class="headerlink" title="4.3.1.1 collection"></a>4.3.1.1 <code>collection</code></h6><h6 id="4-3-1-2-collection-lt-lt-object-amp-8230-amp-8203"><a href="#4-3-1-2-collection-lt-lt-object-amp-8230-amp-8203" class="headerlink" title="4.3.1.2 collection&lt;&lt;(object, &amp;#8230;&amp;#8203;)"></a>4.3.1.2 <code>collection&lt;&lt;(object, &amp;#8230;&amp;#8203;)</code></h6><h6 id="4-3-1-3-collection-delete-object-amp-8230-amp-8203"><a href="#4-3-1-3-collection-delete-object-amp-8230-amp-8203" class="headerlink" title="4.3.1.3 collection.delete(object, &amp;#8230;&amp;#8203;)"></a>4.3.1.3 <code>collection.delete(object, &amp;#8230;&amp;#8203;)</code></h6><h6 id="4-3-1-4-collection-destroy-object-amp-8230-amp-8203"><a href="#4-3-1-4-collection-destroy-object-amp-8230-amp-8203" class="headerlink" title="4.3.1.4 collection.destroy(object, &amp;#8230;&amp;#8203;)"></a>4.3.1.4 <code>collection.destroy(object, &amp;#8230;&amp;#8203;)</code></h6><h6 id="4-3-1-5-collection-objects"><a href="#4-3-1-5-collection-objects" class="headerlink" title="4.3.1.5 collection=(objects)"></a>4.3.1.5 <code>collection=(objects)</code></h6><h6 id="4-3-1-6-collection-singular-ids"><a href="#4-3-1-6-collection-singular-ids" class="headerlink" title="4.3.1.6 collection_singular_ids"></a>4.3.1.6 <code>collection_singular_ids</code></h6><h6 id="4-3-1-7-collection-singular-ids-ids"><a href="#4-3-1-7-collection-singular-ids-ids" class="headerlink" title="4.3.1.7 collection_singular_ids=(ids)"></a>4.3.1.7 <code>collection_singular_ids=(ids)</code></h6><h6 id="4-3-1-8-collection-clear"><a href="#4-3-1-8-collection-clear" class="headerlink" title="4.3.1.8 collection.clear"></a>4.3.1.8 <code>collection.clear</code></h6><h6 id="4-3-1-9-collection-empty"><a href="#4-3-1-9-collection-empty" class="headerlink" title="4.3.1.9 collection.empty?"></a>4.3.1.9 <code>collection.empty?</code></h6><h6 id="4-3-1-10-collection-size"><a href="#4-3-1-10-collection-size" class="headerlink" title="4.3.1.10 collection.size"></a>4.3.1.10 <code>collection.size</code></h6><h6 id="4-3-1-11-collection-find-amp-8230-amp-8203"><a href="#4-3-1-11-collection-find-amp-8230-amp-8203" class="headerlink" title="4.3.1.11 collection.find(&amp;#8230;&amp;#8203;)"></a>4.3.1.11 <code>collection.find(&amp;#8230;&amp;#8203;)</code></h6><h5 id="4-3-2-collection-where-amp-8230-amp-8203"><a href="#4-3-2-collection-where-amp-8230-amp-8203" class="headerlink" title="4.3.2 collection.where(&amp;#8230;&amp;#8203;)"></a>4.3.2 <code>collection.where(&amp;#8230;&amp;#8203;)</code></h5><h6 id="4-3-2-1-collection-exists-amp-8230-amp-8203"><a href="#4-3-2-1-collection-exists-amp-8230-amp-8203" class="headerlink" title="4.3.2.1 collection.exists?(&amp;#8230;&amp;#8203;)"></a>4.3.2.1 <code>collection.exists?(&amp;#8230;&amp;#8203;)</code></h6><h6 id="4-3-2-2-collection-build-attributes-amp-8230-amp-8203"><a href="#4-3-2-2-collection-build-attributes-amp-8230-amp-8203" class="headerlink" title="4.3.2.2 collection.build(attributes = {}, &amp;#8230;&amp;#8203;)"></a>4.3.2.2 <code>collection.build(attributes = {}, &amp;#8230;&amp;#8203;)</code></h6><h6 id="4-3-2-3-collection-create-attributes"><a href="#4-3-2-3-collection-create-attributes" class="headerlink" title="4.3.2.3 collection.create(attributes = {})"></a>4.3.2.3 <code>collection.create(attributes = {})</code></h6><h6 id="4-3-3-collection-create-attributes"><a href="#4-3-3-collection-create-attributes" class="headerlink" title="4.3.3 collection.create!(attributes = {})"></a>4.3.3 <code>collection.create!(attributes = {})</code></h6><h5 id="4-3-4-has-many-方法的选项"><a href="#4-3-4-has-many-方法的选项" class="headerlink" title="4.3.4 has_many 方法的选项"></a>4.3.4 <code>has_many</code> 方法的选项</h5><ul>
<li><p>有时还是需要定制 <code>has_many</code> 关联的行为。定制的方法很简单，声明关联时传入选项即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">:as</span><br><span class="line">:autosave</span><br><span class="line">:class_name</span><br><span class="line">:counter_cache</span><br><span class="line">:dependent</span><br><span class="line">:foreign_key</span><br><span class="line">:inverse_of</span><br><span class="line">:primary_key</span><br><span class="line">:source</span><br><span class="line">:source_type</span><br><span class="line">:through</span><br><span class="line">:validate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-3-4-1-as"><a href="#4-3-4-1-as" class="headerlink" title="4.3.4.1 :as"></a>4.3.4.1 <code>:as</code></h6><h6 id="4-3-4-2-autosave"><a href="#4-3-4-2-autosave" class="headerlink" title="4.3.4.2 :autosave"></a>4.3.4.2 <code>:autosave</code></h6><h6 id="4-3-4-3-class-name"><a href="#4-3-4-3-class-name" class="headerlink" title="4.3.4.3 :class_name"></a>4.3.4.3 <code>:class_name</code></h6><h6 id="4-3-4-4-counter-cache"><a href="#4-3-4-4-counter-cache" class="headerlink" title="4.3.4.4 :counter_cache"></a>4.3.4.4 <code>:counter_cache</code></h6><h6 id="4-3-4-5-dependent"><a href="#4-3-4-5-dependent" class="headerlink" title="4.3.4.5 :dependent"></a>4.3.4.5 <code>:dependent</code></h6><h6 id="4-3-4-6-foreign-key"><a href="#4-3-4-6-foreign-key" class="headerlink" title="4.3.4.6 :foreign_key"></a>4.3.4.6 <code>:foreign_key</code></h6><h6 id="4-3-4-7-inverse-of"><a href="#4-3-4-7-inverse-of" class="headerlink" title="4.3.4.7 :inverse_of"></a>4.3.4.7 <code>:inverse_of</code></h6><h6 id="4-3-4-8-primary-key"><a href="#4-3-4-8-primary-key" class="headerlink" title="4.3.4.8 :primary_key"></a>4.3.4.8 <code>:primary_key</code></h6><h6 id="4-3-4-9-source"><a href="#4-3-4-9-source" class="headerlink" title="4.3.4.9 :source"></a>4.3.4.9 <code>:source</code></h6><h6 id="4-3-4-10-source-type"><a href="#4-3-4-10-source-type" class="headerlink" title="4.3.4.10 :source_type"></a>4.3.4.10 <code>:source_type</code></h6><h6 id="4-3-4-11-through"><a href="#4-3-4-11-through" class="headerlink" title="4.3.4.11 :through"></a>4.3.4.11 <code>:through</code></h6><h6 id="4-3-4-12-validate"><a href="#4-3-4-12-validate" class="headerlink" title="4.3.4.12 :validate"></a>4.3.4.12 <code>:validate</code></h6><h5 id="4-3-5-has-many-的作用域"><a href="#4-3-5-has-many-的作用域" class="headerlink" title="4.3.5 has_many 的作用域"></a>4.3.5 <code>has_many</code> 的作用域</h5><ul>
<li><p>在作用域代码块中可以使用任何一个标准的<a href="https://ruby-china.github.io/rails-guides/active_record_querying.html" target="_blank" rel="noopener">查询方法</a>。下面介绍其中几个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">where</span><br><span class="line">extending</span><br><span class="line">group</span><br><span class="line">includes</span><br><span class="line">limit</span><br><span class="line">offset</span><br><span class="line">order</span><br><span class="line">readonly</span><br><span class="line">select</span><br><span class="line">distinct</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="4-3-5-1-where"><a href="#4-3-5-1-where" class="headerlink" title="4.3.5.1 where"></a>4.3.5.1 <code>where</code></h6><h6 id="4-3-5-2-extending"><a href="#4-3-5-2-extending" class="headerlink" title="4.3.5.2 extending"></a>4.3.5.2 <code>extending</code></h6><h6 id="4-3-5-3-group"><a href="#4-3-5-3-group" class="headerlink" title="4.3.5.3 group"></a>4.3.5.3 <code>group</code></h6><h6 id="4-3-5-4-includes"><a href="#4-3-5-4-includes" class="headerlink" title="4.3.5.4 includes"></a>4.3.5.4 <code>includes</code></h6><h6 id="4-3-5-5-limit"><a href="#4-3-5-5-limit" class="headerlink" title="4.3.5.5 limit"></a>4.3.5.5 <code>limit</code></h6><h6 id="4-3-5-6-offset"><a href="#4-3-5-6-offset" class="headerlink" title="4.3.5.6 offset"></a>4.3.5.6 <code>offset</code></h6><h6 id="4-3-5-7-order"><a href="#4-3-5-7-order" class="headerlink" title="4.3.5.7 order"></a>4.3.5.7 <code>order</code></h6><h6 id="4-3-5-8-readonly"><a href="#4-3-5-8-readonly" class="headerlink" title="4.3.5.8 readonly"></a>4.3.5.8 <code>readonly</code></h6><h6 id="4-3-5-9-select"><a href="#4-3-5-9-select" class="headerlink" title="4.3.5.9 select"></a>4.3.5.9 <code>select</code></h6><h6 id="4-3-5-10-distinct"><a href="#4-3-5-10-distinct" class="headerlink" title="4.3.5.10 distinct"></a>4.3.5.10 <code>distinct</code></h6><h5 id="4-3-6-什么时候保存对象"><a href="#4-3-6-什么时候保存对象" class="headerlink" title="4.3.6 什么时候保存对象"></a>4.3.6 什么时候保存对象</h5><ul>
<li>把对象赋值给 <code>has_many</code> 关联时，会自动保存对象（因为要更新外键）。如果一次赋值多个对象，所有对象都会自动保存。</li>
</ul>
<h4 id="4-4-has-and-belongs-to-many-关联详解"><a href="#4-4-has-and-belongs-to-many-关联详解" class="headerlink" title="4.4 has_and_belongs_to_many 关联详解"></a>4.4 <code>has_and_belongs_to_many</code> 关联详解</h4><ul>
<li><code>has_and_belongs_to_many</code> 关联建立两个模型之间的多对多关系。用数据库术语来说，这种关联的意思是有个联结表包含指向这两个类的外键。</li>
</ul>
<h5 id="4-4-1-has-and-belongs-to-many-关联添加的方法"><a href="#4-4-1-has-and-belongs-to-many-关联添加的方法" class="headerlink" title="4.4.1 has_and_belongs_to_many 关联添加的方法"></a>4.4.1 <code>has_and_belongs_to_many</code> 关联添加的方法</h5><ul>
<li><p>声明 <code>has_and_belongs_to_many</code> 关联后，声明所在的类自动获得了 16 个关联相关的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">collection</span><br><span class="line">collection&lt;&lt;(object, &amp;#8230;&amp;#8203;)</span><br><span class="line">collection.delete(object, &amp;#8230;&amp;#8203;)</span><br><span class="line">collection.destroy(object, &amp;#8230;&amp;#8203;)</span><br><span class="line">collection=(objects)</span><br><span class="line">collection_singular_ids</span><br><span class="line">collection_singular_ids=(ids)</span><br><span class="line">collection.clear</span><br><span class="line">collection.empty?</span><br><span class="line">collection.size</span><br><span class="line">collection.find(&amp;#8230;&amp;#8203;)</span><br><span class="line">collection.where(&amp;#8230;&amp;#8203;)</span><br><span class="line">collection.exists?(&amp;#8230;&amp;#8203;)</span><br><span class="line">collection.build(attributes = &#123;&#125;)</span><br><span class="line">collection.create(attributes = &#123;&#125;)</span><br><span class="line">collection.create!(attributes = &#123;&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>4.4.1.1 额外的列方法</p>
<ul>
<li>如果在多对多关联中需要使用这么复杂的数据表，应该用 <code>has_many :through</code> 关联代替 <code>has_and_belongs_to_many</code> 关联。</li>
</ul>
<p>4.4.1.2 <code>collection</code></p>
<p>4.4.1.3 <code>collection&lt;&lt;(object, &amp;#8230;&amp;#8203;)</code></p>
<p>4.4.1.4 <code>collection.delete(object, &amp;#8230;&amp;#8203;)</code></p>
<p>4.4.1.5 <code>collection.destroy(object, &amp;#8230;&amp;#8203;)</code></p>
<p>4.4.1.6 <code>collection=(objects)</code></p>
<p>4.4.1.7 <code>collection_singular_ids</code></p>
<p>4.4.1.8 <code>collection_singular_ids=(ids)</code></p>
<p>4.4.1.9 <code>collection.clear</code></p>
<p>4.4.1.10 <code>collection.empty?</code></p>
<p>4.4.1.11 <code>collection.size</code></p>
<p>4.4.1.12 <code>collection.find(&amp;#8230;&amp;#8203;)</code></p>
<p>4.4.1.13 <code>collection.where(&amp;#8230;&amp;#8203;)</code></p>
<p>4.4.1.14 <code>collection.exists?(&amp;#8230;&amp;#8203;)</code></p>
<p>4.4.1.15 <code>collection.build(attributes = {})</code></p>
<p>4.4.1.16 <code>collection.create(attributes = {})</code></p>
<p>4.4.1.17 <code>collection.create!(attributes = {})</code></p>
<h5 id="4-4-2-has-and-belongs-to-many-方法的选项"><a href="#4-4-2-has-and-belongs-to-many-方法的选项" class="headerlink" title="4.4.2 has_and_belongs_to_many 方法的选项"></a>4.4.2 <code>has_and_belongs_to_many</code> 方法的选项</h5><ul>
<li><p><code>has_and_belongs_to_many</code> 关联支持以下选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">:association_foreign_key</span><br><span class="line">:autosave</span><br><span class="line">:class_name</span><br><span class="line">:foreign_key</span><br><span class="line">:join_table</span><br><span class="line">:validate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>4.4.2.1 <code>:association_foreign_key</code></p>
<p>4.4.2.2 <code>:autosave</code></p>
<p>4.4.2.3 <code>:class_name</code></p>
<p>4.4.2.4 <code>:foreign_key</code></p>
<p>4.4.2.5 <code>:join_table</code></p>
<p>4.4.2.6 <code>:validate</code></p>
<h5 id="4-4-3-has-and-belongs-to-many-的作用域"><a href="#4-4-3-has-and-belongs-to-many-的作用域" class="headerlink" title="4.4.3 has_and_belongs_to_many 的作用域"></a>4.4.3 <code>has_and_belongs_to_many</code> 的作用域</h5><ul>
<li><p>在作用域代码块中可以使用任何一个标准的<a href="https://ruby-china.github.io/rails-guides/active_record_querying.html" target="_blank" rel="noopener">查询方法</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">where</span><br><span class="line">extending</span><br><span class="line">group</span><br><span class="line">includes</span><br><span class="line">limit</span><br><span class="line">offset</span><br><span class="line">order</span><br><span class="line">readonly</span><br><span class="line">select</span><br><span class="line">distinct</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>4.4.3.1 <code>where</code></p>
<p>4.4.3.2 <code>extending</code></p>
<p>4.4.3.3 <code>group</code></p>
<p>4.4.3.4 <code>includes</code></p>
<p>4.4.3.5 <code>limit</code></p>
<p>4.4.3.6 <code>offset</code></p>
<p>4.4.3.7 <code>order</code></p>
<p>4.4.3.8 <code>readonly</code></p>
<p>4.4.3.9 <code>select</code></p>
<p>4.4.3.10 <code>distinct</code></p>
<h5 id="4-4-4-什么时候保存对象"><a href="#4-4-4-什么时候保存对象" class="headerlink" title="4.4.4 什么时候保存对象"></a>4.4.4 什么时候保存对象</h5><ul>
<li>把对象赋值给 <code>has_and_belongs_to_many</code> 关联时，会自动保存对象（因为要更新外键）。如果一次赋值多个对象，所有对象都会自动保存。</li>
</ul>
<h4 id="4-5-关联回调"><a href="#4-5-关联回调" class="headerlink" title="4.5 关联回调"></a>4.5 关联回调</h4><ul>
<li><p>关联回调和普通回调差不多，只不过由集合生命周期中的事件触发。关联回调有四种：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">before_add</span><br><span class="line">after_add</span><br><span class="line">before_remove</span><br><span class="line">after_remove</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联回调在声明关联时定义。同一事件可以触发多个回调，多个回调使用数组指定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Author &lt; ApplicationRecord</span><br><span class="line">  has_many :books,</span><br><span class="line">    before_add: [:check_credit_limit, :calculate_shipping_charges]</span><br><span class="line"> </span><br><span class="line">  def check_credit_limit(book)</span><br><span class="line">    ...</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  def calculate_shipping_charges(book)</span><br><span class="line">    ...</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>before_add</code> 回调抛出异常，不会把对象添加到集合中。类似地，如果 <code>before_remove</code> 抛出异常，对象不会从集合中删除。</li>
</ul>
</li>
</ul>
<h4 id="4-6-关联扩展"><a href="#4-6-关联扩展" class="headerlink" title="4.6 关联扩展"></a>4.6 关联扩展</h4><ul>
<li><p>Rails 基于关联代理对象自动创建的功能是死的，可以通过匿名模块、新的查找方法、创建对象的方法等进行扩展。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Author &lt; ApplicationRecord</span><br><span class="line">  has_many :books do</span><br><span class="line">    def find_by_book_prefix(book_number)</span><br><span class="line">      find_by(category_id: book_number[0..2])</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果扩展要在多个关联中使用，可以将其写入具名扩展模块。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">module FindRecentExtension</span><br><span class="line">  def find_recent</span><br><span class="line">    where(&quot;created_at &gt; ?&quot;, 5.days.ago)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Author &lt; ApplicationRecord</span><br><span class="line">  has_many :books, -&gt; &#123; extending FindRecentExtension &#125;</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">class Supplier &lt; ApplicationRecord</span><br><span class="line">  has_many :deliveries, -&gt; &#123; extending FindRecentExtension &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li><p>在扩展中可以使用如下 <code>proxy_association</code> 方法的三个属性获取关联代理的内部信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy_association.owner：返回关联所属的对象；</span><br><span class="line">proxy_association.reflection：返回描述关联的反射对象；</span><br><span class="line">proxy_association.target：返回 belongs_to 或 has_one 关联的关联对象，或者 has_many 或 has_and_belongs_to_many 关联的关联对象集合；</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="5-单表继承"><a href="#5-单表继承" class="headerlink" title="5 单表继承"></a>5 单表继承</h3><ul>
<li><p>有时可能想在不同的模型中共用相同的字段和行为。</p>
</li>
<li><p>假如有 Car、Motorcycle 和 Bicycle 三个模型，我们想在它们中共用 <code>color</code> 和 <code>price</code> 字段，但是各自的具体行为不同，而且使用不同的控制器。</p>
<p>在 Rails 中实现这一需求非常简单。首先，生成基模型 Vehicle：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rails generate model vehicle type:string color:string price:decimal&#123;10.2&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对这个例子来说，“type”字段的值可能是“Car”、“Motorcycle”或“Bicycle”。如果表中没有“type”字段，单表继承无法工作。</li>
<li>然后，生成三个模型，都继承自 Vehicle。为此，可以使用 <code>parent=PARENT</code> 选项。这样，生成的模型继承指定的父模型，而且不生成对应的迁移（因为表已经存在）。例如，生成 Car 模型的命令是：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rails generate model car --parent=Vehicle</span><br></pre></td></tr></table></figure>
<ul>
<li>生成的模型如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class Car &lt; Vehicle</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li><p>这意味着，添加到 Vehicle 中的所有行为在 Car 中都可用，例如关联、公开方法，等等。</p>
<p>创建一辆汽车，相应的记录保存在 <code>vehicles</code> 表中，而且 <code>type</code> 字段的值是“Car”：对应的 SQL 如下：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Car.create(color: &apos;Red&apos;, price: 10000)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &quot;vehicles&quot; (&quot;type&quot;, &quot;color&quot;, &quot;price&quot;) VALUES (&apos;Car&apos;, &apos;Red&apos;, 10000)</span><br></pre></td></tr></table></figure>
<ul>
<li>查询汽车记录时只会搜索此类车辆：对应的 SQL 如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Car.all</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &quot;vehicles&quot;.* FROM &quot;vehicles&quot; WHERE &quot;vehicles&quot;.&quot;type&quot; IN (&apos;Car&apos;)</span><br></pre></td></tr></table></figure>
</li>
</ul>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">by 99</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/posts/7d273add/" class="pre-post btn btn-default"><i class="fa fa-angle-left fa-fw"></i>上一篇</a>
    
    
        <a href="/posts/19619b26/" class="next-post btn btn-default">下一篇<i class="fa fa-angle-right fa-fw"></i></a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMzE1My85NzEx">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>


            </main>
            
    <aside class="col-md-3 sidebar">
        
        
    <div class="widget">
        <h3 class="title">搜尋</h3>
        <div id="search-form">
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?">
                    <button type="button" class="search-form-submit" id="search-local">搜索</button>
                
                
            </div>
            <div id="result-wrap" class="hide">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        
        
    <div class="widget notification">
        <h3 class="title">网站公告</h3>
        <div>
            <p>你好，我是99。<br/>欢迎来到我的博客。<br/>
<br/>
<hr/>接受贡献，包括不限于提交问题与需求，修复代码。欢迎Pull Request<br/>支持主题：<a href="https://github.com/shenliyang/hexo-theme-snippet/stargazers">Star一下</a>
</p>
        </div>
    </div>

        
        
    <div class="widget">
      <h3 class="title">社交</h3> 
        <div class="content social">
            
	            <a href="https://github.com/jiujiubad?tab=repositories" rel="external nofollow" title="Github" target="_blank">
			    	<i class="github fa fa-github"></i>
			    </a>
            
	            <a href="jiujiubad@gmail.com" rel="external nofollow" title="邮箱" target="_blank">
			    	<i class="envelope-o fa fa-envelope-o"></i>
			    </a>
            
	            <a href="https://ws4.sinaimg.cn/large/006tNc79ly1fnvcxiavzgj30by0bymxg.jpg" rel="external nofollow" title="微信" target="_blank">
			    	<i class="weixin fa fa-weixin"></i>
			    </a>
            
        </div>
    </div>


        
        
    <div class="widget">
        <h3 class="title">分類</h3>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ror功能/"><i class="fa" aria-hidden="true">ror功能</i></a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ror知识点/"><i class="fa" aria-hidden="true">ror知识点</i></a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ror系统/"><i class="fa" aria-hidden="true">ror系统</i></a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web页面/"><i class="fa" aria-hidden="true">web页面</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/"><i class="fa" aria-hidden="true">工具</i></a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信小程序/"><i class="fa" aria-hidden="true">微信小程序</i></a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link current" href="/categories/心得/"><i class="fa" aria-hidden="true">心得</i></a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/投资/"><i class="fa" aria-hidden="true">投资</i></a><span class="category-list-count">1</span></li></ul>
    </div>


        
        
    <div class="widget">
      <h3 class="title">彙整</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/"><i class="fa" aria-hidden="true">March 2018</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/"><i class="fa" aria-hidden="true">February 2018</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/"><i class="fa" aria-hidden="true">January 2018</i></a><span class="archive-list-count">37</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/"><i class="fa" aria-hidden="true">December 2017</i></a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/"><i class="fa" aria-hidden="true">November 2017</i></a><span class="archive-list-count">36</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/"><i class="fa" aria-hidden="true">September 2017</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/"><i class="fa" aria-hidden="true">April 2017</i></a><span class="archive-list-count">1</span></li></ul>
    </div>


        
        
  <div class="widget">
    <h3 class="title">標籤雲</h3>
    <div class="content tag-cloud">
        <a href="/tags/atom/" style="font-size: 13.08px;">atom</a> <a href="/tags/bug/" style="font-size: 17.69px;">bug</a> <a href="/tags/heroku/" style="font-size: 10px;">heroku</a> <a href="/tags/hexo/" style="font-size: 11.54px;">hexo</a> <a href="/tags/interview/" style="font-size: 13.85px;">interview</a> <a href="/tags/mac/" style="font-size: 11.54px;">mac</a> <a href="/tags/orid-day/" style="font-size: 10.77px;">orid-day</a> <a href="/tags/orid-month/" style="font-size: 11.54px;">orid-month</a> <a href="/tags/ror功能/" style="font-size: 13.08px;">ror功能</a> <a href="/tags/ror知识点/" style="font-size: 16.92px;">ror知识点</a> <a href="/tags/ror系统/" style="font-size: 20px;">ror系统</a> <a href="/tags/stackoverflow/" style="font-size: 10px;">stackoverflow</a> <a href="/tags/typora/" style="font-size: 10px;">typora</a> <a href="/tags/vps/" style="font-size: 16.15px;">vps</a> <a href="/tags/web页面/" style="font-size: 11.54px;">web页面</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/工具/" style="font-size: 19.23px;">工具</a> <a href="/tags/常用/" style="font-size: 13.08px;">常用</a> <a href="/tags/微信功能/" style="font-size: 12.31px;">微信功能</a> <a href="/tags/微信系统/" style="font-size: 15.38px;">微信系统</a> <a href="/tags/微信页面/" style="font-size: 10.77px;">微信页面</a> <a href="/tags/心得/" style="font-size: 18.46px;">心得</a> <a href="/tags/手机/" style="font-size: 10px;">手机</a> <a href="/tags/投资/" style="font-size: 10px;">投资</a> <a href="/tags/搬砖/" style="font-size: 10px;">搬砖</a> <a href="/tags/核聚编程/" style="font-size: 14.62px;">核聚编程</a> <a href="/tags/科学上网/" style="font-size: 13.08px;">科学上网</a> <a href="/tags/部署/" style="font-size: 12.31px;">部署</a>
    </div>
  </div>


        
        
    <div class="widget">
        <h3 class="title">友鏈</h3>
        <div class="content friends-link">
        
            <a href="http://www.shenliyang.com" class="fa" target="_blank">个人博客</a>
        
        </div>
    </div>


        
    </aside>


        </div>
      </section>
    </div>
  </div>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <span>Copyright &copy; 2018
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



	<script src="/js/search.js?rev=@@hash"></script>


<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>
