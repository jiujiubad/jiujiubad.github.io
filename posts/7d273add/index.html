<!DOCTYPE HTML>
<html>
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>ror-system-MVC语法笔记 | Hexo</title>


    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css?rev=3.3.4">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
    <div class="hide">
    	<script src="https://s4.cnzz.com/z_stat.php?id=1263868967&web_id=1263868967" language="JavaScript"></script>
    </div>






    
</head>

<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
  <div class="container-fluid">
    <div class="row">
      <header class="main-header"  style="background-image:url(http://7xpw2b.com1.z0.glb.clouddn.com/hexo-sinppet/img/banner2.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="">
            <img src="/img/avatar.jpg" alt="logo头像">
        </a>
        <div class="branding1">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 记录，把握点滴  ——by 99 </h2>
            
    	</div>
    </div>
</header>

      <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only">Toggle navigation</span>
                    <i class="fa fa-bars"></i>
                    </span>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>主页</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/archives/"><i class="fa fa-fw "></i>所有</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/posts/d16694c4/"><i class="fa fa-fw "></i>标题</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/ror系统/"><i class="fa fa-fw "></i>ror系统</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/categories/微信小程序/"><i class="fa fa-fw "></i>微信小程序</a>
                            </li>
                        
                            <li role="presentation itit"><a href="/"><i class="fa fa-fw "></i>关于我</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

      <section class="content-wra aa99">
        <!-- <div class="row">
          
    <div class="widget" style="padding:0 15px;">
        <div id="search-form" > 
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?" style="width:100%;border-radius:0;">

                
                
            </div>
            <div id="result-wrap" class="hide" style="padding:0 20px;">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        </div> -->
        <div class="row">
            <main class="col-md-9 main-content m-post">
                <p id="process"></p>
<article class="post pp99">
    <div class="post-head">
        <h1 id="ror-system-MVC语法笔记">
            
	            ror-system-MVC语法笔记
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <span>ror系统</span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            ror系统
            
        </span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">2017/12/14</span>
    </span>
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <p><em>【小结】增加controller，就要想要加routes，然后在views里添加路径，然后在controller里把动作补全。
</em>【小结】增加栏位，修改views和controller，甚至model后，要记得加入params中。</p>
<p>ruby Where is the method ‘self’ defined in my Rails app</p>
<h3 id="现在才懂的MVC："><a href="#现在才懂的MVC：" class="headerlink" title="现在才懂的MVC："></a>现在才懂的MVC：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def index</span><br><span class="line">  @job = Job.find(params[:job_id])</span><br><span class="line">  @resumes = Resume.all</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">  def index</span><br><span class="line">  @job = Job.find(params[:job_id])</span><br><span class="line">  @resumes = @job.resumes.order(&quot;created_at DESC&quot;)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li><p>①、controller里的右边参数是类（大写开头），所以Resume.all就是捞出Resume这个类里所有的数据。②、@resumes为什么要加s，就是因为右边捞出来的数据是复数的。</p>
<p>③、然后看到相应的index的views，<code>&lt;% @resumes.each do |resume| %&gt;</code>这里的@resumes就是上面index里的@resumes</p>
</li>
</ul>
<h2 id="怎么解读这些需求？"><a href="#怎么解读这些需求？" class="headerlink" title="怎么解读这些需求？"></a>怎么解读这些需求？</h2><p>购物车练习作业</p>
<ul>
<li>1、请设计一个功能，可以一键清空购物车内所有的物品</li>
<li>2、某样东西突然不想买了，我可以在购物车内删除它</li>
<li>3、已经加入购物车的物品，不能重复被加入</li>
<li>4、可以更改购物车内购买的数量( 原本预设数量都是1）</li>
<li>5、库存为 0 的货品不能购买</li>
<li>6、在购物车新增数量时，不能更新超过原有库存的数量</li>
</ul>
<blockquote>
<p>1、清空所有物品即要清空格子cart_item，是一个动作，在cart的controller里定义一个新的动作、routes加路径delete :clean，因为清空是针对多个格子所以用collection。<br>2、删除一个cart_item，是一个动作，删除一件是destroy的action，所以添加cart_item的controller和相应的destroy的action。<br>3、商品已加入购物车说明车子id已知。。。加入产品的关键代码是add_products_to_cart。。。</p>
<p>Include?是什么？</p>
<p>正解：在current_cart.add_product_to_cart(@product)加入判断，当前车子是否包含这件商品if !current_cart.products.include?(@product)。include?在dash上查到ruby和rails都有这样的用法。<br>4、商品数量是current_cart.current_item.product.count。。。<br>正解：更改数量意味着要edit和update数量，商品数量前边有定义cart_item.quantity<br>5、换个说法是如果库存为0则提示商品无库存，是一个if判断，商品数量是cart_item.quantity，要改的位置有product_controller的add_to_cart行为。<br>6、更新为cart_item_controller的update行为增加if条件。</p>
</blockquote>
<h2 id="怎么解读这些需求？-1"><a href="#怎么解读这些需求？-1" class="headerlink" title="怎么解读这些需求？"></a>怎么解读这些需求？</h2><p>订单状态切换</p>
<ul>
<li>1、建立 admin/orders 可以看到系统内所有订单</li>
<li>2、admin 的 order 列表应要能显示订单状态</li>
<li>3、使用者可以“申请取消订单”</li>
<li>4、使用者“申请取消订单”后，管理员应该要收到“申请通知信”</li>
<li>5、后台管理员可以“取消订单”、“出货”</li>
<li>6、后台管理“出货”后，系统应该寄出通知信</li>
<li>7、后台管理员“取消订单”后，系统应该寄出通知信</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gem &apos;letter_opener&apos;, group: :development</span><br><span class="line">A：这个gem只在development开发环境下使用</span><br><span class="line"></span><br><span class="line">config/environments/development.rb</span><br><span class="line">config.action_mailer.default_url_options = &#123; host: &apos;localhost:3000&apos; &#125;  #gem官网没有给这条代码，测试发现没有这条也可以运行。</span><br><span class="line">config.action_mailer.delivery_method = :letter_opener</span><br></pre></td></tr></table></figure>
<blockquote>
<p>网址<a href="https://fullstack.xinshengdaxue.com/posts/661#task中的#task是什么？" target="_blank" rel="noopener">https://fullstack.xinshengdaxue.com/posts/661#task中的#task是什么？</a><br>A：#像锚点一样，代表网页中的一个位置，浏览器读取url后会滚动到task所在位置。</p>
<p><img src="http://ww3.sinaimg.cn/large/006tNbRwgy1ffhk6uuns5j30jx0fjjsw.jpg" alt=""></p>
</blockquote>
<h1 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h1><p>观察发现：model的信息是可以在不同名的controller里调用。</p>
<blockquote>
<p>查找validates相关用法：<a href="https://guides.ruby.tw/rails3/active_record_validations_callbacks.html" target="_blank" rel="noopener">https://guides.ruby.tw/rails3/active_record_validations_callbacks.html</a> 或<a href="https://ruby-china.github.io/rails-guides/active_record_validations.html" target="_blank" rel="noopener">https://ruby-china.github.io/rails-guides/active_record_validations.html</a> Active Record 数据验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; validates_presence_of :name</span><br><span class="line">&gt; A：validates_presence_of 确定属性是存在的，非空非nil非false。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g migration/model，是否是第一次建立就要model？</span><br><span class="line">A：是</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin_job的controller里没有重新增加title和description栏位（即rails g model title:string description:text），是不是意味着增加的栏位每个controller都可以调用？</span><br><span class="line"></span><br><span class="line">A：没错，不管是admin下面的jobs_controller 还是controllers目录下面的，打交道的数据都是同一个job model，因为普通用户和管理员都是对同一个job相关的信息进行操作的。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rails g migration的数据也属于job model吗？或是说，如果我拿新建的admin的controller去调用6-3创建的那些栏位（wage_lower_bound/wage_upper_bound/contact_email）也是可以的？</span><br><span class="line"></span><br><span class="line">A：整理自己的理解：&quot;看atom的架构图，model里没有admin_job.rb，因为前后台都是用job.rb，而写进db：migrate的数据因为是add_more_detail_to_job，涉及到job，所以model调用的时候是在job中执行，所以db里的数据相当于是在model/job里。&quot;是的，你这样理解基本是对的。那个后面的to_job，job代表的就是model。所谓的rails 约定优于配置，to_job就是其中的一个例子。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">知道11-1，model中只有user和job，不用写关系，但是加入resume就要写，是因为两个就不用多个就要吗？如果resume不写关系会怎样？</span><br><span class="line">A：会提示出错，自己试试，一般model中的rb文件都是要根据所需功能设置关系的。比如，做招聘003的11-2QA，要先找到job，再找相关的resume，如果没有设置相关关系job has_many :resumes，系统就不知道要去哪里找resume。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-    event :make_payment do</span><br><span class="line">+    event :make_payment, after_commit: :pay! do</span><br><span class="line">       transitions from: :order_placed, to: :paid</span><br><span class="line">     end</span><br><span class="line">     </span><br><span class="line"> 1、after_commit是什么？</span><br><span class="line"> A：rails内建callback，after_commit这个callback是在记录被创建，更新或销毁后调用的。</span><br></pre></td></tr></table></figure>
<blockquote>
<h2 id="xxx的用法在model，跟controller一样是执行动作"><a href="#xxx的用法在model，跟controller一样是执行动作" class="headerlink" title=".xxx的用法在model，跟controller一样是执行动作"></a>.xxx的用法在model，跟controller一样是执行动作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; cart_items.destroy_all</span><br><span class="line">&gt; 1、destroy_all和delete_all的区别？</span><br><span class="line">&gt; A：都用于批量删除表格数据。</span><br><span class="line">&gt;</span><br><span class="line">&gt; delete_all 是一条sql语句删除，它会直接执行删除而不查询数据，优点是网络开销相对少，缺点是如果删除出现问题，回滚起来代价比较大。</span><br><span class="line">&gt;</span><br><span class="line">&gt; destroy_all 则先查出所有的数据，再一条一条的按照主键删除，优点是容易过程出现问题容易终止，缺点是网络开销比较大。</span><br><span class="line">&gt;</span><br><span class="line">&gt; 同样的数据量，delete_all 删除的速度更快，因此在什么情况下选用哪种方法，一是可以根据对执行过程的速度需求决定，二是根据对数据安全的需求决定。</span><br><span class="line">&gt;</span><br><span class="line">&gt; 代码运行过程参考这里http://blog.csdn.net/feigeswjtu/article/details/51581020</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; current_cart.clean!  </span><br><span class="line">&gt; A：有加！的要在model进一步定义</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
</blockquote>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><p>观察发现：xxx_params添加的栏位只是那些在new、update有新增、修改的栏位，而栏位的赋值不用加入，比如product_list一节在订单建立后建立购买明细缓存时，调用栏位没有加入params。</p>
<p>观察发现：左边有带@是controller的参数，右边不带@的是views页面传来的参数。</p>
<p>观察发现：controller中的action都是在做同一件事情，就是find_and_do。</p>
<p>观察发现：调用栏位有两种方法，第一种是@xxxs.each do |xxx|，然后xxx.title，第二种是@xxx.title。当栏位xxx是一个复数时用第一种，当xxx是单数时因为@xxx即表示单数所以用第二种。——比如在当前购物车中，购物车就是单数用@cart调用，购物车里的格子就是复数用current_cart.cart_items.each do |cart_item|调用。</p>
<p>观察发现：Routing Error的报错，可能是rails s没有重启、没有新建controller、没有新建model、没有设置routes导致、路径定义了member或collection的动作但是没有在views里声明method是post还是delete。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if !current_user.admin?同理的还有Group.where(:is_hidden =&gt; true)</span><br><span class="line">A：①、controller无视db值的属性直接决定游戏动作，！代表&quot;修改为不是&quot;直接决定user不是admin，true决定这个group是隐藏的。</span><br><span class="line">②、数据库admin？默认boolean为false，这样新建的user默认不是admin。db里的值是一种属性，可以在rails c里可以任意改，影响新建时的默认值但是不在controller中起作用。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在index中，params里用:order是因为log日志里有给出参数地址，那么case又是什么意思？<br>A.固定用法，类似if。不同的是if适用于罗列两种情况，而case用来罗列多种情况。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fl2mki5xcoj30qh0953zx.jpg" alt=""></p>
<p>Q.resume_controller的代码要怎么解读，自己写不出来？<br>A.第一段，找到要建立resume的那个具体的job（地址栏job/id），在这个job里新建resume页面。<br>第二段，①先找到具体在哪一个job上(即地址栏里的job/id)；②通过筛选的栏位content(在resume_params中过滤)拉到新建立的resume上；③通过<code>@resume.job = @job</code>把job的地址给到新建的resume上，使job和新建的resume关联起来，得到一个具体的新resume的路径；④把当前用户设置成resume用户；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; def new</span><br><span class="line">&gt;     @job = Job.find(params[:job_id])</span><br><span class="line">&gt;     @resume = Resume.new</span><br><span class="line">&gt;   end</span><br><span class="line">&gt;   def create</span><br><span class="line">&gt;     @job = Job.find(params[:job_id])</span><br><span class="line">&gt;     @resume = Resume.new(resume_params) #新建resume所以确定了resume的id</span><br><span class="line">&gt;     @resume.job = @job                  #@job的参数传给新建resume，即确定job的id</span><br><span class="line">&gt;     @resume.user = current_user</span><br><span class="line">&gt;     if @resume.save</span><br><span class="line">&gt;       flash[:notice] = &quot;成功提交履历&quot;</span><br><span class="line">&gt;       redirect_to job_path(@job)</span><br><span class="line">&gt;     else</span><br><span class="line">&gt;       render :new</span><br><span class="line">&gt;     end</span><br><span class="line">&gt;   end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CRUD中Group.new和Group.new(group_params)的区别？</span><br><span class="line">A：Group.new没有数据传送，调用new.html.erb即views的页面。而Group.new(group_params)已经进入new的页面，看链接可以发现这里不涉及id，而是要存储title和description的数据，这两个栏位定义在group_params中，所以是用group_params来调用。</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt;  1、购物车的逻辑？ A：见下方。</span><br><span class="line">&gt;  def add_to_cart</span><br><span class="line">&gt;    @product = Product.find(params[:id])</span><br><span class="line">&gt;    current_cart.add_product_to_cart(@product)  #购物车所有动作围绕这句代码在做</span><br><span class="line">&gt;    redirect_to :back</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;  </span><br><span class="line">&gt;  Q：redirect_to :back是什么？如果换成render :back为什么不行？</span><br><span class="line">&gt;  A：</span><br><span class="line">&gt;  </span><br><span class="line">&gt;  2、什么时候要建model，什么时候要建controller，比如在购物车这里rails g model cart、rails g model cart_item？</span><br><span class="line">&gt;  A：①、需要新建表单、填表、使用栏位的时候，第一次要建model，后续增加栏位用rails g migration add_栏位_to_刚刚的model。</span><br><span class="line">&gt;  ②、页面需要执行动作的时候，比如新建表单new、保存表单create、显示出栏位index/show。</span><br><span class="line">&gt;  </span><br><span class="line">&gt;  3、上述建立的model，什么时候要加栏位，要加多少栏位，比如cart_item加了cart_id、product_id、quantity栏位？</span><br><span class="line">&gt;  A：建立model都是因为需要建立数据库表单，表单一定是有想要显示的栏位，可以先加最小必要的栏位，主要功能测试成功后再添加其他次要栏位。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;app/models/cart.rb</span><br><span class="line">&gt; def add_product_to_cart(product)  #定义函数add_product_to_cart（引入view的参数product)</span><br><span class="line">&gt;   ci = cart_items.build  #新建格子，build与new区别见下一条</span><br><span class="line">&gt;   ci.product = product  #填上所添加商品的id号	</span><br><span class="line">&gt;   ci.quantity = 1       #填上商品数量，默认加1</span><br><span class="line">&gt;   ci.save</span><br><span class="line">&gt; end</span><br><span class="line">&gt; </span><br><span class="line">&gt; A：ci仅仅是一个参数而已，我们这里需要新建cart_item,并且向里面添加product和quantity,为便于表示把新建的cart_item赋值给ci。变量名称只是为了阅读方便，对代码执行一般没什么影响。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; helper_method :current_cart</span><br><span class="line">&gt;</span><br><span class="line">&gt; def current_cart</span><br><span class="line">&gt;   @current_cart ||= find_cart </span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br><span class="line">&gt; private</span><br><span class="line">&gt;</span><br><span class="line">&gt; def find_cart</span><br><span class="line">&gt;   cart = Cart.find_by(id: session[:cart_id])</span><br><span class="line">&gt;   if cart.blank?</span><br><span class="line">&gt;     cart = Cart.create</span><br><span class="line">&gt;   end</span><br><span class="line">&gt;   session[:cart_id] = cart.id</span><br><span class="line">&gt;   return cart</span><br><span class="line">&gt; end</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>1、helper_method是什么？<br>A：current_cart 其实原本是一个 controller 内的 method，我们为了要在 view 里面要可以存取它。所以，我们得在 applications_controller.rb 宣告他是 helper_method，才能直接存取。</p>
<p>2、||=是什么？<br>A：或等于，a ||= b 更像是a || a = b，优先取a，如果a为nil或false则取b。</p>
<p>3、find_by与find的区别？<a href="http://jiujiubad-blog.logdown.com/posts/3179266" target="_blank" rel="noopener">http://jiujiubad-blog.logdown.com/posts/3179266</a><br>A：如果查找不到希望找的元素，find会报ActiveRecord：：RecordNotFound的错误，而find_by不报错，返回nil。看起來是find只能找id或多个id如<code>product = Product.find(1,2,3)</code>，find_by 可以找 裡面所有的元素 (title, description, quantity, price)如<code>product = Product.find_by(title: &#39;快乐&#39;)</code>。ruby搜索ruby week ago。</p>
<p>4、(id: session[:card_id])前面的id:是什么？session[:card_id]是什么？<br>A：前面的id:就是字面上的id，session[:card_id]是现在拿到的购物车的id号码。<br> 在每个人进店时，都会有一块电子感应卡，叫做 session，所以你的电子感应卡上面记录了你拿了哪台车 cart_id，每个人「现在的车」 current_cart 就是透过这样的方式去存取的。————万一你的车丢失了没有关系。if cart.blank? 发现你的车不见了，会再给你一台车。重新登记上去。</p>
<p>5、Cart.create，这里create与build、new、save有什么区别？<br>A：①、save：rails中的save其實是create_or_update，新建或修改記錄。</p>
<p>②、new ：只是在內存中新建一個對象，操作數據庫要調用save方法。build和new基本相同，多用於一對多情況。</p>
<p>③、create = new + 执行sql，有跟params里面的栏位信息打交道。</p>
<p>6、blank?是什么？——空的nil的false的<br>A：false is blank；阵列[]；Hash{}；字符（串）’’、’   ‘、”\t\n\r”、nil。以上这些都是blank?<br>如上，一个对象如果是false，空的，或者一个空白字符（串），例如：false, ‘’, ‘ ‘, 或者nil，[], {}, 都是blank，所以在 rails c 中输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;nil.blank? # =&gt; true</span><br><span class="line">&gt;false.blank? # =&gt; true</span><br><span class="line">&gt;true.blank? # =&gt; false</span><br><span class="line">&gt;[].blank?      # =&gt; true</span><br><span class="line">&gt;[1,2,3].blank? # =&gt; false</span><br><span class="line">&gt;&#123;&#125;.blank?                # =&gt; true</span><br><span class="line">&gt;&#123; key: &apos;value&apos; &#125;.blank?  # =&gt; false</span><br><span class="line">&gt;&apos;&apos;.blank?       # =&gt; true</span><br><span class="line">&gt;&apos;   &apos;.blank?    # =&gt; true</span><br><span class="line">&gt;&quot;\t\n\r&quot;.blank? # =&gt; true</span><br><span class="line">&gt;&apos; blah &apos;.blank? # =&gt; false</span><br><span class="line">&gt;&quot;\u00a0&quot;.blank? # =&gt; true</span><br><span class="line">&gt;1.blank? # =&gt; false</span><br><span class="line">&gt;0.blank? # =&gt; false</span><br><span class="line">&gt;Time.now.blank? # =&gt; false</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>7、present?是什么？——非空非nil非false</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;def present?</span><br><span class="line">&gt;  !blank?</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>商品、格子、车子——格子的信息：商品信息id、车子信息id、商品数量</p>
<p>车有很多格子、有很多商品</p>
<p>商品有很多格子（一种商品就有一个格子）</p>
<p>格子属于商品、格子属于车</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;  def destroy</span><br><span class="line">&gt;    @cart = current_cart  #拿到cart_id，因为一个用户一辆车所有不用find(params[:id])</span><br><span class="line">&gt;    @cart_item = @cart.cart_items.find_by(product_id: params[:id]) #注意，find_by里的栏位值必须是已知的，所以在html文件里要传进来这个id的具体值所以要传的参数是(cart_item.product_id)。比如传进来的product_id值是3，系统就会对应到3这个产品的cart_item。</span><br><span class="line">&gt;    @product = @cart_item.product  #拿到product_id，为了后面flash可以引用</span><br><span class="line">&gt;    @cart_item.destroy  #删除格子</span><br><span class="line">&gt;</span><br><span class="line">&gt;    flash[:warning] = &quot;成功将 #&#123;@product.title&#125; 从购物车删除!&quot;</span><br><span class="line">&gt;    redirect_to :back   #测试改成redirect_to carts_path，效果一样</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>1、params[:id]是什么？</p>
<p>在Rails當中，http request會經過ActionController這個內建的機制來消化，並將可用的變數轉換為<strong>params</strong>這個變數，我們在controller當中撰寫params[:id]時，所指的其實是從前端回傳的:id。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fl87h3jhz2j30u00g2dl4.jpg" alt=""></p>
<p>2、find_by(product_id: params[:id]) 为什么不是find_by(params[:id])，这里params[:id]不是cart_item的id吗？ </p>
<p>A：测试发现，用find_by(params[:id])后，点击删除第一件商品会随机删除其他商品，即系统不知道要具体删除哪一个cart_item。——分析：如果写find_by(params[:id])，确实这个id是cart_item的id，但是这里的网址是<a href="http://localhost:3000/carts，并不知道params[:id]是多少，所以系统会随机删除一个cart_item。——由于网址找不到id，所有要通过find_by（find只能找id而find_by可以从栏位找）从cart_item的栏位（我们定义了3个栏位：product_id、cart_id、quantity）来找到cart_item的id。" target="_blank" rel="noopener">http://localhost:3000/carts，并不知道params[:id]是多少，所以系统会随机删除一个cart_item。——由于网址找不到id，所有要通过find_by（find只能找id而find_by可以从栏位找）从cart_item的栏位（我们定义了3个栏位：product_id、cart_id、quantity）来找到cart_item的id。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;%= form_for cart_item, url: cart_item_path(cart_item.product_id) do |f| %&gt; 这是什么？？</span><br><span class="line">&gt;- &lt;%= f.select :quantity, [1,2,3,4,5] %&gt;</span><br><span class="line">&gt;+ &lt;%= f.select :quantity, 1..cart_item.product.quantity %&gt;</span><br><span class="line">&gt;  &lt;%= f.submit &quot;更新&quot;, data: &#123; disable_with: &quot;Submiting...&quot; &#125; %&gt;</span><br><span class="line">&gt;&lt;% end %&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<h3 id="为什么结账页checkout是在cart-controller里用Order-new，能不能是新建一个order的controller做new的action？"><a href="#为什么结账页checkout是在cart-controller里用Order-new，能不能是新建一个order的controller做new的action？" class="headerlink" title="为什么结账页checkout是在cart_controller里用Order.new，能不能是新建一个order的controller做new的action？"></a>为什么结账页checkout是在cart_controller里用Order.new，能不能是新建一个order的controller做new的action？</h3><h3 id="order新建后有订单编号为什么不储存订单信息，把商品名称、价格、数量栏位加上去不行吗？为什么还要新建一个product-list的model？"><a href="#order新建后有订单编号为什么不储存订单信息，把商品名称、价格、数量栏位加上去不行吗？为什么还要新建一个product-list的model？" class="headerlink" title="order新建后有订单编号为什么不储存订单信息，把商品名称、价格、数量栏位加上去不行吗？为什么还要新建一个product_list的model？"></a>order新建后有订单编号为什么不储存订单信息，把商品名称、价格、数量栏位加上去不行吗？为什么还要新建一个product_list的model？</h3><p>A：一般如果订单已生成，那么商家修改商品价格、库存、描述等，是不能改变已拍下的订单信息的。所以已生成的订单里的商品id用product_list记录，商家商城里的商品id还是用product记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;   在订单建立后建立购买明细缓存：</span><br><span class="line">&gt;   if @order.save</span><br><span class="line">&gt;     current_cart.cart_items.each do |cart_item|</span><br><span class="line">&gt;       product_list = ProductList.new   </span><br><span class="line">&gt;       product_list.order = @order      </span><br><span class="line">&gt;       product_list.product_name = cart_item.product.title</span><br><span class="line">&gt;       product_list.product_price = cart_item.product.price</span><br><span class="line">&gt;       product_list.quantity = cart_item.quantity</span><br><span class="line">&gt;       product_list.save</span><br><span class="line">&gt;   end</span><br><span class="line">&gt;</span><br><span class="line">&gt;1、为什么一定要写成ProductList.new?</span><br><span class="line">&gt;A：注意观察一下，controller中右边的表达式都是大写开头，是因为右边代表的是类，所以product_list按类的写法，就跟model里第一行的声明一样，就是ProductList。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; def show</span><br><span class="line">&gt;   @order = Order.find(params[:id])</span><br><span class="line">&gt;   @product_lists = @order.product_lists   </span><br><span class="line">&gt; end</span><br><span class="line">&gt; </span><br><span class="line">&gt; Q：product_lists为什么这里要加s？？？？</span><br><span class="line">&gt; A：show的页面order是唯一的用单数，而order里可能有一张或多张订单，要把他们全部show出来就要加s。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt;before_create :generate_token  </span><br><span class="line">&gt;def generate_token</span><br><span class="line">&gt;  self.token = SecureRandom.uuid</span><br><span class="line">&gt;end</span><br><span class="line">&gt; </span><br><span class="line">&gt;def show</span><br><span class="line">&gt;  @order = Order.find_by_token(params[:id])</span><br><span class="line">&gt;  @product_lists = @order.product_lists</span><br><span class="line">&gt;nd</span><br><span class="line">&gt;</span><br><span class="line">&gt;1、before_create是什么？</span><br><span class="line">&gt;A：before_create 是 Rails model 内建的 callbacks，目的是让资料生成储存前先执行某某动作。</span><br><span class="line">&gt;</span><br><span class="line">&gt;2、SecureRandom.uuid是什么？</span><br><span class="line">&gt;A：SecureRandom.uuid 是 Ruby 内建的随机生成器。</span><br><span class="line">&gt;</span><br><span class="line">&gt;3、find_by_token是什么？</span><br><span class="line">&gt;A：找到元素token</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;def index</span><br><span class="line">&gt;  @orders = current_user.orders</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br><span class="line">&gt;1、index中，@orders = current_user.orders与@orders = Order.all的区别？</span><br><span class="line">&gt;A：订单order是user的，current_user是一个user，Order.all是指所有user的order。解读成一个user的所有订单、和所有user的所有订单。</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>2、@orders =Order.order(“id DESC”)和@resumes = @job.resumes.order(‘created_at DESC’)，order前的名词什么情况加s？？</p>
<p>A：Order是类，@job.resumes是变量的复数形式。</p>
<p>3、Order.order(“id DESC”)是什么？</p>
<p>A：写成Order.all.order(“id DESC”)也得出一样结果，可能是缩写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;def pay_with_alipay</span><br><span class="line">&gt;    @order = Order.find_by_token(params[:id])</span><br><span class="line">&gt;    @order.set_payment_with!(&quot;alipay&quot;)</span><br><span class="line">&gt;    @order.pay!</span><br><span class="line">&gt;</span><br><span class="line">&gt;    redirect_to order_path(@order.token), notice: &quot;使用支付宝成功完成付款&quot;</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;app/models/order.rb</span><br><span class="line">&gt;def set_payment_with!(method)</span><br><span class="line">&gt;  self.update_columns(payment_method: method )</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br><span class="line">&gt;def pay!</span><br><span class="line">&gt;  self.update_columns(is_paid: true )</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>1、self.update_columns(payment_method: method )是什么？<br>A：dash上查到官方文档定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;    def update_column(name, value)</span><br><span class="line">&gt;      update_columns(name =&gt; value)</span><br><span class="line">&gt;    end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>其中，payment_method:相当于是例子中的栏位name，随后的method相当于例子中的value值。</p>
<p>另外一种更新栏位值的写法是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;def pay!</span><br><span class="line">&gt;  self.is_paid = true</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;<br>&gt;<br>&gt;</p>
<blockquote>
<p>2、self是什么？</p>
<p>A：（不知道）在atom中找不到，dash中rails的没有ruby的有但好像不相关。</p>
<p>3、self.update_columns(is_paid: true )，如果像之前设置<code>def admin? is_admin end</code>那样写行不行？<br>A：</p>
<p>解释1：<code>if !current_user.admin?</code>这里is_admin是判断状态是不是admin，而pay！的update_columns是把改变状态为已付款。如果把is_admin写成self.update_columns(is_admin: true)，那么所有点击后台的账号都会改变成管理员账号。</p>
<p>解释2：由下面的分析，猜测is_admin是有role_model动态定义，而is_paid没有所以不行（具体用代码测试）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;def define_dynamic_queries(roles)</span><br><span class="line">&gt;  dynamic_module = Module.new do</span><br><span class="line">&gt;    roles.each do |role|</span><br><span class="line">&gt;      [&quot;#&#123;role&#125;?&quot;.to_sym, &quot;is_#&#123;role&#125;?&quot;.to_sym].each do |method|</span><br><span class="line">&gt;        define_method(method) &#123; is? role &#125;</span><br><span class="line">&gt;      end</span><br><span class="line">&gt;    end</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;  include dynamic_module</span><br><span class="line">&gt;end</span><br><span class="line">&gt;原来，role_model根据分配的角色动态地创建方法 - 所以这就是为什么is_admin不在源代码中显示。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;<br>&gt;<br>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;app/mailers/order_mailer.rb</span><br><span class="line">&gt;def notify_order_placed(order)</span><br><span class="line">&gt;    @order       = order</span><br><span class="line">&gt;    @user        = order.user</span><br><span class="line">&gt;    @product_lists = @order.product_lists</span><br><span class="line">&gt;</span><br><span class="line">&gt;    mail(to: @user.email , subject: &quot;[JDstore] 感谢您完成本次的下单，以下是您这次购物明细 #&#123;order.token&#125;&quot;)</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;OrderMailer.notify_ship(@order).deliver!</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&gt;  include AASM  #有限状态机的架构</span><br><span class="line">&gt;</span><br><span class="line">&gt;  aasm do</span><br><span class="line">&gt;    state :order_placed, initial: true  #已下单</span><br><span class="line">&gt;    state :paid      #已付款</span><br><span class="line">&gt;    state :shipping  #出货中</span><br><span class="line">&gt;    state :shipped   #到货</span><br><span class="line">&gt;    state :order_cancelled  #取消订单</span><br><span class="line">&gt;    state :good_returned    #退货</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt;    event :make_payment do  #付款阶段</span><br><span class="line">&gt;      transitions from: :order_placed, to: :paid</span><br><span class="line">&gt;    end</span><br><span class="line">&gt;</span><br><span class="line">&gt;    event :ship do  #送货阶段</span><br><span class="line">&gt;      transitions from: :paid,         to: :shipping</span><br><span class="line">&gt;    end</span><br><span class="line">&gt;</span><br><span class="line">&gt;    event :deliver do  #收货阶段</span><br><span class="line">&gt;      transitions from: :shipping,     to: :shipped</span><br><span class="line">&gt;    end</span><br><span class="line">&gt;</span><br><span class="line">&gt;    event :return_good do  #退货阶段</span><br><span class="line">&gt;      transitions from: :shipped,      to: :good_returned</span><br><span class="line">&gt;    end</span><br><span class="line">&gt;</span><br><span class="line">&gt;    event :cancel_order do  #取消订单阶段(已下单、已付款都可以取消)</span><br><span class="line">&gt;      transitions from: [:order_placed, :paid], to: :order_cancelled</span><br><span class="line">&gt;    end</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;  def pay_with_wechat</span><br><span class="line">&gt;-   @order.pay!</span><br><span class="line">&gt;+   @order.make_payment!</span><br><span class="line">&gt;    redirect_to order_path(@order.token), notice: &quot;使用微信支付成功完成付款&quot;</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;  </span><br><span class="line">&gt;app/models/order.rb</span><br><span class="line">&gt;event :make_payment, after_commit: :pay! do</span><br><span class="line">&gt;  transitions from: :order_placed, to: :paid</span><br><span class="line">&gt;end</span><br><span class="line">&gt;</span><br><span class="line">&gt;Q：event :make_payment, after_commit: :pay! do是什么？</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<h1 id="第11章还有很多看不明白的地方，查完这些再过一遍"><a href="#第11章还有很多看不明白的地方，查完这些再过一遍" class="headerlink" title="第11章还有很多看不明白的地方，查完这些再过一遍"></a>第11章还有很多看不明白的地方，查完这些再过一遍</h1><p>异动状态改变思路：先在views页面用case…when语法摆出6中状态，分别需要管理员操作的动作：取消订单、取消订单/出货、设为已出货、退货、订单已取消、已退货。订单已取消、已退货已是一种状态，不需要设置动作，需要设置的有取消订单、出货、已出货、退货4种。——设置路径，设置controller中的action即find_and_do。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;%= render &quot;admin/orders/state_option&quot;, order: @order %&gt;，order: @order是什么？</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;app/mailers/order_mailer.rb</span><br><span class="line">&gt;  def apply_cancel(order)</span><br><span class="line">&gt;    @order       = order  #不是刚需，只因为下文要引用order.token</span><br><span class="line">&gt;    @user        = order.user  #不是刚需，只因为下文引用@user.email</span><br><span class="line">&gt;    @product_lists = @order.product_lists  #不是刚需，只因为view里要引用这个model打印栏位</span><br><span class="line">&gt;</span><br><span class="line">&gt;    mail(to: @user.email , subject: &quot;[JDStore] 用户#&#123;order.user.email&#125;申请取消订单 #&#123;order.token&#125;&quot;)   #to:xxx是一定要的，to后面的内容可以随便</span><br><span class="line">&gt;  end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;<br>&gt;<br>&gt;<br>&gt;<br>&gt;<br>&gt;</p>
<blockquote>
<h2 id="xxx的用法在controller"><a href="#xxx的用法在controller" class="headerlink" title=".xxx的用法在controller"></a>.xxx的用法在controller</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; if !current_cart.products.include?(@product)里的.include?</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; if @cart_item.product.quantity &gt;= cart_item_params[:quantity].to_i</span><br><span class="line">&gt;   @cart_item.update(cart_item_params)</span><br><span class="line">&gt;   flash[:notice] = &quot;成功变更数量&quot;</span><br><span class="line">&gt;   </span><br><span class="line">&gt; 1、cart_item_params[:quantity]是什么？</span><br><span class="line">&gt;</span><br><span class="line">&gt; 2、.to_i是什么？</span><br><span class="line">&gt; A：转换成integer整数。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; self.update_columns(is_paid: true )，固定用法前面有解释</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; OrderMailer.notify_ship(@order).deliver!</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>.destroy_all</p>
<p>.include?</p>
<p>.present?</p>
<p>.blank?</p>
<p>.total_price</p>
<p> OrderMailer.apply_cancel(@order).deliver!</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+  def create</span><br><span class="line">+    @order = Order.new(order_params)</span><br><span class="line">+    @order.user = current_user</span><br><span class="line">+    @order.total = current_cart.total_price</span><br><span class="line"></span><br><span class="line">+    if @order.save</span><br><span class="line">+      redirect_to order_path(@order)</span><br><span class="line">+    else</span><br><span class="line">+      render &apos;carts/checkout&apos;</span><br><span class="line">+    end</span><br><span class="line">+  end</span><br></pre></td></tr></table></figure>
<p>1、render ‘carts/checkout’ 和 render :new 的区别？</p>
<p>A：</p>
<p>2、这里的user和total两个栏位是拿来做什么的？</p>
<h1 id="Routes"><a href="#Routes" class="headerlink" title="Routes"></a>Routes</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namespace :admin do</span><br></pre></td></tr></table></figure>
<blockquote>
<p>resources member do，用于加入/退出群组、是否隐藏、加入购物车、微信支付宝支付<br>resources collection do，用于？<br>两者的区别是什么？</p>
<h3 id="member-do-和-collection-do-的区别？"><a href="#member-do-和-collection-do-的区别？" class="headerlink" title="member do 和 collection do 的区别？"></a>member do 和 collection do 的区别？</h3><p>①、member do自定义对特定元素的action，比如@product。</p>
<p>特定元素的意思就是：生成的url helper，需要带（@pruduct）参数，@product是特定的单一的商品。</p>
<p>例如，用于加入/退出群组、是否隐藏、加入购物车、微信支付宝支付。</p>
<p>②、collection do自定义元素集合的action，比如products。</p>
<p>元素集合的意思就是：生成的url helper，不需要带（@cart）这样的参数，它是对所有的carts做同一操作，而不是对单一个cart操作。</p>
<p>例如，用于清空购物车、购物车结账。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; resources :carts do</span><br><span class="line">&gt;   collection do</span><br><span class="line">&gt;     delete :clean</span><br><span class="line">&gt;     post :checkout</span><br><span class="line">&gt;   end</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; resources :orders do</span><br><span class="line">&gt;   member do</span><br><span class="line">&gt;     post :pay_with_alipay</span><br><span class="line">&gt;     post :pay_with_wechat</span><br><span class="line">&gt;     post :apply_to_cancel</span><br><span class="line">&gt;   end</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; resources :orders do</span><br><span class="line">&gt;   member do</span><br><span class="line">&gt;     post :cancel</span><br><span class="line">&gt;     post :ship</span><br><span class="line">&gt;     post :shipped</span><br><span class="line">&gt;     post :return</span><br><span class="line">&gt;   end</span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
</blockquote>
<h1 id="Views"><a href="#Views" class="headerlink" title="Views"></a>Views</h1><p>观察发现：除了index，原来show的页面也是可以调用<code>&lt;% @xxxs.each do |xxx| %&gt;</code></p>
<blockquote>
<p>views里什么时候用（@group）,什么时候用(group)？views里的路径，括号里的内容好像变幻莫测，比如product_path(cart_item.product)。<br>A：①、<strong>通常要帶（）的話，就是因为要知道是哪个东西要被编辑/浏览/删除，那就会是单数的情况</strong>，所以后面基本上就是带 ID 而已。<br>②、@ 是從 controller 傳進來的，你只要記得這個就好，如果該 controller 下的 action 沒有其他的 @，view 就叫不出來。最簡單的測試，比方說controller 裡面的一個 game 的 action，那會變成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; def game</span><br><span class="line">&gt;  @nic = &quot;handsome&quot; </span><br><span class="line">&gt; end</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>那你去 game.html.erb 裡面，寫一行 &lt;%= @nic %&gt;，就会看到他把讯息抛出来变成 handsome，你只要写两行就可以测试了。</p>
<p>③、注意观察一下这里是不是在回圈（循环）内，回圈里面一般不用加@，有 @ 这个符号都是 controller 传进来的。你要看整个档案怎么写，不能只看一句，如果他是包在回圈里，那就是回圈生出来的，如果是有@就是controller传进来的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= link_to(content_tag(:i, &apos;登入&apos;, class: &apos;fa fa-sign-in&apos;), new_user_session_path) %&gt;</span><br><span class="line">&lt;i class=&quot;fa fa-home&quot; &gt;&lt;/i&gt;</span><br><span class="line">A：以上都是调用icon的方法，需要安装gem &apos;font-awesome-rails&apos;。</span><br><span class="line">官网的写法是&lt;i class=&quot;fa fa-telegram&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;，如果要更大可以加上fa-lg、fa-2x、fa-3x等，注意这种写法重构到helper文件里会报错。</span><br><span class="line">万金油的写法是content_tag(:i, &apos;登入&apos;, class: &apos;fa fa-sign-in&apos;)，文字部分如果不输入，就只显示图标。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show和edit表单</span><br><span class="line">&lt;%= simple_form_for [:admin, @product] do |f| %&gt;...&lt;%= f.input :title %&gt;...&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">index页面</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">  &lt;th&gt;Name&lt;/th&gt;</span><br><span class="line">  &lt;th width=&quot;100&quot;&gt; Options&lt;/th&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tbody&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">  &lt;% @products.each do |product| %&gt;</span><br><span class="line">     &lt;td&gt;&lt;%= product.title %&gt;&lt;/td&gt;</span><br><span class="line">     &lt;td&gt;&lt;%= link_to(&quot;Edit&quot;, edit_admin_product_path(product)) %&gt;&lt;/td&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;/tbody&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show页面</span><br><span class="line">&lt;%= @product.title %&gt;</span><br><span class="line">&lt;%= @product.description %&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= simple_form_for [@job, @resume] do |f| %&gt;中的[@job,@resume]是什么意思？&lt;%= simple_form_for [:admin, @job] do |f| %&gt;呢？</span><br><span class="line">A：先去找到一个job，再在job里找到resume。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在helper中定义def是前端用的，后端用的在model中定义？</span><br><span class="line">A：Model是用来更数据库打交道的，是在Controller中调用的，Helper是Viewer中拿来用的。初步看起来你这个总结是对的。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">views里有时用:method =&gt; :delete，有时用method: :delete，那么是不是: xxx =&gt;和：的意思一样(至少debug的时候这些是成对的)？</span><br><span class="line"></span><br><span class="line">A：那两种方式意思一样，都可以。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">简历数量的路径admin_job_resumes_path(job)是怎么来的？</span><br><span class="line">A：很简单，创建rails g controller admin::job，创建后rake routes就有了。</span><br></pre></td></tr></table></figure>
<h2 id="simple-form用法"><a href="#simple-form用法" class="headerlink" title="simple_form用法"></a>simple_form用法</h2><p>&lt;%= simple_form_for xx do |f| %&gt;</p>
<p>&lt;%= f.select/input/submit :xx %&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;% current_cart.cart_items.each do |cart_item| %&gt;</span><br><span class="line">  &lt;%= simple_form_for cart_item, url: cart_item_path(cart_item.product_id) do |f| %&gt;</span><br><span class="line">    &lt;%= f.select :quantity, [1,2,3] %&gt;</span><br><span class="line">    &lt;%= f.submit &quot;更新&quot;, data:&#123;disable_with:&quot;正在更新..&quot;&#125; %&gt;</span><br><span class="line">  &lt;% end %&gt;</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>1、为什么写成&lt;%= simple_form_for cart_item do |f| %&gt;会报错？</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fl8foae9tyj30x60dewgu.jpg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NoMethodError in CartItemsController#update</span><br><span class="line">undefined method `update&apos; for nil:NilClass</span><br><span class="line"></span><br><span class="line">Extracted source (around line #6):</span><br><span class="line">        </span><br><span class="line">    @cart = current_cart</span><br><span class="line">    @cart_item = @cart.cart_items.find_by(product_id: params[:id])</span><br><span class="line">    @cart_item.update(cart_item_params)</span><br><span class="line">    redirect_to :back</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<p>A：分析*案例在修改前是用&lt;%= cart_item.quantity %&gt;，所以这里的f代表的应该是cart_item。——stackoverflow查到加入的url是表单数据要提交到的url。——猜测：因为当前页面<a href="http://localhost:3000/carts，那么购物车是确定的，但是cart_item很多个，而我们要更新的数据" target="_blank" rel="noopener">http://localhost:3000/carts，那么购物车是确定的，但是cart_item很多个，而我们要更新的数据</a>&lt;%= cart_item.quantity %&gt;不知道product_id是多少，系统无法得知要更新哪一个cart_item，所以要指定url。所以如果系统能确定要更新的资料的id位置，就不用去指定url。</p>
<p>2、这里cart_item的url要用哪个URL呢？</p>
<p>A：我觉得在cart_item的index页面不能确定，而show页面可以，所以应该是用show的路径cart_item_path(参数)。这里的参数我一开始猜测是cart_item_path(product_id: params[:id])，但在show页面从网址可以知道cart_item的id，于是我写params[:id]，两种都报错。——根据model里设置的cart、cart_item、product的关系，要讲清楚cart_item是什么就要明白它跟cart和product分别是什么关系，即通过cart_id和product_id就能确定cart_item。所以这里的参数要写cart_item.product_id。</p>
<p>3、为什么问题2的参数不能写params[:id]?</p>
<p>A：猜测，是不是有定义product_id和cart_id栏位，所以不能用params[:id]？或是在</p>
<p>网址：localhost:3000/carts/数字a/cart_item/数字b，参数数字a传给了cart_id，参数数字b传给了product_id，因为有自定义的栏位cart_id和product_id，所以不需要rails自带的栏位params[:id]来存储参数？？</p>
<blockquote>
<h2 id="路径类"><a href="#路径类" class="headerlink" title="路径类"></a>路径类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;%= form_for cart_item, url: cart_item_path(cart_item.product_id) do |f| %&gt;</span><br><span class="line">&gt; A：url对应一个网址；cart_item_path对应的url是：/cart_items/:id(.:format)；cart_item.product_id就是这个特定的cart_item的product_id。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<h2 id="图片类"><a href="#图片类" class="headerlink" title="图片类"></a>图片类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;% if @product.image.present? %&gt;</span><br><span class="line">&gt;   &lt;span&gt;目前商品图&lt;/span&gt; &lt;br&gt;</span><br><span class="line">&gt;   &lt;%= image_tag(@product.image.thumb.url) %&gt;</span><br><span class="line">&gt; &lt;% else %&gt;</span><br><span class="line">&gt;   &lt;%= image_tag(&quot;http://placehold.it/200x200&amp;text=No Pic&quot;, class: &quot;thumbnail&quot;) %&gt;</span><br><span class="line">&gt; &lt;% end %&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt; 1、.thumb.url是什么？</span><br><span class="line">&gt; A：(对解答质疑)gem &apos;carrierwave&apos;中有设置uploader.thumb.url # =&gt; &apos;/url/to/thumb_my_file.png&apos; # size: 200x200，说明了.thumb.url是在uploader中定义的方法，具体作用就是规定了图片大小。</span><br><span class="line">&gt; 我的理解：image_tage()括号里是放一个网址，@product.image.thumb.url是指@product.image这个栏位在thumb这个class样式下的地址url。</span><br><span class="line">&gt; 2、image_tag是什么？</span><br><span class="line">&gt; A：测试发现，image_tag一定要包在&lt;% if.. %&gt;和&lt;% end %&gt;之间，或&lt;%= link_to xxx do %&gt;..&lt;% end %&gt;，才能用相对网址。或是在括号内写上双引号和绝对网址，如&quot;https://ws1.sinaimg.cn/large/006tNc79gy1fl7g3xdhczj307w0503yj.jpg&quot;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;               &lt;%= link_to product_path(cart_item.product) do %&gt;</span><br><span class="line">&gt;                 &lt;% if cart_item.product.image.present? %&gt;</span><br><span class="line">&gt;                   &lt;%= image_tag(cart_item.product.image.thumb.url, class: &quot;thumbnail&quot;) %&gt;</span><br><span class="line">&gt;                 &lt;% else %&gt;</span><br><span class="line">&gt;                   &lt;%= image_tag(&quot;http://placehold.it/200x200&amp;text=No Pic&quot;, class: &quot;thumbnail&quot;) %&gt;</span><br><span class="line">&gt;                 &lt;% end %&gt;</span><br><span class="line">&gt;               &lt;% end %&gt;</span><br><span class="line">&gt; 1、link_to xxx do 是什么？</span><br><span class="line">&gt; A：把图片就变成链接。</span><br><span class="line">&gt; A：</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<h2 id="xxx的用法在views，常表示一种状态而controller中是表示一种动作"><a href="#xxx的用法在views，常表示一种状态而controller中是表示一种动作" class="headerlink" title=".xxx的用法在views，常表示一种状态而controller中是表示一种动作"></a>.xxx的用法在views，常表示一种状态而controller中是表示一种动作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;% if current_user.admin? %&gt;views里的.admin？是调用model的吗？</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;%= current_cart.products.count %&gt;拿到购物车内的物品数量</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;%= order.created_at.to_s(:long) %&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;% if !@order.is_paid? %&gt;，其中is_paid是db的一个栏位设置了boolean。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;%= order.aasm_state %&gt;，其中aasm_state是db的一个栏位。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app/views/carts/index.html.erb </span><br><span class="line">&lt;% current_cart.cart_items.each do |cart_item| %&gt;  #已在model中定义helper_method</span><br><span class="line">   &lt;%= cart_item.product.title %&gt;</span><br><span class="line">   &lt;%= cart_item.product.price %&gt;</span><br><span class="line">   &lt;%= cart_item.quantity %&gt;</span><br><span class="line"> &lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if cart_item.product.price.present? %&gt;，其中present？是什么？</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">数量选择器quantity的用法：</span><br><span class="line">&lt;%= f.select :quantity, [1,2,3,4,5] %&gt;</span><br><span class="line">&lt;%= f.select :quantity, 1..cart_item.product.quantity %&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;% case order.aasm_state %&gt;</span><br><span class="line">&lt;% when &quot;order_placed&quot; %&gt;</span><br><span class="line">  &lt;%= link_to(&quot;取消订单&quot;,</span><br><span class="line">              cancel_admin_order_path(order),</span><br><span class="line">              class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% when &quot;paid&quot; %&gt;</span><br><span class="line">  &lt;%= link_to(&quot;取消订单&quot;,</span><br><span class="line">              cancel_admin_order_path(order),</span><br><span class="line">              class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line">  &lt;%= link_to(&quot;出货&quot;,</span><br><span class="line">              ship_admin_order_path(order),</span><br><span class="line">              class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% when &quot;shipping&quot; %&gt;</span><br><span class="line">  &lt;%= link_to(&quot;设为已出货&quot;,</span><br><span class="line">              shipped_admin_order_path(order),</span><br><span class="line">              class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% when &quot;shipped&quot; %&gt;</span><br><span class="line">  &lt;%= link_to(&quot;退货&quot;,</span><br><span class="line">              return_admin_order_path(order),</span><br><span class="line">              class: &quot;btn btn-default btn-sm&quot;, method: :post) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% when &quot;order_cancelled&quot; %&gt;</span><br><span class="line">  &lt;span class=&quot;label label-default&quot;&gt;订单已取消&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">&lt;% when &quot;good_returned&quot; %&gt;</span><br><span class="line">  &lt;span class=&quot;label label-default&quot;&gt;已退货&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>
<p>Q：已下订单通知信，为什么是用order_url(@order.token)，而不能用order_path(@order.token)？</p>
<p><code>&lt;%= link_to(&quot;订单连结&quot;, order_url(@order.token)) %&gt;</code></p>
<p>A：因为发送邮件要用绝对路径，否则收件人打不开邮件。</p>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">by 99</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/posts/7286171a/" class="pre-post btn btn-default"><i class="fa fa-angle-left fa-fw"></i>上一篇</a>
    
    
        <a href="/posts/bf9570f4/" class="next-post btn btn-default">下一篇<i class="fa fa-angle-right fa-fw"></i></a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMzE1My85NzEx">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>


            </main>
            
    <aside class="col-md-3 sidebar">
        
        
    <div class="widget">
        <h3 class="title">Search</h3>
        <div id="search-form">
            <div id="result-mask" class="hide"></div>
            <div class="search-area">
                
                    <input id="search-key" type="search" autocomplete="off" placeholder="搜点什么呢?">
                    <button type="button" class="search-form-submit" id="search-local">搜索</button>
                
                
            </div>
            <div id="result-wrap" class="hide">
                <div id="search-result"></div>
            </div>
            <div class="hide">
                <template id="search-tpl">
                    <div class="item">
                        <a href="/{path}" title="{title}">
                            <div class="title">{title}</div>
                            <div class="content">{content}</div>
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </div>


        
        
    <div class="widget notification">
        <h3 class="title">网站公告</h3>
        <div>
            <p>你好，我是99。<br/>欢迎来到我的博客。<br/>
<br/>
<hr/>接受贡献，包括不限于提交问题与需求，修复代码。欢迎Pull Request<br/>支持主题：<a href="https://github.com/shenliyang/hexo-theme-snippet/stargazers">Star一下</a>
</p>
        </div>
    </div>

        
        
    <div class="widget">
      <h3 class="title">Social</h3> 
        <div class="content social">
            
	            <a href="https://github.com/jiujiubad?tab=repositories" rel="external nofollow" title="Github" target="_blank">
			    	<i class="github fa fa-github"></i>
			    </a>
            
	            <a href="jiujiubad@gmail.com" rel="external nofollow" title="邮箱" target="_blank">
			    	<i class="envelope-o fa fa-envelope-o"></i>
			    </a>
            
	            <a href="https://ws4.sinaimg.cn/large/006tNc79ly1fnvcxiavzgj30by0bymxg.jpg" rel="external nofollow" title="微信" target="_blank">
			    	<i class="weixin fa fa-weixin"></i>
			    </a>
            
        </div>
    </div>


        
        
    <div class="widget">
        <h3 class="title">Categories</h3>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ror功能/"><i class="fa" aria-hidden="true">ror功能</i></a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ror知识点/"><i class="fa" aria-hidden="true">ror知识点</i></a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ror系统/"><i class="fa" aria-hidden="true">ror系统</i></a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web页面/"><i class="fa" aria-hidden="true">web页面</i></a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/"><i class="fa" aria-hidden="true">工具</i></a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信小程序/"><i class="fa" aria-hidden="true">微信小程序</i></a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link current" href="/categories/心得/"><i class="fa" aria-hidden="true">心得</i></a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/投资/"><i class="fa" aria-hidden="true">投资</i></a><span class="category-list-count">1</span></li></ul>
    </div>


        
        
    <div class="widget">
      <h3 class="title">Archives</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/"><i class="fa" aria-hidden="true">January 2018</i></a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/"><i class="fa" aria-hidden="true">December 2017</i></a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/"><i class="fa" aria-hidden="true">November 2017</i></a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/"><i class="fa" aria-hidden="true">September 2017</i></a><span class="archive-list-count">1</span></li></ul>
    </div>


        
        
  <div class="widget">
    <h3 class="title">Tag Cloud</h3>
    <div class="content tag-cloud">
        <a href="/tags/atom/" style="font-size: 14px;">atom</a> <a href="/tags/bug/" style="font-size: 18px;">bug</a> <a href="/tags/heroku/" style="font-size: 10px;">heroku</a> <a href="/tags/hexo/" style="font-size: 12px;">hexo</a> <a href="/tags/interview/" style="font-size: 11px;">interview</a> <a href="/tags/mac/" style="font-size: 12px;">mac</a> <a href="/tags/orid-day/" style="font-size: 10px;">orid-day</a> <a href="/tags/orid-month/" style="font-size: 11px;">orid-month</a> <a href="/tags/ror功能/" style="font-size: 14px;">ror功能</a> <a href="/tags/ror知识点/" style="font-size: 17px;">ror知识点</a> <a href="/tags/ror系统/" style="font-size: 19px;">ror系统</a> <a href="/tags/stackoverflow/" style="font-size: 10px;">stackoverflow</a> <a href="/tags/typora/" style="font-size: 10px;">typora</a> <a href="/tags/vps/" style="font-size: 16px;">vps</a> <a href="/tags/web页面/" style="font-size: 12px;">web页面</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/工具/" style="font-size: 20px;">工具</a> <a href="/tags/常用/" style="font-size: 13px;">常用</a> <a href="/tags/微信功能/" style="font-size: 13px;">微信功能</a> <a href="/tags/微信系统/" style="font-size: 15px;">微信系统</a> <a href="/tags/微信页面/" style="font-size: 11px;">微信页面</a> <a href="/tags/心得/" style="font-size: 15px;">心得</a> <a href="/tags/手机/" style="font-size: 10px;">手机</a> <a href="/tags/投资/" style="font-size: 10px;">投资</a> <a href="/tags/搬砖/" style="font-size: 10px;">搬砖</a> <a href="/tags/核聚编程/" style="font-size: 12px;">核聚编程</a> <a href="/tags/科学上网/" style="font-size: 14px;">科学上网</a> <a href="/tags/部署/" style="font-size: 13px;">部署</a>
    </div>
  </div>


        
        
    <div class="widget">
        <h3 class="title">Friends</h3>
        <div class="content friends-link">
        
            <a href="http://www.shenliyang.com" class="fa" target="_blank">个人博客</a>
        
        </div>
    </div>


        
    </aside>


        </div>
      </section>
    </div>
  </div>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <span>Copyright &copy; 2018
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



	<script src="/js/search.js?rev=@@hash"></script>


<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>
